diff --git a/README.md b/README.md
index 07298902a127f10ba46428a56d74e5a54634b196..a5fd586363e8fd6f084e7edca2600fb8bd009acc 100644
--- a/README.md
+++ b/README.md
@@ -6,32 +6,15 @@ The `@effect/rpc` library facilitates the development of remote procedure call (
 
 ## Declaring Requests
 
-The `TaggedRequest` API in the `effect/Schema` module is designed to facilitate the creation of structured requests that can serialize function signatures involving input arguments, successful outcomes, and potential failures. Essentially, it's a tool for defining a serializable function that can be reliably transported across different systems or network layers.
+The `RpcGroup` and `Rpc` modules can be used alongside the `Schema` module to
+define requests and responses.
 
-Hereâ€™s a simplified explanation:
-
-1. **Function Modeling**: `TaggedRequest` allows you to model a function signature as a class, which includes the input arguments, the type of the success response, and the type of the failure response.
-
-2. **Serialization Schema**: For each component (input, success, failure), you specify a corresponding schema. This setup helps ensure that the data associated with each request can be properly serialized (converted to a format suitable for storage or transmission) and deserialized (converted back to usable format).
-
-3. **Usage Scenario**: This API is particularly useful when you need to handle remote procedure calls (RPCs) where functions and their arguments need to be sent over a network, processed, and then responded to asynchronously.
-
-4. **Streamlined Code**: By leveraging `Schema.TaggedRequest`, developers can reduce the amount of boilerplate code typically required for handling complex data serialization and deserialization tasks in distributed systems.
-
-In practice, when you create an instance of `TaggedRequest`, you define the function's behavior along with its serialization rules, which streamlines the process of encoding input data, sending it across a network, and decoding responses.
-
-```mermaid
-sequenceDiagram
-    Sender->>SenderBound: encodes A to I
-    SenderBound-->>ReceiverBound: send I
-    ReceiverBound->>Receiver: decodes I to A
-    Receiver->>ReceiverBound: encodes Exit<Success, Failure><br/>to Exit<SuccessEncoded, FailureEncoded>
-    ReceiverBound-->>SenderBound: send back<br/>Exit<SuccessEncoded, FailureEncoded>
-    SenderBound->>Sender: decodes Exit<SuccessEncoded, FailureEncoded><br/>to Exit<Success, Failure>
-```
+Here we are defining a request to retrieve a list of users, a request to
+retrieve a user by ID, and a request to create a new user.
 
 ```ts filename="request.ts"
 // request.ts
+import { Rpc, RpcGroup } from "@effect/rpc"
 import { Schema } from "effect"
 
 // Define a user with an ID and name
@@ -40,90 +23,99 @@ export class User extends Schema.Class<User>("User")({
   name: Schema.String // User's name as a string
 }) {}
 
-// Request to retrieve a list of users
-export class UserList extends Schema.TaggedRequest<UserList>()("UserList", {
-  failure: Schema.Never, // Indicates that no errors are expected
-  success: Schema.Array(User), // Specifies that the response is an array of Users
-  payload: {}
-}) {}
-
-// Request to retrieve a user by ID
-export class UserById extends Schema.TaggedRequest<UserById>()("UserById", {
-  failure: Schema.String, // Indicates that errors, if any, will be returned as strings
-  success: User, // Specifies that the response is a User
-  payload: {
-    id: Schema.String
-  }
-}) {}
-
-// Request to create a new user
-export class UserCreate extends Schema.TaggedRequest<UserCreate>()(
-  "UserCreate",
-  {
-    failure: Schema.Never, // Indicates that no errors are expected
-    success: User, // Specifies that the response is a User
+// Define a group of RPCs for user management.
+// You can use the `RpcGroup.make` function to create a group of RPCs.
+export class UserRpcs extends RpcGroup.make(
+  // Request to retrieve a list of users
+  Rpc.make("UserList", {
+    success: User, // Succeed with a stream of users
+    stream: true
+  }),
+  Rpc.make("UserById", {
+    success: User,
+    error: Schema.String, // Indicates that errors, if any, will be returned as strings
+    payload: {
+      id: Schema.String
+    }
+  }),
+  Rpc.make("UserCreate", {
+    success: User,
     payload: {
       name: Schema.String
     }
-  }
+  })
 ) {}
 ```
 
-## Defining a Router
+## Implementing the handlers
 
-This section introduces how to configure a router using an imaginary database setup to manage user data.
+This section introduces how to implement the rpc handlers, using an imaginary database setup to manage user data.
 
 ```ts filename="router.ts"
-// router.ts
-import { RpcRouter, Rpc } from "@effect/rpc"
-import { Effect, Ref } from "effect"
-import { User, UserById, UserCreate, UserList } from "./request.js"
+// handlers.ts
+import type { Rpc } from "@effect/rpc"
+import { Effect, Layer, Ref, Stream } from "effect"
+import { User, UserRpcs } from "./request.js"
 
 // ---------------------------------------------
 // Imaginary Database
 // ---------------------------------------------
 
-const ref = Ref.unsafeMake<Array<User>>([
-  new User({ id: "1", name: "Alice" }),
-  new User({ id: "2", name: "Bob" })
-])
-
-const db = {
-  user: {
-    findMany: () => ref.get,
-    findById: (id: string) =>
-      Ref.get(ref).pipe(
-        Effect.andThen((users) => {
-          const user = users.find((user) => user.id === id)
-          return user
-            ? Effect.succeed(user)
-            : Effect.fail(`User not found: ${id}`)
-        })
-      ),
-    create: (name: string) =>
-      Ref.updateAndGet(ref, (users) => [
-        ...users,
-        new User({ id: String(users.length + 1), name })
-      ]).pipe(Effect.andThen((users) => users[users.length - 1]))
+class UserRepository extends Effect.Service<UserRepository>()(
+  "UserRepository",
+  {
+    effect: Effect.gen(function* () {
+      const ref = yield* Ref.make<Array<User>>([
+        new User({ id: "1", name: "Alice" }),
+        new User({ id: "2", name: "Bob" })
+      ])
+
+      return {
+        findMany: ref.get,
+        findById: (id: string) =>
+          Ref.get(ref).pipe(
+            Effect.andThen((users) => {
+              const user = users.find((user) => user.id === id)
+              return user
+                ? Effect.succeed(user)
+                : Effect.fail(`User not found: ${id}`)
+            })
+          ),
+        create: (name: string) =>
+          Ref.updateAndGet(ref, (users) => [
+            ...users,
+            new User({ id: String(users.length + 1), name })
+          ]).pipe(Effect.andThen((users) => users[users.length - 1]))
+      }
+    })
   }
-}
+) {}
 
 // ---------------------------------------------
-// Router
+// RPC handlers
 // ---------------------------------------------
 
-export const appRouter = RpcRouter.make(
-  Rpc.effect(UserList, () => db.user.findMany()),
-  Rpc.effect(UserById, ({ id }) => db.user.findById(id)),
-  Rpc.effect(UserCreate, ({ name }) => db.user.create(name))
-)
+export const UsersLive: Layer.Layer<
+  Rpc.Handler<"UserList"> | Rpc.Handler<"UserById"> | Rpc.Handler<"UserCreate">
+> = UserRpcs.toLayer(
+  Effect.gen(function* () {
+    const db = yield* UserRepository
 
-export type AppRouter = typeof appRouter
+    return {
+      UserList: () => Stream.fromIterableEffect(db.findMany),
+      UserById: ({ id }) => db.findById(id),
+      UserCreate: ({ name }) => db.create(name)
+    }
+  })
+).pipe(
+  // Provide the UserRepository layer
+  Layer.provide(UserRepository.Default)
+)
 ```
 
 ## Serving the API
 
-This part explains how to serve the API using the defined router.
+This part explains how to serve the API using the handlers we defined earlier.
 
 ```ts filename="server.ts"
 // server.ts
@@ -151,15 +143,7 @@ Use this `curl` command to test if the API is operational:
 ```bash
 curl -X POST http://localhost:3000/rpc \
      -H "Content-Type: application/json" \
-     -d '[
-           {
-             "request": { "_tag": "UserList" },
-             "traceId": "traceId",
-             "spanId": "spanId",
-             "sampled": true,
-             "headers": {}
-           }
-         ]'
+     -d $'{"_tag": "Request", "id": "123", "tag": "UserList", "payload": {}, "traceId": "traceId", "spanId": "spanId", "sampled": true, "headers": {} }\n'
 ```
 
 ## Using your new backend on the client
@@ -168,141 +152,132 @@ Let's now move to the client-side code and embrace the power of end-to-end types
 
 ```ts
 // client.ts
-import { HttpClient, HttpClientRequest } from "@effect/platform"
-import { RpcResolver } from "@effect/rpc"
-import { HttpRpcResolver } from "@effect/rpc-http"
-import { Effect } from "effect"
-import { UserCreate, UserList } from "./request.js"
-import type { AppRouter } from "./router.js"
-
-// Define an effect which creates the client
-const makeClient = Effect.gen(function*() {
-  const baseClient = yield* HttpClient.HttpClient
-  const client = baseClient.pipe(
-    HttpClient.filterStatusOk,
-    HttpClient.mapRequest(HttpClientRequest.prependUrl("http://localhost:3000/rpc"))
-  )
-  return RpcResolver.toClient(HttpRpcResolver.make<AppRouter>(client))
-})
+import { FetchHttpClient } from "@effect/platform"
+import { RpcClient, RpcSerialization } from "@effect/rpc"
+import { Chunk, Effect, Layer, Stream } from "effect"
+import { UserRpcs } from "./request.js"
+
+// Choose which protocol to use
+const ProtocolLive = RpcClient.layerProtocolHttp({
+  url: "http://localhost:3000/rpc"
+}).pipe(
+  Layer.provide([
+    // use fetch for http requests
+    FetchHttpClient.layer,
+    // use ndjson for serialization
+    RpcSerialization.layerNdjson
+  ])
+)
 
 // Use the client
 const program = Effect.gen(function* () {
-  const client = yield* makeClient
-  let users = yield* client(new UserList())
-  if (!users.find((user) => user.id === "3")) {
+  const client = yield* RpcClient.make(UserRpcs)
+  let users = yield* Stream.runCollect(client.UserList({}))
+  if (!Chunk.findFirst(users, (user) => user.id === "3")) {
     console.log(`Creating user "Charlie"`)
-    yield* client(new UserCreate({ name: "Charlie" }))
-    users = yield* client(new UserList())
+    yield* client.UserCreate({ name: "Charlie" })
+    users = yield* Stream.runCollect(client.UserList({}))
   } else {
     console.log(`User "Charlie" already exists`)
   }
   return users
-})
+}).pipe(Effect.scoped)
 
-program.pipe(
-  Effect.provide(FetchHttpClient.layer),
-  Effect.runPromise
-).then(console.log)
+program.pipe(Effect.provide(ProtocolLive), Effect.runPromise).then(console.log)
 ```
 
-# Stream
-
-## Setting Up the Stream Request
-
-```ts filename="request.ts"
-// request.ts
-import * as Rpc from "@effect/rpc/Rpc"
-import { Schema } from "effect"
+## Defining middleware
 
-export class Counts extends Rpc.StreamRequest<Counts>()("Counts", {
-  failure: Schema.Never, // Indicates that no errors are expected
-  success: Schema.Number, // Specifies that the response is a number
-  payload: {}
-}) {}
-```
+To add middleware to the RPC server (& optionally the client), you can use the
+`RpcMiddleware` module.
 
-## Defining the Router
+The first step is to define the middleware context tag, which is used to both
+implement and access the middleware.
 
-In the router setup, we link the Counts request to a function that emits numbers from 1 to 5 at regular intervals.
+```ts filename="middleware.ts"
+// middleware.ts
+import { RpcMiddleware } from "@effect/rpc"
+import { Context } from "effect"
+import type { User } from "./request.js"
 
-```ts filename="router.ts"
-// router.ts
-import { Router, Rpc } from "@effect/rpc"
-import { Effect, Stream } from "effect"
-import { Counts } from "./request.js"
-
-export const appRouter = Router.make(
-  Rpc.stream(Counts, () =>
-    Stream.make(1, 2, 3, 4, 5).pipe(Stream.tap(() => Effect.sleep("1 second")))
-  )
-)
+// A context tag which represents the current user
+export class CurrentUser extends Context.Tag("CurrentUser")<
+  CurrentUser,
+  User
+>() {}
 
-export type AppRouter = typeof appRouter
+// The context tag for the authentication middleware
+export class AuthMiddleware extends RpcMiddleware.Tag<AuthMiddleware>()(
+  "AuthMiddleware",
+  {
+    // This middleware will provide the current user context
+    provides: CurrentUser,
+    // This middleware requires a client implementation too
+    requiredForClient: true
+  }
+) {}
 ```
 
-## Serving the API
+## Implementing middleware
 
-The server code configures an HTTP server to handle requests, using our appRouter to manage incoming stream requests.
+Once the middleware context tag is defined, you can then use it in a `RpcGroup`
+to apply it to various RPCs.
 
-```ts filename="server.ts"
-// server.ts
-import { HttpRouter, HttpServer } from "@effect/platform"
-import { NodeHttpServer, NodeRuntime } from "@effect/platform-node"
-import { toHttpApp } from "@effect/rpc-http/HttpRouter"
-import { Layer } from "effect"
-import { createServer } from "http"
-import { appRouter } from "./router.js"
+When it has been applied, you can then implement the middleware logic and add it
+to your server and client.
 
-const HttpLive = HttpRouter.empty.pipe(
-  HttpRouter.post("/rpc", toHttpApp(appRouter)),
-  HttpServer.serve(),
-  HttpServer.withLogAddress,
-  Layer.provide(NodeHttpServer.layer(createServer, { port: 3000 }))
+```ts
+import { Headers } from "@effect/platform"
+import { Rpc, RpcClient, RpcGroup, RpcMiddleware, RpcServer } from "@effect/rpc"
+import { Effect, Layer, Schema } from "effect"
+import { AuthMiddleware } from "./middleware.js"
+import { User } from "./request.js"
+
+export class UserRpcs extends RpcGroup.make(
+  Rpc.make("UserById", {
+    success: User,
+    payload: {
+      id: Schema.String
+    }
+  })
+    // apply the middleware to a single RPC
+    .middleware(AuthMiddleware)
 )
-
-NodeRuntime.runMain(Layer.launch(HttpLive))
-```
-
-## Consuming the Stream from the Client
-
-```ts filename="client.ts"
-// client.ts
-import { HttpClient, HttpClientRequest } from "@effect/platform"
-import { RpcResolver } from "@effect/rpc"
-import { HttpRpcResolver } from "@effect/rpc-http"
-import { Effect, Stream } from "effect"
-import { Counts } from "./request.js"
-import type { AppRouter } from "./router.js"
-
-const makeClient = Effect.gen(function*() {
-  const baseClient = yield* HttpClient.HttpClient
-  const client = baseClient.pipe(
-    HttpClient.filterStatusOk,
-    HttpClient.mapRequest(HttpClientRequest.prependUrl("http://localhost:3000/rpc"))
-  )
-  return RpcResolver.toClient(HttpRpcResolver.make<AppRouter>(client))
-})
-
-const program = Effect.gen(function* () {
-  const client = yield* makeClient
-  yield* Effect.log("Running the client")
-  const stream = client(new Counts())
-  return yield* stream.pipe(
-    Stream.tap((element) => Effect.log(element)),
-    Stream.runCollect
+  // or apply the middleware to the entire group
+  .middleware(AuthMiddleware) {}
+
+// Implement the middleware for a server
+export const AuthLive: Layer.Layer<AuthMiddleware> = Layer.succeed(
+  AuthMiddleware,
+  // A middleware that provides the current user.
+  //
+  // You can access the headers, payload, and the RPC definition when
+  // implementing the middleware.
+  AuthMiddleware.of(({ headers, payload, rpc }) =>
+    Effect.succeed(new User({ id: "123", name: "Logged in user" }))
   )
-})
+)
 
-program.pipe(
-  Effect.provide(FetchHttpClient.layer),
-  Effect.runPromise
+// apply the middleware to a rpc server
+RpcServer.layer(UserRpcs).pipe(Layer.provide(AuthLive))
+
+// Implement the middleware for a client
+//
+// The client middleware can access the request and the RPC definition, and
+// returns a modified request.
+export const AuthClientLive: Layer.Layer<
+  RpcMiddleware.ForClient<AuthMiddleware>
+> = RpcMiddleware.layerClient(AuthMiddleware, ({ request, rpc }) =>
+  Effect.succeed({
+    ...request,
+    headers: Headers.set(request.headers, "authorization", "Bearer token")
+  })
 )
-/*
-timestamp=...:50.395Z level=INFO fiber=#0 message="Running the client"
-timestamp=...:52.438Z level=INFO fiber=#1 message=1
-timestamp=...:53.438Z level=INFO fiber=#1 message=2
-timestamp=...:54.440Z level=INFO fiber=#1 message=3
-timestamp=...:55.445Z level=INFO fiber=#1 message=4
-timestamp=...:55.447Z level=INFO fiber=#1 message=5
-*/
+
+// apply the middleware to a rpc client
+export class UsersClient extends Effect.Service<UsersClient>()("UsersClient", {
+  scoped: RpcClient.make(UserRpcs),
+  // add the middleware layer to the dependencies
+  dependencies: [AuthClientLive]
+}) {}
 ```
diff --git a/RpcClient/package.json b/RpcClient/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..198a1fec4560480e9d78d0c1410a36b55190cf5f
--- /dev/null
+++ b/RpcClient/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcClient.js",
+  "module": "../dist/esm/RpcClient.js",
+  "types": "../dist/dts/RpcClient.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcGroup/package.json b/RpcGroup/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..036736a8f4dcd2834c3663bc06c3dc3bab51232a
--- /dev/null
+++ b/RpcGroup/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcGroup.js",
+  "module": "../dist/esm/RpcGroup.js",
+  "types": "../dist/dts/RpcGroup.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcMessage/package.json b/RpcMessage/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..3761d219d9b54e034e6835a4df2e528d2f1386ec
--- /dev/null
+++ b/RpcMessage/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcMessage.js",
+  "module": "../dist/esm/RpcMessage.js",
+  "types": "../dist/dts/RpcMessage.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcMiddleware/package.json b/RpcMiddleware/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..a775119e2013ee5691ae6b565187194796f32c60
--- /dev/null
+++ b/RpcMiddleware/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcMiddleware.js",
+  "module": "../dist/esm/RpcMiddleware.js",
+  "types": "../dist/dts/RpcMiddleware.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcSchema/package.json b/RpcSchema/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..a49b50d8728b47d7651670b3c606a445c2299dee
--- /dev/null
+++ b/RpcSchema/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcSchema.js",
+  "module": "../dist/esm/RpcSchema.js",
+  "types": "../dist/dts/RpcSchema.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcSerialization/package.json b/RpcSerialization/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..58160260e984e72d4ce92ae7a075b9483e78b7b7
--- /dev/null
+++ b/RpcSerialization/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcSerialization.js",
+  "module": "../dist/esm/RpcSerialization.js",
+  "types": "../dist/dts/RpcSerialization.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcServer/package.json b/RpcServer/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..53da2915daa632da51a63b0c5de6376efe8d6b93
--- /dev/null
+++ b/RpcServer/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcServer.js",
+  "module": "../dist/esm/RpcServer.js",
+  "types": "../dist/dts/RpcServer.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcTest/package.json b/RpcTest/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..a54592880ab8fa471152c629bab034b2eab4a0fc
--- /dev/null
+++ b/RpcTest/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcTest.js",
+  "module": "../dist/esm/RpcTest.js",
+  "types": "../dist/dts/RpcTest.d.ts",
+  "sideEffects": []
+}
diff --git a/RpcWorker/package.json b/RpcWorker/package.json
new file mode 100644
index 0000000000000000000000000000000000000000..a4a42f2e3fdffb5050e3a53f71690a768a05bf03
--- /dev/null
+++ b/RpcWorker/package.json
@@ -0,0 +1,6 @@
+{
+  "main": "../dist/cjs/RpcWorker.js",
+  "module": "../dist/esm/RpcWorker.js",
+  "types": "../dist/dts/RpcWorker.d.ts",
+  "sideEffects": []
+}
diff --git a/dist/cjs/Rpc.js b/dist/cjs/Rpc.js
index 4013a8aa2d32fe6ac8ba89cca147c43fe056f48d..0cc4eb50d62b60df05925cfcb4f13707381ab686 100644
--- a/dist/cjs/Rpc.js
+++ b/dist/cjs/Rpc.js
@@ -3,23 +3,16 @@
 Object.defineProperty(exports, "__esModule", {
   value: true
 });
-exports.stream = exports.schemaHeaders = exports.request = exports.provideServiceEffect = exports.provideService = exports.isRpc = exports.effect = exports.currentHeaders = exports.call = exports.annotateHeaders = exports.TypeId = exports.StreamRequestTypeId = exports.StreamRequest = exports.RequestSchema = void 0;
-var Headers = _interopRequireWildcard(require("@effect/platform/Headers"));
-var Effect = _interopRequireWildcard(require("effect/Effect"));
-var FiberRef = _interopRequireWildcard(require("effect/FiberRef"));
-var _Function = require("effect/Function");
+exports.make = exports.isRpc = exports.isFork = exports.fromTaggedRequest = exports.fork = exports.exitSchema = exports.TypeId = exports.ForkTypeId = void 0;
+var Context_ = _interopRequireWildcard(require("effect/Context"));
 var _GlobalValue = require("effect/GlobalValue");
+var Option = _interopRequireWildcard(require("effect/Option"));
 var _Pipeable = require("effect/Pipeable");
 var Predicate = _interopRequireWildcard(require("effect/Predicate"));
 var Schema = _interopRequireWildcard(require("effect/Schema"));
-var Stream = _interopRequireWildcard(require("effect/Stream"));
-var Internal = _interopRequireWildcard(require("./internal/rpc.js"));
+var RpcSchema = _interopRequireWildcard(require("./RpcSchema.js"));
 function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
 function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
-/**
- * @since 1.0.0
- */
-
 /**
  * @since 1.0.0
  * @category type ids
@@ -27,129 +20,133 @@ function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e;
 const TypeId = exports.TypeId = /*#__PURE__*/Symbol.for("@effect/rpc/Rpc");
 /**
  * @since 1.0.0
- * @category refinements
+ * @category guards
  */
 const isRpc = u => Predicate.hasProperty(u, TypeId);
-/**
- * @since 1.0.0
- * @category constructors
- */
 exports.isRpc = isRpc;
-const effect = (schema, handler) => ({
+const Proto = {
   [TypeId]: TypeId,
-  _tag: "Effect",
-  schema,
-  handler,
   pipe() {
     return (0, _Pipeable.pipeArguments)(this, arguments);
+  },
+  setSuccess(successSchema) {
+    return makeProto({
+      ...this,
+      successSchema
+    });
+  },
+  setError(errorSchema) {
+    return makeProto({
+      ...this,
+      errorSchema
+    });
+  },
+  setPayload(payloadSchema) {
+    return makeProto({
+      ...this,
+      payloadSchema: Schema.isSchema(payloadSchema) ? payloadSchema : Schema.Struct(payloadSchema)
+    });
+  },
+  middleware(middleware) {
+    return makeProto({
+      ...this,
+      middlewares: new Set([...this.middlewares, middleware])
+    });
+  },
+  annotate(tag, value) {
+    return makeProto({
+      ...this,
+      annotations: Context_.add(this.annotations, tag, value)
+    });
+  },
+  annotateContext(context) {
+    return makeProto({
+      ...this,
+      annotations: Context_.merge(this.annotations, context)
+    });
   }
-});
-/**
- * @since 1.0.0
- * @category type ids
- */
-exports.effect = effect;
-const StreamRequestTypeId = exports.StreamRequestTypeId = Internal.StreamRequestTypeId;
-/**
- * @since 1.0.0
- * @category schemas
- */
-const StreamRequest = () => (tag, options) => {
-  return class extends Schema.TaggedRequest()(tag, options) {
-    constructor(props, disableValidation) {
-      super(props, disableValidation);
-      this[Internal.StreamRequestTypeId] = Internal.StreamRequestTypeId;
-    }
-  };
 };
+const makeProto = options => {
+  const self = Object.assign(Object.create(Proto), options);
+  self.key = `@effect/rpc/Rpc/${options._tag}`;
+  return self;
+};
+const constEmptyStruct = /*#__PURE__*/Schema.Struct({});
 /**
  * @since 1.0.0
  * @category constructors
  */
-exports.StreamRequest = StreamRequest;
-const stream = (schema, handler) => ({
-  [TypeId]: TypeId,
-  _tag: "Stream",
-  schema: schema,
-  handler,
-  pipe() {
-    return (0, _Pipeable.pipeArguments)(this, arguments);
-  }
-});
-/**
- * @since 1.0.0
- * @category schemas
- */
-exports.stream = stream;
-const RequestSchema = schema => Schema.Struct({
-  request: schema,
-  traceId: Schema.String,
-  spanId: Schema.String,
-  sampled: Schema.Boolean,
-  headers: Schema.Record({
-    key: Schema.String,
-    value: Schema.String
-  })
-});
-/**
- * @since 1.0.0
- * @category headers
- */
-exports.RequestSchema = RequestSchema;
-const currentHeaders = exports.currentHeaders = /*#__PURE__*/(0, _GlobalValue.globalValue)("@effect/rpc/Rpc/currentHeaders", () => FiberRef.unsafeMake(Headers.empty));
+const make = (tag, options) => {
+  const successSchema = options?.success ?? Schema.Void;
+  const errorSchema = options?.error ?? Schema.Never;
+  return makeProto({
+    _tag: tag,
+    payloadSchema: Schema.isSchema(options?.payload) ? options?.payload : options?.payload ? Schema.Struct(options?.payload) : constEmptyStruct,
+    successSchema: options?.stream ? RpcSchema.Stream({
+      success: successSchema,
+      failure: errorSchema
+    }) : successSchema,
+    errorSchema: options?.stream ? Schema.Never : errorSchema,
+    annotations: Context_.empty(),
+    middlewares: new Set()
+  });
+};
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-const annotateHeaders = exports.annotateHeaders = /*#__PURE__*/(0, _Function.dual)(2, (self, headers) => {
-  const resolved = Headers.fromInput(headers);
-  return Effect.locallyWith(self, currentHeaders, prev => ({
-    ...prev,
-    ...resolved
-  }));
+exports.make = make;
+const fromTaggedRequest = schema => makeProto({
+  _tag: schema._tag,
+  payloadSchema: schema,
+  successSchema: schema.success,
+  errorSchema: schema.failure,
+  annotations: Context_.empty(),
+  middlewares: new Set()
 });
+exports.fromTaggedRequest = fromTaggedRequest;
+const exitSchemaCache = /*#__PURE__*/(0, _GlobalValue.globalValue)("@effect/rpc/Rpc/exitSchemaCache", () => new WeakMap());
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-const schemaHeaders = schema => {
-  const decode = Schema.decodeUnknown(schema);
-  return Effect.flatMap(FiberRef.get(currentHeaders), decode);
+const exitSchema = self => {
+  if (exitSchemaCache.has(self)) {
+    return exitSchemaCache.get(self);
+  }
+  const rpc = self;
+  const streamSchemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast);
+  const schema = Schema.Exit({
+    success: Option.isSome(streamSchemas) ? Schema.Void : rpc.successSchema,
+    failure: Option.isSome(streamSchemas) ? Schema.Union(streamSchemas.value.failure, rpc.errorSchema) : rpc.errorSchema,
+    defect: Schema.Defect
+  });
+  exitSchemaCache.set(self, schema);
+  return schema;
 };
 /**
  * @since 1.0.0
- * @category requests
+ * @category Fork
  */
-exports.schemaHeaders = schemaHeaders;
-const request = (request, options) => (0, _Function.pipe)(Effect.makeSpanScoped(`${options?.spanPrefix ?? "Rpc.request "}${request._tag}`, {
-  kind: "client",
-  captureStackTrace: false
-}), Effect.zip(FiberRef.get(currentHeaders)), Effect.map(([span, headers]) => Internal.makeRequest({
-  request,
-  traceId: span.traceId,
-  spanId: span.spanId,
-  sampled: span.sampled,
-  headers
-})));
+exports.exitSchema = exitSchema;
+const ForkTypeId = exports.ForkTypeId = /*#__PURE__*/Symbol.for("@effect/rpc/Rpc/Fork");
 /**
+ * You can use `fork` to wrap a response Effect or Stream, to ensure that the
+ * response is executed concurrently regardless of the RpcServer concurrency
+ * setting.
+ *
  * @since 1.0.0
- * @category requests
+ * @category Fork
  */
-exports.request = request;
-const call = (req, resolver, options) => {
-  const isStream = Internal.StreamRequestTypeId in req;
-  const res = (0, _Function.pipe)(request(req, options), Effect.flatMap(_ => Effect.request(_, resolver)));
-  return isStream ? Stream.unwrapScoped(res) : Effect.scoped(res);
-};
-/**
- * @since 1.0.0
- * @category context
- */
-exports.call = call;
-const provideServiceEffect = exports.provideServiceEffect = /*#__PURE__*/(0, _Function.dual)(3, (self, tag, make) => self._tag === "Effect" ? effect(self.schema, req => Effect.provideServiceEffect(self.handler(req), tag, Effect.orDie(make))) : stream(self.schema, req => Stream.provideServiceEffect(self.handler(req), tag, Effect.orDie(make))));
+const fork = value => ({
+  [ForkTypeId]: ForkTypeId,
+  value
+});
 /**
  * @since 1.0.0
- * @category context
+ * @category Fork
  */
-const provideService = exports.provideService = /*#__PURE__*/(0, _Function.dual)(3, (self, tag, service) => self._tag === "Effect" ? effect(self.schema, req => Effect.provideService(self.handler(req), tag, service)) : stream(self.schema, req => Stream.provideService(self.handler(req), tag, service)));
+exports.fork = fork;
+const isFork = u => ForkTypeId in u;
+exports.isFork = isFork;
 //# sourceMappingURL=Rpc.js.map
\ No newline at end of file
diff --git a/dist/cjs/Rpc.js.map b/dist/cjs/Rpc.js.map
index ee4df6c993ac18c82b0e031bd1d790b14b821bb5..031d960968a0e601735ade6a5f0e221639c95c7c 100644
--- a/dist/cjs/Rpc.js.map
+++ b/dist/cjs/Rpc.js.map
@@ -1 +1 @@
-{"version":3,"file":"Rpc.js","names":["Headers","_interopRequireWildcard","require","Effect","FiberRef","_Function","_GlobalValue","_Pipeable","Predicate","Schema","Stream","Internal","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","TypeId","exports","Symbol","for","isRpc","hasProperty","effect","schema","handler","_tag","pipe","pipeArguments","arguments","StreamRequestTypeId","StreamRequest","tag","options","TaggedRequest","constructor","props","disableValidation","stream","RequestSchema","Struct","request","traceId","String","spanId","sampled","Boolean","headers","Record","key","value","currentHeaders","globalValue","unsafeMake","empty","annotateHeaders","dual","self","resolved","fromInput","locallyWith","prev","schemaHeaders","decode","decodeUnknown","flatMap","makeSpanScoped","spanPrefix","kind","captureStackTrace","zip","map","span","makeRequest","req","resolver","isStream","res","_","unwrapScoped","scoped","provideServiceEffect","make","orDie","provideService","service"],"sources":["../../src/Rpc.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"Rpc.js","names":["Context_","_interopRequireWildcard","require","_GlobalValue","Option","_Pipeable","Predicate","Schema","RpcSchema","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","TypeId","exports","Symbol","for","isRpc","hasProperty","Proto","pipe","pipeArguments","arguments","setSuccess","successSchema","makeProto","setError","errorSchema","setPayload","payloadSchema","isSchema","Struct","middleware","middlewares","Set","annotate","tag","value","annotations","add","annotateContext","context","merge","options","self","assign","create","key","_tag","constEmptyStruct","make","success","Void","error","Never","payload","stream","Stream","failure","empty","fromTaggedRequest","schema","exitSchemaCache","globalValue","exitSchema","rpc","streamSchemas","getStreamSchemas","ast","Exit","isSome","Union","defect","Defect","ForkTypeId","fork","isFork"],"sources":["../../src/Rpc.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcClient.js b/dist/cjs/RpcClient.js
new file mode 100644
index 0000000000000000000000000000000000000000..ab8ef3c694839d56b59ce9e65adcdf8fa4de68ea
--- /dev/null
+++ b/dist/cjs/RpcClient.js
@@ -0,0 +1,643 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.withHeadersEffect = exports.withHeaders = exports.makeProtocolWorker = exports.makeProtocolSocket = exports.makeProtocolHttp = exports.makeNoSerialization = exports.make = exports.layerProtocolWorker = exports.layerProtocolSocket = exports.layerProtocolHttp = exports.currentHeaders = exports.Protocol = void 0;
+var Headers = _interopRequireWildcard(require("@effect/platform/Headers"));
+var HttpBody = _interopRequireWildcard(require("@effect/platform/HttpBody"));
+var HttpClient = _interopRequireWildcard(require("@effect/platform/HttpClient"));
+var HttpClientRequest = _interopRequireWildcard(require("@effect/platform/HttpClientRequest"));
+var Socket = _interopRequireWildcard(require("@effect/platform/Socket"));
+var Transferable = _interopRequireWildcard(require("@effect/platform/Transferable"));
+var Worker = _interopRequireWildcard(require("@effect/platform/Worker"));
+var Cause = _interopRequireWildcard(require("effect/Cause"));
+var Chunk = _interopRequireWildcard(require("effect/Chunk"));
+var Context = _interopRequireWildcard(require("effect/Context"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Exit = _interopRequireWildcard(require("effect/Exit"));
+var Fiber = _interopRequireWildcard(require("effect/Fiber"));
+var FiberId = _interopRequireWildcard(require("effect/FiberId"));
+var FiberRef = _interopRequireWildcard(require("effect/FiberRef"));
+var _Function = require("effect/Function");
+var _GlobalValue = require("effect/GlobalValue");
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var Mailbox = _interopRequireWildcard(require("effect/Mailbox"));
+var Option = _interopRequireWildcard(require("effect/Option"));
+var Pool = _interopRequireWildcard(require("effect/Pool"));
+var Schedule = _interopRequireWildcard(require("effect/Schedule"));
+var Schema = _interopRequireWildcard(require("effect/Schema"));
+var Scope = _interopRequireWildcard(require("effect/Scope"));
+var Stream = _interopRequireWildcard(require("effect/Stream"));
+var _utils = require("./internal/utils.js");
+var Rpc = _interopRequireWildcard(require("./Rpc.js"));
+var _RpcMessage = require("./RpcMessage.js");
+var RpcSchema = _interopRequireWildcard(require("./RpcSchema.js"));
+var RpcSerialization = _interopRequireWildcard(require("./RpcSerialization.js"));
+var RpcWorker = _interopRequireWildcard(require("./RpcWorker.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category client
+ */
+const makeNoSerialization = exports.makeNoSerialization = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const spanPrefix = options?.spanPrefix ?? "RpcClient";
+  const supportsAck = options?.supportsAck ?? true;
+  const disableTracing = options?.disableTracing ?? false;
+  let requestId = BigInt(0);
+  const generateRequestId = options.generateRequestId ?? (() => requestId++);
+  const context = yield* Effect.context();
+  const scope = Context.get(context, Scope.Scope);
+  const entries = new Map();
+  let isShutdown = false;
+  yield* Scope.addFinalizer(scope, Effect.fiberIdWith(fiberId => {
+    isShutdown = true;
+    return clearEntries(Exit.interrupt(fiberId));
+  }));
+  const clearEntries = Effect.fnUntraced(function* (exit) {
+    for (const [id, entry] of entries) {
+      entries.delete(id);
+      if (entry._tag === "Mailbox") {
+        yield* entry.mailbox.done(exit);
+      } else {
+        entry.resume(exit);
+      }
+    }
+  });
+  const onRequest = rpc => {
+    const isStream = RpcSchema.isStreamSchema(rpc.successSchema);
+    const middleware = getRpcClientMiddleware(rpc);
+    return (payload, options) => {
+      const headers = options?.headers ? Headers.fromInput(options.headers) : Headers.empty;
+      if (!isStream) {
+        const effect = Effect.useSpan(`${spanPrefix}.${rpc._tag}`, {
+          captureStackTrace: false
+        }, span => onEffectRequest(rpc, middleware, span, payload ? rpc.payloadSchema.make(payload) : {}, headers, options?.context ?? Context.empty(), options?.discard ?? false));
+        return disableTracing ? Effect.withTracerEnabled(effect, false) : effect;
+      }
+      const mailbox = Effect.suspend(() => onStreamRequest(rpc, middleware, payload ? rpc.payloadSchema.make(payload) : {}, headers, options?.streamBufferSize ?? 16, options?.context ?? Context.empty()));
+      if (options?.asMailbox) return mailbox;
+      return Stream.unwrapScoped(Effect.map(mailbox, Mailbox.toStream));
+    };
+  };
+  const onEffectRequest = (rpc, middleware, span, payload, headers, context, discard) => Effect.withFiberRuntime(parentFiber => {
+    if (isShutdown) {
+      return Effect.interrupt;
+    }
+    const id = generateRequestId();
+    const send = middleware({
+      _tag: "Request",
+      id,
+      tag: rpc._tag,
+      payload,
+      traceId: span.traceId,
+      spanId: span.spanId,
+      sampled: span.sampled,
+      headers: Headers.merge(parentFiber.getFiberRef(currentHeaders), headers)
+    });
+    if (discard) {
+      return Effect.flatMap(send, message => options.onFromClient({
+        message,
+        context,
+        discard
+      }));
+    }
+    let fiber;
+    return Effect.onInterrupt(Effect.async(resume => {
+      const entry = {
+        _tag: "Effect",
+        rpc,
+        context,
+        resume(exit) {
+          resume(exit);
+          if (!fiber.unsafePoll()) {
+            parentFiber.currentScheduler.scheduleTask(() => {
+              fiber.unsafeInterruptAsFork(parentFiber.id());
+            }, 0);
+          }
+        }
+      };
+      entries.set(id, entry);
+      fiber = send.pipe(Effect.flatMap(request => options.onFromClient({
+        message: request,
+        context,
+        discard
+      })), Effect.runFork);
+      fiber.addObserver(exit => {
+        if (exit._tag === "Failure") {
+          return resume(exit);
+        }
+      });
+    }), interruptors => {
+      entries.delete(id);
+      const ids = Array.from(interruptors).flatMap(id => Array.from(FiberId.toSet(id)));
+      return Effect.zipRight(Fiber.interrupt(fiber), sendInterrupt(id, ids, context));
+    });
+  });
+  const onStreamRequest = Effect.fnUntraced(function* (rpc, middleware, payload, headers, streamBufferSize, context) {
+    if (isShutdown) {
+      return yield* Effect.interrupt;
+    }
+    const span = yield* Effect.makeSpanScoped(`${spanPrefix}.${rpc._tag}`, {
+      captureStackTrace: false
+    }).pipe(disableTracing ? Effect.withTracerEnabled(false) : _Function.identity);
+    const fiber = Option.getOrThrow(Fiber.getCurrentFiber());
+    const id = generateRequestId();
+    const scope = Context.unsafeGet(fiber.currentContext, Scope.Scope);
+    yield* Scope.addFinalizerExit(scope, exit => {
+      if (!entries.has(id)) return Effect.void;
+      entries.delete(id);
+      return sendInterrupt(id, Exit.isFailure(exit) ? Array.from(Cause.interruptors(exit.cause)).flatMap(id => Array.from(FiberId.toSet(id))) : [], context);
+    });
+    const mailbox = yield* Mailbox.make(streamBufferSize);
+    entries.set(id, {
+      _tag: "Mailbox",
+      rpc,
+      mailbox,
+      scope,
+      context
+    });
+    yield* middleware({
+      _tag: "Request",
+      id,
+      tag: rpc._tag,
+      traceId: span.traceId,
+      payload,
+      spanId: span.spanId,
+      sampled: span.sampled,
+      headers: Headers.merge(fiber.getFiberRef(currentHeaders), headers)
+    }).pipe(Effect.flatMap(request => options.onFromClient({
+      message: request,
+      context,
+      discard: false
+    })), Effect.catchAllCause(error => mailbox.failCause(error)), Effect.interruptible, Effect.forkIn(scope));
+    return mailbox;
+  });
+  const getRpcClientMiddleware = rpc => {
+    const middlewares = [];
+    for (const tag of rpc.middlewares.values()) {
+      const middleware = context.unsafeMap.get(`${tag.key}/Client`);
+      if (!middleware) continue;
+      middlewares.push(middleware);
+    }
+    return middlewares.length === 0 ? Effect.succeed : function (request) {
+      let i = 0;
+      return Effect.map(Effect.whileLoop({
+        while: () => i < middlewares.length,
+        body: () => middlewares[i]({
+          rpc,
+          request
+        }),
+        step(nextRequest) {
+          request = nextRequest;
+          i++;
+        }
+      }), () => request);
+    };
+  };
+  const sendInterrupt = (requestId, interruptors, context) => Effect.async(resume => {
+    const fiber = options.onFromClient({
+      message: {
+        _tag: "Interrupt",
+        requestId,
+        interruptors
+      },
+      context,
+      discard: false
+    }).pipe(Effect.timeout(1000), Effect.runFork);
+    fiber.addObserver(() => {
+      resume(Effect.void);
+    });
+  });
+  const write = message => {
+    switch (message._tag) {
+      case "Chunk":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry || entry._tag !== "Mailbox") return Effect.void;
+          return entry.mailbox.offerAll(message.values).pipe(supportsAck ? Effect.zipRight(options.onFromClient({
+            message: {
+              _tag: "Ack",
+              requestId: message.requestId
+            },
+            context: entry.context,
+            discard: false
+          })) : _Function.identity, Effect.onError(cause => entry.mailbox.done(Exit.failCause(cause))), Effect.forkIn(entry.scope));
+        }
+      case "Exit":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry) return Effect.void;
+          entries.delete(requestId);
+          if (entry._tag === "Effect") {
+            entry.resume(message.exit);
+            return Effect.void;
+          }
+          return entry.mailbox.done(Exit.asVoid(message.exit));
+        }
+      case "Defect":
+        {
+          return clearEntries(Exit.die(message.defect));
+        }
+      case "ClientEnd":
+        {
+          return Effect.void;
+        }
+    }
+  };
+  const client = {};
+  for (const rpc of group.requests.values()) {
+    ;
+    client[rpc._tag] = onRequest(rpc);
+  }
+  return {
+    client: client,
+    write
+  };
+});
+/**
+ * @since 1.0.0
+ * @category client
+ */
+const make = exports.make = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const context = yield* Effect.context();
+  const {
+    run,
+    send,
+    supportsAck,
+    supportsTransferables
+  } = yield* Protocol;
+  const entries = new Map();
+  const {
+    client,
+    write
+  } = yield* makeNoSerialization(group, {
+    ...options,
+    supportsAck,
+    onFromClient({
+      message
+    }) {
+      switch (message._tag) {
+        case "Request":
+          {
+            const rpc = group.requests.get(message.tag);
+            const schemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast);
+            const collector = supportsTransferables ? Transferable.unsafeMakeCollector() : undefined;
+            const entry = {
+              rpc,
+              decodeChunk: Option.isSome(schemas) ? Schema.decodeUnknown(Schema.NonEmptyArray(schemas.value.success)) : undefined
+            };
+            entries.set(message.id, entry);
+            return Schema.encode(rpc.payloadSchema)(message.payload).pipe(Effect.locally(FiberRef.currentContext, collector ? Context.add(context, Transferable.Collector, collector) : context), Effect.orDie, Effect.flatMap(payload => send({
+              ...message,
+              payload,
+              headers: Object.entries(message.headers)
+            }, collector && collector.unsafeClear())));
+          }
+        case "Ack":
+          {
+            const entry = entries.get(message.requestId);
+            if (!entry) return Effect.void;
+            return send(message);
+          }
+        case "Interrupt":
+          {
+            const entry = entries.get(message.requestId);
+            if (!entry) return Effect.void;
+            entries.delete(message.requestId);
+            return send({
+              _tag: "Interrupt",
+              requestId: message.requestId
+            });
+          }
+        case "Eof":
+          {
+            return Effect.void;
+          }
+      }
+    }
+  });
+  yield* run(message => {
+    switch (message._tag) {
+      case "Chunk":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry || !entry.decodeChunk) return Effect.void;
+          return entry.decodeChunk(message.values).pipe(Effect.locally(FiberRef.currentContext, context), Effect.orDie, Effect.flatMap(chunk => write({
+            _tag: "Chunk",
+            clientId: 0,
+            requestId: parseRequestId(message.requestId),
+            values: chunk
+          })), Effect.onError(cause => write({
+            _tag: "Exit",
+            clientId: 0,
+            requestId: parseRequestId(message.requestId),
+            exit: Exit.failCause(cause)
+          })));
+        }
+      case "Exit":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry) return Effect.void;
+          entries.delete(requestId);
+          return Schema.decode(Rpc.exitSchema(entry.rpc))(message.exit).pipe(Effect.locally(FiberRef.currentContext, context), Effect.orDie, Effect.matchCauseEffect({
+            onSuccess: exit => write({
+              _tag: "Exit",
+              clientId: 0,
+              requestId,
+              exit
+            }),
+            onFailure: cause => write({
+              _tag: "Exit",
+              clientId: 0,
+              requestId,
+              exit: Exit.failCause(cause)
+            })
+          }));
+        }
+      case "Defect":
+        {
+          return write({
+            _tag: "Defect",
+            clientId: 0,
+            defect: decodeDefect(message.defect)
+          });
+        }
+      default:
+        {
+          return Effect.void;
+        }
+    }
+  }).pipe(Effect.catchAllCause(Effect.logError), Effect.interruptible, Effect.forkScoped);
+  return client;
+});
+const parseRequestId = input => typeof input === "string" ? BigInt(input) : input;
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+const currentHeaders = exports.currentHeaders = /*#__PURE__*/(0, _GlobalValue.globalValue)("@effect/rpc/RpcClient/currentHeaders", () => FiberRef.unsafeMake(Headers.empty));
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+const withHeaders = exports.withHeaders = /*#__PURE__*/(0, _Function.dual)(2, (effect, headers) => Effect.locallyWith(effect, currentHeaders, Headers.merge(Headers.fromInput(headers))));
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+const withHeadersEffect = exports.withHeadersEffect = /*#__PURE__*/(0, _Function.dual)(2, (effect, headers) => Effect.flatMap(headers, headers => withHeaders(effect, headers)));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+class Protocol extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcClient/Protocol")() {
+  /**
+   * @since 1.0.0
+   */
+  static make = /*#__PURE__*/(0, _utils.withRun)();
+}
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.Protocol = Protocol;
+const makeProtocolHttp = client => Protocol.make(Effect.fnUntraced(function* (writeResponse) {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const isJson = serialization.contentType === "application/json";
+  const send = request => {
+    if (request._tag !== "Request") {
+      return Effect.void;
+    }
+    const parser = serialization.unsafeMake();
+    if (!serialization.supportsBigInt) transformBigInt(request);
+    const encoded = parser.encode(request);
+    const body = typeof encoded === "string" ? HttpBody.text(encoded, serialization.contentType) : HttpBody.uint8Array(encoded, serialization.contentType);
+    if (isJson) {
+      return client.post("/", {
+        body
+      }).pipe(Effect.flatMap(r => r.json), Effect.scoped, Effect.flatMap(u => {
+        if (!Array.isArray(u)) {
+          return Effect.dieMessage(`Expected an array of responses, but got: ${u}`);
+        }
+        let i = 0;
+        return Effect.whileLoop({
+          while: () => i < u.length,
+          body: () => writeResponse(u[i++]),
+          step: _Function.constVoid
+        });
+      }), Effect.orDie);
+    }
+    return client.post("/", {
+      body
+    }).pipe(Effect.flatMap(r => Stream.runForEachChunk(r.stream, chunk => {
+      const responses = Chunk.toReadonlyArray(chunk).flatMap(parser.decode);
+      if (responses.length === 0) return Effect.void;
+      let i = 0;
+      return Effect.whileLoop({
+        while: () => i < responses.length,
+        body: () => writeResponse(responses[i++]),
+        step: _Function.constVoid
+      });
+    })), Effect.scoped, Effect.orDie);
+  };
+  return {
+    send,
+    supportsAck: false,
+    supportsTransferables: false
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.makeProtocolHttp = makeProtocolHttp;
+const layerProtocolHttp = options => Layer.scoped(Protocol, Effect.flatMap(HttpClient.HttpClient, client => {
+  client = HttpClient.mapRequest(client, HttpClientRequest.prependUrl(options.url));
+  return makeProtocolHttp(options.transformClient ? options.transformClient(client) : client);
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.layerProtocolHttp = layerProtocolHttp;
+const makeProtocolSocket = exports.makeProtocolSocket = /*#__PURE__*/Protocol.make( /*#__PURE__*/Effect.fnUntraced(function* (writeResponse) {
+  const socket = yield* Socket.Socket;
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const write = yield* socket.writer;
+  let parser = serialization.unsafeMake();
+  yield* Effect.suspend(() => {
+    parser = serialization.unsafeMake();
+    return socket.runRaw(message => {
+      try {
+        const responses = parser.decode(message);
+        if (responses.length === 0) return;
+        let i = 0;
+        return Effect.whileLoop({
+          while: () => i < responses.length,
+          body: () => writeResponse(responses[i++]),
+          step: _Function.constVoid
+        });
+      } catch (defect) {
+        return writeResponse({
+          _tag: "Defect",
+          defect
+        });
+      }
+    });
+  }).pipe(Effect.zipRight(Effect.fail(new Socket.SocketCloseError({
+    reason: "Close",
+    code: 1000
+  }))), Effect.tapErrorCause(cause => writeResponse({
+    _tag: "Defect",
+    defect: Cause.squash(cause)
+  })), Effect.retry(Schedule.spaced(1000)), Effect.annotateLogs({
+    module: "RpcClient",
+    method: "makeProtocolSocket"
+  }), Effect.interruptible, Effect.forkScoped);
+  yield* Effect.suspend(() => write(parser.encode(_RpcMessage.constPing))).pipe(Effect.delay("30 seconds"), Effect.ignore, Effect.forever, Effect.interruptible, Effect.forkScoped);
+  return {
+    send(request) {
+      if (!serialization.supportsBigInt) transformBigInt(request);
+      return Effect.orDie(write(parser.encode(request)));
+    },
+    supportsAck: true,
+    supportsTransferables: false
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+const makeProtocolWorker = options => Protocol.make(Effect.fnUntraced(function* (writeResponse) {
+  const worker = yield* Worker.PlatformWorker;
+  const scope = yield* Effect.scope;
+  let workerId = 0;
+  const initialMessage = yield* Effect.serviceOption(RpcWorker.InitialMessage);
+  const entries = new Map();
+  yield* Scope.addFinalizerExit(scope, exit => Effect.forEach(entries, ([_, entry]) => Scope.close(entry.scope, exit), {
+    discard: true,
+    concurrency: "unbounded"
+  }));
+  const acquire = Effect.gen(function* () {
+    const id = workerId++;
+    const backing = yield* worker.spawn(id);
+    const readyLatch = yield* Effect.makeLatch();
+    yield* backing.run(message => {
+      if (message[0] === 0) {
+        return readyLatch.open;
+      }
+      const response = message[1];
+      if (response._tag === "Exit") {
+        const entry = entries.get(response.requestId);
+        if (entry) {
+          entries.delete(response.requestId);
+          return Effect.ensuring(writeResponse(response), Scope.close(entry.scope, Exit.void));
+        }
+      } else if (response._tag === "Defect") {
+        return Effect.zipRight(Effect.forEach(entries, ([requestId, entry]) => {
+          entries.delete(requestId);
+          return Scope.close(entry.scope, Exit.die(response.defect));
+        }, {
+          discard: true
+        }), writeResponse(response));
+      }
+      return writeResponse(response);
+    }).pipe(Effect.tapErrorCause(cause => writeResponse({
+      _tag: "Defect",
+      defect: Cause.squash(cause)
+    })), Effect.retry(Schedule.spaced(1000)), Effect.annotateLogs({
+      module: "RpcClient",
+      method: "makeProtocolWorker"
+    }), Effect.interruptible, Effect.forkScoped);
+    yield* readyLatch.await;
+    if (Option.isSome(initialMessage)) {
+      const [value, transfers] = yield* initialMessage.value;
+      yield* backing.send({
+        _tag: "InitialMessage",
+        value
+      }, transfers);
+    }
+    return backing;
+  });
+  const pool = "minSize" in options ? yield* Pool.makeWithTTL({
+    acquire,
+    min: options.minSize,
+    max: options.maxSize,
+    concurrency: options.concurrency,
+    targetUtilization: options.targetUtilization,
+    timeToLive: options.timeToLive
+  }) : yield* Pool.make({
+    acquire,
+    size: options.size,
+    concurrency: options.concurrency,
+    targetUtilization: options.targetUtilization
+  });
+  const send = (request, transferables) => {
+    switch (request._tag) {
+      case "Request":
+        {
+          return Scope.make().pipe(Effect.flatMap(scope => Effect.flatMap(Scope.extend(pool.get, scope), worker => {
+            entries.set(request.id, {
+              worker,
+              scope
+            });
+            return Effect.orDie(worker.send(request, transferables));
+          })), Effect.orDie);
+        }
+      case "Interrupt":
+        {
+          const entry = entries.get(request.requestId);
+          if (!entry) return Effect.void;
+          entries.delete(request.requestId);
+          return Effect.ensuring(Effect.orDie(entry.worker.send(request)), Scope.close(entry.scope, Exit.void));
+        }
+      case "Ack":
+        {
+          const entry = entries.get(request.requestId);
+          if (!entry) return Effect.void;
+          return Effect.orDie(entry.worker.send(request));
+        }
+    }
+    return Effect.void;
+  };
+  yield* Effect.scoped(pool.get);
+  return {
+    send,
+    supportsAck: true,
+    supportsTransferables: true
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.makeProtocolWorker = makeProtocolWorker;
+const layerProtocolWorker = options => Layer.scoped(Protocol, makeProtocolWorker(options));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.layerProtocolWorker = layerProtocolWorker;
+const layerProtocolSocket = exports.layerProtocolSocket = /*#__PURE__*/Layer.scoped(Protocol, makeProtocolSocket);
+// internal
+const decodeDefect = /*#__PURE__*/Schema.decodeSync(Schema.Defect);
+const transformBigInt = request => {
+  if (request._tag === "Request") {
+    ;
+    request.id = request.id.toString();
+  } else if ("requestId" in request) {
+    ;
+    request.requestId = request.requestId.toString();
+  }
+};
+//# sourceMappingURL=RpcClient.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcClient.js.map b/dist/cjs/RpcClient.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..6c16c702c2dc684503c41a39ab8a00fb7095b3f6
--- /dev/null
+++ b/dist/cjs/RpcClient.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcClient.js","names":["Headers","_interopRequireWildcard","require","HttpBody","HttpClient","HttpClientRequest","Socket","Transferable","Worker","Cause","Chunk","Context","Effect","Exit","Fiber","FiberId","FiberRef","_Function","_GlobalValue","Layer","Mailbox","Option","Pool","Schedule","Schema","Scope","Stream","_utils","Rpc","_RpcMessage","RpcSchema","RpcSerialization","RpcWorker","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","makeNoSerialization","exports","fnUntraced","group","options","spanPrefix","supportsAck","disableTracing","requestId","BigInt","generateRequestId","context","scope","entries","Map","isShutdown","addFinalizer","fiberIdWith","fiberId","clearEntries","interrupt","exit","id","entry","delete","_tag","mailbox","done","resume","onRequest","rpc","isStream","isStreamSchema","successSchema","middleware","getRpcClientMiddleware","payload","headers","fromInput","empty","effect","useSpan","captureStackTrace","span","onEffectRequest","payloadSchema","make","discard","withTracerEnabled","suspend","onStreamRequest","streamBufferSize","asMailbox","unwrapScoped","map","toStream","withFiberRuntime","parentFiber","send","tag","traceId","spanId","sampled","merge","getFiberRef","currentHeaders","flatMap","message","onFromClient","fiber","onInterrupt","async","unsafePoll","currentScheduler","scheduleTask","unsafeInterruptAsFork","pipe","request","runFork","addObserver","interruptors","ids","Array","from","toSet","zipRight","sendInterrupt","makeSpanScoped","identity","getOrThrow","getCurrentFiber","unsafeGet","currentContext","addFinalizerExit","void","isFailure","cause","catchAllCause","error","failCause","interruptible","forkIn","middlewares","values","unsafeMap","key","push","length","succeed","whileLoop","while","body","step","nextRequest","timeout","write","parseRequestId","offerAll","onError","asVoid","die","defect","client","requests","run","supportsTransferables","Protocol","schemas","getStreamSchemas","ast","collector","unsafeMakeCollector","undefined","decodeChunk","isSome","decodeUnknown","NonEmptyArray","value","success","encode","locally","add","Collector","orDie","unsafeClear","chunk","clientId","decode","exitSchema","matchCauseEffect","onSuccess","onFailure","decodeDefect","logError","forkScoped","input","globalValue","unsafeMake","withHeaders","dual","locallyWith","withHeadersEffect","Tag","withRun","makeProtocolHttp","writeResponse","serialization","isJson","contentType","parser","supportsBigInt","transformBigInt","encoded","text","uint8Array","post","json","scoped","isArray","dieMessage","constVoid","runForEachChunk","stream","responses","toReadonlyArray","layerProtocolHttp","mapRequest","prependUrl","url","transformClient","makeProtocolSocket","socket","writer","runRaw","fail","SocketCloseError","reason","code","tapErrorCause","squash","retry","spaced","annotateLogs","module","method","constPing","delay","ignore","forever","makeProtocolWorker","worker","PlatformWorker","workerId","initialMessage","serviceOption","InitialMessage","forEach","_","close","concurrency","acquire","gen","backing","spawn","readyLatch","makeLatch","open","response","ensuring","await","transfers","pool","makeWithTTL","min","minSize","max","maxSize","targetUtilization","timeToLive","size","transferables","extend","layerProtocolWorker","layerProtocolSocket","decodeSync","Defect","toString"],"sources":["../../src/RpcClient.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcGroup.js b/dist/cjs/RpcGroup.js
new file mode 100644
index 0000000000000000000000000000000000000000..fc2cc0aa88c7b017307c3c481f2ad83463a3a661
--- /dev/null
+++ b/dist/cjs/RpcGroup.js
@@ -0,0 +1,97 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.make = exports.TypeId = void 0;
+var Context = _interopRequireWildcard(require("effect/Context"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var Schema = _interopRequireWildcard(require("effect/Schema"));
+var Rpc = _interopRequireWildcard(require("./Rpc.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+const TypeId = exports.TypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcGroup");
+const RpcGroupProto = {
+  add(...rpcs) {
+    return makeProto({
+      requests: resolveInput(...this.requests.values(), ...rpcs),
+      annotations: this.annotations
+    });
+  },
+  merge(that) {
+    const requests = new Map(this.requests);
+    for (const rpc of that.requests.values()) {
+      requests.set(rpc._tag, rpc);
+    }
+    return makeProto({
+      requests,
+      annotations: Context.merge(this.annotations, that.annotations)
+    });
+  },
+  middleware(middleware) {
+    const requests = new Map();
+    for (const [tag, rpc] of this.requests) {
+      requests.set(tag, rpc.middleware(middleware));
+    }
+    return makeProto({
+      requests,
+      annotations: this.annotations
+    });
+  },
+  toHandlersContext(build) {
+    return Effect.gen(this, function* () {
+      const context = yield* Effect.context();
+      const handlers = Effect.isEffect(build) ? yield* build : build;
+      const contextMap = new Map();
+      for (const [tag, handler] of Object.entries(handlers)) {
+        const rpc = this.requests.get(tag);
+        contextMap.set(rpc.key, {
+          handler,
+          context
+        });
+      }
+      return Context.unsafeMake(contextMap);
+    });
+  },
+  toLayer(build) {
+    return Layer.scopedContext(this.toHandlersContext(build));
+  },
+  annotate(tag, value) {
+    return makeProto({
+      requests: this.requests,
+      annotations: Context.add(this.annotations, tag, value)
+    });
+  },
+  annotateContext(context) {
+    return makeProto({
+      requests: this.requests,
+      annotations: Context.merge(this.annotations, context)
+    });
+  }
+};
+const makeProto = options => Object.assign(function () {}, RpcGroupProto, {
+  requests: options.requests,
+  annotations: options.annotations
+});
+const resolveInput = (...rpcs) => {
+  const requests = new Map();
+  for (const rpc of rpcs) {
+    requests.set(rpc._tag, Schema.isSchema(rpc) ? Rpc.fromTaggedRequest(rpc) : rpc);
+  }
+  return requests;
+};
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+const make = (...rpcs) => makeProto({
+  requests: resolveInput(...rpcs),
+  annotations: Context.empty()
+});
+exports.make = make;
+//# sourceMappingURL=RpcGroup.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcGroup.js.map b/dist/cjs/RpcGroup.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..85f7ad0bdb73997bc03a32edc96e8670a74ad663
--- /dev/null
+++ b/dist/cjs/RpcGroup.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcGroup.js","names":["Context","_interopRequireWildcard","require","Effect","Layer","Schema","Rpc","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","TypeId","exports","Symbol","for","RpcGroupProto","add","rpcs","makeProto","requests","resolveInput","values","annotations","merge","that","Map","rpc","_tag","middleware","tag","toHandlersContext","build","gen","context","handlers","isEffect","contextMap","handler","entries","key","unsafeMake","toLayer","scopedContext","annotate","value","annotateContext","options","assign","isSchema","fromTaggedRequest","make","empty"],"sources":["../../src/RpcGroup.ts"],"sourcesContent":[null],"mappings":";;;;;;AAIA,IAAAA,OAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,MAAA,GAAAF,uBAAA,CAAAC,OAAA;AACA,IAAAE,KAAA,GAAAH,uBAAA,CAAAC,OAAA;AAIA,IAAAG,MAAA,GAAAJ,uBAAA,CAAAC,OAAA;AAGA,IAAAI,GAAA,GAAAL,uBAAA,CAAAC,OAAA;AAA+B,SAAAK,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAP,wBAAAO,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAG/B;;;;AAIO,MAAMW,MAAM,GAAAC,OAAA,CAAAD,MAAA,gBAAkBE,MAAM,CAACC,GAAG,CAAC,sBAAsB,CAAC;AAyIvE,MAAMC,aAAa,GAAG;EACpBC,GAAGA,CAAsB,GAAGC,IAAgB;IAC1C,OAAOC,SAAS,CAAC;MACfC,QAAQ,EAAEC,YAAY,CACpB,GAAG,IAAI,CAACD,QAAQ,CAACE,MAAM,EAAE,EACzB,GAAGJ,IAAI,CACR;MACDK,WAAW,EAAE,IAAI,CAACA;KACnB,CAAC;EACJ,CAAC;EACDC,KAAKA,CAAsBC,IAAmB;IAC5C,MAAML,QAAQ,GAAG,IAAIM,GAAG,CAAC,IAAI,CAACN,QAAQ,CAAC;IACvC,KAAK,MAAMO,GAAG,IAAIF,IAAI,CAACL,QAAQ,CAACE,MAAM,EAAE,EAAE;MACxCF,QAAQ,CAACT,GAAG,CAACgB,GAAG,CAACC,IAAI,EAAED,GAAG,CAAC;IAC7B;IACA,OAAOR,SAAS,CAAC;MACfC,QAAQ;MACRG,WAAW,EAAEtC,OAAO,CAACuC,KAAK,CAAC,IAAI,CAACD,WAAW,EAAEE,IAAI,CAACF,WAAW;KAC9D,CAAC;EACJ,CAAC;EACDM,UAAUA,CAAsBA,UAAqC;IACnE,MAAMT,QAAQ,GAAG,IAAIM,GAAG,EAAe;IACvC,KAAK,MAAM,CAACI,GAAG,EAAEH,GAAG,CAAC,IAAI,IAAI,CAACP,QAAQ,EAAE;MACtCA,QAAQ,CAACT,GAAG,CAACmB,GAAG,EAAEH,GAAG,CAACE,UAAU,CAACA,UAAU,CAAC,CAAC;IAC/C;IACA,OAAOV,SAAS,CAAC;MACfC,QAAQ;MACRG,WAAW,EAAE,IAAI,CAACA;KACnB,CAAC;EACJ,CAAC;EACDQ,iBAAiBA,CAAsBC,KAA2D;IAChG,OAAO5C,MAAM,CAAC6C,GAAG,CAAC,IAAI,EAAE,aAAS;MAC/B,MAAMC,OAAO,GAAG,OAAO9C,MAAM,CAAC8C,OAAO,EAAS;MAC9C,MAAMC,QAAQ,GAAG/C,MAAM,CAACgD,QAAQ,CAACJ,KAAK,CAAC,GAAG,OAAOA,KAAK,GAAGA,KAAK;MAC9D,MAAMK,UAAU,GAAG,IAAIX,GAAG,EAAmB;MAC7C,KAAK,MAAM,CAACI,GAAG,EAAEQ,OAAO,CAAC,IAAIlC,MAAM,CAACmC,OAAO,CAACJ,QAAQ,CAAC,EAAE;QACrD,MAAMR,GAAG,GAAG,IAAI,CAACP,QAAQ,CAACpB,GAAG,CAAC8B,GAAG,CAAE;QACnCO,UAAU,CAAC1B,GAAG,CAACgB,GAAG,CAACa,GAAG,EAAE;UACtBF,OAAO;UACPJ;SACD,CAAC;MACJ;MACA,OAAOjD,OAAO,CAACwD,UAAU,CAACJ,UAAU,CAAC;IACvC,CAAC,CAAC;EACJ,CAAC;EACDK,OAAOA,CAAsBV,KAA2D;IACtF,OAAO3C,KAAK,CAACsD,aAAa,CAAC,IAAI,CAACZ,iBAAiB,CAACC,KAAK,CAAC,CAAC;EAC3D,CAAC;EACDY,QAAQA,CAAsBd,GAA0B,EAAEe,KAAU;IAClE,OAAO1B,SAAS,CAAC;MACfC,QAAQ,EAAE,IAAI,CAACA,QAAQ;MACvBG,WAAW,EAAEtC,OAAO,CAACgC,GAAG,CAAC,IAAI,CAACM,WAAW,EAAEO,GAAG,EAAEe,KAAK;KACtD,CAAC;EACJ,CAAC;EACDC,eAAeA,CAAsBZ,OAA6B;IAChE,OAAOf,SAAS,CAAC;MACfC,QAAQ,EAAE,IAAI,CAACA,QAAQ;MACvBG,WAAW,EAAEtC,OAAO,CAACuC,KAAK,CAAC,IAAI,CAACD,WAAW,EAAEW,OAAO;KACrD,CAAC;EACJ;CACD;AAED,MAAMf,SAAS,GAA0B4B,OAGxC,IACC3C,MAAM,CAAC4C,MAAM,CAAC,aAAY,CAAC,EAAEhC,aAAa,EAAE;EAC1CI,QAAQ,EAAE2B,OAAO,CAAC3B,QAAQ;EAC1BG,WAAW,EAAEwB,OAAO,CAACxB;CACtB,CAAQ;AAEX,MAAMF,YAAY,GAAGA,CACnB,GAAGH,IAAU,KACwB;EACrC,MAAME,QAAQ,GAAG,IAAIM,GAAG,EAAwB;EAChD,KAAK,MAAMC,GAAG,IAAIT,IAAI,EAAE;IACtBE,QAAQ,CAACT,GAAG,CAACgB,GAAG,CAACC,IAAI,EAAEtC,MAAM,CAAC2D,QAAQ,CAACtB,GAAG,CAAC,GAAGpC,GAAG,CAAC2D,iBAAiB,CAACvB,GAAU,CAAC,GAAGA,GAAU,CAAC;EAC/F;EACA,OAAOP,QAAQ;AACjB,CAAC;AAED;;;;AAIO,MAAM+B,IAAI,GAAGA,CAClB,GAAGjC,IAAU,KAEbC,SAAS,CAAC;EACRC,QAAQ,EAAEC,YAAY,CAAC,GAAGH,IAAI,CAAC;EAC/BK,WAAW,EAAEtC,OAAO,CAACmE,KAAK;CAC3B,CAAC;AAAAvC,OAAA,CAAAsC,IAAA,GAAAA,IAAA","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcMessage.js b/dist/cjs/RpcMessage.js
new file mode 100644
index 0000000000000000000000000000000000000000..d9c98938d0b38033c0ba6aa50d1d53d738dec7fd
--- /dev/null
+++ b/dist/cjs/RpcMessage.js
@@ -0,0 +1,57 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.constPong = exports.constPing = exports.constEof = exports.ResponseIdTypeId = exports.ResponseDefectEncoded = exports.RequestIdTypeId = exports.RequestId = void 0;
+var Schema = _interopRequireWildcard(require("effect/Schema"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ * @category request
+ */
+const RequestIdTypeId = exports.RequestIdTypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcServer/RequestId");
+/**
+ * @since 1.0.0
+ * @category request
+ */
+const RequestId = id => typeof id === "bigint" ? id : BigInt(id);
+/**
+ * @since 1.0.0
+ * @category request
+ */
+exports.RequestId = RequestId;
+const constEof = exports.constEof = {
+  _tag: "Eof"
+};
+/**
+ * @since 1.0.0
+ * @category request
+ */
+const constPing = exports.constPing = {
+  _tag: "Ping"
+};
+/**
+ * @since 1.0.0
+ * @category response
+ */
+const ResponseIdTypeId = exports.ResponseIdTypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcServer/ResponseId");
+const encodeDefect = /*#__PURE__*/Schema.encodeSync(Schema.Defect);
+/**
+ * @since 1.0.0
+ * @category response
+ */
+const ResponseDefectEncoded = input => ({
+  _tag: "Defect",
+  defect: encodeDefect(input)
+});
+/**
+ * @since 1.0.0
+ * @category response
+ */
+exports.ResponseDefectEncoded = ResponseDefectEncoded;
+const constPong = exports.constPong = {
+  _tag: "Pong"
+};
+//# sourceMappingURL=RpcMessage.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcMessage.js.map b/dist/cjs/RpcMessage.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..e0e0daf2db05cfbb17455b6dfbd07029e35e9b22
--- /dev/null
+++ b/dist/cjs/RpcMessage.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcMessage.js","names":["Schema","_interopRequireWildcard","require","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","RequestIdTypeId","exports","Symbol","for","RequestId","id","BigInt","constEof","_tag","constPing","ResponseIdTypeId","encodeDefect","encodeSync","Defect","ResponseDefectEncoded","input","defect","constPong"],"sources":["../../src/RpcMessage.ts"],"sourcesContent":[null],"mappings":";;;;;;AAOA,IAAAA,MAAA,GAAAC,uBAAA,CAAAC,OAAA;AAAuC,SAAAC,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAH,wBAAAG,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAevC;;;;AAIO,MAAMW,eAAe,GAAAC,OAAA,CAAAD,eAAA,gBAAkBE,MAAM,CAACC,GAAG,CAAC,iCAAiC,CAAC;AAc3F;;;;AAIO,MAAMC,SAAS,GAAIC,EAAmB,IAC3C,OAAOA,EAAE,KAAK,QAAQ,GAAGA,EAAe,GAAGC,MAAM,CAACD,EAAE,CAAc;AA4EpE;;;;AAAAJ,OAAA,CAAAG,SAAA,GAAAA,SAAA;AAIO,MAAMG,QAAQ,GAAAN,OAAA,CAAAM,QAAA,GAAQ;EAAEC,IAAI,EAAE;AAAK,CAAE;AAE5C;;;;AAIO,MAAMC,SAAS,GAAAR,OAAA,CAAAQ,SAAA,GAAS;EAAED,IAAI,EAAE;AAAM,CAAE;AAkB/C;;;;AAIO,MAAME,gBAAgB,GAAAT,OAAA,CAAAS,gBAAA,gBAAkBR,MAAM,CAACC,GAAG,CAAC,kCAAkC,CAAC;AAiE7F,MAAMQ,YAAY,gBAAGlC,MAAM,CAACmC,UAAU,CAACnC,MAAM,CAACoC,MAAM,CAAC;AAErD;;;;AAIO,MAAMC,qBAAqB,GAAIC,KAAc,KAA6B;EAC/EP,IAAI,EAAE,QAAQ;EACdQ,MAAM,EAAEL,YAAY,CAACI,KAAK;CAC3B,CAAC;AA6BF;;;;AAAAd,OAAA,CAAAa,qBAAA,GAAAA,qBAAA;AAIO,MAAMG,SAAS,GAAAhB,OAAA,CAAAgB,SAAA,GAAS;EAAET,IAAI,EAAE;AAAM,CAAE","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcMiddleware.js b/dist/cjs/RpcMiddleware.js
new file mode 100644
index 0000000000000000000000000000000000000000..9f3389fb4d331e702cd620ec46e6d8b77c872206
--- /dev/null
+++ b/dist/cjs/RpcMiddleware.js
@@ -0,0 +1,58 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.layerClient = exports.TypeId = exports.Tag = void 0;
+var Context = _interopRequireWildcard(require("effect/Context"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var Schema = _interopRequireWildcard(require("effect/Schema"));
+var _Scope = require("effect/Scope");
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+const TypeId = exports.TypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcMiddleware");
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+const Tag = () => (id, options) => {
+  const Err = globalThis.Error;
+  const limit = Err.stackTraceLimit;
+  Err.stackTraceLimit = 2;
+  const creationError = new Err();
+  Err.stackTraceLimit = limit;
+  function TagClass() {}
+  const TagClass_ = TagClass;
+  Object.setPrototypeOf(TagClass, Object.getPrototypeOf(Context.GenericTag(id)));
+  TagClass.key = id;
+  Object.defineProperty(TagClass, "stack", {
+    get() {
+      return creationError.stack;
+    }
+  });
+  TagClass_[TypeId] = TypeId;
+  TagClass_.failure = options?.optional === true || options?.failure === undefined ? Schema.Never : options.failure;
+  if (options?.provides) {
+    TagClass_.provides = options.provides;
+  }
+  TagClass_.optional = options?.optional ?? false;
+  TagClass_.requiredForClient = options?.requiredForClient ?? false;
+  return TagClass;
+};
+/**
+ * @since 1.0.0
+ * @category client
+ */
+exports.Tag = Tag;
+const layerClient = (tag, service) => Layer.scopedContext(Effect.gen(function* () {
+  const context = (yield* Effect.context()).pipe(Context.omit(_Scope.Scope));
+  const middleware = Effect.isEffect(service) ? yield* service : service;
+  return Context.unsafeMake(new Map([[`${tag.key}/Client`, options => Effect.mapInputContext(middleware(options), requestContext => Context.merge(context, requestContext))]]));
+}));
+exports.layerClient = layerClient;
+//# sourceMappingURL=RpcMiddleware.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcMiddleware.js.map b/dist/cjs/RpcMiddleware.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..25e0fe23c09fcebca549940b5a95b5c8b5a29f8f
--- /dev/null
+++ b/dist/cjs/RpcMiddleware.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcMiddleware.js","names":["Context","_interopRequireWildcard","require","Effect","Layer","Schema","_Scope","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","TypeId","exports","Symbol","for","Tag","id","options","Err","globalThis","Error","limit","stackTraceLimit","creationError","TagClass","TagClass_","setPrototypeOf","getPrototypeOf","GenericTag","key","stack","failure","optional","undefined","Never","provides","requiredForClient","layerClient","tag","service","scopedContext","gen","context","pipe","omit","Scope","middleware","isEffect","unsafeMake","Map","mapInputContext","requestContext","merge"],"sources":["../../src/RpcMiddleware.ts"],"sourcesContent":[null],"mappings":";;;;;;AAIA,IAAAA,OAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,MAAA,GAAAF,uBAAA,CAAAC,OAAA;AACA,IAAAE,KAAA,GAAAH,uBAAA,CAAAC,OAAA;AACA,IAAAG,MAAA,GAAAJ,uBAAA,CAAAC,OAAA;AACA,IAAAI,MAAA,GAAAJ,OAAA;AAAoC,SAAAK,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAP,wBAAAO,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAKpC;;;;AAIO,MAAMW,MAAM,GAAAC,OAAA,CAAAD,MAAA,gBAAkBE,MAAM,CAACC,GAAG,CAAC,2BAA2B,CAAC;AA8K5E;;;;AAIO,MAAMC,GAAG,GAAGA,CAAA,KAYnB,CACEC,EAAU,EACVC,OAKC,KACC;EACF,MAAMC,GAAG,GAAGC,UAAU,CAACC,KAAY;EACnC,MAAMC,KAAK,GAAGH,GAAG,CAACI,eAAe;EACjCJ,GAAG,CAACI,eAAe,GAAG,CAAC;EACvB,MAAMC,aAAa,GAAG,IAAIL,GAAG,EAAE;EAC/BA,GAAG,CAACI,eAAe,GAAGD,KAAK;EAE3B,SAASG,QAAQA,CAAA,GAAI;EACrB,MAAMC,SAAS,GAAGD,QAAuC;EACzDrB,MAAM,CAACuB,cAAc,CAACF,QAAQ,EAAErB,MAAM,CAACwB,cAAc,CAAC3C,OAAO,CAAC4C,UAAU,CAAYZ,EAAE,CAAC,CAAC,CAAC;EACzFQ,QAAQ,CAACK,GAAG,GAAGb,EAAE;EACjBb,MAAM,CAACC,cAAc,CAACoB,QAAQ,EAAE,OAAO,EAAE;IACvCzB,GAAGA,CAAA;MACD,OAAOwB,aAAa,CAACO,KAAK;IAC5B;GACD,CAAC;EACFL,SAAS,CAACd,MAAM,CAAC,GAAGA,MAAM;EAC1Bc,SAAS,CAACM,OAAO,GAAGd,OAAO,EAAEe,QAAQ,KAAK,IAAI,IAAIf,OAAO,EAAEc,OAAO,KAAKE,SAAS,GAAG5C,MAAM,CAAC6C,KAAK,GAAGjB,OAAO,CAACc,OAAO;EACjH,IAAId,OAAO,EAAEkB,QAAQ,EAAE;IACrBV,SAAS,CAACU,QAAQ,GAAGlB,OAAO,CAACkB,QAAQ;EACvC;EACAV,SAAS,CAACO,QAAQ,GAAGf,OAAO,EAAEe,QAAQ,IAAI,KAAK;EAC/CP,SAAS,CAACW,iBAAiB,GAAGnB,OAAO,EAAEmB,iBAAiB,IAAI,KAAK;EACjE,OAAOZ,QAAe;AACxB,CAAC;AAED;;;;AAAAZ,OAAA,CAAAG,GAAA,GAAAA,GAAA;AAIO,MAAMsB,WAAW,GAAGA,CACzBC,GAAuB,EACvBC,OAA+E,KAE/EnD,KAAK,CAACoD,aAAa,CAACrD,MAAM,CAACsD,GAAG,CAAC,aAAS;EACtC,MAAMC,OAAO,GAAG,CAAC,OAAOvD,MAAM,CAACuD,OAAO,EAAa,EAAEC,IAAI,CACvD3D,OAAO,CAAC4D,IAAI,CAACC,YAAK,CAAC,CACE;EACvB,MAAMC,UAAU,GAAG3D,MAAM,CAAC4D,QAAQ,CAACR,OAAO,CAAC,GAAG,OAAOA,OAAO,GAAGA,OAAO;EACtE,OAAOvD,OAAO,CAACgE,UAAU,CACvB,IAAIC,GAAG,CAAC,CAAC,CACP,GAAGX,GAAG,CAACT,GAAG,SAAS,EAClBZ,OAAY,IACX9B,MAAM,CAAC+D,eAAe,CACpBJ,UAAU,CAAC7B,OAAO,CAAC,EAClBkC,cAAc,IAAKnE,OAAO,CAACoE,KAAK,CAACV,OAAO,EAAES,cAAc,CAAC,CAC3D,CACJ,CAAC,CAAC,CACJ;AACH,CAAC,CAAC,CAAC;AAAAvC,OAAA,CAAAyB,WAAA,GAAAA,WAAA","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcResolverNoStream.js b/dist/cjs/RpcResolverNoStream.js
index f2beeb9cc0ff7a56c1f29d605cd6fde5fa9ca4ed..04fb4c154aa55d92e9ae9d43e80ecdf94cf9d93b 100644
--- a/dist/cjs/RpcResolverNoStream.js
+++ b/dist/cjs/RpcResolverNoStream.js
@@ -26,7 +26,7 @@ const make = handler => () => {
   return RequestResolver.makeBatched(requests => (0, _Function.pipe)(Effect.forEach(requests, _ => Effect.map(Schema.serialize(_.request), request => ({
     ..._,
     request
-  }))), Effect.flatMap(handler), Effect.filterOrDieMessage(_ => Array.isArray(_) && _.length === requests.length, "@effect/rpc: handler must return an array of responses with the same length as the requests."), Effect.flatMap(Effect.forEach((response, index) => {
+  }))), Effect.flatMap(handler), Effect.filterOrElse(_ => Array.isArray(_) && _.length === requests.length, _ => Effect.dieMessage("@effect/rpc: handler must return an array of responses with the same length as the requests. Got: " + JSON.stringify(_))), Effect.flatMap(Effect.forEach((response, index) => {
     const request = requests[index];
     if (_rpc.StreamRequestTypeId in request.request) {
       return (0, _Function.pipe)(getDecodeChunk(request.request)(response), Effect.orDie, Effect.matchCauseEffect({
diff --git a/dist/cjs/RpcResolverNoStream.js.map b/dist/cjs/RpcResolverNoStream.js.map
index 3af703619193927c4d3aa338d33542b31833842d..d99e49b05214a1a9f04e92d8cde907a0b65f3118 100644
--- a/dist/cjs/RpcResolverNoStream.js.map
+++ b/dist/cjs/RpcResolverNoStream.js.map
@@ -1 +1 @@
-{"version":3,"file":"RpcResolverNoStream.js","names":["Channel","_interopRequireWildcard","require","Chunk","Effect","Exit","_Function","Request","RequestResolver","Schema","Stream","_rpc","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","make","handler","getDecode","withRequestTag","req","decodeUnknown","exitSchema","getDecodeChunk","makeBatched","requests","pipe","forEach","_","map","serialize","request","flatMap","filterOrDieMessage","Array","isArray","length","response","index","StreamRequestTypeId","orDie","matchCauseEffect","onFailure","cause","succeed","failCause","onSuccess","chunk","lastExit","unsafeLast","channel","match","zipRight","write","dropRight","exit","value","fromChannel","complete","discard","catchAllCause","exports"],"sources":["../../src/RpcResolverNoStream.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"RpcResolverNoStream.js","names":["Channel","_interopRequireWildcard","require","Chunk","Effect","Exit","_Function","Request","RequestResolver","Schema","Stream","_rpc","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","make","handler","getDecode","withRequestTag","req","decodeUnknown","exitSchema","getDecodeChunk","makeBatched","requests","pipe","forEach","_","map","serialize","request","flatMap","filterOrElse","Array","isArray","length","dieMessage","JSON","stringify","response","index","StreamRequestTypeId","orDie","matchCauseEffect","onFailure","cause","succeed","failCause","onSuccess","chunk","lastExit","unsafeLast","channel","match","zipRight","write","dropRight","exit","value","fromChannel","complete","discard","catchAllCause","exports"],"sources":["../../src/RpcResolverNoStream.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcRouter.js.map b/dist/cjs/RpcRouter.js.map
index 42316e07533b11c2c6b3099c4dec6b1d5e7069e7..d549bf1babe79c42aeb7b9351562c160af56ae42 100644
--- a/dist/cjs/RpcRouter.js.map
+++ b/dist/cjs/RpcRouter.js.map
@@ -1 +1 @@
-{"version":3,"file":"RpcRouter.js","names":["Cause","_interopRequireWildcard","require","Channel","Chunk","Context","Effect","Exit","_Function","Mailbox","_Pipeable","Predicate","Schema","Stream","_rpc","Rpc","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","TypeId","exports","Symbol","for","isRpcRouter","hasProperty","fromSet","rpcs","pipe","pipeArguments","arguments","make","rpcSet","Set","forEach","rpc","add","provideServiceEffect","dual","self","tag","effect","map","provideService","service","emptyExit","encodeSync","failure","Never","success","defect","Defect","failCause","empty","toHandler","args","router","options","spanPrefix","schema","Union","transform","Tuple","typeSchema","Any","strict","decode","request","encode","schemaArray","Array","RequestSchema","decodeUnknown","getEncode","withRequestTag","req","exitSchema","getEncodeChunk","zip","tap","requests","mailbox","index","_tag","exit","handler","flatMap","orDie","matchCauseEffect","onSuccess","response","offer","onFailure","cause","locally","currentHeaders","headers","withSpan","kind","parent","traceId","spanId","sampled","context","captureStackTrace","toChannel","mapOutEffect","chunk","succeed","runDrain","of","concurrency","discard","ensuring","end","forkScoped","_","toStream","unwrapScoped","toHandlerNoStream","catchAllCause","runCollect","toHandlerRaw","parse","isStream","StreamRequestTypeId","withHandler","unwrap","toHandlerUndecoded","successSchema","ChunkFromSelf","result","isEffect","mapChunksEffect"],"sources":["../../src/RpcRouter.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"RpcRouter.js","names":["Cause","_interopRequireWildcard","require","Channel","Chunk","Context","Effect","Exit","_Function","Mailbox","_Pipeable","Predicate","Schema","Stream","_rpc","Rpc","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","TypeId","exports","Symbol","for","isRpcRouter","hasProperty","fromSet","rpcs","pipe","pipeArguments","arguments","make","rpcSet","Set","forEach","rpc","add","provideServiceEffect","dual","self","tag","effect","map","provideService","service","emptyExit","encodeSync","failure","Never","success","defect","Defect","failCause","empty","toHandler","args","router","options","spanPrefix","schema","Union","transform","Tuple","typeSchema","Any","strict","decode","request","encode","schemaArray","Array","RequestSchema","decodeUnknown","getEncode","withRequestTag","req","exitSchema","getEncodeChunk","zip","tap","requests","mailbox","index","_tag","exit","handler","flatMap","orDie","matchCauseEffect","onSuccess","response","offer","onFailure","cause","locally","currentHeaders","headers","withSpan","kind","parent","traceId","spanId","sampled","context","captureStackTrace","toChannel","mapOutEffect","chunk","succeed","runDrain","of","concurrency","discard","ensuring","end","forkScoped","_","toStream","unwrapScoped","toHandlerNoStream","catchAllCause","runCollect","toHandlerRaw","parse","isStream","StreamRequestTypeId","withHandler","unwrap","toHandlerUndecoded","successSchema","ChunkFromSelf","result","isEffect","mapChunksEffect"],"sources":["../../src/RpcRouter.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcSchema.js b/dist/cjs/RpcSchema.js
new file mode 100644
index 0000000000000000000000000000000000000000..9801cf4e14cbcb19aaceab10fe3bee969cd4501b
--- /dev/null
+++ b/dist/cjs/RpcSchema.js
@@ -0,0 +1,71 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.isStreamSerializable = exports.isStreamSchema = exports.getStreamSchemas = exports.StreamSchemaId = exports.Stream = void 0;
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Option = _interopRequireWildcard(require("effect/Option"));
+var ParseResult = _interopRequireWildcard(require("effect/ParseResult"));
+var _Predicate = require("effect/Predicate");
+var Schema = _interopRequireWildcard(require("effect/Schema"));
+var AST = _interopRequireWildcard(require("effect/SchemaAST"));
+var Stream_ = _interopRequireWildcard(require("effect/Stream"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+const StreamSchemaId = exports.StreamSchemaId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcSchema/Stream");
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+const isStreamSchema = schema => schema.ast.annotations[AST.SchemaIdAnnotationId] === StreamSchemaId;
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+exports.isStreamSchema = isStreamSchema;
+const isStreamSerializable = schema => isStreamSchema(Schema.successSchema(schema));
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+exports.isStreamSerializable = isStreamSerializable;
+const getStreamSchemas = ast => ast.annotations[StreamSchemaId] ? Option.some(ast.annotations[StreamSchemaId]) : Option.none();
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+exports.getStreamSchemas = getStreamSchemas;
+const Stream = ({
+  failure,
+  success
+}) => Object.assign(Schema.declare([success, failure], {
+  decode: (success, failure) => parseStream(ParseResult.decodeUnknown(Schema.ChunkFromSelf(success)), ParseResult.decodeUnknown(failure)),
+  encode: (success, failure) => parseStream(ParseResult.encodeUnknown(Schema.ChunkFromSelf(success)), ParseResult.encodeUnknown(failure))
+}, {
+  schemaId: StreamSchemaId,
+  [StreamSchemaId]: {
+    success,
+    failure
+  }
+}), {
+  success,
+  failure
+});
+exports.Stream = Stream;
+const isStream = u => (0, _Predicate.hasProperty)(u, Stream_.StreamTypeId);
+const parseStream = (decodeSuccess, decodeFailure) => (u, options, ast) => Effect.flatMap(Effect.context(), context => {
+  if (!isStream(u)) return Effect.fail(new ParseResult.Type(ast, u));
+  return Effect.succeed(u.pipe(Stream_.mapChunksEffect(value => decodeSuccess(value, options)), Stream_.catchAll(error => {
+    if (ParseResult.isParseError(error)) return Stream_.die(error);
+    return Effect.matchEffect(decodeFailure(error, options), {
+      onFailure: Effect.die,
+      onSuccess: Effect.fail
+    });
+  }), Stream_.provideContext(context)));
+});
+//# sourceMappingURL=RpcSchema.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcSchema.js.map b/dist/cjs/RpcSchema.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..10bdbfa50588859b8f8857d31456113671c6dbad
--- /dev/null
+++ b/dist/cjs/RpcSchema.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcSchema.js","names":["Effect","_interopRequireWildcard","require","Option","ParseResult","_Predicate","Schema","AST","Stream_","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","StreamSchemaId","exports","Symbol","for","isStreamSchema","schema","ast","annotations","SchemaIdAnnotationId","isStreamSerializable","successSchema","getStreamSchemas","some","none","Stream","failure","success","assign","declare","decode","parseStream","decodeUnknown","ChunkFromSelf","encode","encodeUnknown","schemaId","isStream","hasProperty","StreamTypeId","decodeSuccess","decodeFailure","options","flatMap","context","fail","Type","succeed","pipe","mapChunksEffect","value","catchAll","error","isParseError","die","matchEffect","onFailure","onSuccess","provideContext"],"sources":["../../src/RpcSchema.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcSerialization.js b/dist/cjs/RpcSerialization.js
new file mode 100644
index 0000000000000000000000000000000000000000..6ae0602b92d7246a4ed4073230aa01598ce86a35
--- /dev/null
+++ b/dist/cjs/RpcSerialization.js
@@ -0,0 +1,116 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.ndjson = exports.msgPack = exports.layerNdjson = exports.layerMsgPack = exports.layerJson = exports.json = exports.RpcSerialization = void 0;
+var _MsgPack = require("@effect/platform/MsgPack");
+var Context = _interopRequireWildcard(require("effect/Context"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+class RpcSerialization extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcSerialization")() {}
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+exports.RpcSerialization = RpcSerialization;
+const json = exports.json = /*#__PURE__*/Effect.sync(() => {
+  const decoder = new TextDecoder();
+  return RpcSerialization.of({
+    contentType: "application/json",
+    supportsBigInt: false,
+    unsafeMake: () => ({
+      decode: bytes => [JSON.parse(typeof bytes === "string" ? bytes : decoder.decode(bytes))],
+      encode: response => JSON.stringify(response)
+    })
+  });
+});
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+const ndjson = exports.ndjson = /*#__PURE__*/Effect.sync(() => {
+  const decoder = new TextDecoder();
+  return RpcSerialization.of({
+    contentType: "application/ndjson",
+    supportsBigInt: false,
+    unsafeMake: () => {
+      let buffer = "";
+      return {
+        decode: bytes => {
+          buffer += typeof bytes === "string" ? bytes : decoder.decode(bytes);
+          let position = 0;
+          let nlIndex = buffer.indexOf("\n", position);
+          const items = [];
+          while (nlIndex !== -1) {
+            const item = JSON.parse(buffer.slice(position, nlIndex));
+            items.push(item);
+            position = nlIndex + 1;
+            nlIndex = buffer.indexOf("\n", position);
+          }
+          buffer = buffer.slice(position);
+          return items;
+        },
+        encode: response => JSON.stringify(response) + "\n"
+      };
+    }
+  });
+});
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+const msgPack = exports.msgPack = /*#__PURE__*/RpcSerialization.of({
+  contentType: "application/msgpack",
+  supportsBigInt: true,
+  unsafeMake: () => {
+    const unpackr = new _MsgPack.Msgpackr.Unpackr();
+    const packr = new _MsgPack.Msgpackr.Packr();
+    const encoder = new TextEncoder();
+    return {
+      decode: bytes => unpackr.unpackMultiple(typeof bytes === "string" ? encoder.encode(bytes) : bytes),
+      encode: response => packr.pack(response)
+    };
+  }
+});
+/**
+ * A rpc serialization layer that uses JSON for serialization.
+ *
+ * Use this if your protocol supports framing for messages, otherwise use
+ * `layerSerializationNdjson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+const layerJson = exports.layerJson = /*#__PURE__*/Layer.effect(RpcSerialization, json);
+/**
+ * A rpc serialization layer that uses NDJSON for serialization.
+ *
+ * Use this if your protocol does not support framing for messages, otherwise
+ * use `layerSerializationJson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+const layerNdjson = exports.layerNdjson = /*#__PURE__*/Layer.effect(RpcSerialization, ndjson);
+/**
+ * A rpc serialization layer that uses MessagePack for serialization.
+ *
+ * MessagePack has a more compact binary format compared to JSON and NDJSON. It
+ * also has better support for binary data.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+const layerMsgPack = exports.layerMsgPack = /*#__PURE__*/Layer.succeed(RpcSerialization, msgPack);
+//# sourceMappingURL=RpcSerialization.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcSerialization.js.map b/dist/cjs/RpcSerialization.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..1edffd6eccaedd44e261dbb1af5797ffae0e486f
--- /dev/null
+++ b/dist/cjs/RpcSerialization.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcSerialization.js","names":["_MsgPack","require","Context","_interopRequireWildcard","Effect","Layer","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","RpcSerialization","Tag","exports","json","sync","decoder","TextDecoder","of","contentType","supportsBigInt","unsafeMake","decode","bytes","JSON","parse","encode","response","stringify","ndjson","buffer","position","nlIndex","indexOf","items","item","slice","push","msgPack","unpackr","Msgpackr","Unpackr","packr","Packr","encoder","TextEncoder","unpackMultiple","pack","layerJson","effect","layerNdjson","layerMsgPack","succeed"],"sources":["../../src/RpcSerialization.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcServer.js b/dist/cjs/RpcServer.js
new file mode 100644
index 0000000000000000000000000000000000000000..7562179c4ef7d19e9977187eb607f7f10ee13597
--- /dev/null
+++ b/dist/cjs/RpcServer.js
@@ -0,0 +1,855 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.toWebHandler = exports.toHttpAppWebsocket = exports.toHttpApp = exports.makeProtocolWorkerRunner = exports.makeProtocolWithHttpAppWebsocket = exports.makeProtocolWithHttpApp = exports.makeProtocolWebsocket = exports.makeProtocolSocketServer = exports.makeProtocolHttp = exports.makeNoSerialization = exports.make = exports.layerProtocolWorkerRunner = exports.layerProtocolWebsocket = exports.layerProtocolSocketServer = exports.layerProtocolHttp = exports.layer = exports.Protocol = void 0;
+var Headers = _interopRequireWildcard(require("@effect/platform/Headers"));
+var HttpApp = _interopRequireWildcard(require("@effect/platform/HttpApp"));
+var HttpRouter = _interopRequireWildcard(require("@effect/platform/HttpRouter"));
+var HttpServerRequest = _interopRequireWildcard(require("@effect/platform/HttpServerRequest"));
+var HttpServerResponse = _interopRequireWildcard(require("@effect/platform/HttpServerResponse"));
+var SocketServer = _interopRequireWildcard(require("@effect/platform/SocketServer"));
+var Transferable = _interopRequireWildcard(require("@effect/platform/Transferable"));
+var WorkerRunner = _interopRequireWildcard(require("@effect/platform/WorkerRunner"));
+var Arr = _interopRequireWildcard(require("effect/Array"));
+var Cause = _interopRequireWildcard(require("effect/Cause"));
+var Chunk = _interopRequireWildcard(require("effect/Chunk"));
+var Context = _interopRequireWildcard(require("effect/Context"));
+var Deferred = _interopRequireWildcard(require("effect/Deferred"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Exit = _interopRequireWildcard(require("effect/Exit"));
+var Fiber = _interopRequireWildcard(require("effect/Fiber"));
+var FiberId = _interopRequireWildcard(require("effect/FiberId"));
+var FiberRef = _interopRequireWildcard(require("effect/FiberRef"));
+var FiberSet = _interopRequireWildcard(require("effect/FiberSet"));
+var _Function = require("effect/Function");
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var Mailbox = _interopRequireWildcard(require("effect/Mailbox"));
+var ManagedRuntime = _interopRequireWildcard(require("effect/ManagedRuntime"));
+var Option = _interopRequireWildcard(require("effect/Option"));
+var _ParseResult = require("effect/ParseResult");
+var Predicate = _interopRequireWildcard(require("effect/Predicate"));
+var Schema = _interopRequireWildcard(require("effect/Schema"));
+var Scope = _interopRequireWildcard(require("effect/Scope"));
+var Stream = _interopRequireWildcard(require("effect/Stream"));
+var _utils = require("./internal/utils.js");
+var Rpc = _interopRequireWildcard(require("./Rpc.js"));
+var _RpcMessage = require("./RpcMessage.js");
+var RpcSchema = _interopRequireWildcard(require("./RpcSchema.js"));
+var RpcSerialization = _interopRequireWildcard(require("./RpcSerialization.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category server
+ */
+const makeNoSerialization = exports.makeNoSerialization = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const tracingEnabled = options.disableSpanPropagation !== true;
+  const supportsAck = options.disableClientAcks !== true;
+  const spanPrefix = options.spanPrefix ?? "RpcServer";
+  const concurrency = options.concurrency ?? "unbounded";
+  const context = yield* Effect.context();
+  const scope = Context.get(context, Scope.Scope);
+  const fiberSet = yield* FiberSet.make();
+  const runFork = yield* FiberSet.runtime(fiberSet)().pipe(Effect.interruptible);
+  const concurrencySemaphore = concurrency === "unbounded" ? undefined : yield* Effect.makeSemaphore(concurrency);
+  const clients = new Map();
+  let isShutdown = false;
+  const shutdownLatch = Effect.unsafeMakeLatch(false);
+  yield* Scope.addFinalizer(scope, Effect.fiberIdWith(fiberId => {
+    isShutdown = true;
+    for (const client of clients.values()) {
+      client.ended = true;
+      if (client.fibers.size === 0) {
+        runFork(endClient(client));
+        continue;
+      }
+      for (const fiber of client.fibers.values()) {
+        fiber.unsafeInterruptAsFork(fiberId);
+      }
+    }
+    if (clients.size === 0) {
+      return Effect.void;
+    }
+    return shutdownLatch.await;
+  }));
+  const disconnect = clientId => Effect.fiberIdWith(fiberId => {
+    const client = clients.get(clientId);
+    if (!client) return Effect.void;
+    for (const fiber of client.fibers.values()) {
+      fiber.unsafeInterruptAsFork(fiberId);
+    }
+    clients.delete(clientId);
+    return Effect.void;
+  });
+  const write = (clientId, message) => Effect.catchAllDefect(Effect.suspend(() => {
+    if (isShutdown) return Effect.interrupt;
+    let client = clients.get(clientId);
+    if (!client) {
+      client = {
+        id: clientId,
+        latches: new Map(),
+        fibers: new Map(),
+        ended: false
+      };
+      clients.set(clientId, client);
+    } else if (client.ended) {
+      return Effect.interrupt;
+    }
+    switch (message._tag) {
+      case "Request":
+        {
+          return handleRequest(client, message);
+        }
+      case "Ack":
+        {
+          const latch = client.latches.get(message.requestId);
+          return latch ? latch.open : Effect.void;
+        }
+      case "Interrupt":
+        {
+          const fiber = client.fibers.get(message.requestId);
+          return fiber ? Fiber.interruptFork(fiber) : options.onFromServer({
+            _tag: "Exit",
+            clientId,
+            requestId: message.requestId,
+            exit: Exit.interrupt(FiberId.none)
+          });
+        }
+      case "Eof":
+        {
+          client.ended = true;
+          if (client.fibers.size > 0) return Effect.void;
+          return endClient(client);
+        }
+      default:
+        {
+          return sendDefect(client, `Unknown request tag: ${message._tag}`);
+        }
+    }
+  }), defect => sendDefect(clients.get(clientId), defect));
+  const endClient = client => {
+    clients.delete(client.id);
+    const write = options.onFromServer({
+      _tag: "ClientEnd",
+      clientId: client.id
+    });
+    if (isShutdown && clients.size === 0) {
+      return Effect.zipRight(write, shutdownLatch.open);
+    }
+    return write;
+  };
+  const handleRequest = (client, request) => {
+    if (client.fibers.has(request.id)) {
+      return Effect.interrupt;
+    }
+    const rpc = group.requests.get(request.tag);
+    const entry = context.unsafeMap.get(rpc?.key);
+    if (!rpc || !entry) {
+      const write = Effect.catchAllDefect(options.onFromServer({
+        _tag: "Exit",
+        clientId: client.id,
+        requestId: request.id,
+        exit: Exit.die(`Unknown request tag: ${request.tag}`)
+      }), defect => sendDefect(client, defect));
+      if (!client.ended || client.fibers.size > 0) return write;
+      return Effect.zipRight(write, endClient(client));
+    }
+    const isStream = RpcSchema.isStreamSchema(rpc.successSchema);
+    const result = entry.handler(request.payload, request.headers);
+    // if the handler requested forking, then we skip the concurrency control
+    const isFork = Rpc.isFork(result);
+    // unwrap the fork data type
+    const streamOrEffect = isFork ? result.value : result;
+    let responded = false;
+    let effect = Effect.uninterruptible(Effect.matchCauseEffect(Effect.interruptible(applyMiddleware(rpc, context, request.payload, request.headers, isStream ? streamEffect(client, request, streamOrEffect) : streamOrEffect)), {
+      onSuccess: value => {
+        responded = true;
+        return options.onFromServer({
+          _tag: "Exit",
+          clientId: client.id,
+          requestId: request.id,
+          exit: Exit.succeed(value)
+        });
+      },
+      onFailure: cause => {
+        responded = true;
+        return options.onFromServer({
+          _tag: "Exit",
+          clientId: client.id,
+          requestId: request.id,
+          exit: Exit.failCause(cause)
+        });
+      }
+    }));
+    if (tracingEnabled) {
+      effect = Effect.withSpan(effect, `${spanPrefix}.${request.tag}`, {
+        captureStackTrace: false,
+        parent: {
+          _tag: "ExternalSpan",
+          traceId: request.traceId,
+          spanId: request.spanId,
+          sampled: request.sampled,
+          context: Context.empty()
+        }
+      });
+    }
+    effect = Effect.locally(effect, FiberRef.currentContext, entry.context);
+    if (!isFork && concurrencySemaphore) {
+      effect = concurrencySemaphore.withPermits(1)(effect);
+    }
+    const fiber = runFork(effect);
+    client.fibers.set(request.id, fiber);
+    fiber.addObserver(exit => {
+      if (!responded && exit._tag === "Failure") {
+        runFork(options.onFromServer({
+          _tag: "Exit",
+          clientId: client.id,
+          requestId: request.id,
+          exit: Exit.interrupt(FiberId.none)
+        }));
+      }
+      client.fibers.delete(request.id);
+      client.latches.delete(request.id);
+      if (client.ended && client.fibers.size === 0) {
+        runFork(endClient(client));
+      }
+    });
+    return Effect.void;
+  };
+  const streamEffect = (client, request, stream) => {
+    let latch = client.latches.get(request.id);
+    if (supportsAck && !latch) {
+      latch = Effect.unsafeMakeLatch(false);
+      client.latches.set(request.id, latch);
+    }
+    if (Effect.isEffect(stream)) {
+      let done = false;
+      return stream.pipe(Effect.flatMap(mailbox => Effect.whileLoop({
+        while: () => !done,
+        body: (0, _Function.constant)(Effect.flatMap(mailbox.takeAll, ([chunk, done_]) => {
+          done = done_;
+          if (!Chunk.isNonEmpty(chunk)) return Effect.void;
+          const write = options.onFromServer({
+            _tag: "Chunk",
+            clientId: client.id,
+            requestId: request.id,
+            values: Chunk.toReadonlyArray(chunk)
+          });
+          if (!latch) return write;
+          latch.unsafeClose();
+          return Effect.zipRight(write, latch.await);
+        })),
+        step: _Function.constVoid
+      })), Effect.scoped);
+    }
+    return Stream.runForEachChunk(stream, chunk => {
+      if (!Chunk.isNonEmpty(chunk)) return Effect.void;
+      const write = options.onFromServer({
+        _tag: "Chunk",
+        clientId: client.id,
+        requestId: request.id,
+        values: Chunk.toReadonlyArray(chunk)
+      });
+      if (!latch) return write;
+      latch.unsafeClose();
+      return Effect.zipRight(write, latch.await);
+    });
+  };
+  const sendDefect = (client, defect) => Effect.suspend(() => {
+    const shouldEnd = client.ended && client.fibers.size === 0;
+    const write = options.onFromServer({
+      _tag: "Defect",
+      clientId: client.id,
+      defect
+    });
+    if (!shouldEnd) return write;
+    return Effect.zipRight(write, endClient(client));
+  });
+  return (0, _Function.identity)({
+    write,
+    disconnect
+  });
+});
+const applyMiddleware = (rpc, context, payload, headers, handler) => {
+  if (rpc.middlewares.size === 0) {
+    return handler;
+  }
+  const options = {
+    rpc,
+    payload,
+    headers
+  };
+  for (const tag of rpc.middlewares) {
+    const middleware = Context.unsafeGet(context, tag);
+    if (tag.optional) {
+      const previous = handler;
+      handler = Effect.matchEffect(middleware(options), {
+        onFailure: () => previous,
+        onSuccess: tag.provides !== undefined ? value => Effect.provideService(previous, tag.provides, value) : _ => previous
+      });
+    } else {
+      handler = tag.provides !== undefined ? Effect.provideServiceEffect(handler, tag.provides, middleware(options)) : Effect.zipRight(middleware(options), handler);
+    }
+  }
+  return handler;
+};
+/**
+ * @since 1.0.0
+ * @category server
+ */
+const make = exports.make = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const {
+    disconnects,
+    end,
+    run,
+    send,
+    supportsAck,
+    supportsTransferables
+  } = yield* Protocol;
+  const context = yield* Effect.context();
+  const scope = yield* Scope.make();
+  const server = yield* makeNoSerialization(group, {
+    ...options,
+    disableClientAcks: !supportsAck,
+    onFromServer(response) {
+      const client = clients.get(response.clientId);
+      if (!client) return Effect.void;
+      switch (response._tag) {
+        case "Chunk":
+          {
+            const schemas = client.schemas.get(response.requestId);
+            if (!schemas) return Effect.void;
+            return handleEncode(client, response.requestId, schemas.collector, Effect.locally(schemas.encodeChunk(response.values), FiberRef.currentContext, schemas.context), values => ({
+              _tag: "Chunk",
+              requestId: response.requestId,
+              values
+            }));
+          }
+        case "Exit":
+          {
+            const schemas = client.schemas.get(response.requestId);
+            if (!schemas) return Effect.void;
+            client.schemas.delete(response.requestId);
+            return handleEncode(client, response.requestId, schemas.collector, Effect.locally(schemas.encodeExit(response.exit), FiberRef.currentContext, schemas.context), exit => ({
+              _tag: "Exit",
+              requestId: response.requestId,
+              exit
+            }));
+          }
+        case "Defect":
+          {
+            return sendDefect(client, response.defect);
+          }
+        case "ClientEnd":
+          {
+            clients.delete(response.clientId);
+            return end(response.clientId);
+          }
+      }
+    }
+  }).pipe(Scope.extend(scope));
+  // handle disconnects
+  yield* Effect.fork(Effect.interruptible(Effect.whileLoop({
+    while: _Function.constTrue,
+    body: (0, _Function.constant)(Effect.flatMap(disconnects.take, clientId => {
+      clients.delete(clientId);
+      return server.disconnect(clientId);
+    })),
+    step: _Function.constVoid
+  })));
+  const schemasCache = new WeakMap();
+  const getSchemas = rpc => {
+    let schemas = schemasCache.get(rpc);
+    if (!schemas) {
+      const entry = context.unsafeMap.get(rpc.key);
+      const streamSchemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast);
+      const failures = new Set([rpc.errorSchema]);
+      if (Option.isSome(streamSchemas)) {
+        failures.add(streamSchemas.value.failure);
+      }
+      for (const middleware of rpc.middlewares) {
+        failures.add(middleware.failure);
+      }
+      schemas = {
+        decode: Schema.decodeUnknown(rpc.payloadSchema),
+        encodeChunk: Schema.encodeUnknown(Schema.Array(Option.isSome(streamSchemas) ? streamSchemas.value.success : Schema.Any)),
+        encodeExit: Schema.encodeUnknown(Rpc.exitSchema(rpc)),
+        context: entry.context
+      };
+      schemasCache.set(rpc, schemas);
+    }
+    return schemas;
+  };
+  const clients = new Map();
+  const handleEncode = (client, requestId, collector, effect, onSuccess) => (collector ? Effect.provideService(effect, Transferable.Collector, collector) : effect).pipe(Effect.flatMap(a => send(client.id, onSuccess(a), collector && collector.unsafeClear())), Effect.catchAllCause(cause => {
+    client.schemas.delete(requestId);
+    const defect = Cause.squash(Cause.map(cause, _ParseResult.ArrayFormatter.formatErrorSync));
+    return Effect.zipRight(server.write(client.id, {
+      _tag: "Interrupt",
+      requestId,
+      interruptors: []
+    }), sendRequestDefect(client, requestId, defect));
+  }));
+  const sendRequestDefect = (client, requestId, defect) => Effect.catchAllCause(send(client.id, {
+    _tag: "Exit",
+    requestId,
+    exit: {
+      _tag: "Failure",
+      cause: {
+        _tag: "Die",
+        defect
+      }
+    }
+  }), cause => sendDefect(client, Cause.squash(cause)));
+  const sendDefect = (client, defect) => Effect.catchAllCause(send(client.id, {
+    _tag: "Defect",
+    defect
+  }), cause => Effect.annotateLogs(Effect.logDebug(cause), {
+    module: "RpcServer",
+    method: "sendDefect"
+  }));
+  // main server loop
+  return yield* run((clientId, request) => {
+    let client = clients.get(clientId);
+    if (!client) {
+      client = {
+        id: clientId,
+        schemas: new Map()
+      };
+      clients.set(clientId, client);
+    }
+    switch (request._tag) {
+      case "Request":
+        {
+          const tag = Predicate.hasProperty(request, "tag") ? request.tag : "";
+          const rpc = group.requests.get(tag);
+          if (!rpc) {
+            return sendDefect(client, `Unknown request tag: ${tag}`);
+          }
+          let requestId;
+          switch (typeof request.id) {
+            case "bigint":
+            case "string":
+              {
+                requestId = (0, _RpcMessage.RequestId)(request.id);
+                break;
+              }
+            default:
+              {
+                return sendDefect(client, `Invalid request id: ${request.id}`);
+              }
+          }
+          const schemas = getSchemas(rpc);
+          return Effect.matchEffect(Effect.locally(schemas.decode(request.payload), FiberRef.currentContext, schemas.context), {
+            onFailure: error => sendRequestDefect(client, requestId, _ParseResult.ArrayFormatter.formatErrorSync(error)),
+            onSuccess: payload => {
+              client.schemas.set(requestId, supportsTransferables ? {
+                ...schemas,
+                collector: Transferable.unsafeMakeCollector()
+              } : schemas);
+              return server.write(clientId, {
+                ...request,
+                id: requestId,
+                payload,
+                headers: Headers.fromInput(request.headers)
+              });
+            }
+          });
+        }
+      case "Ping":
+        {
+          return Effect.catchAllCause(send(client.id, _RpcMessage.constPong), cause => sendDefect(client, Cause.squash(cause)));
+        }
+      case "Ack":
+      case "Eof":
+      case "Interrupt":
+        {
+          if ("requestId" in request && typeof request.requestId === "string") {
+            ;
+            request.requestId = BigInt(request.requestId);
+          }
+          return server.write(clientId, request._tag === "Interrupt" ? {
+            ...request,
+            interruptors: []
+          } : request);
+        }
+      default:
+        {
+          return sendDefect(client, `Unknown request tag: ${request._tag}`);
+        }
+    }
+  }).pipe(Effect.interruptible, Effect.tapErrorCause(cause => Effect.logFatal("BUG: RpcServer protocol crashed", cause)), Effect.onExit(exit => Scope.close(scope, exit)));
+});
+/**
+ * @since 1.0.0
+ * @category server
+ */
+const layer = (group, options) => Layer.scopedDiscard(Effect.forkScoped(Effect.interruptible(make(group, options))));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.layer = layer;
+class Protocol extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcServer/Protocol")() {
+  /**
+   * @since 1.0.0
+   */
+  static make = /*#__PURE__*/(0, _utils.withRun)();
+}
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.Protocol = Protocol;
+const makeProtocolSocketServer = exports.makeProtocolSocketServer = /*#__PURE__*/Effect.gen(function* () {
+  const server = yield* SocketServer.SocketServer;
+  const {
+    onSocket,
+    protocol
+  } = yield* makeSocketProtocol;
+  yield* Effect.forkScoped(Effect.interruptible(server.run(Effect.fnUntraced(onSocket, Effect.scoped))));
+  return protocol;
+});
+/**
+ * A rpc protocol that uses `SocketServer` for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+const layerProtocolSocketServer = exports.layerProtocolSocketServer = /*#__PURE__*/Layer.scoped(Protocol, makeProtocolSocketServer);
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+const makeProtocolWithHttpAppWebsocket = exports.makeProtocolWithHttpAppWebsocket = /*#__PURE__*/Effect.gen(function* () {
+  const {
+    onSocket,
+    protocol
+  } = yield* makeSocketProtocol;
+  const httpApp = Effect.gen(function* () {
+    const request = yield* HttpServerRequest.HttpServerRequest;
+    const socket = yield* Effect.orDie(request.upgrade);
+    yield* onSocket(socket);
+    return HttpServerResponse.empty();
+  });
+  return {
+    protocol,
+    httpApp
+  };
+});
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+const makeProtocolWebsocket = exports.makeProtocolWebsocket = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpAppWebsocket;
+  const router = yield* options.routerTag ?? HttpRouter.Default;
+  yield* router.get(options.path, httpApp);
+  return protocol;
+});
+/**
+ * A rpc protocol that uses websockets for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+const layerProtocolWebsocket = options => {
+  const routerTag = options.routerTag ?? HttpRouter.Default;
+  return Layer.effect(Protocol, makeProtocolWebsocket(options)).pipe(Layer.provide(routerTag.Live));
+};
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+exports.layerProtocolWebsocket = layerProtocolWebsocket;
+const makeProtocolWithHttpApp = exports.makeProtocolWithHttpApp = /*#__PURE__*/Effect.gen(function* () {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const isJson = serialization.contentType === "application/json";
+  const disconnects = yield* Mailbox.make();
+  let writeRequest;
+  let clientId = 0;
+  const clients = new Map();
+  const httpApp = Effect.gen(function* () {
+    const request = yield* HttpServerRequest.HttpServerRequest;
+    const data = yield* Effect.orDie(request.arrayBuffer);
+    const id = clientId++;
+    const mailbox = yield* Mailbox.make();
+    const parser = serialization.unsafeMake();
+    const encoder = new TextEncoder();
+    const offer = data => typeof data === "string" ? mailbox.offer(encoder.encode(data)) : mailbox.offer(data);
+    clients.set(id, {
+      write: response => {
+        try {
+          if (!serialization.supportsBigInt) {
+            transformBigInt(response);
+          }
+          return isJson ? mailbox.offer(response) : offer(parser.encode(response));
+        } catch (cause) {
+          return isJson ? mailbox.offer((0, _RpcMessage.ResponseDefectEncoded)(cause)) : offer(parser.encode((0, _RpcMessage.ResponseDefectEncoded)(cause)));
+        }
+      },
+      end: mailbox.end
+    });
+    const requestIds = [];
+    try {
+      const decoded = parser.decode(new Uint8Array(data));
+      for (const message of decoded) {
+        if (message._tag === "Request") {
+          requestIds.push((0, _RpcMessage.RequestId)(message.id));
+        }
+        yield* writeRequest(id, message);
+      }
+    } catch (cause) {
+      yield* offer(parser.encode((0, _RpcMessage.ResponseDefectEncoded)(cause)));
+    }
+    yield* writeRequest(id, _RpcMessage.constEof);
+    if (isJson) {
+      let done = false;
+      yield* Effect.addFinalizer(() => {
+        clients.delete(id);
+        disconnects.unsafeOffer(id);
+        if (done) return Effect.void;
+        return Effect.forEach(requestIds, requestId => writeRequest(id, {
+          _tag: "Interrupt",
+          requestId
+        }), {
+          discard: true
+        });
+      });
+      const responses = Arr.empty();
+      while (true) {
+        const [items, done] = yield* mailbox.takeAll;
+        // eslint-disable-next-line no-restricted-syntax
+        responses.push(...items);
+        if (done) break;
+      }
+      done = true;
+      return HttpServerResponse.unsafeJson(responses);
+    }
+    return HttpServerResponse.stream(Stream.ensuringWith(Mailbox.toStream(mailbox), exit => {
+      clients.delete(id);
+      disconnects.unsafeOffer(id);
+      if (!Exit.isInterrupted(exit)) return Effect.void;
+      return Effect.forEach(requestIds, requestId => writeRequest(id, {
+        _tag: "Interrupt",
+        requestId
+      }), {
+        discard: true
+      });
+    }), {
+      contentType: serialization.contentType
+    });
+  }).pipe(Effect.interruptible);
+  const protocol = yield* Protocol.make(writeRequest_ => {
+    writeRequest = writeRequest_;
+    return Effect.succeed({
+      disconnects,
+      send: (clientId, response) => {
+        const client = clients.get(clientId);
+        if (!client) return Effect.void;
+        return client.write(response);
+      },
+      end(clientId) {
+        const client = clients.get(clientId);
+        if (!client) return Effect.void;
+        return client.end;
+      },
+      initialMessage: Effect.succeedNone,
+      supportsAck: false,
+      supportsTransferables: false
+    });
+  });
+  return {
+    protocol,
+    httpApp
+  };
+});
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+const makeProtocolHttp = exports.makeProtocolHttp = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpApp;
+  const router = yield* options.routerTag ?? HttpRouter.Default;
+  yield* router.post(options.path, httpApp);
+  return protocol;
+});
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+const makeProtocolWorkerRunner = exports.makeProtocolWorkerRunner = /*#__PURE__*/Protocol.make( /*#__PURE__*/Effect.fnUntraced(function* (writeRequest) {
+  const runner = yield* WorkerRunner.PlatformRunner;
+  const closeLatch = yield* WorkerRunner.CloseLatch;
+  const backing = yield* runner.start(closeLatch);
+  const initialMessage = yield* Deferred.make();
+  yield* backing.run((clientId, message) => {
+    if (message._tag === "InitialMessage") {
+      return Deferred.succeed(initialMessage, message.value);
+    }
+    return writeRequest(clientId, message);
+  });
+  return {
+    disconnects: backing.disconnects ?? (yield* Mailbox.make()),
+    send: backing.send,
+    end(_clientId) {
+      return Effect.void;
+    },
+    initialMessage: Effect.asSome(Deferred.await(initialMessage)),
+    supportsAck: true,
+    supportsTransferables: true
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+const layerProtocolWorkerRunner = exports.layerProtocolWorkerRunner = /*#__PURE__*/Layer.scoped(Protocol, makeProtocolWorkerRunner);
+/**
+ * A rpc protocol that uses streaming http for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+const layerProtocolHttp = options => {
+  const routerTag = options.routerTag ?? HttpRouter.Default;
+  return Layer.effect(Protocol, makeProtocolHttp(options)).pipe(Layer.provide(routerTag.Live));
+};
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+exports.layerProtocolHttp = layerProtocolHttp;
+const toHttpApp = exports.toHttpApp = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpApp;
+  yield* make(group, options).pipe(Effect.provideService(Protocol, protocol), Effect.interruptible, Effect.forkScoped);
+  return httpApp;
+});
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+const toHttpAppWebsocket = exports.toHttpAppWebsocket = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpAppWebsocket;
+  yield* make(group, options).pipe(Effect.provideService(Protocol, protocol), Effect.interruptible, Effect.forkScoped);
+  return httpApp;
+});
+/**
+ * Construct an http web handler from an `RpcGroup`.
+ *
+ * @since 1.0.0
+ * @category constructors
+ */
+const toWebHandler = (group, options) => {
+  const runtime = ManagedRuntime.make(Layer.mergeAll(options.layer, Layer.scope), options?.memoMap);
+  let handlerCached;
+  const handlerPromise = Effect.gen(function* () {
+    const app = yield* toHttpApp(group, options);
+    const rt = yield* runtime.runtimeEffect;
+    const handler = HttpApp.toWebHandlerRuntime(rt)(options?.middleware ? options.middleware(app) : app);
+    handlerCached = handler;
+    return handler;
+  }).pipe(runtime.runPromise);
+  function handler(request, context) {
+    if (handlerCached !== undefined) {
+      return handlerCached(request, context);
+    }
+    return handlerPromise.then(handler => handler(request, context));
+  }
+  return {
+    handler,
+    dispose: runtime.dispose
+  };
+};
+// internal
+exports.toWebHandler = toWebHandler;
+const makeSocketProtocol = /*#__PURE__*/Effect.gen(function* () {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const disconnects = yield* Mailbox.make();
+  let clientId = 0;
+  const clients = new Map();
+  let writeRequest;
+  const onSocket = function* (socket) {
+    const scope = yield* Effect.scope;
+    const parser = serialization.unsafeMake();
+    const id = clientId++;
+    yield* Scope.addFinalizerExit(scope, () => {
+      clients.delete(id);
+      return disconnects.offer(id);
+    });
+    const writeRaw = yield* socket.writer;
+    const write = response => {
+      try {
+        if (!serialization.supportsBigInt) {
+          transformBigInt(response);
+        }
+        return Effect.orDie(writeRaw(parser.encode(response)));
+      } catch (cause) {
+        return Effect.orDie(writeRaw(parser.encode((0, _RpcMessage.ResponseDefectEncoded)(cause))));
+      }
+    };
+    clients.set(id, {
+      write
+    });
+    yield* Effect.orDie(Effect.interruptible(socket.runRaw(data => {
+      try {
+        const decoded = parser.decode(data);
+        if (decoded.length === 0) return Effect.void;
+        let i = 0;
+        return Effect.whileLoop({
+          while: () => i < decoded.length,
+          body: () => writeRequest(id, decoded[i++]),
+          step: _Function.constVoid
+        });
+      } catch (cause) {
+        return writeRaw(parser.encode((0, _RpcMessage.ResponseDefectEncoded)(cause)));
+      }
+    })));
+  };
+  const protocol = yield* Protocol.make(writeRequest_ => {
+    writeRequest = writeRequest_;
+    return Effect.succeed({
+      disconnects,
+      send: (clientId, response) => {
+        const client = clients.get(clientId);
+        if (!client) return Effect.void;
+        return Effect.orDie(client.write(response));
+      },
+      end(_clientId) {
+        return Effect.void;
+      },
+      initialMessage: Effect.succeedNone,
+      supportsAck: true,
+      supportsTransferables: false
+    });
+  });
+  return {
+    protocol,
+    onSocket
+  };
+});
+const transformBigInt = response => {
+  if ("requestId" in response) {
+    ;
+    response.requestId = response.requestId.toString();
+  }
+};
+//# sourceMappingURL=RpcServer.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcServer.js.map b/dist/cjs/RpcServer.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..bcc38501c20084cfacc9220ed1c2ab642913b842
--- /dev/null
+++ b/dist/cjs/RpcServer.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcServer.js","names":["Headers","_interopRequireWildcard","require","HttpApp","HttpRouter","HttpServerRequest","HttpServerResponse","SocketServer","Transferable","WorkerRunner","Arr","Cause","Chunk","Context","Deferred","Effect","Exit","Fiber","FiberId","FiberRef","FiberSet","_Function","Layer","Mailbox","ManagedRuntime","Option","_ParseResult","Predicate","Schema","Scope","Stream","_utils","Rpc","_RpcMessage","RpcSchema","RpcSerialization","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","makeNoSerialization","exports","fnUntraced","group","options","tracingEnabled","disableSpanPropagation","supportsAck","disableClientAcks","spanPrefix","concurrency","context","scope","fiberSet","make","runFork","runtime","pipe","interruptible","concurrencySemaphore","undefined","makeSemaphore","clients","Map","isShutdown","shutdownLatch","unsafeMakeLatch","addFinalizer","fiberIdWith","fiberId","client","values","ended","fibers","size","endClient","fiber","unsafeInterruptAsFork","void","await","disconnect","clientId","delete","write","message","catchAllDefect","suspend","interrupt","id","latches","_tag","handleRequest","latch","requestId","open","interruptFork","onFromServer","exit","none","sendDefect","defect","zipRight","request","rpc","requests","tag","entry","unsafeMap","key","die","isStream","isStreamSchema","successSchema","result","handler","payload","headers","isFork","streamOrEffect","value","responded","effect","uninterruptible","matchCauseEffect","applyMiddleware","streamEffect","onSuccess","succeed","onFailure","cause","failCause","withSpan","captureStackTrace","parent","traceId","spanId","sampled","empty","locally","currentContext","withPermits","addObserver","stream","isEffect","done","flatMap","mailbox","whileLoop","while","body","constant","takeAll","chunk","done_","isNonEmpty","toReadonlyArray","unsafeClose","step","constVoid","scoped","runForEachChunk","shouldEnd","identity","middlewares","middleware","unsafeGet","optional","previous","matchEffect","provides","provideService","_","provideServiceEffect","disconnects","end","run","send","supportsTransferables","Protocol","server","response","schemas","handleEncode","collector","encodeChunk","encodeExit","extend","fork","constTrue","take","schemasCache","getSchemas","streamSchemas","getStreamSchemas","ast","failures","Set","errorSchema","isSome","add","failure","decode","decodeUnknown","payloadSchema","encodeUnknown","Array","success","Any","exitSchema","Collector","unsafeClear","catchAllCause","squash","map","ArrayFormatter","formatErrorSync","interruptors","sendRequestDefect","annotateLogs","logDebug","module","method","hasProperty","RequestId","error","unsafeMakeCollector","fromInput","constPong","BigInt","tapErrorCause","logFatal","onExit","close","layer","scopedDiscard","forkScoped","Tag","withRun","makeProtocolSocketServer","gen","onSocket","protocol","makeSocketProtocol","layerProtocolSocketServer","makeProtocolWithHttpAppWebsocket","httpApp","socket","orDie","upgrade","makeProtocolWebsocket","router","routerTag","Default","path","layerProtocolWebsocket","provide","Live","makeProtocolWithHttpApp","serialization","isJson","contentType","writeRequest","data","arrayBuffer","parser","unsafeMake","encoder","TextEncoder","offer","encode","supportsBigInt","transformBigInt","ResponseDefectEncoded","requestIds","decoded","Uint8Array","push","constEof","unsafeOffer","forEach","discard","responses","items","unsafeJson","ensuringWith","toStream","isInterrupted","writeRequest_","initialMessage","succeedNone","makeProtocolHttp","post","makeProtocolWorkerRunner","runner","PlatformRunner","closeLatch","CloseLatch","backing","start","_clientId","asSome","layerProtocolWorkerRunner","layerProtocolHttp","toHttpApp","toHttpAppWebsocket","toWebHandler","mergeAll","memoMap","handlerCached","handlerPromise","app","rt","runtimeEffect","toWebHandlerRuntime","runPromise","then","dispose","addFinalizerExit","writeRaw","writer","runRaw","length","toString"],"sources":["../../src/RpcServer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcTest.js b/dist/cjs/RpcTest.js
new file mode 100644
index 0000000000000000000000000000000000000000..0feed5c410f0a3bad1aecbdc5baf3ab8284e7262
--- /dev/null
+++ b/dist/cjs/RpcTest.js
@@ -0,0 +1,38 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.makeClient = void 0;
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var RpcClient = _interopRequireWildcard(require("./RpcClient.js"));
+var RpcServer = _interopRequireWildcard(require("./RpcServer.js"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+const makeClient = exports.makeClient = /*#__PURE__*/Effect.fnUntraced(function* (group) {
+  // eslint-disable-next-line prefer-const
+  let client;
+  const server = yield* RpcServer.makeNoSerialization(group, {
+    onFromServer(response) {
+      return client.write(response);
+    }
+  });
+  client = yield* RpcClient.makeNoSerialization(group, {
+    supportsAck: true,
+    onFromClient({
+      message
+    }) {
+      return server.write(0, message);
+    }
+  });
+  return client.client;
+});
+//# sourceMappingURL=RpcTest.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcTest.js.map b/dist/cjs/RpcTest.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..8dd1c214019b01d385f13121b35e853d2e7a4b8e
--- /dev/null
+++ b/dist/cjs/RpcTest.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcTest.js","names":["Effect","_interopRequireWildcard","require","RpcClient","RpcServer","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","makeClient","exports","fnUntraced","group","client","server","makeNoSerialization","onFromServer","response","write","supportsAck","onFromClient","message"],"sources":["../../src/RpcTest.ts"],"sourcesContent":[null],"mappings":";;;;;;AAGA,IAAAA,MAAA,GAAAC,uBAAA,CAAAC,OAAA;AAGA,IAAAC,SAAA,GAAAF,uBAAA,CAAAC,OAAA;AAEA,IAAAE,SAAA,GAAAH,uBAAA,CAAAC,OAAA;AAA2C,SAAAG,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAL,wBAAAK,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAR3C;;;;AAUA;;;;AAIO,MAAMW,UAAU,GAAAC,OAAA,CAAAD,UAAA,gBAMnBzB,MAAM,CAAC2B,UAAU,CAAC,WACpBC,KAA8B;EAE9B;EACA,IAAIC,MAA6F;EACjG,MAAMC,MAAM,GAAG,OAAO1B,SAAS,CAAC2B,mBAAmB,CAACH,KAAK,EAAE;IACzDI,YAAYA,CAACC,QAAQ;MACnB,OAAOJ,MAAM,CAACK,KAAK,CAACD,QAAQ,CAAC;IAC/B;GACD,CAAC;EACFJ,MAAM,GAAG,OAAO1B,SAAS,CAAC4B,mBAAmB,CAACH,KAAK,EAAE;IACnDO,WAAW,EAAE,IAAI;IACjBC,YAAYA,CAAC;MAAEC;IAAO,CAAE;MACtB,OAAOP,MAAM,CAACI,KAAK,CAAC,CAAC,EAAEG,OAAO,CAAC;IACjC;GACD,CAAC;EACF,OAAOR,MAAM,CAACA,MAAM;AACtB,CAAC,CAAC","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/RpcWorker.js b/dist/cjs/RpcWorker.js
new file mode 100644
index 0000000000000000000000000000000000000000..74a1d52ac4ce964fc9726b2d4f9dd45e2cca85c5
--- /dev/null
+++ b/dist/cjs/RpcWorker.js
@@ -0,0 +1,46 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.makeInitialMessage = exports.layerInitialMessage = exports.initialMessage = exports.InitialMessage = void 0;
+var Transferable = _interopRequireWildcard(require("@effect/platform/Transferable"));
+var Context = _interopRequireWildcard(require("effect/Context"));
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+var Layer = _interopRequireWildcard(require("effect/Layer"));
+var Schema = _interopRequireWildcard(require("effect/Schema"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/**
+ * @since 1.0.0
+ */
+
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+class InitialMessage extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcWorker/InitialMessage")() {}
+exports.InitialMessage = InitialMessage;
+const ProtocolTag = /*#__PURE__*/Context.GenericTag("@effect/rpc/RpcServer/Protocol");
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+const makeInitialMessage = (schema, effect) => Effect.flatMap(effect, value => {
+  const collector = Transferable.unsafeMakeCollector();
+  return Schema.encode(schema)(value).pipe(Effect.provideService(Transferable.Collector, collector), Effect.map(encoded => [encoded, collector.unsafeClear()]));
+});
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+exports.makeInitialMessage = makeInitialMessage;
+const layerInitialMessage = (schema, build) => Layer.effect(InitialMessage, Effect.contextWith(context => Effect.provide(Effect.orDie(makeInitialMessage(schema, build)), context)));
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+exports.layerInitialMessage = layerInitialMessage;
+const initialMessage = schema => ProtocolTag.pipe(Effect.flatMap(protocol => protocol.initialMessage), Effect.flatten, Effect.flatMap(Schema.decodeUnknown(schema)));
+exports.initialMessage = initialMessage;
+//# sourceMappingURL=RpcWorker.js.map
\ No newline at end of file
diff --git a/dist/cjs/RpcWorker.js.map b/dist/cjs/RpcWorker.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..45a2665c2a16b789b8eb7d2cd3ceff8a6b388d28
--- /dev/null
+++ b/dist/cjs/RpcWorker.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcWorker.js","names":["Transferable","_interopRequireWildcard","require","Context","Effect","Layer","Schema","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","InitialMessage","Tag","exports","ProtocolTag","GenericTag","makeInitialMessage","schema","effect","flatMap","value","collector","unsafeMakeCollector","encode","pipe","provideService","Collector","map","encoded","unsafeClear","layerInitialMessage","build","contextWith","context","provide","orDie","initialMessage","protocol","flatten","decodeUnknown"],"sources":["../../src/RpcWorker.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/cjs/index.js b/dist/cjs/index.js
index f731e8759717e1341ffc71bf93af665eb31cef79..3ba7d9e776531a53bd931b0c320ece9cbb23a0ef 100644
--- a/dist/cjs/index.js
+++ b/dist/cjs/index.js
@@ -3,15 +3,27 @@
 Object.defineProperty(exports, "__esModule", {
   value: true
 });
-exports.RpcRouter = exports.RpcResolverNoStream = exports.RpcResolver = exports.Rpc = void 0;
+exports.RpcWorker = exports.RpcTest = exports.RpcServer = exports.RpcSerialization = exports.RpcSchema = exports.RpcMiddleware = exports.RpcMessage = exports.RpcGroup = exports.RpcClient = exports.Rpc = void 0;
 var _Rpc = _interopRequireWildcard(require("./Rpc.js"));
 exports.Rpc = _Rpc;
-var _RpcResolver = _interopRequireWildcard(require("./RpcResolver.js"));
-exports.RpcResolver = _RpcResolver;
-var _RpcResolverNoStream = _interopRequireWildcard(require("./RpcResolverNoStream.js"));
-exports.RpcResolverNoStream = _RpcResolverNoStream;
-var _RpcRouter = _interopRequireWildcard(require("./RpcRouter.js"));
-exports.RpcRouter = _RpcRouter;
+var _RpcClient = _interopRequireWildcard(require("./RpcClient.js"));
+exports.RpcClient = _RpcClient;
+var _RpcGroup = _interopRequireWildcard(require("./RpcGroup.js"));
+exports.RpcGroup = _RpcGroup;
+var _RpcMessage = _interopRequireWildcard(require("./RpcMessage.js"));
+exports.RpcMessage = _RpcMessage;
+var _RpcMiddleware = _interopRequireWildcard(require("./RpcMiddleware.js"));
+exports.RpcMiddleware = _RpcMiddleware;
+var _RpcSchema = _interopRequireWildcard(require("./RpcSchema.js"));
+exports.RpcSchema = _RpcSchema;
+var _RpcSerialization = _interopRequireWildcard(require("./RpcSerialization.js"));
+exports.RpcSerialization = _RpcSerialization;
+var _RpcServer = _interopRequireWildcard(require("./RpcServer.js"));
+exports.RpcServer = _RpcServer;
+var _RpcTest = _interopRequireWildcard(require("./RpcTest.js"));
+exports.RpcTest = _RpcTest;
+var _RpcWorker = _interopRequireWildcard(require("./RpcWorker.js"));
+exports.RpcWorker = _RpcWorker;
 function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
 function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
 //# sourceMappingURL=index.js.map
\ No newline at end of file
diff --git a/dist/cjs/internal/utils.js b/dist/cjs/internal/utils.js
new file mode 100644
index 0000000000000000000000000000000000000000..f21d302dfe07e532d0b702f17e2783b3b5ee5dcb
--- /dev/null
+++ b/dist/cjs/internal/utils.js
@@ -0,0 +1,34 @@
+"use strict";
+
+Object.defineProperty(exports, "__esModule", {
+  value: true
+});
+exports.withRun = void 0;
+var Effect = _interopRequireWildcard(require("effect/Effect"));
+function _getRequireWildcardCache(e) { if ("function" != typeof WeakMap) return null; var r = new WeakMap(), t = new WeakMap(); return (_getRequireWildcardCache = function (e) { return e ? t : r; })(e); }
+function _interopRequireWildcard(e, r) { if (!r && e && e.__esModule) return e; if (null === e || "object" != typeof e && "function" != typeof e) return { default: e }; var t = _getRequireWildcardCache(r); if (t && t.has(e)) return t.get(e); var n = { __proto__: null }, a = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var u in e) if ("default" !== u && {}.hasOwnProperty.call(e, u)) { var i = a ? Object.getOwnPropertyDescriptor(e, u) : null; i && (i.get || i.set) ? Object.defineProperty(n, u, i) : n[u] = e[u]; } return n.default = e, t && t.set(e, n), n; }
+/** @internal */
+const withRun = () => f => Effect.suspend(() => {
+  const semaphore = Effect.unsafeMakeSemaphore(1);
+  let buffer = [];
+  let write = (...args) => Effect.sync(() => buffer.push(args));
+  return Effect.map(f((...args) => write(...args)), a => ({
+    ...a,
+    run(f) {
+      return semaphore.withPermits(1)(Effect.gen(function* () {
+        const prev = write;
+        write = f;
+        for (const value of buffer) {
+          yield* write(...value);
+        }
+        buffer = [];
+        return yield* Effect.onExit(Effect.never, () => {
+          write = prev;
+          return Effect.void;
+        });
+      }));
+    }
+  }));
+});
+exports.withRun = withRun;
+//# sourceMappingURL=utils.js.map
\ No newline at end of file
diff --git a/dist/cjs/internal/utils.js.map b/dist/cjs/internal/utils.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..bbf4da14fd9d365097a11844605badea2686b75a
--- /dev/null
+++ b/dist/cjs/internal/utils.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"utils.js","names":["Effect","_interopRequireWildcard","require","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","withRun","f","suspend","semaphore","unsafeMakeSemaphore","buffer","write","args","sync","push","map","run","withPermits","gen","prev","value","onExit","never","void","exports"],"sources":["../../../src/internal/utils.ts"],"sourcesContent":[null],"mappings":";;;;;;AAAA,IAAAA,MAAA,GAAAC,uBAAA,CAAAC,OAAA;AAAuC,SAAAC,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAH,wBAAAG,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,CAAA,SAAAG,CAAA,GAAAP,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAG,CAAA,KAAAA,CAAA,CAAAV,GAAA,IAAAU,CAAA,CAAAC,GAAA,IAAAP,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAG,CAAA,IAAAT,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAe,GAAA,CAAAlB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAEvC;AACO,MAAMW,OAAO,GAAGA,CAAA,KAKdC,CAA4E,IACnFxB,MAAM,CAACyB,OAAO,CAAC,MAAK;EAClB,MAAMC,SAAS,GAAG1B,MAAM,CAAC2B,mBAAmB,CAAC,CAAC,CAAC;EAC/C,IAAIC,MAAM,GAAsB,EAAE;EAClC,IAAIC,KAAK,GAAGA,CAAC,GAAGC,IAAgB,KAA0B9B,MAAM,CAAC+B,IAAI,CAAC,MAAMH,MAAM,CAACI,IAAI,CAACF,IAAI,CAAC,CAAC;EAC9F,OAAO9B,MAAM,CAACiC,GAAG,CAACT,CAAC,CAAC,CAAC,GAAGM,IAAI,KAAKD,KAAK,CAAC,GAAGC,IAAI,CAAC,CAAC,EAAGhB,CAAC,KAAM;IACxD,GAAGA,CAAC;IACJoB,GAAGA,CAACV,CAAC;MACH,OAAOE,SAAS,CAACS,WAAW,CAAC,CAAC,CAAC,CAACnC,MAAM,CAACoC,GAAG,CAAC,aAAS;QAClD,MAAMC,IAAI,GAAGR,KAAK;QAClBA,KAAK,GAAGL,CAAC;QAET,KAAK,MAAMc,KAAK,IAAIV,MAAM,EAAE;UAC1B,OAAOC,KAAK,CAAC,GAAGS,KAAK,CAAC;QACxB;QACAV,MAAM,GAAG,EAAE;QAEX,OAAO,OAAO5B,MAAM,CAACuC,MAAM,CAACvC,MAAM,CAACwC,KAAK,EAAE,MAAK;UAC7CX,KAAK,GAAGQ,IAAI;UACZ,OAAOrC,MAAM,CAACyC,IAAI;QACpB,CAAC,CAAC;MACJ,CAAC,CAAC,CAAC;IACL;GACK,EAAC;AACV,CAAC,CAAC;AAAAC,OAAA,CAAAnB,OAAA,GAAAA,OAAA","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/dts/Rpc.d.ts b/dist/dts/Rpc.d.ts
index ea17729cad33fac41a5c316aac495d938f7c24be..6ccf545e0f2afc7f6c55e5a3e76c53659a987f38 100644
--- a/dist/dts/Rpc.d.ts
+++ b/dist/dts/Rpc.d.ts
@@ -1,20 +1,16 @@
 /**
  * @since 1.0.0
  */
-import * as Headers from "@effect/platform/Headers";
-import type * as Context from "effect/Context";
-import * as Effect from "effect/Effect";
-import * as FiberRef from "effect/FiberRef";
-import type * as ParseResult from "effect/ParseResult";
+import type { Headers } from "@effect/platform/Headers";
+import * as Context_ from "effect/Context";
+import type { Effect } from "effect/Effect";
+import type { Exit as Exit_ } from "effect/Exit";
 import { type Pipeable } from "effect/Pipeable";
-import type * as PrimaryKey from "effect/PrimaryKey";
-import type * as Record from "effect/Record";
-import type * as EffectRequest from "effect/Request";
-import type * as RequestResolver from "effect/RequestResolver";
 import * as Schema from "effect/Schema";
-import type { Scope } from "effect/Scope";
-import * as Stream from "effect/Stream";
-import type * as Types from "effect/Types";
+import type * as AST from "effect/SchemaAST";
+import type { Stream } from "effect/Stream";
+import type * as RpcMiddleware from "./RpcMiddleware.js";
+import * as RpcSchema from "./RpcSchema.js";
 /**
  * @since 1.0.0
  * @category type ids
@@ -27,221 +23,295 @@ export declare const TypeId: unique symbol;
 export type TypeId = typeof TypeId;
 /**
  * @since 1.0.0
- * @category refinements
+ * @category guards
  */
-export declare const isRpc: (u: unknown) => u is Rpc<any, any>;
+export declare const isRpc: (u: unknown) => u is Rpc<any, any, any>;
 /**
+ * Represents an API endpoint. An API endpoint is mapped to a single route on
+ * the underlying `HttpRouter`.
+ *
  * @since 1.0.0
  * @category models
  */
-export type Rpc<Req extends Schema.TaggedRequest.All, R> = RpcEffect<Req, R> | RpcStream<Req, R>;
+export interface Rpc<out Tag extends string, out Payload extends AnyStructSchema = Schema.Struct<{}>, out Success extends Schema.Schema.Any = typeof Schema.Void, out Error extends Schema.Schema.All = typeof Schema.Never, out Middleware extends RpcMiddleware.TagClassAny = never> extends Pipeable {
+    readonly [TypeId]: TypeId;
+    readonly _tag: Tag;
+    readonly key: string;
+    readonly payloadSchema: Payload;
+    readonly successSchema: Success;
+    readonly errorSchema: Error;
+    readonly annotations: Context_.Context<never>;
+    readonly middlewares: ReadonlySet<Middleware>;
+    /**
+     * Set the schema for the success response of the rpc.
+     */
+    setSuccess<S extends Schema.Schema.Any>(schema: S): Rpc<Tag, Payload, S, Error, Middleware>;
+    /**
+     * Set the schema for the error response of the rpc.
+     */
+    setError<E extends Schema.Schema.Any>(schema: E): Rpc<Tag, Payload, Success, E, Middleware>;
+    /**
+     * Set the schema for the payload of the rpc.
+     */
+    setPayload<P extends Schema.Struct<any> | Schema.Struct.Fields>(schema: P): Rpc<Tag, P extends Schema.Struct<infer _> ? P : P extends Schema.Struct.Fields ? Schema.Struct<P> : never, Success, Error, Middleware>;
+    /**
+     * Add an `RpcMiddleware` to this procedure.
+     */
+    middleware<M extends RpcMiddleware.TagClassAny>(middleware: M): Rpc<Tag, Payload, Success, Error, Middleware | M>;
+    /**
+     * Add an annotation on the rpc.
+     */
+    annotate<I, S>(tag: Context_.Tag<I, S>, value: S): Rpc<Tag, Payload, Success, Error, Middleware>;
+    /**
+     * Merge the annotations of the rpc with the provided context.
+     */
+    annotateContext<I>(context: Context_.Context<I>): Rpc<Tag, Payload, Success, Error, Middleware>;
+}
 /**
+ * Represents an implemented rpc.
+ *
  * @since 1.0.0
  * @category models
  */
-export interface RpcEffect<Req extends Schema.TaggedRequest.All, R> extends Rpc.Proto<Req> {
-    readonly _tag: "Effect";
-    readonly handler: (request: Req) => Effect.Effect<EffectRequest.Request.Success<Req>, EffectRequest.Request.Error<Req>, R>;
+export interface Handler<Tag extends string> {
+    readonly _: unique symbol;
+    readonly tag: Tag;
+    readonly handler: (request: any, headers: Headers) => Effect<any, any> | Stream<any, any>;
+    readonly context: Context<never>;
 }
 /**
  * @since 1.0.0
  * @category models
  */
-export interface RpcStream<Req extends Schema.TaggedRequest.All, R> extends Rpc.Proto<Req> {
-    readonly _tag: "Stream";
-    readonly handler: (request: Req) => Stream.Stream<Req extends Schema.WithResult<infer A, infer _I, infer _E, infer _EI, infer _R> ? A : never, Req extends Schema.WithResult<infer _A, infer _I, infer E, infer _EI, infer _R> ? E : never, R>;
+export interface Any extends Pipeable {
+    readonly [TypeId]: TypeId;
+    readonly _tag: string;
+    readonly key: string;
 }
 /**
  * @since 1.0.0
  * @category models
  */
-export declare namespace Rpc {
-    /**
-     * @since 1.0.0
-     * @category models
-     */
-    interface Proto<Req extends Schema.TaggedRequest.All> extends Pipeable {
-        readonly [TypeId]: TypeId;
-        readonly _tag: string;
-        readonly schema: Schema.Schema<Req, any, unknown>;
-    }
-    /**
-     * @since 1.0.0
-     * @category models
-     */
-    type Context<A extends Rpc<any, any>> = A extends Rpc<infer Req, infer R> ? R | Schema.SerializableWithResult.Context<Req> : never;
-    /**
-     * @since 1.0.0
-     * @category models
-     */
-    type Request<A extends Rpc<any, any>> = Schema.Schema.Type<A["schema"]>;
-    /**
-     * @since 1.0.0
-     * @category models
-     */
-    type Result<A extends Schema.TaggedRequest.All, R = never> = StreamRequestTypeId extends keyof A ? EffectRequest.Request.Success<A> : Effect.Effect<EffectRequest.Request.Success<A>, EffectRequest.Request.Error<A>, R>;
-    /**
-     * @since 1.0.0
-     * @category models
-     */
-    type ResultUndecoded<A extends Schema.TaggedRequest.All, R = never> = A extends Schema.WithResult<infer _A, infer I, infer E, infer _EI, infer _R> ? StreamRequestTypeId extends keyof A ? Stream.Stream<I, E, R> : Effect.Effect<I, E, R> : never;
+export interface AnyWithProps {
+    readonly [TypeId]: TypeId;
+    readonly _tag: string;
+    readonly key: string;
+    readonly payloadSchema: AnyStructSchema;
+    readonly successSchema: Schema.Schema.Any;
+    readonly errorSchema: Schema.Schema.All;
+    readonly annotations: Context_.Context<never>;
+    readonly middlewares: ReadonlySet<RpcMiddleware.TagClassAnyWithProps>;
 }
 /**
  * @since 1.0.0
- * @category constructors
+ * @category models
  */
-export declare const effect: <Req extends Schema.TaggedRequest.All, R>(schema: Schema.Schema<Req, any, unknown>, handler: (request: Req) => Effect.Effect<EffectRequest.Request.Success<Req>, EffectRequest.Request.Error<Req>, R>) => Rpc<Req, R>;
+export type Tag<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Tag : never;
 /**
  * @since 1.0.0
- * @category type ids
+ * @category models
  */
-export declare const StreamRequestTypeId: unique symbol;
+export type Success<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Success["Type"] : never;
 /**
  * @since 1.0.0
- * @category type ids
+ * @category models
  */
-export type StreamRequestTypeId = typeof StreamRequestTypeId;
+export type SuccessEncoded<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Success["Encoded"] : never;
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export interface StreamRequest<Tag extends string, SR, SI, S, RR, EI, E, AI, A> extends EffectRequest.Request<Stream.Stream<A, E, never>>, Schema.SerializableWithResult<S, SI, SR, A, AI, E, EI, RR> {
-    readonly [StreamRequestTypeId]: StreamRequestTypeId;
-    readonly _tag: Tag;
-}
+export type SuccessExit<R> = Success<R> extends infer T ? T extends Stream<infer _A, infer _E, infer _Env> ? void : T : never;
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export declare namespace StreamRequest {
-    /**
-     * @since 1.0.0
-     * @category schemas
-     */
-    type Any = StreamRequest<string, any, any, any, any, any, any, any, any> | StreamRequest<string, any, any, any, any, never, never, any, any>;
-}
+export type SuccessExitEncoded<R> = SuccessEncoded<R> extends infer T ? T extends Stream<infer _A, infer _E, infer _Env> ? void : T : never;
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export interface StreamRequestConstructor<Tag extends string, Self, R, IS, S, RR, IE, E, IA, A> extends Schema.Schema<Self, Types.Simplify<IS & {
-    readonly _tag: Tag;
-}>, R> {
-    new (props: Types.Equals<S, {}> extends true ? void : S, disableValidation?: boolean): StreamRequest<Tag, R, IS & {
-        readonly _tag: Tag;
-    }, Self, RR, IE, E, IA, A> & S;
-}
+export type SuccessChunk<R> = Success<R> extends Stream<infer _A, infer _E, infer _Env> ? _A : never;
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export declare const StreamRequest: <Self>() => <Tag extends string, E, IE, RE, A, IA, RA, Payload extends Schema.Struct.Fields>(tag: Tag, options: {
-    readonly failure: Schema.Schema<E, IE, RE>;
-    readonly success: Schema.Schema<A, IA, RA>;
-    readonly payload: Payload;
-}) => StreamRequestConstructor<Tag, Self, Schema.Schema.Context<Payload[keyof Payload]>, Types.Simplify<Schema.Struct.Encoded<Payload>>, Types.Simplify<Schema.Struct.Type<Payload>>, RE | RA, IE, E, IA, A>;
+export type SuccessChunkEncoded<R> = SuccessEncoded<R> extends Stream<infer _A, infer _E, infer _Env> ? _A : never;
 /**
  * @since 1.0.0
- * @category constructors
+ * @category models
  */
-export declare const stream: <Req extends StreamRequest.Any, R>(schema: Schema.Schema<Req, any, unknown>, handler: (request: Req) => Stream.Stream<Req extends Schema.WithResult<infer A, infer _I, infer _E, infer _EI, infer _R> ? A : never, Req extends Schema.WithResult<infer _A, infer _I_1, infer E, infer _EI_1, infer _R_1> ? E : never, R>) => Rpc<Req, R>;
+export type ErrorSchema<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Error | _Middleware : never;
 /**
  * @since 1.0.0
  * @category models
  */
-export interface Request<A extends Schema.TaggedRequest.All> extends EffectRequest.Request<EffectRequest.Request.Success<A>, EffectRequest.Request.Error<A>>, PrimaryKey.PrimaryKey, Schema.WithResult<Schema.WithResult.Context<A>, Schema.Schema.Encoded<A[typeof Schema.symbolWithResult]["failure"]>, Schema.Schema.Type<A[typeof Schema.symbolWithResult]["failure"]>, Schema.Schema.Encoded<A[typeof Schema.symbolWithResult]["success"]>, Schema.Schema.Type<A[typeof Schema.symbolWithResult]["success"]>> {
-    readonly request: A;
-    readonly traceId: string;
-    readonly spanId: string;
-    readonly sampled: boolean;
-    readonly headers: Headers.Headers;
-}
+export type Error<R> = Schema.Schema.Type<ErrorSchema<R>>;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ErrorEncoded<R> = Schema.Schema.Encoded<ErrorSchema<R>>;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ErrorExit<R> = Success<R> extends Stream<infer _A, infer _E, infer _Env> ? _E | Error<R> : Error<R>;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ErrorExitEncoded<R> = SuccessEncoded<R> extends Stream<infer _A, infer _E, infer _Env> ? _E | ErrorEncoded<R> : ErrorEncoded<R>;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Exit<R> = Exit_<SuccessExit<R>, ErrorExit<R>>;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExitEncoded<R, Defect = unknown> = Schema.ExitEncoded<SuccessExitEncoded<R>, ErrorExitEncoded<R>, Defect>;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type PayloadConstructor<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? Schema.Struct.Constructor<_Payload["fields"]> extends infer T ? [
+    keyof T
+] extends [never] ? void | {} : Schema.Simplify<T> : never : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Payload<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Payload["Type"] : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Context<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Payload["Context"] | _Success["Context"] | _Error["Context"] : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Middleware<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? Context_.Tag.Identifier<_Middleware> : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type MiddlewareClient<R> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Middleware extends {
+    readonly requiredForClient: true;
+} ? RpcMiddleware.ForClient<Context_.Tag.Identifier<_Middleware>> : never : never;
 /**
  * @since 1.0.0
  * @category models
  */
-export interface RequestFrom<A> {
-    readonly request: A;
-    readonly traceId: string;
-    readonly spanId: string;
-    readonly sampled: boolean;
-    readonly headers: Record<string, string>;
+export type AddError<R extends Any, Error extends Schema.Schema.All> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? Rpc<_Tag, _Payload, _Success, _Error | Error, _Middleware> : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type AddMiddleware<R extends Any, Middleware extends RpcMiddleware.TagClassAny> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? Rpc<_Tag, _Payload, _Success, _Error, _Middleware | Middleware> : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ToHandler<R extends Any> = R extends Rpc<infer _Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? Handler<_Tag> : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExtractTag<R extends Any, Tag extends string> = R extends Rpc<Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? R : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExtractProvides<R extends Any, Tag extends string> = R extends Rpc<Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Middleware extends {
+    readonly provides: Context_.Tag<infer _I, infer _S>;
+} ? _I : never : never;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExcludeProvides<Env, R extends Any, Tag extends string> = Exclude<Env, ExtractProvides<R, Tag>>;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface From<S extends AnyTaggedRequestSchema> extends Rpc<S["_tag"], S, S["success"], S["failure"]> {
 }
 /**
  * @since 1.0.0
- * @category schemas
+ * @category constructors
  */
-export declare const RequestSchema: <A, I, R>(schema: Schema.Schema<A, I, R>) => Schema.Schema<RequestFrom<A>, RequestFrom<I>, R>;
+export declare const make: <const Tag extends string, Payload extends AnyStructSchema | Schema.Struct.Fields = Schema.Struct<{}>, Success extends Schema.Schema.Any = typeof Schema.Void, Error extends Schema.Schema.All = typeof Schema.Never, const Stream extends boolean = false>(tag: Tag, options?: {
+    readonly payload?: Payload;
+    readonly success?: Success;
+    readonly error?: Error;
+    readonly stream?: Stream;
+}) => Rpc<Tag, Payload extends Schema.Struct.Fields ? Schema.Struct<Payload> : Payload, Stream extends true ? RpcSchema.Stream<Success, Error> : Success, Stream extends true ? typeof Schema.Never : Error>;
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-export declare const currentHeaders: FiberRef.FiberRef<Headers.Headers>;
+export interface AnyStructSchema extends Pipeable {
+    readonly [Schema.TypeId]: any;
+    readonly make: any;
+    readonly Type: any;
+    readonly Encoded: any;
+    readonly Context: any;
+    readonly ast: AST.AST;
+    readonly fields: Schema.Struct.Fields;
+    readonly annotations: any;
+}
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-export declare const annotateHeaders: {
-    /**
-     * @since 1.0.0
-     * @category headers
-     */
-    (headers: Headers.Input): <A, E, R>(self: Effect.Effect<A, E, R>) => Effect.Effect<A, E, R>;
-    /**
-     * @since 1.0.0
-     * @category headers
-     */
-    <A, E, R>(self: Effect.Effect<A, E, R>, headers: Headers.Input): Effect.Effect<A, E, R>;
-};
+export interface AnyTaggedRequestSchema extends AnyStructSchema {
+    readonly _tag: string;
+    readonly success: Schema.Schema.Any;
+    readonly failure: Schema.Schema.All;
+}
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-export declare const schemaHeaders: <R, I extends Record.ReadonlyRecord<string, string | undefined>, A>(schema: Schema.Schema<R, I, A>) => Effect.Effect<R, ParseResult.ParseError, A>;
+export declare const fromTaggedRequest: <S extends AnyTaggedRequestSchema>(schema: S) => From<S>;
 /**
  * @since 1.0.0
- * @category requests
+ * @category constructors
  */
-export declare const request: <A extends Schema.TaggedRequest.All>(request: A, options?: {
-    readonly spanPrefix?: string;
-}) => Effect.Effect<Request<A>, never, Scope>;
+export declare const exitSchema: <R extends Any>(self: R) => Schema.Schema<Exit<R>, ExitEncoded<R>, Context<R>>;
 /**
  * @since 1.0.0
- * @category requests
+ * @category Fork
  */
-export declare const call: <A extends Schema.TaggedRequest.All, R extends RequestResolver.RequestResolver<Request<A>> | Effect.Effect<RequestResolver.RequestResolver<Request<A>>, never, any>>(req: A, resolver: R, options?: {
-    readonly spanPrefix?: string;
-}) => R extends Effect.Effect<infer _A, infer _E, infer R_1> ? Rpc.Result<A, R_1> : Rpc.Result<A>;
+export declare const ForkTypeId: unique symbol;
 /**
  * @since 1.0.0
- * @category context
+ * @category Fork
  */
-export declare const provideServiceEffect: {
-    /**
-     * @since 1.0.0
-     * @category context
-     */
-    <I, S, E, R2>(tag: Context.Tag<I, S>, effect: Effect.Effect<S, E, R2>): <Req extends Schema.TaggedRequest.All, R>(self: Rpc<Req, R>) => Rpc<Req, Exclude<R, I> | R2>;
-    /**
-     * @since 1.0.0
-     * @category context
-     */
-    <Req extends Schema.TaggedRequest.All, R, I, S, E, R2>(self: Rpc<Req, R>, tag: Context.Tag<I, S>, effect: Effect.Effect<S, E, R2>): Rpc<Req, Exclude<R, I> | R2>;
-};
+export type ForkTypeId = typeof ForkTypeId;
 /**
  * @since 1.0.0
- * @category context
+ * @category Fork
  */
-export declare const provideService: {
-    /**
-     * @since 1.0.0
-     * @category context
-     */
-    <I, S>(tag: Context.Tag<I, S>, service: S): <Req extends Schema.TaggedRequest.All, R>(self: Rpc<Req, R>) => Rpc<Req, Exclude<R, I>>;
-    /**
-     * @since 1.0.0
-     * @category context
-     */
-    <Req extends Schema.TaggedRequest.All, R, I, S>(self: Rpc<Req, R>, tag: Context.Tag<I, S>, service: S): Rpc<Req, Exclude<R, I>>;
-};
+export interface Fork<A> {
+    readonly [ForkTypeId]: ForkTypeId;
+    readonly value: A;
+}
+/**
+ * You can use `fork` to wrap a response Effect or Stream, to ensure that the
+ * response is executed concurrently regardless of the RpcServer concurrency
+ * setting.
+ *
+ * @since 1.0.0
+ * @category Fork
+ */
+export declare const fork: <A>(value: A) => Fork<A>;
+/**
+ * @since 1.0.0
+ * @category Fork
+ */
+export declare const isFork: (u: object) => u is Fork<any>;
 //# sourceMappingURL=Rpc.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/Rpc.d.ts.map b/dist/dts/Rpc.d.ts.map
index 0377b43c75ba362cfffb72b46978cbd91ef8cbb0..513fdc46ef3250e587a6b3746bbdb883be3f2bce 100644
--- a/dist/dts/Rpc.d.ts.map
+++ b/dist/dts/Rpc.d.ts.map
@@ -1 +1 @@
-{"version":3,"file":"Rpc.d.ts","sourceRoot":"","sources":["../../src/Rpc.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
+{"version":3,"file":"Rpc.d.ts","sourceRoot":"","sources":["../../src/Rpc.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
diff --git a/dist/dts/RpcClient.d.ts b/dist/dts/RpcClient.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..e633265abce741331337f7aab2337856388b76e1
--- /dev/null
+++ b/dist/dts/RpcClient.d.ts
@@ -0,0 +1,186 @@
+/**
+ * @since 1.0.0
+ */
+import * as Headers from "@effect/platform/Headers";
+import * as HttpClient from "@effect/platform/HttpClient";
+import * as Socket from "@effect/platform/Socket";
+import * as Worker from "@effect/platform/Worker";
+import type { WorkerError } from "@effect/platform/WorkerError";
+import * as Context from "effect/Context";
+import type * as Duration from "effect/Duration";
+import * as Effect from "effect/Effect";
+import * as FiberRef from "effect/FiberRef";
+import * as Layer from "effect/Layer";
+import * as Mailbox from "effect/Mailbox";
+import * as Scope from "effect/Scope";
+import * as Stream from "effect/Stream";
+import * as Rpc from "./Rpc.js";
+import type * as RpcGroup from "./RpcGroup.js";
+import type { FromClient, FromClientEncoded, FromServer, FromServerEncoded, RequestId } from "./RpcMessage.js";
+import * as RpcSerialization from "./RpcSerialization.js";
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export type RpcClient<Rpcs extends Rpc.Any, E = never> = {
+    readonly [Current in Rpcs as Current["_tag"]]: <const AsMailbox extends boolean = false, const Discard = false>(input: Rpc.PayloadConstructor<Current>, options?: Rpc.Success<Current> extends Stream.Stream<infer _A, infer _E, infer _R> ? {
+        readonly asMailbox?: AsMailbox | undefined;
+        readonly streamBufferSize?: number | undefined;
+        readonly headers?: Headers.Input | undefined;
+        readonly context?: Context.Context<never> | undefined;
+    } : {
+        readonly headers?: Headers.Input | undefined;
+        readonly context?: Context.Context<never> | undefined;
+        readonly discard?: Discard | undefined;
+    }) => Rpc.Success<Current> extends Stream.Stream<infer _A, infer _E, infer _R> ? AsMailbox extends true ? Effect.Effect<Mailbox.ReadonlyMailbox<_A, _E | Rpc.Error<Current> | E>, never, Scope.Scope> : Stream.Stream<_A, _E | Rpc.Error<Current> | E> : Effect.Effect<Discard extends true ? void : Rpc.Success<Current>, Discard extends true ? never : Rpc.Error<Current> | E>;
+};
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export type FromGroup<Group> = RpcClient<RpcGroup.Rpcs<Group>>;
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export declare const makeNoSerialization: <Rpcs extends Rpc.Any, E>(group: RpcGroup.RpcGroup<Rpcs>, options: {
+    readonly onFromClient: (options: {
+        readonly message: FromClient<Rpcs>;
+        readonly context: Context.Context<never>;
+        readonly discard: boolean;
+    }) => Effect.Effect<void, E>;
+    readonly supportsAck?: boolean | undefined;
+    readonly spanPrefix?: string | undefined;
+    readonly generateRequestId?: (() => RequestId) | undefined;
+    readonly disableTracing?: boolean | undefined;
+}) => Effect.Effect<{
+    readonly client: RpcClient<Rpcs, E>;
+    readonly write: (message: FromServer<Rpcs>) => Effect.Effect<void>;
+}, never, Scope.Scope | Rpc.MiddlewareClient<Rpcs>>;
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export declare const make: <Rpcs extends Rpc.Any>(group: RpcGroup.RpcGroup<Rpcs>, options?: {
+    readonly spanPrefix?: string | undefined;
+    readonly generateRequestId?: (() => RequestId) | undefined;
+    readonly disableTracing?: boolean | undefined;
+} | undefined) => Effect.Effect<RpcClient<Rpcs>, never, Protocol | Rpc.Context<Rpcs> | Rpc.MiddlewareClient<Rpcs> | Scope.Scope>;
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export declare const currentHeaders: FiberRef.FiberRef<Headers.Headers>;
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export declare const withHeaders: {
+    /**
+     * @since 1.0.0
+     * @category headers
+     */
+    (headers: Headers.Input): <A, E, R>(effect: Effect.Effect<A, E, R>) => Effect.Effect<A, E, R>;
+    /**
+     * @since 1.0.0
+     * @category headers
+     */
+    <A, E, R>(effect: Effect.Effect<A, E, R>, headers: Headers.Input): Effect.Effect<A, E, R>;
+};
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export declare const withHeadersEffect: {
+    /**
+     * @since 1.0.0
+     * @category headers
+     */
+    <E2, R2>(headers: Effect.Effect<Headers.Input, E2, R2>): <A, E, R>(effect: Effect.Effect<A, E, R>) => Effect.Effect<A, E | E2, R | R2>;
+    /**
+     * @since 1.0.0
+     * @category headers
+     */
+    <A, E, R, E2, R2>(effect: Effect.Effect<A, E, R>, headers: Effect.Effect<Headers.Input, E2, R2>): Effect.Effect<A, E | E2, R | R2>;
+};
+declare const Protocol_base: Context.TagClass<Protocol, "@effect/rpc/RpcClient/Protocol", {
+    readonly run: (f: (data: FromServerEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+    readonly send: (request: FromClientEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+    readonly supportsAck: boolean;
+    readonly supportsTransferables: boolean;
+}>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare class Protocol extends Protocol_base {
+    /**
+     * @since 1.0.0
+     */
+    static make: <EX, RX>(f: (write: (data: FromServerEncoded) => Effect.Effect<void>) => Effect.Effect<Omit<{
+        readonly run: (f: (data: FromServerEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+        readonly send: (request: FromClientEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+        readonly supportsAck: boolean;
+        readonly supportsTransferables: boolean;
+    }, "run">, EX, RX>) => Effect.Effect<{
+        readonly run: (f: (data: FromServerEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+        readonly send: (request: FromClientEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+        readonly supportsAck: boolean;
+        readonly supportsTransferables: boolean;
+    }, EX, RX>;
+}
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolHttp: (client: HttpClient.HttpClient) => Effect.Effect<Protocol["Type"], never, RpcSerialization.RpcSerialization>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const layerProtocolHttp: (options: {
+    readonly url: string;
+    readonly transformClient?: <E, R>(client: HttpClient.HttpClient.With<E, R>) => HttpClient.HttpClient.With<E, R>;
+}) => Layer.Layer<Protocol, never, RpcSerialization.RpcSerialization | HttpClient.HttpClient>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolSocket: Effect.Effect<Protocol["Type"], never, Scope.Scope | RpcSerialization.RpcSerialization | Socket.Socket>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolWorker: (options: {
+    readonly size: number;
+    readonly concurrency?: number | undefined;
+    readonly targetUtilization?: number | undefined;
+} | {
+    readonly minSize: number;
+    readonly maxSize: number;
+    readonly concurrency?: number | undefined;
+    readonly targetUtilization?: number | undefined;
+    readonly timeToLive: Duration.DurationInput;
+}) => Effect.Effect<Protocol["Type"], WorkerError, Scope.Scope | Worker.PlatformWorker | Worker.Spawner>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const layerProtocolWorker: (options: {
+    readonly size: number;
+    readonly concurrency?: number | undefined;
+    readonly targetUtilization?: number | undefined;
+} | {
+    readonly minSize: number;
+    readonly maxSize: number;
+    readonly concurrency?: number | undefined;
+    readonly targetUtilization?: number | undefined;
+    readonly timeToLive: Duration.DurationInput;
+}) => Layer.Layer<Protocol, WorkerError, Worker.PlatformWorker | Worker.Spawner>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const layerProtocolSocket: Layer.Layer<Protocol, never, Socket.Socket | RpcSerialization.RpcSerialization>;
+export {};
+//# sourceMappingURL=RpcClient.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcClient.d.ts.map b/dist/dts/RpcClient.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..3eacc6465f446bb1462f8edbdb5f749a04edfca5
--- /dev/null
+++ b/dist/dts/RpcClient.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcClient.d.ts","sourceRoot":"","sources":["../../src/RpcClient.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,OAAO,MAAM,0BAA0B,CAAA;AAEnD,OAAO,KAAK,UAAU,MAAM,6BAA6B,CAAA;AAEzD,OAAO,KAAK,MAAM,MAAM,yBAAyB,CAAA;AAEjD,OAAO,KAAK,MAAM,MAAM,yBAAyB,CAAA;AACjD,OAAO,KAAK,EAAE,WAAW,EAAE,MAAM,8BAA8B,CAAA;AAI/D,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AACzC,OAAO,KAAK,KAAK,QAAQ,MAAM,iBAAiB,CAAA;AAChD,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAIvC,OAAO,KAAK,QAAQ,MAAM,iBAAiB,CAAA;AAG3C,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AAMzC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAIvC,OAAO,KAAK,GAAG,MAAM,UAAU,CAAA;AAC/B,OAAO,KAAK,KAAK,QAAQ,MAAM,eAAe,CAAA;AAC9C,OAAO,KAAK,EAAE,UAAU,EAAE,iBAAiB,EAAE,UAAU,EAAE,iBAAiB,EAAW,SAAS,EAAE,MAAM,iBAAiB,CAAA;AAIvH,OAAO,KAAK,gBAAgB,MAAM,uBAAuB,CAAA;AAGzD;;;GAGG;AACH,MAAM,MAAM,SAAS,CAAC,IAAI,SAAS,GAAG,CAAC,GAAG,EAAE,CAAC,GAAG,KAAK,IAAI;IACvD,QAAQ,EAAE,OAAO,IAAI,IAAI,IAAI,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,SAAS,SAAS,OAAO,GAAG,KAAK,EAAE,KAAK,CAAC,OAAO,GAAG,KAAK,EAC5G,KAAK,EAAE,GAAG,CAAC,kBAAkB,CAAC,OAAO,CAAC,EACtC,OAAO,CAAC,EAAE,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,GAAG;QACjF,QAAQ,CAAC,SAAS,CAAC,EAAE,SAAS,GAAG,SAAS,CAAA;QAC1C,QAAQ,CAAC,gBAAgB,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;QAC9C,QAAQ,CAAC,OAAO,CAAC,EAAE,OAAO,CAAC,KAAK,GAAG,SAAS,CAAA;QAC5C,QAAQ,CAAC,OAAO,CAAC,EAAE,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,SAAS,CAAA;KACtD,GACD;QACE,QAAQ,CAAC,OAAO,CAAC,EAAE,OAAO,CAAC,KAAK,GAAG,SAAS,CAAA;QAC5C,QAAQ,CAAC,OAAO,CAAC,EAAE,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,GAAG,SAAS,CAAA;QACrD,QAAQ,CAAC,OAAO,CAAC,EAAE,OAAO,GAAG,SAAS,CAAA;KACvC,KACA,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,GACzE,SAAS,SAAS,IAAI,GAAG,MAAM,CAAC,MAAM,CACpC,OAAO,CAAC,eAAe,CAAC,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,EACxD,KAAK,EACL,KAAK,CAAC,KAAK,CACZ,GACD,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,GAC9C,MAAM,CAAC,MAAM,CACb,OAAO,SAAS,IAAI,GAAG,IAAI,GAAG,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,EAClD,OAAO,SAAS,IAAI,GAAG,KAAK,GAAG,GAAG,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,CACtD;CACJ,CAAA;AAED;;;GAGG;AACH,MAAM,MAAM,SAAS,CAAC,KAAK,IAAI,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAA;AAE9D;;;GAGG;AACH,eAAO,MAAM,mBAAmB,EAAE,CAAC,IAAI,SAAS,GAAG,CAAC,GAAG,EAAE,CAAC,EACxD,KAAK,EAAE,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,EAC9B,OAAO,EAAE;IACP,QAAQ,CAAC,YAAY,EAAE,CACrB,OAAO,EAAE;QACP,QAAQ,CAAC,OAAO,EAAE,UAAU,CAAC,IAAI,CAAC,CAAA;QAClC,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAA;QACxC,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;KAC1B,KACE,MAAM,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,CAAA;IAC3B,QAAQ,CAAC,WAAW,CAAC,EAAE,OAAO,GAAG,SAAS,CAAA;IAC1C,QAAQ,CAAC,UAAU,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IACxC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,CAAC,MAAM,SAAS,CAAC,GAAG,SAAS,CAAA;IAC1D,QAAQ,CAAC,cAAc,CAAC,EAAE,OAAO,GAAG,SAAS,CAAA;CAC9C,KACE,MAAM,CAAC,MAAM,CAChB;IACE,QAAQ,CAAC,MAAM,EAAE,SAAS,CAAC,IAAI,EAAE,CAAC,CAAC,CAAA;IACnC,QAAQ,CAAC,KAAK,EAAE,CAAC,OAAO,EAAE,UAAU,CAAC,IAAI,CAAC,KAAK,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;CACnE,EACD,KAAK,EACL,KAAK,CAAC,KAAK,GAAG,GAAG,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAyVxC,CAAA;AAEF;;;GAGG;AACH,eAAO,MAAM,IAAI,EAAE,CAAC,IAAI,SAAS,GAAG,CAAC,GAAG,EACtC,KAAK,EAAE,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,EAC9B,OAAO,CAAC,EAAE;IACR,QAAQ,CAAC,UAAU,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IACxC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,CAAC,MAAM,SAAS,CAAC,GAAG,SAAS,CAAA;IAC1D,QAAQ,CAAC,cAAc,CAAC,EAAE,OAAO,GAAG,SAAS,CAAA;CAC9C,GAAG,SAAS,KACV,MAAM,CAAC,MAAM,CAChB,SAAS,CAAC,IAAI,CAAC,EACf,KAAK,EACL,QAAQ,GAAG,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,GAAG,CAAC,gBAAgB,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,KAAK,CA0HvE,CAAA;AAIF;;;GAGG;AACH,eAAO,MAAM,cAAc,EAAE,QAAQ,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,CAG7D,CAAA;AAED;;;GAGG;AACH,eAAO,MAAM,WAAW,EAAE;IACxB;;;OAGG;IACH,CAAC,OAAO,EAAE,OAAO,CAAC,KAAK,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,KAAK,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAA;IAC7F;;;OAGG;IACH,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,EAAE,OAAO,EAAE,OAAO,CAAC,KAAK,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAA;CAK1F,CAAA;AAED;;;GAGG;AACH,eAAO,MAAM,iBAAiB,EAAE;IAC9B;;;OAGG;IACH,CAAC,EAAE,EAAE,EAAE,EACL,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,EAAE,EAAE,CAAC,GAC5C,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,KAAK,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,EAAE,CAAC,CAAA;IAChF;;;OAGG;IACH,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,EAAE,EAAE,EACd,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,EAC9B,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,EAAE,EAAE,CAAC,GAC5C,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,EAAE,CAAC,CAAA;CAOpC,CAAA;;kBAOe,CACZ,CAAC,EAAE,CAAC,IAAI,EAAE,iBAAiB,KAAK,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,KAChD,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC;mBACV,CACb,OAAO,EAAE,iBAAiB,EAC1B,aAAa,CAAC,EAAE,aAAa,CAAC,UAAU,CAAC,YAAY,CAAC,KACnD,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC;0BACF,OAAO;oCACG,OAAO;;AAbzC;;;GAGG;AACH,qBAAa,QAAS,SAAQ,aAU1B;IACF;;OAEG;IACH,MAAM,CAAC,IAAI,6BAZC,iBAAiB,KAAK,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC;sBADvC,CACZ,CAAC,EAAE,CAAC,IAAI,EAAE,iBAAiB,KAAK,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,KAChD,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC;uBACV,CACb,OAAO,EAAE,iBAAiB,EAC1B,aAAa,CAAC,EAAE,aAAa,CAAC,UAAU,CAAC,YAAY,CAAC,KACnD,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC;8BACF,OAAO;wCACG,OAAO;;sBARzB,CACZ,CAAC,EAAE,CAAC,IAAI,EAAE,iBAAiB,KAAK,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,KAChD,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC;uBACV,CACb,OAAO,EAAE,iBAAiB,EAC1B,aAAa,CAAC,EAAE,aAAa,CAAC,UAAU,CAAC,YAAY,CAAC,KACnD,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC;8BACF,OAAO;wCACG,OAAO;eAKE;CAC1C;AAED;;;GAGG;AACH,eAAO,MAAM,gBAAgB,WAAY,UAAU,CAAC,UAAU,KAAG,MAAM,CAAC,MAAM,CAC5E,QAAQ,CAAC,MAAM,CAAC,EAChB,KAAK,EACL,gBAAgB,CAAC,gBAAgB,CA6D9B,CAAA;AAEL;;;GAGG;AACH,eAAO,MAAM,iBAAiB,YAAa;IACzC,QAAQ,CAAC,GAAG,EAAE,MAAM,CAAA;IACpB,QAAQ,CAAC,eAAe,CAAC,EAAE,CAAC,CAAC,EAAE,CAAC,EAAE,MAAM,EAAE,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,KAAK,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,CAAC,CAAA;CAChH,KAAG,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,KAAK,EAAE,gBAAgB,CAAC,gBAAgB,GAAG,UAAU,CAAC,UAAU,CAUvF,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,kBAAkB,EAAE,MAAM,CAAC,MAAM,CAC5C,QAAQ,CAAC,MAAM,CAAC,EAChB,KAAK,EACL,KAAK,CAAC,KAAK,GAAG,gBAAgB,CAAC,gBAAgB,GAAG,MAAM,CAAC,MAAM,CA0D9D,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,kBAAkB,YACpB;IACP,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAA;IACrB,QAAQ,CAAC,WAAW,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IACzC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;CAChD,GAAG;IACF,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAA;IACxB,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAA;IACxB,QAAQ,CAAC,WAAW,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IACzC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IAC/C,QAAQ,CAAC,UAAU,EAAE,QAAQ,CAAC,aAAa,CAAA;CAC5C,KACA,MAAM,CAAC,MAAM,CACd,QAAQ,CAAC,MAAM,CAAC,EAChB,WAAW,EACX,KAAK,CAAC,KAAK,GAAG,MAAM,CAAC,cAAc,GAAG,MAAM,CAAC,OAAO,CA2HjD,CAAA;AAEL;;;GAGG;AACH,eAAO,MAAM,mBAAmB,YACrB;IACP,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAA;IACrB,QAAQ,CAAC,WAAW,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IACzC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;CAChD,GAAG;IACF,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAA;IACxB,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAA;IACxB,QAAQ,CAAC,WAAW,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IACzC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,MAAM,GAAG,SAAS,CAAA;IAC/C,QAAQ,CAAC,UAAU,EAAE,QAAQ,CAAC,aAAa,CAAA;CAC5C,KACA,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,WAAW,EAAE,MAAM,CAAC,cAAc,GAAG,MAAM,CAAC,OAAO,CACvB,CAAA;AAErD;;;GAGG;AACH,eAAO,MAAM,mBAAmB,EAAE,KAAK,CAAC,KAAK,CAAC,QAAQ,EAAE,KAAK,EAAE,MAAM,CAAC,MAAM,GAAG,gBAAgB,CAAC,gBAAgB,CACpE,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/RpcGroup.d.ts b/dist/dts/RpcGroup.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..93a40827a078c85c6058094a7c014ed2f2ed0b26
--- /dev/null
+++ b/dist/dts/RpcGroup.d.ts
@@ -0,0 +1,90 @@
+/**
+ * @since 1.0.0
+ */
+import type { Headers } from "@effect/platform/Headers";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import type { ReadonlyMailbox } from "effect/Mailbox";
+import { type Pipeable } from "effect/Pipeable";
+import type { Scope } from "effect/Scope";
+import type * as Stream from "effect/Stream";
+import * as Rpc from "./Rpc.js";
+import type * as RpcMiddleware from "./RpcMiddleware.js";
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export declare const TypeId: unique symbol;
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export type TypeId = typeof TypeId;
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export interface RpcGroup<in out Rpcs extends Rpc.Any> extends Pipeable {
+    new (_: never): {};
+    readonly [TypeId]: TypeId;
+    readonly requests: ReadonlyMap<string, Rpcs>;
+    readonly annotations: Context.Context<never>;
+    /**
+     * Add one or more procedures to the group.
+     */
+    add<const Rpcs2 extends ReadonlyArray<Rpc.Any>>(...rpcs: Rpcs2): RpcGroup<Rpcs | Rpcs2[number]>;
+    /**
+     * Merge this group with another group.
+     */
+    merge<Rpcs2 extends Rpc.Any>(that: RpcGroup<Rpcs2>): RpcGroup<Rpcs | Rpcs2>;
+    /**
+     * Add middleware to all the procedures added to the group until this point.
+     */
+    middleware<M extends RpcMiddleware.TagClassAny>(middleware: M): RpcGroup<Rpc.AddMiddleware<Rpcs, M>>;
+    /**
+     * Implement the handlers for the procedures in this group, returning a
+     * context object.
+     */
+    toHandlersContext<Handlers extends HandlersFrom<Rpcs>, EX = never, RX = never>(build: Handlers | Effect.Effect<Handlers, EX, RX>): Effect.Effect<Context.Context<Rpc.ToHandler<Rpcs>>, EX, RX | HandlersContext<Rpcs, Handlers>>;
+    /**
+     * Implement the handlers for the procedures in this group.
+     */
+    toLayer<Handlers extends HandlersFrom<Rpcs>, EX = never, RX = never>(build: Handlers | Effect.Effect<Handlers, EX, RX>): Layer.Layer<Rpc.ToHandler<Rpcs>, EX, Exclude<RX, Scope> | HandlersContext<Rpcs, Handlers>>;
+    /**
+     * Annotate the group with a value.
+     */
+    annotate<I, S>(tag: Context.Tag<I, S>, value: S): RpcGroup<Rpcs>;
+    /**
+     * Annotate the group with a context object.
+     */
+    annotateContext<S>(context: Context.Context<S>): RpcGroup<Rpcs>;
+}
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type HandlersFrom<Rpc extends Rpc.Any> = {
+    readonly [Current in Rpc as Current["_tag"]]: (payload: Rpc.Payload<Current>, headers: Headers) => ResultFrom<Current> | Rpc.Fork<ResultFrom<Current>>;
+};
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type ResultFrom<Rpc extends Rpc.Any> = Rpc.Success<Rpc> extends Stream.Stream<infer _A, infer _E, infer _R> ? Stream.Stream<_A, _E | Rpc.Error<Rpc>, any> | Effect.Effect<ReadonlyMailbox<_A, _E | Rpc.Error<Rpc>>, _E | Rpc.Error<Rpc>, any> : Effect.Effect<Rpc.Success<Rpc>, Rpc.Error<Rpc>, any>;
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type HandlersContext<Rpcs extends Rpc.Any, Handlers> = keyof Handlers extends infer K ? K extends keyof Handlers & string ? Handlers[K] extends (...args: any) => Stream.Stream<infer _A, infer _E, infer _R> | Effect.Effect<ReadonlyMailbox<infer _A, infer _E>, infer _EX, infer _R> ? Exclude<Rpc.ExcludeProvides<_R, Rpcs, K>, Scope> : Handlers[K] extends (...args: any) => Effect.Effect<infer _A, infer _E, infer _R> ? _R : never : never : never;
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type Rpcs<Group> = Group extends RpcGroup<infer R> ? R : never;
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export declare const make: <const Rpcs extends ReadonlyArray<Rpc.Any>>(...rpcs: Rpcs) => RpcGroup<Rpcs[number]>;
+//# sourceMappingURL=RpcGroup.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcGroup.d.ts.map b/dist/dts/RpcGroup.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..88dc75b3173188251c40d11a5814886df6bdce45
--- /dev/null
+++ b/dist/dts/RpcGroup.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcGroup.d.ts","sourceRoot":"","sources":["../../src/RpcGroup.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
diff --git a/dist/dts/RpcMessage.d.ts b/dist/dts/RpcMessage.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..15ee2a97e538c927e7becc1c5fcf5e9697f72e94
--- /dev/null
+++ b/dist/dts/RpcMessage.d.ts
@@ -0,0 +1,222 @@
+/**
+ * @since 1.0.0
+ */
+import type { Headers } from "@effect/platform/Headers";
+import type { NonEmptyReadonlyArray } from "effect/Array";
+import type { Branded } from "effect/Brand";
+import type * as FiberId from "effect/FiberId";
+import * as Schema from "effect/Schema";
+import type * as Rpc from "./Rpc.js";
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type FromClient<A extends Rpc.Any> = Request<A> | Ack | Interrupt | Eof;
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type FromClientEncoded = RequestEncoded | Ack | InterruptEncoded | Ping | Eof;
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export declare const RequestIdTypeId: unique symbol;
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type RequestIdTypeId = typeof RequestIdTypeId;
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type RequestId = Branded<bigint, RequestIdTypeId>;
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export declare const RequestId: (id: bigint | string) => RequestId;
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface RequestEncoded {
+    readonly _tag: "Request";
+    readonly id: bigint | string;
+    readonly tag: string;
+    readonly payload: unknown;
+    readonly traceId: string;
+    readonly spanId: string;
+    readonly sampled: boolean;
+    readonly headers: ReadonlyArray<[string, string]>;
+}
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Request<A extends Rpc.Any> {
+    readonly _tag: "Request";
+    readonly id: RequestId;
+    readonly tag: Rpc.Tag<A>;
+    readonly payload: Rpc.Payload<A>;
+    readonly traceId: string;
+    readonly spanId: string;
+    readonly sampled: boolean;
+    readonly headers: Headers;
+}
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Ack {
+    readonly _tag: "Ack";
+    readonly requestId: RequestId;
+}
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Interrupt {
+    readonly _tag: "Interrupt";
+    readonly requestId: RequestId;
+    readonly interruptors: ReadonlyArray<FiberId.FiberId>;
+}
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface InterruptEncoded {
+    readonly _tag: "Interrupt";
+    readonly requestId: RequestId;
+}
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Eof {
+    readonly _tag: "Eof";
+}
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Ping {
+    readonly _tag: "Ping";
+}
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export declare const constEof: Eof;
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export declare const constPing: Ping;
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type FromServer<A extends Rpc.Any> = ResponseChunk<A> | ResponseExit<A> | ResponseDefect | ClientEnd;
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type FromServerEncoded = ResponseChunkEncoded | ResponseExitEncoded | ResponseDefectEncoded | Pong;
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export declare const ResponseIdTypeId: unique symbol;
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type ResponseIdTypeId = typeof ResponseIdTypeId;
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type ResponseId = Branded<number, ResponseIdTypeId>;
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseChunkEncoded {
+    readonly _tag: "Chunk";
+    readonly requestId: bigint | string;
+    readonly values: NonEmptyReadonlyArray<unknown>;
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseChunk<A extends Rpc.Any> {
+    readonly _tag: "Chunk";
+    readonly clientId: number;
+    readonly requestId: RequestId;
+    readonly values: NonEmptyReadonlyArray<Rpc.SuccessChunk<A>>;
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseExitEncoded {
+    readonly _tag: "Exit";
+    readonly requestId: bigint | string;
+    readonly exit: Schema.ExitEncoded<unknown, unknown, unknown>;
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseExit<A extends Rpc.Any> {
+    readonly _tag: "Exit";
+    readonly clientId: number;
+    readonly requestId: RequestId;
+    readonly exit: Rpc.Exit<A>;
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseDefectEncoded {
+    readonly _tag: "Defect";
+    readonly defect: unknown;
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export declare const ResponseDefectEncoded: (input: unknown) => ResponseDefectEncoded;
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseDefect {
+    readonly _tag: "Defect";
+    readonly clientId: number;
+    readonly defect: unknown;
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ClientEnd {
+    readonly _tag: "ClientEnd";
+    readonly clientId: number;
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface Pong {
+    readonly _tag: "Pong";
+}
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export declare const constPong: Pong;
+//# sourceMappingURL=RpcMessage.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcMessage.d.ts.map b/dist/dts/RpcMessage.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..7b51b93b533f3dc272f0ca39d4184e8a6c12a435
--- /dev/null
+++ b/dist/dts/RpcMessage.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcMessage.d.ts","sourceRoot":"","sources":["../../src/RpcMessage.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,EAAE,OAAO,EAAE,MAAM,0BAA0B,CAAA;AACvD,OAAO,KAAK,EAAE,qBAAqB,EAAE,MAAM,cAAc,CAAA;AACzD,OAAO,KAAK,EAAE,OAAO,EAAE,MAAM,cAAc,CAAA;AAC3C,OAAO,KAAK,KAAK,OAAO,MAAM,gBAAgB,CAAA;AAC9C,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,KAAK,KAAK,GAAG,MAAM,UAAU,CAAA;AAEpC;;;GAGG;AACH,MAAM,MAAM,UAAU,CAAC,CAAC,SAAS,GAAG,CAAC,GAAG,IAAI,OAAO,CAAC,CAAC,CAAC,GAAG,GAAG,GAAG,SAAS,GAAG,GAAG,CAAA;AAE9E;;;GAGG;AACH,MAAM,MAAM,iBAAiB,GAAG,cAAc,GAAG,GAAG,GAAG,gBAAgB,GAAG,IAAI,GAAG,GAAG,CAAA;AAEpF;;;GAGG;AACH,eAAO,MAAM,eAAe,EAAE,OAAO,MAAsD,CAAA;AAE3F;;;GAGG;AACH,MAAM,MAAM,eAAe,GAAG,OAAO,eAAe,CAAA;AAEpD;;;GAGG;AACH,MAAM,MAAM,SAAS,GAAG,OAAO,CAAC,MAAM,EAAE,eAAe,CAAC,CAAA;AAExD;;;GAGG;AACH,eAAO,MAAM,SAAS,OAAQ,MAAM,GAAG,MAAM,KAAG,SACoB,CAAA;AAEpE;;;GAGG;AACH,MAAM,WAAW,cAAc;IAC7B,QAAQ,CAAC,IAAI,EAAE,SAAS,CAAA;IACxB,QAAQ,CAAC,EAAE,EAAE,MAAM,GAAG,MAAM,CAAA;IAC5B,QAAQ,CAAC,GAAG,EAAE,MAAM,CAAA;IACpB,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;IACzB,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAA;IACxB,QAAQ,CAAC,MAAM,EAAE,MAAM,CAAA;IACvB,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;IACzB,QAAQ,CAAC,OAAO,EAAE,aAAa,CAAC,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC,CAAA;CAClD;AAED;;;GAGG;AACH,MAAM,WAAW,OAAO,CAAC,CAAC,SAAS,GAAG,CAAC,GAAG;IACxC,QAAQ,CAAC,IAAI,EAAE,SAAS,CAAA;IACxB,QAAQ,CAAC,EAAE,EAAE,SAAS,CAAA;IACtB,QAAQ,CAAC,GAAG,EAAE,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAA;IACxB,QAAQ,CAAC,OAAO,EAAE,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,CAAA;IAChC,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAA;IACxB,QAAQ,CAAC,MAAM,EAAE,MAAM,CAAA;IACvB,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;IACzB,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;CAC1B;AAED;;;GAGG;AACH,MAAM,WAAW,GAAG;IAClB,QAAQ,CAAC,IAAI,EAAE,KAAK,CAAA;IACpB,QAAQ,CAAC,SAAS,EAAE,SAAS,CAAA;CAC9B;AAED;;;GAGG;AACH,MAAM,WAAW,SAAS;IACxB,QAAQ,CAAC,IAAI,EAAE,WAAW,CAAA;IAC1B,QAAQ,CAAC,SAAS,EAAE,SAAS,CAAA;IAC7B,QAAQ,CAAC,YAAY,EAAE,aAAa,CAAC,OAAO,CAAC,OAAO,CAAC,CAAA;CACtD;AAED;;;GAGG;AACH,MAAM,WAAW,gBAAgB;IAC/B,QAAQ,CAAC,IAAI,EAAE,WAAW,CAAA;IAC1B,QAAQ,CAAC,SAAS,EAAE,SAAS,CAAA;CAC9B;AAED;;;GAGG;AACH,MAAM,WAAW,GAAG;IAClB,QAAQ,CAAC,IAAI,EAAE,KAAK,CAAA;CACrB;AAED;;;GAGG;AACH,MAAM,WAAW,IAAI;IACnB,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAA;CACtB;AAED;;;GAGG;AACH,eAAO,MAAM,QAAQ,EAAE,GAAqB,CAAA;AAE5C;;;GAGG;AACH,eAAO,MAAM,SAAS,EAAE,IAAuB,CAAA;AAE/C;;;GAGG;AACH,MAAM,MAAM,UAAU,CAAC,CAAC,SAAS,GAAG,CAAC,GAAG,IACpC,aAAa,CAAC,CAAC,CAAC,GAChB,YAAY,CAAC,CAAC,CAAC,GACf,cAAc,GACd,SAAS,CAAA;AAEb;;;GAGG;AACH,MAAM,MAAM,iBAAiB,GAAG,oBAAoB,GAAG,mBAAmB,GAAG,qBAAqB,GAAG,IAAI,CAAA;AAEzG;;;GAGG;AACH,eAAO,MAAM,gBAAgB,EAAE,OAAO,MAAuD,CAAA;AAE7F;;;GAGG;AACH,MAAM,MAAM,gBAAgB,GAAG,OAAO,gBAAgB,CAAA;AAEtD;;;GAGG;AACH,MAAM,MAAM,UAAU,GAAG,OAAO,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAAA;AAE1D;;;GAGG;AACH,MAAM,WAAW,oBAAoB;IACnC,QAAQ,CAAC,IAAI,EAAE,OAAO,CAAA;IACtB,QAAQ,CAAC,SAAS,EAAE,MAAM,GAAG,MAAM,CAAA;IACnC,QAAQ,CAAC,MAAM,EAAE,qBAAqB,CAAC,OAAO,CAAC,CAAA;CAChD;AAED;;;GAGG;AACH,MAAM,WAAW,aAAa,CAAC,CAAC,SAAS,GAAG,CAAC,GAAG;IAC9C,QAAQ,CAAC,IAAI,EAAE,OAAO,CAAA;IACtB,QAAQ,CAAC,QAAQ,EAAE,MAAM,CAAA;IACzB,QAAQ,CAAC,SAAS,EAAE,SAAS,CAAA;IAC7B,QAAQ,CAAC,MAAM,EAAE,qBAAqB,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,CAAA;CAC5D;AAED;;;GAGG;AACH,MAAM,WAAW,mBAAmB;IAClC,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAA;IACrB,QAAQ,CAAC,SAAS,EAAE,MAAM,GAAG,MAAM,CAAA;IACnC,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAC,WAAW,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAA;CAC7D;AAED;;;GAGG;AACH,MAAM,WAAW,YAAY,CAAC,CAAC,SAAS,GAAG,CAAC,GAAG;IAC7C,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAA;IACrB,QAAQ,CAAC,QAAQ,EAAE,MAAM,CAAA;IACzB,QAAQ,CAAC,SAAS,EAAE,SAAS,CAAA;IAC7B,QAAQ,CAAC,IAAI,EAAE,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;CAC3B;AAED;;;GAGG;AACH,MAAM,WAAW,qBAAqB;IACpC,QAAQ,CAAC,IAAI,EAAE,QAAQ,CAAA;IACvB,QAAQ,CAAC,MAAM,EAAE,OAAO,CAAA;CACzB;AAID;;;GAGG;AACH,eAAO,MAAM,qBAAqB,UAAW,OAAO,KAAG,qBAGrD,CAAA;AAEF;;;GAGG;AACH,MAAM,WAAW,cAAc;IAC7B,QAAQ,CAAC,IAAI,EAAE,QAAQ,CAAA;IACvB,QAAQ,CAAC,QAAQ,EAAE,MAAM,CAAA;IACzB,QAAQ,CAAC,MAAM,EAAE,OAAO,CAAA;CACzB;AAED;;;GAGG;AACH,MAAM,WAAW,SAAS;IACxB,QAAQ,CAAC,IAAI,EAAE,WAAW,CAAA;IAC1B,QAAQ,CAAC,QAAQ,EAAE,MAAM,CAAA;CAC1B;AAED;;;GAGG;AACH,MAAM,WAAW,IAAI;IACnB,QAAQ,CAAC,IAAI,EAAE,MAAM,CAAA;CACtB;AAED;;;GAGG;AACH,eAAO,MAAM,SAAS,EAAE,IAAuB,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/RpcMiddleware.d.ts b/dist/dts/RpcMiddleware.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..25de8a8ab7d5ca570b9fcc179257b70155462406
--- /dev/null
+++ b/dist/dts/RpcMiddleware.d.ts
@@ -0,0 +1,180 @@
+/**
+ * @since 1.0.0
+ */
+import type { Headers } from "@effect/platform/Headers";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as Schema from "effect/Schema";
+import { Scope } from "effect/Scope";
+import type * as Rpc from "./Rpc.js";
+import type { Request } from "./RpcMessage.js";
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export declare const TypeId: unique symbol;
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export type TypeId = typeof TypeId;
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface RpcMiddleware<Provides, E> {
+    (options: {
+        readonly rpc: Rpc.AnyWithProps;
+        readonly payload: unknown;
+        readonly headers: Headers;
+    }): Effect.Effect<Provides, E>;
+}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface RpcMiddlewareClient<R = never> {
+    (options: {
+        readonly rpc: Rpc.AnyWithProps;
+        readonly request: Request<Rpc.Any>;
+    }): Effect.Effect<Request<Rpc.Any>, never, R>;
+}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface ForClient<Id> {
+    readonly _: unique symbol;
+    readonly id: Id;
+}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface Any {
+    (options: {
+        readonly rpc: Rpc.AnyWithProps;
+        readonly payload: unknown;
+        readonly headers: Headers;
+    }): Effect.Effect<any, any>;
+}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface TagClass<Self, Name extends string, Options> extends TagClass.Base<Self, Name, Options, RpcMiddleware<TagClass.Service<Options>, TagClass.FailureService<Options>>> {
+}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export declare namespace TagClass {
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type Provides<Options> = Options extends {
+        readonly provides: Context.Tag<any, any>;
+        readonly optional?: false;
+    } ? Context.Tag.Identifier<Options["provides"]> : never;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type Service<Options> = Options extends {
+        readonly provides: Context.Tag<any, any>;
+    } ? Context.Tag.Service<Options["provides"]> : void;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type FailureSchema<Options> = Options extends {
+        readonly failure: Schema.Schema.All;
+        readonly optional?: false;
+    } ? Options["failure"] : typeof Schema.Never;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type Failure<Options> = Options extends {
+        readonly failure: Schema.Schema<infer _A, infer _I, infer _R>;
+        readonly optional?: false;
+    } ? _A : never;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type FailureContext<Options> = Schema.Schema.Context<FailureSchema<Options>>;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type FailureService<Options> = Optional<Options> extends true ? unknown : Failure<Options>;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type Optional<Options> = Options extends {
+        readonly optional: true;
+    } ? true : false;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    type RequiredForClient<Options> = Options extends {
+        readonly requiredForClient: true;
+    } ? true : false;
+    /**
+     * @since 1.0.0
+     * @category models
+     */
+    interface Base<Self, Name extends string, Options, Service> extends Context.Tag<Self, Service> {
+        new (_: never): Context.TagClassShape<Name, Service>;
+        readonly [TypeId]: TypeId;
+        readonly optional: Optional<Options>;
+        readonly failure: FailureSchema<Options>;
+        readonly provides: Options extends {
+            readonly provides: Context.Tag<any, any>;
+        } ? Options["provides"] : undefined;
+        readonly requiredForClient: RequiredForClient<Options>;
+    }
+}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface TagClassAny extends Context.Tag<any, any> {
+    readonly [TypeId]: TypeId;
+    readonly optional: boolean;
+    readonly provides?: Context.Tag<any, any> | undefined;
+    readonly failure: Schema.Schema.All;
+    readonly requiredForClient: boolean;
+}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface TagClassAnyWithProps extends Context.Tag<any, RpcMiddleware<any, any>> {
+    readonly [TypeId]: TypeId;
+    readonly optional: boolean;
+    readonly provides?: Context.Tag<any, any>;
+    readonly failure: Schema.Schema.All;
+    readonly requiredForClient: boolean;
+}
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+export declare const Tag: <Self>() => <const Name extends string, const Options extends {
+    readonly optional?: boolean;
+    readonly failure?: Schema.Schema.All;
+    readonly provides?: Context.Tag<any, any>;
+    readonly requiredForClient?: boolean;
+}>(id: Name, options?: Options | undefined) => TagClass<Self, Name, Options>;
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export declare const layerClient: <Id, S, R, EX = never, RX = never>(tag: Context.Tag<Id, S>, service: RpcMiddlewareClient<R> | Effect.Effect<RpcMiddlewareClient<R>, EX, RX>) => Layer.Layer<ForClient<Id>, EX, R | Exclude<RX, Scope>>;
+//# sourceMappingURL=RpcMiddleware.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcMiddleware.d.ts.map b/dist/dts/RpcMiddleware.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..240631deb2f010a23e40b811decdd478b7de6c1f
--- /dev/null
+++ b/dist/dts/RpcMiddleware.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcMiddleware.d.ts","sourceRoot":"","sources":["../../src/RpcMiddleware.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,EAAE,OAAO,EAAE,MAAM,0BAA0B,CAAA;AACvD,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AACzC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,EAAE,KAAK,EAAE,MAAM,cAAc,CAAA;AAEpC,OAAO,KAAK,KAAK,GAAG,MAAM,UAAU,CAAA;AACpC,OAAO,KAAK,EAAE,OAAO,EAAE,MAAM,iBAAiB,CAAA;AAE9C;;;GAGG;AACH,eAAO,MAAM,MAAM,EAAE,OAAO,MAAgD,CAAA;AAE5E;;;GAGG;AACH,MAAM,MAAM,MAAM,GAAG,OAAO,MAAM,CAAA;AAElC;;;GAGG;AACH,MAAM,WAAW,aAAa,CAAC,QAAQ,EAAE,CAAC;IACxC,CAAC,OAAO,EAAE;QACR,QAAQ,CAAC,GAAG,EAAE,GAAG,CAAC,YAAY,CAAA;QAC9B,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;QACzB,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;KAC1B,GAAG,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAA;CAC/B;AAED;;;GAGG;AACH,MAAM,WAAW,mBAAmB,CAAC,CAAC,GAAG,KAAK;IAC5C,CAAC,OAAO,EAAE;QACR,QAAQ,CAAC,GAAG,EAAE,GAAG,CAAC,YAAY,CAAA;QAC9B,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;KACnC,GAAG,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,CAAA;CAC9C;AAED;;;GAGG;AACH,MAAM,WAAW,SAAS,CAAC,EAAE;IAC3B,QAAQ,CAAC,CAAC,EAAE,OAAO,MAAM,CAAA;IACzB,QAAQ,CAAC,EAAE,EAAE,EAAE,CAAA;CAChB;AAED;;;GAGG;AACH,MAAM,WAAW,GAAG;IAClB,CAAC,OAAO,EAAE;QACR,QAAQ,CAAC,GAAG,EAAE,GAAG,CAAC,YAAY,CAAA;QAC9B,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;QACzB,QAAQ,CAAC,OAAO,EAAE,OAAO,CAAA;KAC1B,GAAG,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;CAC5B;AAED;;;GAGG;AACH,MAAM,WAAW,QAAQ,CACvB,IAAI,EACJ,IAAI,SAAS,MAAM,EACnB,OAAO,CACP,SACA,QAAQ,CAAC,IAAI,CACX,IAAI,EACJ,IAAI,EACJ,OAAO,EACP,aAAa,CACX,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,EACzB,QAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,CACjC,CACF;CACD;AAEF;;;GAGG;AACH,MAAM,CAAC,OAAO,WAAW,QAAQ,CAAC;IAChC;;;OAGG;IACH,KAAY,QAAQ,CAAC,OAAO,IAAI,OAAO,SAAS;QAC9C,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;QACxC,QAAQ,CAAC,QAAQ,CAAC,EAAE,KAAK,CAAA;KAC1B,GAAG,OAAO,CAAC,GAAG,CAAC,UAAU,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,GAC3C,KAAK,CAAA;IAET;;;OAGG;IACH,KAAY,OAAO,CAAC,OAAO,IAAI,OAAO,SAAS;QAAE,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;KAAE,GACvF,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,GACxC,IAAI,CAAA;IAER;;;OAGG;IACH,KAAY,aAAa,CAAC,OAAO,IAAI,OAAO,SAC1C;QAAE,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC;QAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,KAAK,CAAA;KAAE,GAAG,OAAO,CAAC,SAAS,CAAC,GACrF,OAAO,MAAM,CAAC,KAAK,CAAA;IAEvB;;;OAGG;IACH,KAAY,OAAO,CAAC,OAAO,IAAI,OAAO,SACpC;QAAE,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,MAAM,EAAE,EAAE,MAAM,EAAE,CAAC,CAAC;QAAC,QAAQ,CAAC,QAAQ,CAAC,EAAE,KAAK,CAAA;KAAE,GAAG,EAAE,GAC/F,KAAK,CAAA;IAET;;;OAGG;IACH,KAAY,cAAc,CAAC,OAAO,IAAI,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC,CAAA;IAEnF;;;OAGG;IACH,KAAY,cAAc,CAAC,OAAO,IAAI,QAAQ,CAAC,OAAO,CAAC,SAAS,IAAI,GAAG,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC,CAAA;IAEjG;;;OAGG;IACH,KAAY,QAAQ,CAAC,OAAO,IAAI,OAAO,SAAS;QAAE,QAAQ,CAAC,QAAQ,EAAE,IAAI,CAAA;KAAE,GAAG,IAAI,GAAG,KAAK,CAAA;IAE1F;;;OAGG;IACH,KAAY,iBAAiB,CAAC,OAAO,IAAI,OAAO,SAAS;QAAE,QAAQ,CAAC,iBAAiB,EAAE,IAAI,CAAA;KAAE,GAAG,IAAI,GAAG,KAAK,CAAA;IAE5G;;;OAGG;IACH,UAAiB,IAAI,CAAC,IAAI,EAAE,IAAI,SAAS,MAAM,EAAE,OAAO,EAAE,OAAO,CAAE,SAAQ,OAAO,CAAC,GAAG,CAAC,IAAI,EAAE,OAAO,CAAC;QACnG,KAAI,CAAC,EAAE,KAAK,GAAG,OAAO,CAAC,aAAa,CAAC,IAAI,EAAE,OAAO,CAAC,CAAA;QACnD,QAAQ,CAAC,CAAC,MAAM,CAAC,EAAE,MAAM,CAAA;QACzB,QAAQ,CAAC,QAAQ,EAAE,QAAQ,CAAC,OAAO,CAAC,CAAA;QACpC,QAAQ,CAAC,OAAO,EAAE,aAAa,CAAC,OAAO,CAAC,CAAA;QACxC,QAAQ,CAAC,QAAQ,EAAE,OAAO,SAAS;YAAE,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;SAAE,GAAG,OAAO,CAAC,UAAU,CAAC,GACjG,SAAS,CAAA;QACb,QAAQ,CAAC,iBAAiB,EAAE,iBAAiB,CAAC,OAAO,CAAC,CAAA;KACvD;CACF;AAED;;;GAGG;AACH,MAAM,WAAW,WAAY,SAAQ,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC;IACxD,QAAQ,CAAC,CAAC,MAAM,CAAC,EAAE,MAAM,CAAA;IACzB,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAA;IAC1B,QAAQ,CAAC,QAAQ,CAAC,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,GAAG,SAAS,CAAA;IACrD,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAA;IACnC,QAAQ,CAAC,iBAAiB,EAAE,OAAO,CAAA;CACpC;AAED;;;GAGG;AACH,MAAM,WAAW,oBAAqB,SAAQ,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,aAAa,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;IACrF,QAAQ,CAAC,CAAC,MAAM,CAAC,EAAE,MAAM,CAAA;IACzB,QAAQ,CAAC,QAAQ,EAAE,OAAO,CAAA;IAC1B,QAAQ,CAAC,QAAQ,CAAC,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;IACzC,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAA;IACnC,QAAQ,CAAC,iBAAiB,EAAE,OAAO,CAAA;CACpC;AAED;;;GAGG;AACH,eAAO,MAAM,GAAG,GAAI,IAAI,OAAK,CAC3B,KAAK,CAAC,IAAI,SAAS,MAAM,EACzB,KAAK,CAAC,OAAO,SAAS;IACpB,QAAQ,CAAC,QAAQ,CAAC,EAAE,OAAO,CAAA;IAC3B,QAAQ,CAAC,OAAO,CAAC,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAA;IACpC,QAAQ,CAAC,QAAQ,CAAC,EAAE,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;IACzC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,OAAO,CAAA;CACrC,EAED,EAAE,EAAE,IAAI,EACR,OAAO,CAAC,EAAE,OAAO,GAAG,SAAS,KAC1B,QAAQ,CAAC,IAAI,EAAE,IAAI,EAAE,OAAO,CAiChC,CAAA;AAED;;;GAGG;AACH,eAAO,MAAM,WAAW,GAAI,EAAE,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,UAAU,EAAE,eAC7C,OAAO,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,CAAC,WACd,mBAAmB,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,MAAM,CAAC,mBAAmB,CAAC,CAAC,CAAC,EAAE,EAAE,EAAE,EAAE,CAAC,KAC9E,KAAK,CAAC,KAAK,CAAC,SAAS,CAAC,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,GAAG,OAAO,CAAC,EAAE,EAAE,KAAK,CAAC,CAgBnD,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/RpcResolverNoStream.d.ts.map b/dist/dts/RpcResolverNoStream.d.ts.map
index edcc9e92bb22031780c15fd0db5efddfb049c87a..659ddb5f07eb555161b80a3d9a2e3a38f098737a 100644
--- a/dist/dts/RpcResolverNoStream.d.ts.map
+++ b/dist/dts/RpcResolverNoStream.d.ts.map
@@ -1 +1 @@
-{"version":3,"file":"RpcResolverNoStream.d.ts","sourceRoot":"","sources":["../../src/RpcResolverNoStream.ts"],"names":[],"mappings":"AAMA,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAIvC,OAAO,KAAK,eAAe,MAAM,wBAAwB,CAAA;AACzD,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAGvC,OAAO,KAAK,KAAK,GAAG,MAAM,UAAU,CAAA;AACpC,OAAO,KAAK,KAAK,MAAM,MAAM,gBAAgB,CAAA;AAE7C;;;GAGG;AACH,eAAO,MAAM,IAAI,GAAI,EAAE,EAAE,CAAC,WACf,CAAC,CAAC,EAAE,aAAa,CAAC,OAAO,CAAC,KAAK,MAAM,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC,EAAE,EAAE,CAAC,MAEtE,CAAC,SAAS,MAAM,CAAC,SAAS,CAAC,GAAG,EAAE,GAAG,CAAC,OAAK,eAAe,CAAC,eAAe,CACvE,GAAG,CAAC,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,EACxC,MAAM,CAAC,sBAAsB,CAAC,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,CA4DxE,CAAA"}
\ No newline at end of file
+{"version":3,"file":"RpcResolverNoStream.d.ts","sourceRoot":"","sources":["../../src/RpcResolverNoStream.ts"],"names":[],"mappings":"AAMA,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAIvC,OAAO,KAAK,eAAe,MAAM,wBAAwB,CAAA;AACzD,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAGvC,OAAO,KAAK,KAAK,GAAG,MAAM,UAAU,CAAA;AACpC,OAAO,KAAK,KAAK,MAAM,MAAM,gBAAgB,CAAA;AAE7C;;;GAGG;AACH,eAAO,MAAM,IAAI,GAAI,EAAE,EAAE,CAAC,WACf,CAAC,CAAC,EAAE,aAAa,CAAC,OAAO,CAAC,KAAK,MAAM,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC,EAAE,EAAE,CAAC,MAEtE,CAAC,SAAS,MAAM,CAAC,SAAS,CAAC,GAAG,EAAE,GAAG,CAAC,OAAK,eAAe,CAAC,eAAe,CACvE,GAAG,CAAC,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,EACxC,MAAM,CAAC,sBAAsB,CAAC,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,CAgExE,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/RpcRouter.d.ts.map b/dist/dts/RpcRouter.d.ts.map
index 4d12b3f55cb0c8179f640de524d38545c8e47225..81fd6aee84686b31cd3fbbd13a62d2ed8b3485fb 100644
--- a/dist/dts/RpcRouter.d.ts.map
+++ b/dist/dts/RpcRouter.d.ts.map
@@ -1 +1 @@
-{"version":3,"file":"RpcRouter.d.ts","sourceRoot":"","sources":["../../src/RpcRouter.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
+{"version":3,"file":"RpcRouter.d.ts","sourceRoot":"","sources":["../../src/RpcRouter.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
diff --git a/dist/dts/RpcSchema.d.ts b/dist/dts/RpcSchema.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..d3c7e0a19f9860b6de262d614ee0e65373bc22ff
--- /dev/null
+++ b/dist/dts/RpcSchema.d.ts
@@ -0,0 +1,44 @@
+import * as Option from "effect/Option";
+import * as Schema from "effect/Schema";
+import * as AST from "effect/SchemaAST";
+import * as Stream_ from "effect/Stream";
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export declare const StreamSchemaId: unique symbol;
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export declare const isStreamSchema: (schema: Schema.Schema.All) => schema is Stream<any, any>;
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export declare const isStreamSerializable: (schema: Schema.WithResult.Any) => boolean;
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export declare const getStreamSchemas: (ast: AST.AST) => Option.Option<{
+    readonly success: Schema.Schema.Any;
+    readonly failure: Schema.Schema.All;
+}>;
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export interface Stream<A extends Schema.Schema.Any, E extends Schema.Schema.All> extends Schema.Schema<Stream_.Stream<A["Type"], E["Type"]>, Stream_.Stream<A["Encoded"], E["Encoded"]>, A["Context"] | E["Context"]> {
+    readonly success: A;
+    readonly failure: E;
+}
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export declare const Stream: <A extends Schema.Schema.Any, E extends Schema.Schema.All>({ failure, success }: {
+    readonly failure: E;
+    readonly success: A;
+}) => Stream<A, E>;
+//# sourceMappingURL=RpcSchema.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcSchema.d.ts.map b/dist/dts/RpcSchema.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..ce3583241a0be1391f6d1710d3e7db455acc5331
--- /dev/null
+++ b/dist/dts/RpcSchema.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcSchema.d.ts","sourceRoot":"","sources":["../../src/RpcSchema.ts"],"names":[],"mappings":"AAKA,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AAGvC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,KAAK,GAAG,MAAM,kBAAkB,CAAA;AACvC,OAAO,KAAK,OAAO,MAAM,eAAe,CAAA;AAExC;;;GAGG;AACH,eAAO,MAAM,cAAc,EAAE,OAAO,MAAmD,CAAA;AAEvF;;;GAGG;AACH,eAAO,MAAM,cAAc,WAAY,MAAM,CAAC,MAAM,CAAC,GAAG,KAAG,MAAM,IAAI,MAAM,CAAC,GAAG,EAAE,GAAG,CACf,CAAA;AAErE;;;GAGG;AACH,eAAO,MAAM,oBAAoB,WAAY,MAAM,CAAC,UAAU,CAAC,GAAG,KAAG,OACvB,CAAA;AAE9C;;;GAGG;AACH,eAAO,MAAM,gBAAgB,QACtB,GAAG,CAAC,GAAG,KACX,MAAM,CAAC,MAAM,CAAC;IACf,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAA;IACnC,QAAQ,CAAC,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,GAAG,CAAA;CACpC,CAA0G,CAAA;AAE3G;;;GAGG;AACH,MAAM,WAAW,MAAM,CAAC,CAAC,SAAS,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC,SAAS,MAAM,CAAC,MAAM,CAAC,GAAG,CAAE,SAChF,MAAM,CAAC,MAAM,CACX,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,EACpC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,SAAS,CAAC,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,EAC1C,CAAC,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,SAAS,CAAC,CAC5B;IAED,QAAQ,CAAC,OAAO,EAAE,CAAC,CAAA;IACnB,QAAQ,CAAC,OAAO,EAAE,CAAC,CAAA;CACpB;AAED;;;GAGG;AACH,eAAO,MAAM,MAAM,GAAI,CAAC,SAAS,MAAM,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC,SAAS,MAAM,CAAC,MAAM,CAAC,GAAG,wBACvD;IACpB,QAAQ,CAAC,OAAO,EAAE,CAAC,CAAA;IACnB,QAAQ,CAAC,OAAO,EAAE,CAAC,CAAA;CACpB,KACA,MAAM,CAAC,CAAC,EAAE,CAAC,CAyBX,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/RpcSerialization.d.ts b/dist/dts/RpcSerialization.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..e2ad70a3c3ba425d160f22dd0487ab6da80797c5
--- /dev/null
+++ b/dist/dts/RpcSerialization.d.ts
@@ -0,0 +1,69 @@
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+declare const RpcSerialization_base: Context.TagClass<RpcSerialization, "@effect/rpc/RpcSerialization", {
+    unsafeMake(): Parser;
+    readonly contentType: string;
+    readonly supportsBigInt: boolean;
+}>;
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export declare class RpcSerialization extends RpcSerialization_base {
+}
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export interface Parser {
+    readonly decode: (data: Uint8Array | string) => ReadonlyArray<unknown>;
+    readonly encode: (response: unknown) => Uint8Array | string;
+}
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export declare const json: Effect.Effect<RpcSerialization["Type"]>;
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export declare const ndjson: Effect.Effect<RpcSerialization["Type"]>;
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export declare const msgPack: RpcSerialization["Type"];
+/**
+ * A rpc serialization layer that uses JSON for serialization.
+ *
+ * Use this if your protocol supports framing for messages, otherwise use
+ * `layerSerializationNdjson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export declare const layerJson: Layer.Layer<RpcSerialization>;
+/**
+ * A rpc serialization layer that uses NDJSON for serialization.
+ *
+ * Use this if your protocol does not support framing for messages, otherwise
+ * use `layerSerializationJson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export declare const layerNdjson: Layer.Layer<RpcSerialization>;
+/**
+ * A rpc serialization layer that uses MessagePack for serialization.
+ *
+ * MessagePack has a more compact binary format compared to JSON and NDJSON. It
+ * also has better support for binary data.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export declare const layerMsgPack: Layer.Layer<RpcSerialization>;
+export {};
+//# sourceMappingURL=RpcSerialization.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcSerialization.d.ts.map b/dist/dts/RpcSerialization.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..9568622963e866233379112c2907f4a5372640f7
--- /dev/null
+++ b/dist/dts/RpcSerialization.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcSerialization.d.ts","sourceRoot":"","sources":["../../src/RpcSerialization.ts"],"names":[],"mappings":"AAIA,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AACzC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;;kBAOrB,MAAM;0BACE,MAAM;6BACH,OAAO;;AAPlC;;;GAGG;AACH,qBAAa,gBAAiB,SAAQ,qBAIlC;CAAG;AAEP;;;GAGG;AACH,MAAM,WAAW,MAAM;IACrB,QAAQ,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,UAAU,GAAG,MAAM,KAAK,aAAa,CAAC,OAAO,CAAC,CAAA;IACtE,QAAQ,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE,OAAO,KAAK,UAAU,GAAG,MAAM,CAAA;CAC5D;AAED;;;GAGG;AACH,eAAO,MAAM,IAAI,EAAE,MAAM,CAAC,MAAM,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAUvD,CAAA;AAEF;;;GAGG;AACH,eAAO,MAAM,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,gBAAgB,CAAC,MAAM,CAAC,CA0BzD,CAAA;AAEF;;;GAGG;AACH,eAAO,MAAM,OAAO,EAAE,gBAAgB,CAAC,MAAM,CAY3C,CAAA;AAEF;;;;;;;;GAQG;AACH,eAAO,MAAM,SAAS,EAAE,KAAK,CAAC,KAAK,CAAC,gBAAgB,CAAwC,CAAA;AAE5F;;;;;;;;GAQG;AACH,eAAO,MAAM,WAAW,EAAE,KAAK,CAAC,KAAK,CAAC,gBAAgB,CAA0C,CAAA;AAEhG;;;;;;;;GAQG;AACH,eAAO,MAAM,YAAY,EAAE,KAAK,CAAC,KAAK,CAAC,gBAAgB,CAA4C,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/RpcServer.d.ts b/dist/dts/RpcServer.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..a9771e77a23694f17b8c3b98710b9c63d68157a5
--- /dev/null
+++ b/dist/dts/RpcServer.d.ts
@@ -0,0 +1,211 @@
+import * as HttpApp from "@effect/platform/HttpApp";
+import * as HttpRouter from "@effect/platform/HttpRouter";
+import * as SocketServer from "@effect/platform/SocketServer";
+import type { WorkerError } from "@effect/platform/WorkerError";
+import * as WorkerRunner from "@effect/platform/WorkerRunner";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as Mailbox from "effect/Mailbox";
+import * as Option from "effect/Option";
+import * as Scope from "effect/Scope";
+import * as Rpc from "./Rpc.js";
+import type * as RpcGroup from "./RpcGroup.js";
+import { type FromClient, type FromClientEncoded, type FromServer, type FromServerEncoded } from "./RpcMessage.js";
+import * as RpcSerialization from "./RpcSerialization.js";
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export interface RpcServer<A extends Rpc.Any> {
+    readonly write: (clientId: number, message: FromClient<A>) => Effect.Effect<void>;
+    readonly disconnect: (clientId: number) => Effect.Effect<void>;
+}
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export declare const makeNoSerialization: <Rpcs extends Rpc.Any>(group: RpcGroup.RpcGroup<Rpcs>, options: {
+    readonly onFromServer: (response: FromServer<Rpcs>) => Effect.Effect<void>;
+    readonly disableSpanPropagation?: boolean | undefined;
+    readonly spanPrefix?: string | undefined;
+    readonly disableClientAcks?: boolean | undefined;
+    readonly concurrency?: number | "unbounded" | undefined;
+}) => Effect.Effect<RpcServer<Rpcs>, never, Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs> | Scope.Scope>;
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export declare const make: <Rpcs extends Rpc.Any>(group: RpcGroup.RpcGroup<Rpcs>, options?: {
+    readonly disableSpanPropagation?: boolean | undefined;
+    readonly spanPrefix?: string | undefined;
+    readonly concurrency?: number | "unbounded" | undefined;
+} | undefined) => Effect.Effect<never, never, Protocol | Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs>>;
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export declare const layer: <Rpcs extends Rpc.Any>(group: RpcGroup.RpcGroup<Rpcs>, options?: {
+    readonly disableSpanPropagation?: boolean | undefined;
+    readonly spanPrefix?: string | undefined;
+    readonly concurrency?: number | "unbounded" | undefined;
+}) => Layer.Layer<never, never, Protocol | Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs>>;
+declare const Protocol_base: Context.TagClass<Protocol, "@effect/rpc/RpcServer/Protocol", {
+    readonly run: (f: (clientId: number, data: FromClientEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+    readonly disconnects: Mailbox.ReadonlyMailbox<number>;
+    readonly send: (clientId: number, response: FromServerEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+    readonly end: (clientId: number) => Effect.Effect<void>;
+    readonly initialMessage: Effect.Effect<Option.Option<unknown>>;
+    readonly supportsAck: boolean;
+    readonly supportsTransferables: boolean;
+}>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare class Protocol extends Protocol_base {
+    /**
+     * @since 1.0.0
+     */
+    static make: <EX, RX>(f: (write: (clientId: number, data: FromClientEncoded) => Effect.Effect<void>) => Effect.Effect<Omit<{
+        readonly run: (f: (clientId: number, data: FromClientEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+        readonly disconnects: Mailbox.ReadonlyMailbox<number>;
+        readonly send: (clientId: number, response: FromServerEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+        readonly end: (clientId: number) => Effect.Effect<void>;
+        readonly initialMessage: Effect.Effect<Option.Option<unknown>>;
+        readonly supportsAck: boolean;
+        readonly supportsTransferables: boolean;
+    }, "run">, EX, RX>) => Effect.Effect<{
+        readonly run: (f: (clientId: number, data: FromClientEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+        readonly disconnects: Mailbox.ReadonlyMailbox<number>;
+        readonly send: (clientId: number, response: FromServerEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+        readonly end: (clientId: number) => Effect.Effect<void>;
+        readonly initialMessage: Effect.Effect<Option.Option<unknown>>;
+        readonly supportsAck: boolean;
+        readonly supportsTransferables: boolean;
+    }, EX, RX>;
+}
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolSocketServer: Effect.Effect<{
+    readonly run: (f: (clientId: number, data: FromClientEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+    readonly disconnects: Mailbox.ReadonlyMailbox<number>;
+    readonly send: (clientId: number, response: FromServerEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+    readonly end: (clientId: number) => Effect.Effect<void>;
+    readonly initialMessage: Effect.Effect<Option.Option<unknown>>;
+    readonly supportsAck: boolean;
+    readonly supportsTransferables: boolean;
+}, never, Scope.Scope | RpcSerialization.RpcSerialization | SocketServer.SocketServer>;
+/**
+ * A rpc protocol that uses `SocketServer` for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const layerProtocolSocketServer: Layer.Layer<Protocol, never, RpcSerialization.RpcSerialization | SocketServer.SocketServer>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolWithHttpAppWebsocket: Effect.Effect<{
+    readonly protocol: Protocol["Type"];
+    readonly httpApp: HttpApp.Default<never, Scope.Scope>;
+}, never, RpcSerialization.RpcSerialization>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolWebsocket: <I = HttpRouter.Default>(options: {
+    readonly path: HttpRouter.PathInput;
+    readonly routerTag?: Context.Tag<I, HttpRouter.HttpRouter.Service<any, any>>;
+}) => Effect.Effect<Protocol["Type"], never, RpcSerialization.RpcSerialization | I>;
+/**
+ * A rpc protocol that uses websockets for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const layerProtocolWebsocket: <I = HttpRouter.Default>(options: {
+    readonly path: HttpRouter.PathInput;
+    readonly routerTag?: HttpRouter.HttpRouter.TagClass<I, string, any, any>;
+}) => Layer.Layer<Protocol, never, RpcSerialization.RpcSerialization>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolWithHttpApp: Effect.Effect<{
+    readonly protocol: Protocol["Type"];
+    readonly httpApp: HttpApp.Default<never, Scope.Scope>;
+}, never, RpcSerialization.RpcSerialization>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolHttp: <I = HttpRouter.Default>(options: {
+    readonly path: HttpRouter.PathInput;
+    readonly routerTag?: HttpRouter.HttpRouter.TagClass<I, string, any, any>;
+}) => Effect.Effect<{
+    readonly run: (f: (clientId: number, data: FromClientEncoded) => Effect.Effect<void>) => Effect.Effect<never>;
+    readonly disconnects: Mailbox.ReadonlyMailbox<number>;
+    readonly send: (clientId: number, response: FromServerEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => Effect.Effect<void>;
+    readonly end: (clientId: number) => Effect.Effect<void>;
+    readonly initialMessage: Effect.Effect<Option.Option<unknown>>;
+    readonly supportsAck: boolean;
+    readonly supportsTransferables: boolean;
+}, never, RpcSerialization.RpcSerialization | I>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const makeProtocolWorkerRunner: Effect.Effect<Protocol["Type"], WorkerError, WorkerRunner.PlatformRunner | Scope.Scope>;
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const layerProtocolWorkerRunner: Layer.Layer<Protocol, WorkerError, WorkerRunner.PlatformRunner>;
+/**
+ * A rpc protocol that uses streaming http for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export declare const layerProtocolHttp: <I = HttpRouter.Default>(options: {
+    readonly path: HttpRouter.PathInput;
+    readonly routerTag?: HttpRouter.HttpRouter.TagClass<I, string, any, any>;
+}) => Layer.Layer<Protocol, never, RpcSerialization.RpcSerialization>;
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+export declare const toHttpApp: <Rpcs extends Rpc.Any>(group: RpcGroup.RpcGroup<Rpcs>, options?: {
+    readonly disableSpanPropagation?: boolean | undefined;
+    readonly spanPrefix?: string | undefined;
+} | undefined) => Effect.Effect<HttpApp.Default<never, Scope.Scope>, never, Scope.Scope | RpcSerialization.RpcSerialization | Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs>>;
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+export declare const toHttpAppWebsocket: <Rpcs extends Rpc.Any>(group: RpcGroup.RpcGroup<Rpcs>, options?: {
+    readonly disableSpanPropagation?: boolean | undefined;
+    readonly spanPrefix?: string | undefined;
+} | undefined) => Effect.Effect<HttpApp.Default<never, Scope.Scope>, never, Scope.Scope | RpcSerialization.RpcSerialization | Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs>>;
+/**
+ * Construct an http web handler from an `RpcGroup`.
+ *
+ * @since 1.0.0
+ * @category constructors
+ */
+export declare const toWebHandler: <Rpcs extends Rpc.Any, LE>(group: RpcGroup.RpcGroup<Rpcs>, options: {
+    readonly layer: Layer.Layer<Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs> | RpcSerialization.RpcSerialization | HttpRouter.HttpRouter.DefaultServices, LE>;
+    readonly disableSpanPropagation?: boolean | undefined;
+    readonly spanPrefix?: string | undefined;
+    readonly middleware?: (httpApp: HttpApp.Default) => HttpApp.Default<never, HttpRouter.HttpRouter.DefaultServices>;
+    readonly memoMap?: Layer.MemoMap;
+}) => {
+    readonly handler: (request: globalThis.Request, context?: Context.Context<never> | undefined) => Promise<Response>;
+    readonly dispose: () => Promise<void>;
+};
+export {};
+//# sourceMappingURL=RpcServer.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcServer.d.ts.map b/dist/dts/RpcServer.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..5259f6354bbfd31bdac63cb194ac7c4a8194a601
--- /dev/null
+++ b/dist/dts/RpcServer.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcServer.d.ts","sourceRoot":"","sources":["../../src/RpcServer.ts"],"names":[],"mappings":"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"}
\ No newline at end of file
diff --git a/dist/dts/RpcTest.d.ts b/dist/dts/RpcTest.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..375d57de11c0df9ee7f8aa3f1cde2b01a23eaec8
--- /dev/null
+++ b/dist/dts/RpcTest.d.ts
@@ -0,0 +1,14 @@
+/**
+ * @since 1.0.0
+ */
+import * as Effect from "effect/Effect";
+import type * as Scope from "effect/Scope";
+import type * as Rpc from "./Rpc.js";
+import * as RpcClient from "./RpcClient.js";
+import type * as RpcGroup from "./RpcGroup.js";
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export declare const makeClient: <Rpcs extends Rpc.Any>(group: RpcGroup.RpcGroup<Rpcs>) => Effect.Effect<RpcClient.RpcClient<Rpcs>, never, Scope.Scope | Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs> | Rpc.MiddlewareClient<Rpcs>>;
+//# sourceMappingURL=RpcTest.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcTest.d.ts.map b/dist/dts/RpcTest.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..2818d099369f90704c18e67a7f1ba64ffe3ed458
--- /dev/null
+++ b/dist/dts/RpcTest.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcTest.d.ts","sourceRoot":"","sources":["../../src/RpcTest.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,KAAK,KAAK,KAAK,MAAM,cAAc,CAAA;AAC1C,OAAO,KAAK,KAAK,GAAG,MAAM,UAAU,CAAA;AACpC,OAAO,KAAK,SAAS,MAAM,gBAAgB,CAAA;AAC3C,OAAO,KAAK,KAAK,QAAQ,MAAM,eAAe,CAAA;AAG9C;;;GAGG;AACH,eAAO,MAAM,UAAU,EAAE,CAAC,IAAI,SAAS,GAAG,CAAC,GAAG,EAC5C,KAAK,EAAE,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,KAC3B,MAAM,CAAC,MAAM,CAChB,SAAS,CAAC,SAAS,CAAC,IAAI,CAAC,EACzB,KAAK,EACL,KAAK,CAAC,KAAK,GAAG,GAAG,CAAC,SAAS,CAAC,IAAI,CAAC,GAAG,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,GAAG,GAAG,CAAC,gBAAgB,CAAC,IAAI,CAAC,CAkBrF,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/RpcWorker.d.ts b/dist/dts/RpcWorker.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..bfcb8d162b738b30cc2c743086b7cd76cc897406
--- /dev/null
+++ b/dist/dts/RpcWorker.d.ts
@@ -0,0 +1,45 @@
+import type { NoSuchElementException } from "effect/Cause";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import type { ParseError } from "effect/ParseResult";
+import * as Schema from "effect/Schema";
+import type { Protocol } from "./RpcServer.js";
+declare const InitialMessage_base: Context.TagClass<InitialMessage, "@effect/rpc/RpcWorker/InitialMessage", Effect.Effect<readonly [data: unknown, transfers: readonly Transferable[]], never, never>>;
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export declare class InitialMessage extends InitialMessage_base {
+}
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export declare namespace InitialMessage {
+    /**
+     * @since 1.0.0
+     * @category initial message
+     */
+    interface Encoded {
+        readonly _tag: "InitialMessage";
+        readonly value: unknown;
+    }
+}
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export declare const makeInitialMessage: <A, I, R, E, R2>(schema: Schema.Schema<A, I, R>, effect: Effect.Effect<A, E, R2>) => Effect.Effect<readonly [data: unknown, transferables: ReadonlyArray<globalThis.Transferable>], E | ParseError, R | R2>;
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export declare const layerInitialMessage: <A, I, R, R2>(schema: Schema.Schema<A, I, R>, build: Effect.Effect<A, never, R2>) => Layer.Layer<InitialMessage, never, R | R2>;
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export declare const initialMessage: <A, I, R>(schema: Schema.Schema<A, I, R>) => Effect.Effect<A, NoSuchElementException | ParseError, Protocol | R>;
+export {};
+//# sourceMappingURL=RpcWorker.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/RpcWorker.d.ts.map b/dist/dts/RpcWorker.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..1fcff3a5619eeb773a25714ba0e63a13dc03b107
--- /dev/null
+++ b/dist/dts/RpcWorker.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcWorker.d.ts","sourceRoot":"","sources":["../../src/RpcWorker.ts"],"names":[],"mappings":"AAIA,OAAO,KAAK,EAAE,sBAAsB,EAAE,MAAM,cAAc,CAAA;AAC1D,OAAO,KAAK,OAAO,MAAM,gBAAgB,CAAA;AACzC,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,KAAK,EAAE,UAAU,EAAE,MAAM,oBAAoB,CAAA;AACpD,OAAO,KAAK,MAAM,MAAM,eAAe,CAAA;AACvC,OAAO,KAAK,EAAE,QAAQ,EAAE,MAAM,gBAAgB,CAAA;;AAE9C;;;GAGG;AACH,qBAAa,cAAe,SAAQ,mBAQjC;CAAG;AAEN;;;GAGG;AACH,MAAM,CAAC,OAAO,WAAW,cAAc,CAAC;IACtC;;;OAGG;IACH,UAAiB,OAAO;QACtB,QAAQ,CAAC,IAAI,EAAE,gBAAgB,CAAA;QAC/B,QAAQ,CAAC,KAAK,EAAE,OAAO,CAAA;KACxB;CACF;AAID;;;GAGG;AACH,eAAO,MAAM,kBAAkB,GAAI,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,UACvC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,UACtB,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,KAC9B,MAAM,CAAC,MAAM,CACd,SAAS,CAAC,IAAI,EAAE,OAAO,EAAE,aAAa,EAAE,aAAa,CAAC,UAAU,CAAC,YAAY,CAAC,CAAC,EAC/E,CAAC,GAAG,UAAU,EACd,CAAC,GAAG,EAAE,CAQJ,CAAA;AAEJ;;;GAGG;AACH,eAAO,MAAM,mBAAmB,GAAI,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,EAAE,UACrC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,SACvB,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,KAAK,EAAE,EAAE,CAAC,KACjC,KAAK,CAAC,KAAK,CAAC,cAAc,EAAE,KAAK,EAAE,CAAC,GAAG,EAAE,CAMzC,CAAA;AAEH;;;GAGG;AACH,eAAO,MAAM,cAAc,GAAI,CAAC,EAAE,CAAC,EAAE,CAAC,UAC5B,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,KAC7B,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,sBAAsB,GAAG,UAAU,EAAE,QAAQ,GAAG,CAAC,CAKlE,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/index.d.ts b/dist/dts/index.d.ts
index 6fbf32b72167941044d14670e86fdc157ecd85d9..094390da9086d2fed5ff80522095c9942dae0a02 100644
--- a/dist/dts/index.d.ts
+++ b/dist/dts/index.d.ts
@@ -5,13 +5,37 @@ export * as Rpc from "./Rpc.js";
 /**
  * @since 1.0.0
  */
-export * as RpcResolver from "./RpcResolver.js";
+export * as RpcClient from "./RpcClient.js";
 /**
  * @since 1.0.0
  */
-export * as RpcResolverNoStream from "./RpcResolverNoStream.js";
+export * as RpcGroup from "./RpcGroup.js";
 /**
  * @since 1.0.0
  */
-export * as RpcRouter from "./RpcRouter.js";
+export * as RpcMessage from "./RpcMessage.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcMiddleware from "./RpcMiddleware.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcSchema from "./RpcSchema.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcSerialization from "./RpcSerialization.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcServer from "./RpcServer.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcTest from "./RpcTest.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcWorker from "./RpcWorker.js";
 //# sourceMappingURL=index.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/index.d.ts.map b/dist/dts/index.d.ts.map
index 39ebfc50fb7607423585cce9f1d1051d8785f253..878530b5d20bccc53b9eb107e6fac2a39e98eb8e 100644
--- a/dist/dts/index.d.ts.map
+++ b/dist/dts/index.d.ts.map
@@ -1 +1 @@
-{"version":3,"file":"index.d.ts","sourceRoot":"","sources":["../../src/index.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,GAAG,MAAM,UAAU,CAAA;AAE/B;;GAEG;AACH,OAAO,KAAK,WAAW,MAAM,kBAAkB,CAAA;AAE/C;;GAEG;AACH,OAAO,KAAK,mBAAmB,MAAM,0BAA0B,CAAA;AAE/D;;GAEG;AACH,OAAO,KAAK,SAAS,MAAM,gBAAgB,CAAA"}
\ No newline at end of file
+{"version":3,"file":"index.d.ts","sourceRoot":"","sources":["../../src/index.ts"],"names":[],"mappings":"AAAA;;GAEG;AACH,OAAO,KAAK,GAAG,MAAM,UAAU,CAAA;AAE/B;;GAEG;AACH,OAAO,KAAK,SAAS,MAAM,gBAAgB,CAAA;AAE3C;;GAEG;AACH,OAAO,KAAK,QAAQ,MAAM,eAAe,CAAA;AAEzC;;GAEG;AACH,OAAO,KAAK,UAAU,MAAM,iBAAiB,CAAA;AAE7C;;GAEG;AACH,OAAO,KAAK,aAAa,MAAM,oBAAoB,CAAA;AAEnD;;GAEG;AACH,OAAO,KAAK,SAAS,MAAM,gBAAgB,CAAA;AAE3C;;GAEG;AACH,OAAO,KAAK,gBAAgB,MAAM,uBAAuB,CAAA;AAEzD;;GAEG;AACH,OAAO,KAAK,SAAS,MAAM,gBAAgB,CAAA;AAE3C;;GAEG;AACH,OAAO,KAAK,OAAO,MAAM,cAAc,CAAA;AAEvC;;GAEG;AACH,OAAO,KAAK,SAAS,MAAM,gBAAgB,CAAA"}
\ No newline at end of file
diff --git a/dist/dts/internal/utils.d.ts b/dist/dts/internal/utils.d.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9c5cca70c8e02d0b305ca11b5f8b08febb270a7b
--- /dev/null
+++ b/dist/dts/internal/utils.d.ts
@@ -0,0 +1,2 @@
+export {};
+//# sourceMappingURL=utils.d.ts.map
\ No newline at end of file
diff --git a/dist/dts/internal/utils.d.ts.map b/dist/dts/internal/utils.d.ts.map
new file mode 100644
index 0000000000000000000000000000000000000000..7fef0f5d45ae0da3c44ec406aaaf377c9046b9ae
--- /dev/null
+++ b/dist/dts/internal/utils.d.ts.map
@@ -0,0 +1 @@
+{"version":3,"file":"utils.d.ts","sourceRoot":"","sources":["../../../src/internal/utils.ts"],"names":[],"mappings":""}
\ No newline at end of file
diff --git a/dist/esm/Rpc.js b/dist/esm/Rpc.js
index 89cd957cf6b6386c0ce07946abd18fcb78cefe6e..57a3104b3160da87d790ca49949da977c78847b8 100644
--- a/dist/esm/Rpc.js
+++ b/dist/esm/Rpc.js
@@ -1,16 +1,10 @@
-/**
- * @since 1.0.0
- */
-import * as Headers from "@effect/platform/Headers";
-import * as Effect from "effect/Effect";
-import * as FiberRef from "effect/FiberRef";
-import { dual, pipe } from "effect/Function";
+import * as Context_ from "effect/Context";
 import { globalValue } from "effect/GlobalValue";
+import * as Option from "effect/Option";
 import { pipeArguments } from "effect/Pipeable";
 import * as Predicate from "effect/Predicate";
 import * as Schema from "effect/Schema";
-import * as Stream from "effect/Stream";
-import * as Internal from "./internal/rpc.js";
+import * as RpcSchema from "./RpcSchema.js";
 /**
  * @since 1.0.0
  * @category type ids
@@ -18,121 +12,127 @@ import * as Internal from "./internal/rpc.js";
 export const TypeId = /*#__PURE__*/Symbol.for("@effect/rpc/Rpc");
 /**
  * @since 1.0.0
- * @category refinements
+ * @category guards
  */
 export const isRpc = u => Predicate.hasProperty(u, TypeId);
-/**
- * @since 1.0.0
- * @category constructors
- */
-export const effect = (schema, handler) => ({
+const Proto = {
   [TypeId]: TypeId,
-  _tag: "Effect",
-  schema,
-  handler,
   pipe() {
     return pipeArguments(this, arguments);
+  },
+  setSuccess(successSchema) {
+    return makeProto({
+      ...this,
+      successSchema
+    });
+  },
+  setError(errorSchema) {
+    return makeProto({
+      ...this,
+      errorSchema
+    });
+  },
+  setPayload(payloadSchema) {
+    return makeProto({
+      ...this,
+      payloadSchema: Schema.isSchema(payloadSchema) ? payloadSchema : Schema.Struct(payloadSchema)
+    });
+  },
+  middleware(middleware) {
+    return makeProto({
+      ...this,
+      middlewares: new Set([...this.middlewares, middleware])
+    });
+  },
+  annotate(tag, value) {
+    return makeProto({
+      ...this,
+      annotations: Context_.add(this.annotations, tag, value)
+    });
+  },
+  annotateContext(context) {
+    return makeProto({
+      ...this,
+      annotations: Context_.merge(this.annotations, context)
+    });
   }
-});
-/**
- * @since 1.0.0
- * @category type ids
- */
-export const StreamRequestTypeId = Internal.StreamRequestTypeId;
-/**
- * @since 1.0.0
- * @category schemas
- */
-export const StreamRequest = () => (tag, options) => {
-  return class extends Schema.TaggedRequest()(tag, options) {
-    constructor(props, disableValidation) {
-      super(props, disableValidation);
-      this[Internal.StreamRequestTypeId] = Internal.StreamRequestTypeId;
-    }
-  };
 };
+const makeProto = options => {
+  const self = Object.assign(Object.create(Proto), options);
+  self.key = `@effect/rpc/Rpc/${options._tag}`;
+  return self;
+};
+const constEmptyStruct = /*#__PURE__*/Schema.Struct({});
 /**
  * @since 1.0.0
  * @category constructors
  */
-export const stream = (schema, handler) => ({
-  [TypeId]: TypeId,
-  _tag: "Stream",
-  schema: schema,
-  handler,
-  pipe() {
-    return pipeArguments(this, arguments);
-  }
-});
-/**
- * @since 1.0.0
- * @category schemas
- */
-export const RequestSchema = schema => Schema.Struct({
-  request: schema,
-  traceId: Schema.String,
-  spanId: Schema.String,
-  sampled: Schema.Boolean,
-  headers: Schema.Record({
-    key: Schema.String,
-    value: Schema.String
-  })
-});
-/**
- * @since 1.0.0
- * @category headers
- */
-export const currentHeaders = /*#__PURE__*/globalValue("@effect/rpc/Rpc/currentHeaders", () => FiberRef.unsafeMake(Headers.empty));
+export const make = (tag, options) => {
+  const successSchema = options?.success ?? Schema.Void;
+  const errorSchema = options?.error ?? Schema.Never;
+  return makeProto({
+    _tag: tag,
+    payloadSchema: Schema.isSchema(options?.payload) ? options?.payload : options?.payload ? Schema.Struct(options?.payload) : constEmptyStruct,
+    successSchema: options?.stream ? RpcSchema.Stream({
+      success: successSchema,
+      failure: errorSchema
+    }) : successSchema,
+    errorSchema: options?.stream ? Schema.Never : errorSchema,
+    annotations: Context_.empty(),
+    middlewares: new Set()
+  });
+};
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-export const annotateHeaders = /*#__PURE__*/dual(2, (self, headers) => {
-  const resolved = Headers.fromInput(headers);
-  return Effect.locallyWith(self, currentHeaders, prev => ({
-    ...prev,
-    ...resolved
-  }));
+export const fromTaggedRequest = schema => makeProto({
+  _tag: schema._tag,
+  payloadSchema: schema,
+  successSchema: schema.success,
+  errorSchema: schema.failure,
+  annotations: Context_.empty(),
+  middlewares: new Set()
 });
+const exitSchemaCache = /*#__PURE__*/globalValue("@effect/rpc/Rpc/exitSchemaCache", () => new WeakMap());
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-export const schemaHeaders = schema => {
-  const decode = Schema.decodeUnknown(schema);
-  return Effect.flatMap(FiberRef.get(currentHeaders), decode);
+export const exitSchema = self => {
+  if (exitSchemaCache.has(self)) {
+    return exitSchemaCache.get(self);
+  }
+  const rpc = self;
+  const streamSchemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast);
+  const schema = Schema.Exit({
+    success: Option.isSome(streamSchemas) ? Schema.Void : rpc.successSchema,
+    failure: Option.isSome(streamSchemas) ? Schema.Union(streamSchemas.value.failure, rpc.errorSchema) : rpc.errorSchema,
+    defect: Schema.Defect
+  });
+  exitSchemaCache.set(self, schema);
+  return schema;
 };
 /**
  * @since 1.0.0
- * @category requests
+ * @category Fork
  */
-export const request = (request, options) => pipe(Effect.makeSpanScoped(`${options?.spanPrefix ?? "Rpc.request "}${request._tag}`, {
-  kind: "client",
-  captureStackTrace: false
-}), Effect.zip(FiberRef.get(currentHeaders)), Effect.map(([span, headers]) => Internal.makeRequest({
-  request,
-  traceId: span.traceId,
-  spanId: span.spanId,
-  sampled: span.sampled,
-  headers
-})));
+export const ForkTypeId = /*#__PURE__*/Symbol.for("@effect/rpc/Rpc/Fork");
 /**
+ * You can use `fork` to wrap a response Effect or Stream, to ensure that the
+ * response is executed concurrently regardless of the RpcServer concurrency
+ * setting.
+ *
  * @since 1.0.0
- * @category requests
+ * @category Fork
  */
-export const call = (req, resolver, options) => {
-  const isStream = Internal.StreamRequestTypeId in req;
-  const res = pipe(request(req, options), Effect.flatMap(_ => Effect.request(_, resolver)));
-  return isStream ? Stream.unwrapScoped(res) : Effect.scoped(res);
-};
-/**
- * @since 1.0.0
- * @category context
- */
-export const provideServiceEffect = /*#__PURE__*/dual(3, (self, tag, make) => self._tag === "Effect" ? effect(self.schema, req => Effect.provideServiceEffect(self.handler(req), tag, Effect.orDie(make))) : stream(self.schema, req => Stream.provideServiceEffect(self.handler(req), tag, Effect.orDie(make))));
+export const fork = value => ({
+  [ForkTypeId]: ForkTypeId,
+  value
+});
 /**
  * @since 1.0.0
- * @category context
+ * @category Fork
  */
-export const provideService = /*#__PURE__*/dual(3, (self, tag, service) => self._tag === "Effect" ? effect(self.schema, req => Effect.provideService(self.handler(req), tag, service)) : stream(self.schema, req => Stream.provideService(self.handler(req), tag, service)));
+export const isFork = u => ForkTypeId in u;
 //# sourceMappingURL=Rpc.js.map
\ No newline at end of file
diff --git a/dist/esm/Rpc.js.map b/dist/esm/Rpc.js.map
index b52a11752bd9a0cbb11023afdc9effe576a09a14..625f2db24a9a58c7904a07b67a980d83167a6956 100644
--- a/dist/esm/Rpc.js.map
+++ b/dist/esm/Rpc.js.map
@@ -1 +1 @@
-{"version":3,"file":"Rpc.js","names":["Headers","Effect","FiberRef","dual","pipe","globalValue","pipeArguments","Predicate","Schema","Stream","Internal","TypeId","Symbol","for","isRpc","u","hasProperty","effect","schema","handler","_tag","arguments","StreamRequestTypeId","StreamRequest","tag","options","TaggedRequest","constructor","props","disableValidation","stream","RequestSchema","Struct","request","traceId","String","spanId","sampled","Boolean","headers","Record","key","value","currentHeaders","unsafeMake","empty","annotateHeaders","self","resolved","fromInput","locallyWith","prev","schemaHeaders","decode","decodeUnknown","flatMap","get","makeSpanScoped","spanPrefix","kind","captureStackTrace","zip","map","span","makeRequest","call","req","resolver","isStream","res","_","unwrapScoped","scoped","provideServiceEffect","make","orDie","provideService","service"],"sources":["../../src/Rpc.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,OAAO,MAAM,0BAA0B;AAEnD,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,QAAQ,MAAM,iBAAiB;AAC3C,SAASC,IAAI,EAAEC,IAAI,QAAQ,iBAAiB;AAC5C,SAASC,WAAW,QAAQ,oBAAoB;AAEhD,SAAwBC,aAAa,QAAQ,iBAAiB;AAC9D,OAAO,KAAKC,SAAS,MAAM,kBAAkB;AAK7C,OAAO,KAAKC,MAAM,MAAM,eAAe;AAEvC,OAAO,KAAKC,MAAM,MAAM,eAAe;AAEvC,OAAO,KAAKC,QAAQ,MAAM,mBAAmB;AAE7C;;;;AAIA,OAAO,MAAMC,MAAM,gBAAkBC,MAAM,CAACC,GAAG,CAAC,iBAAiB,CAAC;AAQlE;;;;AAIA,OAAO,MAAMC,KAAK,GAAIC,CAAU,IAAyBR,SAAS,CAACS,WAAW,CAACD,CAAC,EAAEJ,MAAM,CAAC;AAsFzF;;;;AAIA,OAAO,MAAMM,MAAM,GAAGA,CACpBC,MAAwC,EACxCC,OAAiH,MAChG;EACjB,CAACR,MAAM,GAAGA,MAAM;EAChBS,IAAI,EAAE,QAAQ;EACdF,MAAM;EACNC,OAAO;EACPf,IAAIA,CAAA;IACF,OAAOE,aAAa,CAAC,IAAI,EAAEe,SAAS,CAAC;EACvC;CACD,CAAC;AAEF;;;;AAIA,OAAO,MAAMC,mBAAmB,GAAkBZ,QAAQ,CAACY,mBAAmB;AA8C9E;;;;AAIA,OAAO,MAAMC,aAAa,GACxBA,CAAA,KACA,CACEC,GAAQ,EACRC,OAIC,KAYC;EACF,OAAO,cAAejB,MAAM,CAACkB,aAAa,EAAM,CAACF,GAAG,EAAEC,OAAO,CAAS;IACpEE,YAAYC,KAAU,EAAEC,iBAA2B;MACjD,KAAK,CAACD,KAAK,EAAEC,iBAAiB,CAAC;MAC7B,IAAY,CAACnB,QAAQ,CAACY,mBAAmB,CAAC,GAAGZ,QAAQ,CAACY,mBAAmB;IAC7E;GACM;AACV,CAAC;AAEH;;;;AAIA,OAAO,MAAMQ,MAAM,GAAGA,CACpBZ,MAAwC,EACxCC,OAMC,MACgB;EACjB,CAACR,MAAM,GAAGA,MAAM;EAChBS,IAAI,EAAE,QAAQ;EACdF,MAAM,EAAEA,MAAa;EACrBC,OAAO;EACPf,IAAIA,CAAA;IACF,OAAOE,aAAa,CAAC,IAAI,EAAEe,SAAS,CAAC;EACvC;CACD,CAAC;AAuCF;;;;AAIA,OAAO,MAAMU,aAAa,GACxBb,MAA8B,IAE9BV,MAAM,CAACwB,MAAM,CAAC;EACZC,OAAO,EAAEf,MAAM;EACfgB,OAAO,EAAE1B,MAAM,CAAC2B,MAAM;EACtBC,MAAM,EAAE5B,MAAM,CAAC2B,MAAM;EACrBE,OAAO,EAAE7B,MAAM,CAAC8B,OAAO;EACvBC,OAAO,EAAE/B,MAAM,CAACgC,MAAM,CAAC;IAAEC,GAAG,EAAEjC,MAAM,CAAC2B,MAAM;IAAEO,KAAK,EAAElC,MAAM,CAAC2B;EAAM,CAAE;CACpE,CAAC;AAEJ;;;;AAIA,OAAO,MAAMQ,cAAc,gBAAuCtC,WAAW,CAC3E,gCAAgC,EAChC,MAAMH,QAAQ,CAAC0C,UAAU,CAAC5C,OAAO,CAAC6C,KAAK,CAAC,CACzC;AAED;;;;AAIA,OAAO,MAAMC,eAAe,gBAWxB3C,IAAI,CAAC,CAAC,EAAE,CAAC4C,IAAI,EAAER,OAAO,KAAI;EAC5B,MAAMS,QAAQ,GAAGhD,OAAO,CAACiD,SAAS,CAACV,OAAO,CAAC;EAC3C,OAAOtC,MAAM,CAACiD,WAAW,CAACH,IAAI,EAAEJ,cAAc,EAAGQ,IAAI,KAAM;IAAE,GAAGA,IAAI;IAAE,GAAGH;EAAQ,CAAE,CAAC,CAAC;AACvF,CAAC,CAAC;AAEF;;;;AAIA,OAAO,MAAMI,aAAa,GACxBlC,MAA8B,IACiB;EAC/C,MAAMmC,MAAM,GAAG7C,MAAM,CAAC8C,aAAa,CAACpC,MAAM,CAAC;EAC3C,OAAOjB,MAAM,CAACsD,OAAO,CAACrD,QAAQ,CAACsD,GAAG,CAACb,cAAc,CAAC,EAAEU,MAAM,CAAC;AAC7D,CAAC;AAED;;;;AAIA,OAAO,MAAMpB,OAAO,GAAGA,CACrBA,OAAU,EACVR,OAEC,KAEDrB,IAAI,CACFH,MAAM,CAACwD,cAAc,CAAC,GAAGhC,OAAO,EAAEiC,UAAU,IAAI,cAAc,GAAGzB,OAAO,CAACb,IAAI,EAAE,EAAE;EAC/EuC,IAAI,EAAE,QAAQ;EACdC,iBAAiB,EAAE;CACpB,CAAC,EACF3D,MAAM,CAAC4D,GAAG,CAAC3D,QAAQ,CAACsD,GAAG,CAACb,cAAc,CAAC,CAAC,EACxC1C,MAAM,CAAC6D,GAAG,CAAC,CAAC,CAACC,IAAI,EAAExB,OAAO,CAAC,KACzB7B,QAAQ,CAACsD,WAAW,CAAC;EACnB/B,OAAO;EACPC,OAAO,EAAE6B,IAAI,CAAC7B,OAAO;EACrBE,MAAM,EAAE2B,IAAI,CAAC3B,MAAM;EACnBC,OAAO,EAAE0B,IAAI,CAAC1B,OAAO;EACrBE;CACD,CAAC,CACH,CACF;AAEH;;;;AAIA,OAAO,MAAM0B,IAAI,GAAGA,CAMlBC,GAAM,EACNC,QAAW,EACX1C,OAEC,KAC0F;EAC3F,MAAM2C,QAAQ,GAAG1D,QAAQ,CAACY,mBAAmB,IAAI4C,GAAG;EACpD,MAAMG,GAAG,GAAGjE,IAAI,CACd6B,OAAO,CAACiC,GAAG,EAAEzC,OAAO,CAAC,EACrBxB,MAAM,CAACsD,OAAO,CAAEe,CAAC,IAAKrE,MAAM,CAACgC,OAAO,CAACqC,CAAC,EAAEH,QAAQ,CAAC,CAAC,CACnD;EACD,OAAOC,QAAQ,GAAG3D,MAAM,CAAC8D,YAAY,CAACF,GAAU,CAAC,GAAGpE,MAAM,CAACuE,MAAM,CAACH,GAAG,CAAQ;AAC/E,CAAC;AAED;;;;AAIA,OAAO,MAAMI,oBAAoB,gBAW7BtE,IAAI,CAAC,CAAC,EAAE,CACV4C,IAAiB,EACjBvB,GAAsB,EACtBkD,IAA6B,KAE7B3B,IAAI,CAAC3B,IAAI,KAAK,QAAQ,GAClBH,MAAM,CAAC8B,IAAI,CAAC7B,MAAM,EAAGgD,GAAG,IAAKjE,MAAM,CAACwE,oBAAoB,CAAC1B,IAAI,CAAC5B,OAAO,CAAC+C,GAAG,CAAC,EAAE1C,GAAG,EAAEvB,MAAM,CAAC0E,KAAK,CAACD,IAAI,CAAC,CAAC,CAAQ,GAC5G5C,MAAM,CACNiB,IAAI,CAAC7B,MAAa,EACjBgD,GAAG,IAAKzD,MAAM,CAACgE,oBAAoB,CAAC1B,IAAI,CAAC5B,OAAO,CAAC+C,GAAU,CAAC,EAAE1C,GAAG,EAAEvB,MAAM,CAAC0E,KAAK,CAACD,IAAI,CAAC,CAAC,CACxF,CAAC;AAEN;;;;AAIA,OAAO,MAAME,cAAc,gBAWvBzE,IAAI,CAAC,CAAC,EAAE,CACV4C,IAAiB,EACjBvB,GAAsB,EACtBqD,OAAU,KAEV9B,IAAI,CAAC3B,IAAI,KAAK,QAAQ,GAClBH,MAAM,CAAC8B,IAAI,CAAC7B,MAAM,EAAGgD,GAAG,IAAKjE,MAAM,CAAC2E,cAAc,CAAC7B,IAAI,CAAC5B,OAAO,CAAC+C,GAAG,CAAC,EAAE1C,GAAG,EAAEqD,OAAO,CAAC,CAAQ,GAC3F/C,MAAM,CACNiB,IAAI,CAAC7B,MAAa,EACjBgD,GAAG,IAAKzD,MAAM,CAACmE,cAAc,CAAC7B,IAAI,CAAC5B,OAAO,CAAC+C,GAAU,CAAC,EAAE1C,GAAG,EAAEqD,OAAO,CAAC,CACvE,CAAC","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"Rpc.js","names":["Context_","globalValue","Option","pipeArguments","Predicate","Schema","RpcSchema","TypeId","Symbol","for","isRpc","u","hasProperty","Proto","pipe","arguments","setSuccess","successSchema","makeProto","setError","errorSchema","setPayload","payloadSchema","isSchema","Struct","middleware","middlewares","Set","annotate","tag","value","annotations","add","annotateContext","context","merge","options","self","Object","assign","create","key","_tag","constEmptyStruct","make","success","Void","error","Never","payload","stream","Stream","failure","empty","fromTaggedRequest","schema","exitSchemaCache","WeakMap","exitSchema","has","get","rpc","streamSchemas","getStreamSchemas","ast","Exit","isSome","Union","defect","Defect","set","ForkTypeId","fork","isFork"],"sources":["../../src/Rpc.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcClient.js b/dist/esm/RpcClient.js
new file mode 100644
index 0000000000000000000000000000000000000000..6387528ba4f22c4da9c7780da17b695ea8664826
--- /dev/null
+++ b/dist/esm/RpcClient.js
@@ -0,0 +1,629 @@
+/**
+ * @since 1.0.0
+ */
+import * as Headers from "@effect/platform/Headers";
+import * as HttpBody from "@effect/platform/HttpBody";
+import * as HttpClient from "@effect/platform/HttpClient";
+import * as HttpClientRequest from "@effect/platform/HttpClientRequest";
+import * as Socket from "@effect/platform/Socket";
+import * as Transferable from "@effect/platform/Transferable";
+import * as Worker from "@effect/platform/Worker";
+import * as Cause from "effect/Cause";
+import * as Chunk from "effect/Chunk";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Exit from "effect/Exit";
+import * as Fiber from "effect/Fiber";
+import * as FiberId from "effect/FiberId";
+import * as FiberRef from "effect/FiberRef";
+import { constVoid, dual, identity } from "effect/Function";
+import { globalValue } from "effect/GlobalValue";
+import * as Layer from "effect/Layer";
+import * as Mailbox from "effect/Mailbox";
+import * as Option from "effect/Option";
+import * as Pool from "effect/Pool";
+import * as Schedule from "effect/Schedule";
+import * as Schema from "effect/Schema";
+import * as Scope from "effect/Scope";
+import * as Stream from "effect/Stream";
+import { withRun } from "./internal/utils.js";
+import * as Rpc from "./Rpc.js";
+import { constPing } from "./RpcMessage.js";
+import * as RpcSchema from "./RpcSchema.js";
+import * as RpcSerialization from "./RpcSerialization.js";
+import * as RpcWorker from "./RpcWorker.js";
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export const makeNoSerialization = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const spanPrefix = options?.spanPrefix ?? "RpcClient";
+  const supportsAck = options?.supportsAck ?? true;
+  const disableTracing = options?.disableTracing ?? false;
+  let requestId = BigInt(0);
+  const generateRequestId = options.generateRequestId ?? (() => requestId++);
+  const context = yield* Effect.context();
+  const scope = Context.get(context, Scope.Scope);
+  const entries = new Map();
+  let isShutdown = false;
+  yield* Scope.addFinalizer(scope, Effect.fiberIdWith(fiberId => {
+    isShutdown = true;
+    return clearEntries(Exit.interrupt(fiberId));
+  }));
+  const clearEntries = Effect.fnUntraced(function* (exit) {
+    for (const [id, entry] of entries) {
+      entries.delete(id);
+      if (entry._tag === "Mailbox") {
+        yield* entry.mailbox.done(exit);
+      } else {
+        entry.resume(exit);
+      }
+    }
+  });
+  const onRequest = rpc => {
+    const isStream = RpcSchema.isStreamSchema(rpc.successSchema);
+    const middleware = getRpcClientMiddleware(rpc);
+    return (payload, options) => {
+      const headers = options?.headers ? Headers.fromInput(options.headers) : Headers.empty;
+      if (!isStream) {
+        const effect = Effect.useSpan(`${spanPrefix}.${rpc._tag}`, {
+          captureStackTrace: false
+        }, span => onEffectRequest(rpc, middleware, span, payload ? rpc.payloadSchema.make(payload) : {}, headers, options?.context ?? Context.empty(), options?.discard ?? false));
+        return disableTracing ? Effect.withTracerEnabled(effect, false) : effect;
+      }
+      const mailbox = Effect.suspend(() => onStreamRequest(rpc, middleware, payload ? rpc.payloadSchema.make(payload) : {}, headers, options?.streamBufferSize ?? 16, options?.context ?? Context.empty()));
+      if (options?.asMailbox) return mailbox;
+      return Stream.unwrapScoped(Effect.map(mailbox, Mailbox.toStream));
+    };
+  };
+  const onEffectRequest = (rpc, middleware, span, payload, headers, context, discard) => Effect.withFiberRuntime(parentFiber => {
+    if (isShutdown) {
+      return Effect.interrupt;
+    }
+    const id = generateRequestId();
+    const send = middleware({
+      _tag: "Request",
+      id,
+      tag: rpc._tag,
+      payload,
+      traceId: span.traceId,
+      spanId: span.spanId,
+      sampled: span.sampled,
+      headers: Headers.merge(parentFiber.getFiberRef(currentHeaders), headers)
+    });
+    if (discard) {
+      return Effect.flatMap(send, message => options.onFromClient({
+        message,
+        context,
+        discard
+      }));
+    }
+    let fiber;
+    return Effect.onInterrupt(Effect.async(resume => {
+      const entry = {
+        _tag: "Effect",
+        rpc,
+        context,
+        resume(exit) {
+          resume(exit);
+          if (!fiber.unsafePoll()) {
+            parentFiber.currentScheduler.scheduleTask(() => {
+              fiber.unsafeInterruptAsFork(parentFiber.id());
+            }, 0);
+          }
+        }
+      };
+      entries.set(id, entry);
+      fiber = send.pipe(Effect.flatMap(request => options.onFromClient({
+        message: request,
+        context,
+        discard
+      })), Effect.runFork);
+      fiber.addObserver(exit => {
+        if (exit._tag === "Failure") {
+          return resume(exit);
+        }
+      });
+    }), interruptors => {
+      entries.delete(id);
+      const ids = Array.from(interruptors).flatMap(id => Array.from(FiberId.toSet(id)));
+      return Effect.zipRight(Fiber.interrupt(fiber), sendInterrupt(id, ids, context));
+    });
+  });
+  const onStreamRequest = Effect.fnUntraced(function* (rpc, middleware, payload, headers, streamBufferSize, context) {
+    if (isShutdown) {
+      return yield* Effect.interrupt;
+    }
+    const span = yield* Effect.makeSpanScoped(`${spanPrefix}.${rpc._tag}`, {
+      captureStackTrace: false
+    }).pipe(disableTracing ? Effect.withTracerEnabled(false) : identity);
+    const fiber = Option.getOrThrow(Fiber.getCurrentFiber());
+    const id = generateRequestId();
+    const scope = Context.unsafeGet(fiber.currentContext, Scope.Scope);
+    yield* Scope.addFinalizerExit(scope, exit => {
+      if (!entries.has(id)) return Effect.void;
+      entries.delete(id);
+      return sendInterrupt(id, Exit.isFailure(exit) ? Array.from(Cause.interruptors(exit.cause)).flatMap(id => Array.from(FiberId.toSet(id))) : [], context);
+    });
+    const mailbox = yield* Mailbox.make(streamBufferSize);
+    entries.set(id, {
+      _tag: "Mailbox",
+      rpc,
+      mailbox,
+      scope,
+      context
+    });
+    yield* middleware({
+      _tag: "Request",
+      id,
+      tag: rpc._tag,
+      traceId: span.traceId,
+      payload,
+      spanId: span.spanId,
+      sampled: span.sampled,
+      headers: Headers.merge(fiber.getFiberRef(currentHeaders), headers)
+    }).pipe(Effect.flatMap(request => options.onFromClient({
+      message: request,
+      context,
+      discard: false
+    })), Effect.catchAllCause(error => mailbox.failCause(error)), Effect.interruptible, Effect.forkIn(scope));
+    return mailbox;
+  });
+  const getRpcClientMiddleware = rpc => {
+    const middlewares = [];
+    for (const tag of rpc.middlewares.values()) {
+      const middleware = context.unsafeMap.get(`${tag.key}/Client`);
+      if (!middleware) continue;
+      middlewares.push(middleware);
+    }
+    return middlewares.length === 0 ? Effect.succeed : function (request) {
+      let i = 0;
+      return Effect.map(Effect.whileLoop({
+        while: () => i < middlewares.length,
+        body: () => middlewares[i]({
+          rpc,
+          request
+        }),
+        step(nextRequest) {
+          request = nextRequest;
+          i++;
+        }
+      }), () => request);
+    };
+  };
+  const sendInterrupt = (requestId, interruptors, context) => Effect.async(resume => {
+    const fiber = options.onFromClient({
+      message: {
+        _tag: "Interrupt",
+        requestId,
+        interruptors
+      },
+      context,
+      discard: false
+    }).pipe(Effect.timeout(1000), Effect.runFork);
+    fiber.addObserver(() => {
+      resume(Effect.void);
+    });
+  });
+  const write = message => {
+    switch (message._tag) {
+      case "Chunk":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry || entry._tag !== "Mailbox") return Effect.void;
+          return entry.mailbox.offerAll(message.values).pipe(supportsAck ? Effect.zipRight(options.onFromClient({
+            message: {
+              _tag: "Ack",
+              requestId: message.requestId
+            },
+            context: entry.context,
+            discard: false
+          })) : identity, Effect.onError(cause => entry.mailbox.done(Exit.failCause(cause))), Effect.forkIn(entry.scope));
+        }
+      case "Exit":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry) return Effect.void;
+          entries.delete(requestId);
+          if (entry._tag === "Effect") {
+            entry.resume(message.exit);
+            return Effect.void;
+          }
+          return entry.mailbox.done(Exit.asVoid(message.exit));
+        }
+      case "Defect":
+        {
+          return clearEntries(Exit.die(message.defect));
+        }
+      case "ClientEnd":
+        {
+          return Effect.void;
+        }
+    }
+  };
+  const client = {};
+  for (const rpc of group.requests.values()) {
+    ;
+    client[rpc._tag] = onRequest(rpc);
+  }
+  return {
+    client: client,
+    write
+  };
+});
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export const make = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const context = yield* Effect.context();
+  const {
+    run,
+    send,
+    supportsAck,
+    supportsTransferables
+  } = yield* Protocol;
+  const entries = new Map();
+  const {
+    client,
+    write
+  } = yield* makeNoSerialization(group, {
+    ...options,
+    supportsAck,
+    onFromClient({
+      message
+    }) {
+      switch (message._tag) {
+        case "Request":
+          {
+            const rpc = group.requests.get(message.tag);
+            const schemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast);
+            const collector = supportsTransferables ? Transferable.unsafeMakeCollector() : undefined;
+            const entry = {
+              rpc,
+              decodeChunk: Option.isSome(schemas) ? Schema.decodeUnknown(Schema.NonEmptyArray(schemas.value.success)) : undefined
+            };
+            entries.set(message.id, entry);
+            return Schema.encode(rpc.payloadSchema)(message.payload).pipe(Effect.locally(FiberRef.currentContext, collector ? Context.add(context, Transferable.Collector, collector) : context), Effect.orDie, Effect.flatMap(payload => send({
+              ...message,
+              payload,
+              headers: Object.entries(message.headers)
+            }, collector && collector.unsafeClear())));
+          }
+        case "Ack":
+          {
+            const entry = entries.get(message.requestId);
+            if (!entry) return Effect.void;
+            return send(message);
+          }
+        case "Interrupt":
+          {
+            const entry = entries.get(message.requestId);
+            if (!entry) return Effect.void;
+            entries.delete(message.requestId);
+            return send({
+              _tag: "Interrupt",
+              requestId: message.requestId
+            });
+          }
+        case "Eof":
+          {
+            return Effect.void;
+          }
+      }
+    }
+  });
+  yield* run(message => {
+    switch (message._tag) {
+      case "Chunk":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry || !entry.decodeChunk) return Effect.void;
+          return entry.decodeChunk(message.values).pipe(Effect.locally(FiberRef.currentContext, context), Effect.orDie, Effect.flatMap(chunk => write({
+            _tag: "Chunk",
+            clientId: 0,
+            requestId: parseRequestId(message.requestId),
+            values: chunk
+          })), Effect.onError(cause => write({
+            _tag: "Exit",
+            clientId: 0,
+            requestId: parseRequestId(message.requestId),
+            exit: Exit.failCause(cause)
+          })));
+        }
+      case "Exit":
+        {
+          const requestId = parseRequestId(message.requestId);
+          const entry = entries.get(requestId);
+          if (!entry) return Effect.void;
+          entries.delete(requestId);
+          return Schema.decode(Rpc.exitSchema(entry.rpc))(message.exit).pipe(Effect.locally(FiberRef.currentContext, context), Effect.orDie, Effect.matchCauseEffect({
+            onSuccess: exit => write({
+              _tag: "Exit",
+              clientId: 0,
+              requestId,
+              exit
+            }),
+            onFailure: cause => write({
+              _tag: "Exit",
+              clientId: 0,
+              requestId,
+              exit: Exit.failCause(cause)
+            })
+          }));
+        }
+      case "Defect":
+        {
+          return write({
+            _tag: "Defect",
+            clientId: 0,
+            defect: decodeDefect(message.defect)
+          });
+        }
+      default:
+        {
+          return Effect.void;
+        }
+    }
+  }).pipe(Effect.catchAllCause(Effect.logError), Effect.interruptible, Effect.forkScoped);
+  return client;
+});
+const parseRequestId = input => typeof input === "string" ? BigInt(input) : input;
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export const currentHeaders = /*#__PURE__*/globalValue("@effect/rpc/RpcClient/currentHeaders", () => FiberRef.unsafeMake(Headers.empty));
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export const withHeaders = /*#__PURE__*/dual(2, (effect, headers) => Effect.locallyWith(effect, currentHeaders, Headers.merge(Headers.fromInput(headers))));
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export const withHeadersEffect = /*#__PURE__*/dual(2, (effect, headers) => Effect.flatMap(headers, headers => withHeaders(effect, headers)));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export class Protocol extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcClient/Protocol")() {
+  /**
+   * @since 1.0.0
+   */
+  static make = /*#__PURE__*/withRun();
+}
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolHttp = client => Protocol.make(Effect.fnUntraced(function* (writeResponse) {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const isJson = serialization.contentType === "application/json";
+  const send = request => {
+    if (request._tag !== "Request") {
+      return Effect.void;
+    }
+    const parser = serialization.unsafeMake();
+    if (!serialization.supportsBigInt) transformBigInt(request);
+    const encoded = parser.encode(request);
+    const body = typeof encoded === "string" ? HttpBody.text(encoded, serialization.contentType) : HttpBody.uint8Array(encoded, serialization.contentType);
+    if (isJson) {
+      return client.post("/", {
+        body
+      }).pipe(Effect.flatMap(r => r.json), Effect.scoped, Effect.flatMap(u => {
+        if (!Array.isArray(u)) {
+          return Effect.dieMessage(`Expected an array of responses, but got: ${u}`);
+        }
+        let i = 0;
+        return Effect.whileLoop({
+          while: () => i < u.length,
+          body: () => writeResponse(u[i++]),
+          step: constVoid
+        });
+      }), Effect.orDie);
+    }
+    return client.post("/", {
+      body
+    }).pipe(Effect.flatMap(r => Stream.runForEachChunk(r.stream, chunk => {
+      const responses = Chunk.toReadonlyArray(chunk).flatMap(parser.decode);
+      if (responses.length === 0) return Effect.void;
+      let i = 0;
+      return Effect.whileLoop({
+        while: () => i < responses.length,
+        body: () => writeResponse(responses[i++]),
+        step: constVoid
+      });
+    })), Effect.scoped, Effect.orDie);
+  };
+  return {
+    send,
+    supportsAck: false,
+    supportsTransferables: false
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolHttp = options => Layer.scoped(Protocol, Effect.flatMap(HttpClient.HttpClient, client => {
+  client = HttpClient.mapRequest(client, HttpClientRequest.prependUrl(options.url));
+  return makeProtocolHttp(options.transformClient ? options.transformClient(client) : client);
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolSocket = /*#__PURE__*/Protocol.make( /*#__PURE__*/Effect.fnUntraced(function* (writeResponse) {
+  const socket = yield* Socket.Socket;
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const write = yield* socket.writer;
+  let parser = serialization.unsafeMake();
+  yield* Effect.suspend(() => {
+    parser = serialization.unsafeMake();
+    return socket.runRaw(message => {
+      try {
+        const responses = parser.decode(message);
+        if (responses.length === 0) return;
+        let i = 0;
+        return Effect.whileLoop({
+          while: () => i < responses.length,
+          body: () => writeResponse(responses[i++]),
+          step: constVoid
+        });
+      } catch (defect) {
+        return writeResponse({
+          _tag: "Defect",
+          defect
+        });
+      }
+    });
+  }).pipe(Effect.zipRight(Effect.fail(new Socket.SocketCloseError({
+    reason: "Close",
+    code: 1000
+  }))), Effect.tapErrorCause(cause => writeResponse({
+    _tag: "Defect",
+    defect: Cause.squash(cause)
+  })), Effect.retry(Schedule.spaced(1000)), Effect.annotateLogs({
+    module: "RpcClient",
+    method: "makeProtocolSocket"
+  }), Effect.interruptible, Effect.forkScoped);
+  yield* Effect.suspend(() => write(parser.encode(constPing))).pipe(Effect.delay("30 seconds"), Effect.ignore, Effect.forever, Effect.interruptible, Effect.forkScoped);
+  return {
+    send(request) {
+      if (!serialization.supportsBigInt) transformBigInt(request);
+      return Effect.orDie(write(parser.encode(request)));
+    },
+    supportsAck: true,
+    supportsTransferables: false
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWorker = options => Protocol.make(Effect.fnUntraced(function* (writeResponse) {
+  const worker = yield* Worker.PlatformWorker;
+  const scope = yield* Effect.scope;
+  let workerId = 0;
+  const initialMessage = yield* Effect.serviceOption(RpcWorker.InitialMessage);
+  const entries = new Map();
+  yield* Scope.addFinalizerExit(scope, exit => Effect.forEach(entries, ([_, entry]) => Scope.close(entry.scope, exit), {
+    discard: true,
+    concurrency: "unbounded"
+  }));
+  const acquire = Effect.gen(function* () {
+    const id = workerId++;
+    const backing = yield* worker.spawn(id);
+    const readyLatch = yield* Effect.makeLatch();
+    yield* backing.run(message => {
+      if (message[0] === 0) {
+        return readyLatch.open;
+      }
+      const response = message[1];
+      if (response._tag === "Exit") {
+        const entry = entries.get(response.requestId);
+        if (entry) {
+          entries.delete(response.requestId);
+          return Effect.ensuring(writeResponse(response), Scope.close(entry.scope, Exit.void));
+        }
+      } else if (response._tag === "Defect") {
+        return Effect.zipRight(Effect.forEach(entries, ([requestId, entry]) => {
+          entries.delete(requestId);
+          return Scope.close(entry.scope, Exit.die(response.defect));
+        }, {
+          discard: true
+        }), writeResponse(response));
+      }
+      return writeResponse(response);
+    }).pipe(Effect.tapErrorCause(cause => writeResponse({
+      _tag: "Defect",
+      defect: Cause.squash(cause)
+    })), Effect.retry(Schedule.spaced(1000)), Effect.annotateLogs({
+      module: "RpcClient",
+      method: "makeProtocolWorker"
+    }), Effect.interruptible, Effect.forkScoped);
+    yield* readyLatch.await;
+    if (Option.isSome(initialMessage)) {
+      const [value, transfers] = yield* initialMessage.value;
+      yield* backing.send({
+        _tag: "InitialMessage",
+        value
+      }, transfers);
+    }
+    return backing;
+  });
+  const pool = "minSize" in options ? yield* Pool.makeWithTTL({
+    acquire,
+    min: options.minSize,
+    max: options.maxSize,
+    concurrency: options.concurrency,
+    targetUtilization: options.targetUtilization,
+    timeToLive: options.timeToLive
+  }) : yield* Pool.make({
+    acquire,
+    size: options.size,
+    concurrency: options.concurrency,
+    targetUtilization: options.targetUtilization
+  });
+  const send = (request, transferables) => {
+    switch (request._tag) {
+      case "Request":
+        {
+          return Scope.make().pipe(Effect.flatMap(scope => Effect.flatMap(Scope.extend(pool.get, scope), worker => {
+            entries.set(request.id, {
+              worker,
+              scope
+            });
+            return Effect.orDie(worker.send(request, transferables));
+          })), Effect.orDie);
+        }
+      case "Interrupt":
+        {
+          const entry = entries.get(request.requestId);
+          if (!entry) return Effect.void;
+          entries.delete(request.requestId);
+          return Effect.ensuring(Effect.orDie(entry.worker.send(request)), Scope.close(entry.scope, Exit.void));
+        }
+      case "Ack":
+        {
+          const entry = entries.get(request.requestId);
+          if (!entry) return Effect.void;
+          return Effect.orDie(entry.worker.send(request));
+        }
+    }
+    return Effect.void;
+  };
+  yield* Effect.scoped(pool.get);
+  return {
+    send,
+    supportsAck: true,
+    supportsTransferables: true
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolWorker = options => Layer.scoped(Protocol, makeProtocolWorker(options));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolSocket = /*#__PURE__*/Layer.scoped(Protocol, makeProtocolSocket);
+// internal
+const decodeDefect = /*#__PURE__*/Schema.decodeSync(Schema.Defect);
+const transformBigInt = request => {
+  if (request._tag === "Request") {
+    ;
+    request.id = request.id.toString();
+  } else if ("requestId" in request) {
+    ;
+    request.requestId = request.requestId.toString();
+  }
+};
+//# sourceMappingURL=RpcClient.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcClient.js.map b/dist/esm/RpcClient.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..57408a35a0fa3830fc02b76182c7cac153376902
--- /dev/null
+++ b/dist/esm/RpcClient.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcClient.js","names":["Headers","HttpBody","HttpClient","HttpClientRequest","Socket","Transferable","Worker","Cause","Chunk","Context","Effect","Exit","Fiber","FiberId","FiberRef","constVoid","dual","identity","globalValue","Layer","Mailbox","Option","Pool","Schedule","Schema","Scope","Stream","withRun","Rpc","constPing","RpcSchema","RpcSerialization","RpcWorker","makeNoSerialization","fnUntraced","group","options","spanPrefix","supportsAck","disableTracing","requestId","BigInt","generateRequestId","context","scope","get","entries","Map","isShutdown","addFinalizer","fiberIdWith","fiberId","clearEntries","interrupt","exit","id","entry","delete","_tag","mailbox","done","resume","onRequest","rpc","isStream","isStreamSchema","successSchema","middleware","getRpcClientMiddleware","payload","headers","fromInput","empty","effect","useSpan","captureStackTrace","span","onEffectRequest","payloadSchema","make","discard","withTracerEnabled","suspend","onStreamRequest","streamBufferSize","asMailbox","unwrapScoped","map","toStream","withFiberRuntime","parentFiber","send","tag","traceId","spanId","sampled","merge","getFiberRef","currentHeaders","flatMap","message","onFromClient","fiber","onInterrupt","async","unsafePoll","currentScheduler","scheduleTask","unsafeInterruptAsFork","set","pipe","request","runFork","addObserver","interruptors","ids","Array","from","toSet","zipRight","sendInterrupt","makeSpanScoped","getOrThrow","getCurrentFiber","unsafeGet","currentContext","addFinalizerExit","has","void","isFailure","cause","catchAllCause","error","failCause","interruptible","forkIn","middlewares","values","unsafeMap","key","push","length","succeed","i","whileLoop","while","body","step","nextRequest","timeout","write","parseRequestId","offerAll","onError","asVoid","die","defect","client","requests","run","supportsTransferables","Protocol","schemas","getStreamSchemas","ast","collector","unsafeMakeCollector","undefined","decodeChunk","isSome","decodeUnknown","NonEmptyArray","value","success","encode","locally","add","Collector","orDie","Object","unsafeClear","chunk","clientId","decode","exitSchema","matchCauseEffect","onSuccess","onFailure","decodeDefect","logError","forkScoped","input","unsafeMake","withHeaders","locallyWith","withHeadersEffect","Tag","makeProtocolHttp","writeResponse","serialization","isJson","contentType","parser","supportsBigInt","transformBigInt","encoded","text","uint8Array","post","r","json","scoped","u","isArray","dieMessage","runForEachChunk","stream","responses","toReadonlyArray","layerProtocolHttp","mapRequest","prependUrl","url","transformClient","makeProtocolSocket","socket","writer","runRaw","fail","SocketCloseError","reason","code","tapErrorCause","squash","retry","spaced","annotateLogs","module","method","delay","ignore","forever","makeProtocolWorker","worker","PlatformWorker","workerId","initialMessage","serviceOption","InitialMessage","forEach","_","close","concurrency","acquire","gen","backing","spawn","readyLatch","makeLatch","open","response","ensuring","await","transfers","pool","makeWithTTL","min","minSize","max","maxSize","targetUtilization","timeToLive","size","transferables","extend","layerProtocolWorker","layerProtocolSocket","decodeSync","Defect","toString"],"sources":["../../src/RpcClient.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcGroup.js b/dist/esm/RpcGroup.js
new file mode 100644
index 0000000000000000000000000000000000000000..1b8617b5491c66dc6925d9a5c89532936a3d63de
--- /dev/null
+++ b/dist/esm/RpcGroup.js
@@ -0,0 +1,88 @@
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as Schema from "effect/Schema";
+import * as Rpc from "./Rpc.js";
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export const TypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcGroup");
+const RpcGroupProto = {
+  add(...rpcs) {
+    return makeProto({
+      requests: resolveInput(...this.requests.values(), ...rpcs),
+      annotations: this.annotations
+    });
+  },
+  merge(that) {
+    const requests = new Map(this.requests);
+    for (const rpc of that.requests.values()) {
+      requests.set(rpc._tag, rpc);
+    }
+    return makeProto({
+      requests,
+      annotations: Context.merge(this.annotations, that.annotations)
+    });
+  },
+  middleware(middleware) {
+    const requests = new Map();
+    for (const [tag, rpc] of this.requests) {
+      requests.set(tag, rpc.middleware(middleware));
+    }
+    return makeProto({
+      requests,
+      annotations: this.annotations
+    });
+  },
+  toHandlersContext(build) {
+    return Effect.gen(this, function* () {
+      const context = yield* Effect.context();
+      const handlers = Effect.isEffect(build) ? yield* build : build;
+      const contextMap = new Map();
+      for (const [tag, handler] of Object.entries(handlers)) {
+        const rpc = this.requests.get(tag);
+        contextMap.set(rpc.key, {
+          handler,
+          context
+        });
+      }
+      return Context.unsafeMake(contextMap);
+    });
+  },
+  toLayer(build) {
+    return Layer.scopedContext(this.toHandlersContext(build));
+  },
+  annotate(tag, value) {
+    return makeProto({
+      requests: this.requests,
+      annotations: Context.add(this.annotations, tag, value)
+    });
+  },
+  annotateContext(context) {
+    return makeProto({
+      requests: this.requests,
+      annotations: Context.merge(this.annotations, context)
+    });
+  }
+};
+const makeProto = options => Object.assign(function () {}, RpcGroupProto, {
+  requests: options.requests,
+  annotations: options.annotations
+});
+const resolveInput = (...rpcs) => {
+  const requests = new Map();
+  for (const rpc of rpcs) {
+    requests.set(rpc._tag, Schema.isSchema(rpc) ? Rpc.fromTaggedRequest(rpc) : rpc);
+  }
+  return requests;
+};
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export const make = (...rpcs) => makeProto({
+  requests: resolveInput(...rpcs),
+  annotations: Context.empty()
+});
+//# sourceMappingURL=RpcGroup.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcGroup.js.map b/dist/esm/RpcGroup.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..98c92bd2d20260f2d828b1cfa29586f0cfdb7222
--- /dev/null
+++ b/dist/esm/RpcGroup.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcGroup.js","names":["Context","Effect","Layer","Schema","Rpc","TypeId","Symbol","for","RpcGroupProto","add","rpcs","makeProto","requests","resolveInput","values","annotations","merge","that","Map","rpc","set","_tag","middleware","tag","toHandlersContext","build","gen","context","handlers","isEffect","contextMap","handler","Object","entries","get","key","unsafeMake","toLayer","scopedContext","annotate","value","annotateContext","options","assign","isSchema","fromTaggedRequest","make","empty"],"sources":["../../src/RpcGroup.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcMessage.js b/dist/esm/RpcMessage.js
new file mode 100644
index 0000000000000000000000000000000000000000..627350f5b78192c8b6ee8584541a630c0158f7b7
--- /dev/null
+++ b/dist/esm/RpcMessage.js
@@ -0,0 +1,47 @@
+import * as Schema from "effect/Schema";
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const RequestIdTypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcServer/RequestId");
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const RequestId = id => typeof id === "bigint" ? id : BigInt(id);
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const constEof = {
+  _tag: "Eof"
+};
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const constPing = {
+  _tag: "Ping"
+};
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export const ResponseIdTypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcServer/ResponseId");
+const encodeDefect = /*#__PURE__*/Schema.encodeSync(Schema.Defect);
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export const ResponseDefectEncoded = input => ({
+  _tag: "Defect",
+  defect: encodeDefect(input)
+});
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export const constPong = {
+  _tag: "Pong"
+};
+//# sourceMappingURL=RpcMessage.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcMessage.js.map b/dist/esm/RpcMessage.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..98f57d84541fd14a31d042ddef574d0c8f0df680
--- /dev/null
+++ b/dist/esm/RpcMessage.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcMessage.js","names":["Schema","RequestIdTypeId","Symbol","for","RequestId","id","BigInt","constEof","_tag","constPing","ResponseIdTypeId","encodeDefect","encodeSync","Defect","ResponseDefectEncoded","input","defect","constPong"],"sources":["../../src/RpcMessage.ts"],"sourcesContent":[null],"mappings":"AAOA,OAAO,KAAKA,MAAM,MAAM,eAAe;AAevC;;;;AAIA,OAAO,MAAMC,eAAe,gBAAkBC,MAAM,CAACC,GAAG,CAAC,iCAAiC,CAAC;AAc3F;;;;AAIA,OAAO,MAAMC,SAAS,GAAIC,EAAmB,IAC3C,OAAOA,EAAE,KAAK,QAAQ,GAAGA,EAAe,GAAGC,MAAM,CAACD,EAAE,CAAc;AA4EpE;;;;AAIA,OAAO,MAAME,QAAQ,GAAQ;EAAEC,IAAI,EAAE;AAAK,CAAE;AAE5C;;;;AAIA,OAAO,MAAMC,SAAS,GAAS;EAAED,IAAI,EAAE;AAAM,CAAE;AAkB/C;;;;AAIA,OAAO,MAAME,gBAAgB,gBAAkBR,MAAM,CAACC,GAAG,CAAC,kCAAkC,CAAC;AAiE7F,MAAMQ,YAAY,gBAAGX,MAAM,CAACY,UAAU,CAACZ,MAAM,CAACa,MAAM,CAAC;AAErD;;;;AAIA,OAAO,MAAMC,qBAAqB,GAAIC,KAAc,KAA6B;EAC/EP,IAAI,EAAE,QAAQ;EACdQ,MAAM,EAAEL,YAAY,CAACI,KAAK;CAC3B,CAAC;AA6BF;;;;AAIA,OAAO,MAAME,SAAS,GAAS;EAAET,IAAI,EAAE;AAAM,CAAE","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcMiddleware.js b/dist/esm/RpcMiddleware.js
new file mode 100644
index 0000000000000000000000000000000000000000..d203ceac2b513b4a497dfd70d7fdd6fa2d047650
--- /dev/null
+++ b/dist/esm/RpcMiddleware.js
@@ -0,0 +1,48 @@
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as Schema from "effect/Schema";
+import { Scope } from "effect/Scope";
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export const TypeId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcMiddleware");
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+export const Tag = () => (id, options) => {
+  const Err = globalThis.Error;
+  const limit = Err.stackTraceLimit;
+  Err.stackTraceLimit = 2;
+  const creationError = new Err();
+  Err.stackTraceLimit = limit;
+  function TagClass() {}
+  const TagClass_ = TagClass;
+  Object.setPrototypeOf(TagClass, Object.getPrototypeOf(Context.GenericTag(id)));
+  TagClass.key = id;
+  Object.defineProperty(TagClass, "stack", {
+    get() {
+      return creationError.stack;
+    }
+  });
+  TagClass_[TypeId] = TypeId;
+  TagClass_.failure = options?.optional === true || options?.failure === undefined ? Schema.Never : options.failure;
+  if (options?.provides) {
+    TagClass_.provides = options.provides;
+  }
+  TagClass_.optional = options?.optional ?? false;
+  TagClass_.requiredForClient = options?.requiredForClient ?? false;
+  return TagClass;
+};
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export const layerClient = (tag, service) => Layer.scopedContext(Effect.gen(function* () {
+  const context = (yield* Effect.context()).pipe(Context.omit(Scope));
+  const middleware = Effect.isEffect(service) ? yield* service : service;
+  return Context.unsafeMake(new Map([[`${tag.key}/Client`, options => Effect.mapInputContext(middleware(options), requestContext => Context.merge(context, requestContext))]]));
+}));
+//# sourceMappingURL=RpcMiddleware.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcMiddleware.js.map b/dist/esm/RpcMiddleware.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..7dbf6517b0cce4da3d1370731eeda712d68a773b
--- /dev/null
+++ b/dist/esm/RpcMiddleware.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcMiddleware.js","names":["Context","Effect","Layer","Schema","Scope","TypeId","Symbol","for","Tag","id","options","Err","globalThis","Error","limit","stackTraceLimit","creationError","TagClass","TagClass_","Object","setPrototypeOf","getPrototypeOf","GenericTag","key","defineProperty","get","stack","failure","optional","undefined","Never","provides","requiredForClient","layerClient","tag","service","scopedContext","gen","context","pipe","omit","middleware","isEffect","unsafeMake","Map","mapInputContext","requestContext","merge"],"sources":["../../src/RpcMiddleware.ts"],"sourcesContent":[null],"mappings":"AAIA,OAAO,KAAKA,OAAO,MAAM,gBAAgB;AACzC,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,KAAK,MAAM,cAAc;AACrC,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,SAASC,KAAK,QAAQ,cAAc;AAKpC;;;;AAIA,OAAO,MAAMC,MAAM,gBAAkBC,MAAM,CAACC,GAAG,CAAC,2BAA2B,CAAC;AA8K5E;;;;AAIA,OAAO,MAAMC,GAAG,GAAGA,CAAA,KAYnB,CACEC,EAAU,EACVC,OAKC,KACC;EACF,MAAMC,GAAG,GAAGC,UAAU,CAACC,KAAY;EACnC,MAAMC,KAAK,GAAGH,GAAG,CAACI,eAAe;EACjCJ,GAAG,CAACI,eAAe,GAAG,CAAC;EACvB,MAAMC,aAAa,GAAG,IAAIL,GAAG,EAAE;EAC/BA,GAAG,CAACI,eAAe,GAAGD,KAAK;EAE3B,SAASG,QAAQA,CAAA,GAAI;EACrB,MAAMC,SAAS,GAAGD,QAAuC;EACzDE,MAAM,CAACC,cAAc,CAACH,QAAQ,EAAEE,MAAM,CAACE,cAAc,CAACrB,OAAO,CAACsB,UAAU,CAAYb,EAAE,CAAC,CAAC,CAAC;EACzFQ,QAAQ,CAACM,GAAG,GAAGd,EAAE;EACjBU,MAAM,CAACK,cAAc,CAACP,QAAQ,EAAE,OAAO,EAAE;IACvCQ,GAAGA,CAAA;MACD,OAAOT,aAAa,CAACU,KAAK;IAC5B;GACD,CAAC;EACFR,SAAS,CAACb,MAAM,CAAC,GAAGA,MAAM;EAC1Ba,SAAS,CAACS,OAAO,GAAGjB,OAAO,EAAEkB,QAAQ,KAAK,IAAI,IAAIlB,OAAO,EAAEiB,OAAO,KAAKE,SAAS,GAAG1B,MAAM,CAAC2B,KAAK,GAAGpB,OAAO,CAACiB,OAAO;EACjH,IAAIjB,OAAO,EAAEqB,QAAQ,EAAE;IACrBb,SAAS,CAACa,QAAQ,GAAGrB,OAAO,CAACqB,QAAQ;EACvC;EACAb,SAAS,CAACU,QAAQ,GAAGlB,OAAO,EAAEkB,QAAQ,IAAI,KAAK;EAC/CV,SAAS,CAACc,iBAAiB,GAAGtB,OAAO,EAAEsB,iBAAiB,IAAI,KAAK;EACjE,OAAOf,QAAe;AACxB,CAAC;AAED;;;;AAIA,OAAO,MAAMgB,WAAW,GAAGA,CACzBC,GAAuB,EACvBC,OAA+E,KAE/EjC,KAAK,CAACkC,aAAa,CAACnC,MAAM,CAACoC,GAAG,CAAC,aAAS;EACtC,MAAMC,OAAO,GAAG,CAAC,OAAOrC,MAAM,CAACqC,OAAO,EAAa,EAAEC,IAAI,CACvDvC,OAAO,CAACwC,IAAI,CAACpC,KAAK,CAAC,CACE;EACvB,MAAMqC,UAAU,GAAGxC,MAAM,CAACyC,QAAQ,CAACP,OAAO,CAAC,GAAG,OAAOA,OAAO,GAAGA,OAAO;EACtE,OAAOnC,OAAO,CAAC2C,UAAU,CACvB,IAAIC,GAAG,CAAC,CAAC,CACP,GAAGV,GAAG,CAACX,GAAG,SAAS,EAClBb,OAAY,IACXT,MAAM,CAAC4C,eAAe,CACpBJ,UAAU,CAAC/B,OAAO,CAAC,EAClBoC,cAAc,IAAK9C,OAAO,CAAC+C,KAAK,CAACT,OAAO,EAAEQ,cAAc,CAAC,CAC3D,CACJ,CAAC,CAAC,CACJ;AACH,CAAC,CAAC,CAAC","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcResolverNoStream.js b/dist/esm/RpcResolverNoStream.js
index 3438b81823863b1361cb93b499bd56930d424beb..421a35d576431b81dccd9e0abf34458dfe9006ac 100644
--- a/dist/esm/RpcResolverNoStream.js
+++ b/dist/esm/RpcResolverNoStream.js
@@ -18,7 +18,7 @@ export const make = handler => () => {
   return RequestResolver.makeBatched(requests => pipe(Effect.forEach(requests, _ => Effect.map(Schema.serialize(_.request), request => ({
     ..._,
     request
-  }))), Effect.flatMap(handler), Effect.filterOrDieMessage(_ => Array.isArray(_) && _.length === requests.length, "@effect/rpc: handler must return an array of responses with the same length as the requests."), Effect.flatMap(Effect.forEach((response, index) => {
+  }))), Effect.flatMap(handler), Effect.filterOrElse(_ => Array.isArray(_) && _.length === requests.length, _ => Effect.dieMessage("@effect/rpc: handler must return an array of responses with the same length as the requests. Got: " + JSON.stringify(_))), Effect.flatMap(Effect.forEach((response, index) => {
     const request = requests[index];
     if (StreamRequestTypeId in request.request) {
       return pipe(getDecodeChunk(request.request)(response), Effect.orDie, Effect.matchCauseEffect({
diff --git a/dist/esm/RpcResolverNoStream.js.map b/dist/esm/RpcResolverNoStream.js.map
index fe22577d666d1eb77818cc1783a5276c6a7f7f15..8e815d9a9ecdf447ce3f7fa844c3576e3decee4e 100644
--- a/dist/esm/RpcResolverNoStream.js.map
+++ b/dist/esm/RpcResolverNoStream.js.map
@@ -1 +1 @@
-{"version":3,"file":"RpcResolverNoStream.js","names":["Channel","Chunk","Effect","Exit","pipe","Request","RequestResolver","Schema","Stream","StreamRequestTypeId","withRequestTag","make","handler","getDecode","req","decodeUnknown","exitSchema","getDecodeChunk","makeBatched","requests","forEach","_","map","serialize","request","flatMap","filterOrDieMessage","Array","isArray","length","response","index","orDie","matchCauseEffect","onFailure","cause","succeed","failCause","onSuccess","chunk","lastExit","unsafeLast","channel","match","zipRight","write","dropRight","exit","value","fromChannel","complete","discard","catchAllCause"],"sources":["../../src/RpcResolverNoStream.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"RpcResolverNoStream.js","names":["Channel","Chunk","Effect","Exit","pipe","Request","RequestResolver","Schema","Stream","StreamRequestTypeId","withRequestTag","make","handler","getDecode","req","decodeUnknown","exitSchema","getDecodeChunk","makeBatched","requests","forEach","_","map","serialize","request","flatMap","filterOrElse","Array","isArray","length","dieMessage","JSON","stringify","response","index","orDie","matchCauseEffect","onFailure","cause","succeed","failCause","onSuccess","chunk","lastExit","unsafeLast","channel","match","zipRight","write","dropRight","exit","value","fromChannel","complete","discard","catchAllCause"],"sources":["../../src/RpcResolverNoStream.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcRouter.js.map b/dist/esm/RpcRouter.js.map
index 440e0aad94ce75253d083bb8b7d21dd6e60570c2..c3f2ca4d46394e29ac75ee1ed0ee895271ab785e 100644
--- a/dist/esm/RpcRouter.js.map
+++ b/dist/esm/RpcRouter.js.map
@@ -1 +1 @@
-{"version":3,"file":"RpcRouter.js","names":["Cause","Channel","Chunk","Context","Effect","Exit","dual","pipe","Mailbox","pipeArguments","Predicate","Schema","Stream","StreamRequestTypeId","withRequestTag","Rpc","TypeId","Symbol","for","isRpcRouter","u","hasProperty","fromSet","rpcs","arguments","make","rpcSet","Set","forEach","rpc","add","provideServiceEffect","self","tag","effect","map","provideService","service","emptyExit","encodeSync","failure","Never","success","defect","Defect","failCause","empty","toHandler","args","router","options","spanPrefix","schema","Union","transform","Tuple","typeSchema","Any","strict","decode","request","encode","schemaArray","Array","RequestSchema","decodeUnknown","getEncode","req","exitSchema","getEncodeChunk","zip","tap","requests","mailbox","index","_tag","exit","handler","flatMap","orDie","matchCauseEffect","onSuccess","response","offer","onFailure","cause","locally","currentHeaders","headers","withSpan","kind","parent","traceId","spanId","sampled","context","captureStackTrace","toChannel","mapOutEffect","chunk","succeed","runDrain","of","concurrency","discard","ensuring","end","forkScoped","_","toStream","unwrapScoped","toHandlerNoStream","catchAllCause","runCollect","toHandlerRaw","parse","isStream","withHandler","unwrap","toHandlerUndecoded","successSchema","ChunkFromSelf","result","isEffect","mapChunksEffect"],"sources":["../../src/RpcRouter.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"RpcRouter.js","names":["Cause","Channel","Chunk","Context","Effect","Exit","dual","pipe","Mailbox","pipeArguments","Predicate","Schema","Stream","StreamRequestTypeId","withRequestTag","Rpc","TypeId","Symbol","for","isRpcRouter","u","hasProperty","fromSet","rpcs","arguments","make","rpcSet","Set","forEach","rpc","add","provideServiceEffect","self","tag","effect","map","provideService","service","emptyExit","encodeSync","failure","Never","success","defect","Defect","failCause","empty","toHandler","args","router","options","spanPrefix","schema","Union","transform","Tuple","typeSchema","Any","strict","decode","request","encode","schemaArray","Array","RequestSchema","decodeUnknown","getEncode","req","exitSchema","getEncodeChunk","zip","tap","requests","mailbox","index","_tag","exit","handler","flatMap","orDie","matchCauseEffect","onSuccess","response","offer","onFailure","cause","locally","currentHeaders","headers","withSpan","kind","parent","traceId","spanId","sampled","context","captureStackTrace","toChannel","mapOutEffect","chunk","succeed","runDrain","of","concurrency","discard","ensuring","end","forkScoped","_","toStream","unwrapScoped","toHandlerNoStream","catchAllCause","runCollect","toHandlerRaw","parse","isStream","withHandler","unwrap","toHandlerUndecoded","successSchema","ChunkFromSelf","result","isEffect","mapChunksEffect"],"sources":["../../src/RpcRouter.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcSchema.js b/dist/esm/RpcSchema.js
new file mode 100644
index 0000000000000000000000000000000000000000..e148c73e6867999256315cc329f4cc529c03342a
--- /dev/null
+++ b/dist/esm/RpcSchema.js
@@ -0,0 +1,59 @@
+import * as Effect from "effect/Effect";
+import * as Option from "effect/Option";
+import * as ParseResult from "effect/ParseResult";
+import { hasProperty } from "effect/Predicate";
+import * as Schema from "effect/Schema";
+import * as AST from "effect/SchemaAST";
+import * as Stream_ from "effect/Stream";
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const StreamSchemaId = /*#__PURE__*/Symbol.for("@effect/rpc/RpcSchema/Stream");
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const isStreamSchema = schema => schema.ast.annotations[AST.SchemaIdAnnotationId] === StreamSchemaId;
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const isStreamSerializable = schema => isStreamSchema(Schema.successSchema(schema));
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const getStreamSchemas = ast => ast.annotations[StreamSchemaId] ? Option.some(ast.annotations[StreamSchemaId]) : Option.none();
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const Stream = ({
+  failure,
+  success
+}) => Object.assign(Schema.declare([success, failure], {
+  decode: (success, failure) => parseStream(ParseResult.decodeUnknown(Schema.ChunkFromSelf(success)), ParseResult.decodeUnknown(failure)),
+  encode: (success, failure) => parseStream(ParseResult.encodeUnknown(Schema.ChunkFromSelf(success)), ParseResult.encodeUnknown(failure))
+}, {
+  schemaId: StreamSchemaId,
+  [StreamSchemaId]: {
+    success,
+    failure
+  }
+}), {
+  success,
+  failure
+});
+const isStream = u => hasProperty(u, Stream_.StreamTypeId);
+const parseStream = (decodeSuccess, decodeFailure) => (u, options, ast) => Effect.flatMap(Effect.context(), context => {
+  if (!isStream(u)) return Effect.fail(new ParseResult.Type(ast, u));
+  return Effect.succeed(u.pipe(Stream_.mapChunksEffect(value => decodeSuccess(value, options)), Stream_.catchAll(error => {
+    if (ParseResult.isParseError(error)) return Stream_.die(error);
+    return Effect.matchEffect(decodeFailure(error, options), {
+      onFailure: Effect.die,
+      onSuccess: Effect.fail
+    });
+  }), Stream_.provideContext(context)));
+});
+//# sourceMappingURL=RpcSchema.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcSchema.js.map b/dist/esm/RpcSchema.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..4432a186f3ed82e9abf0c9c331ab115d03256bdb
--- /dev/null
+++ b/dist/esm/RpcSchema.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcSchema.js","names":["Effect","Option","ParseResult","hasProperty","Schema","AST","Stream_","StreamSchemaId","Symbol","for","isStreamSchema","schema","ast","annotations","SchemaIdAnnotationId","isStreamSerializable","successSchema","getStreamSchemas","some","none","Stream","failure","success","Object","assign","declare","decode","parseStream","decodeUnknown","ChunkFromSelf","encode","encodeUnknown","schemaId","isStream","u","StreamTypeId","decodeSuccess","decodeFailure","options","flatMap","context","fail","Type","succeed","pipe","mapChunksEffect","value","catchAll","error","isParseError","die","matchEffect","onFailure","onSuccess","provideContext"],"sources":["../../src/RpcSchema.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcSerialization.js b/dist/esm/RpcSerialization.js
new file mode 100644
index 0000000000000000000000000000000000000000..706ef915baf4160d8bdfa5dc430459a322b1138d
--- /dev/null
+++ b/dist/esm/RpcSerialization.js
@@ -0,0 +1,106 @@
+/**
+ * @since 1.0.0
+ */
+import { Msgpackr } from "@effect/platform/MsgPack";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export class RpcSerialization extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcSerialization")() {}
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export const json = /*#__PURE__*/Effect.sync(() => {
+  const decoder = new TextDecoder();
+  return RpcSerialization.of({
+    contentType: "application/json",
+    supportsBigInt: false,
+    unsafeMake: () => ({
+      decode: bytes => [JSON.parse(typeof bytes === "string" ? bytes : decoder.decode(bytes))],
+      encode: response => JSON.stringify(response)
+    })
+  });
+});
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export const ndjson = /*#__PURE__*/Effect.sync(() => {
+  const decoder = new TextDecoder();
+  return RpcSerialization.of({
+    contentType: "application/ndjson",
+    supportsBigInt: false,
+    unsafeMake: () => {
+      let buffer = "";
+      return {
+        decode: bytes => {
+          buffer += typeof bytes === "string" ? bytes : decoder.decode(bytes);
+          let position = 0;
+          let nlIndex = buffer.indexOf("\n", position);
+          const items = [];
+          while (nlIndex !== -1) {
+            const item = JSON.parse(buffer.slice(position, nlIndex));
+            items.push(item);
+            position = nlIndex + 1;
+            nlIndex = buffer.indexOf("\n", position);
+          }
+          buffer = buffer.slice(position);
+          return items;
+        },
+        encode: response => JSON.stringify(response) + "\n"
+      };
+    }
+  });
+});
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export const msgPack = /*#__PURE__*/RpcSerialization.of({
+  contentType: "application/msgpack",
+  supportsBigInt: true,
+  unsafeMake: () => {
+    const unpackr = new Msgpackr.Unpackr();
+    const packr = new Msgpackr.Packr();
+    const encoder = new TextEncoder();
+    return {
+      decode: bytes => unpackr.unpackMultiple(typeof bytes === "string" ? encoder.encode(bytes) : bytes),
+      encode: response => packr.pack(response)
+    };
+  }
+});
+/**
+ * A rpc serialization layer that uses JSON for serialization.
+ *
+ * Use this if your protocol supports framing for messages, otherwise use
+ * `layerSerializationNdjson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export const layerJson = /*#__PURE__*/Layer.effect(RpcSerialization, json);
+/**
+ * A rpc serialization layer that uses NDJSON for serialization.
+ *
+ * Use this if your protocol does not support framing for messages, otherwise
+ * use `layerSerializationJson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export const layerNdjson = /*#__PURE__*/Layer.effect(RpcSerialization, ndjson);
+/**
+ * A rpc serialization layer that uses MessagePack for serialization.
+ *
+ * MessagePack has a more compact binary format compared to JSON and NDJSON. It
+ * also has better support for binary data.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export const layerMsgPack = /*#__PURE__*/Layer.succeed(RpcSerialization, msgPack);
+//# sourceMappingURL=RpcSerialization.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcSerialization.js.map b/dist/esm/RpcSerialization.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..80bd3aae0bd0eb2027a32612b3e7c7a2c5637a42
--- /dev/null
+++ b/dist/esm/RpcSerialization.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcSerialization.js","names":["Msgpackr","Context","Effect","Layer","RpcSerialization","Tag","json","sync","decoder","TextDecoder","of","contentType","supportsBigInt","unsafeMake","decode","bytes","JSON","parse","encode","response","stringify","ndjson","buffer","position","nlIndex","indexOf","items","item","slice","push","msgPack","unpackr","Unpackr","packr","Packr","encoder","TextEncoder","unpackMultiple","pack","layerJson","effect","layerNdjson","layerMsgPack","succeed"],"sources":["../../src/RpcSerialization.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcServer.js b/dist/esm/RpcServer.js
new file mode 100644
index 0000000000000000000000000000000000000000..2941b474f6215c41001b84815f90bbf3a682fa8e
--- /dev/null
+++ b/dist/esm/RpcServer.js
@@ -0,0 +1,845 @@
+/**
+ * @since 1.0.0
+ */
+import * as Headers from "@effect/platform/Headers";
+import * as HttpApp from "@effect/platform/HttpApp";
+import * as HttpRouter from "@effect/platform/HttpRouter";
+import * as HttpServerRequest from "@effect/platform/HttpServerRequest";
+import * as HttpServerResponse from "@effect/platform/HttpServerResponse";
+import * as SocketServer from "@effect/platform/SocketServer";
+import * as Transferable from "@effect/platform/Transferable";
+import * as WorkerRunner from "@effect/platform/WorkerRunner";
+import * as Arr from "effect/Array";
+import * as Cause from "effect/Cause";
+import * as Chunk from "effect/Chunk";
+import * as Context from "effect/Context";
+import * as Deferred from "effect/Deferred";
+import * as Effect from "effect/Effect";
+import * as Exit from "effect/Exit";
+import * as Fiber from "effect/Fiber";
+import * as FiberId from "effect/FiberId";
+import * as FiberRef from "effect/FiberRef";
+import * as FiberSet from "effect/FiberSet";
+import { constant, constTrue, constVoid, identity, flow } from "effect/Function";
+import * as Layer from "effect/Layer";
+import * as Mailbox from "effect/Mailbox";
+import * as ManagedRuntime from "effect/ManagedRuntime";
+import * as Option from "effect/Option";
+import { ArrayFormatter } from "effect/ParseResult";
+import * as Predicate from "effect/Predicate";
+import * as Runtime from "effect/Runtime";
+import * as Schema from "effect/Schema";
+import * as Scope from "effect/Scope";
+import * as Stream from "effect/Stream";
+import { withRun } from "./internal/utils.js";
+import * as Rpc from "./Rpc.js";
+import { constEof, constPong, RequestId, ResponseDefectEncoded } from "./RpcMessage.js";
+import * as RpcSchema from "./RpcSchema.js";
+import * as RpcSerialization from "./RpcSerialization.js";
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export const makeNoSerialization = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const tracingEnabled = options.disableSpanPropagation !== true;
+  const supportsAck = options.disableClientAcks !== true;
+  const spanPrefix = options.spanPrefix ?? "RpcServer";
+  const concurrency = options.concurrency ?? "unbounded";
+  const context = yield* Effect.context();
+  const scope = Context.get(context, Scope.Scope);
+  const fiberSet = yield* FiberSet.make();
+  const runFork = yield* FiberSet.runtime(fiberSet)().pipe(Effect.interruptible);
+  const concurrencySemaphore = concurrency === "unbounded" ? undefined : yield* Effect.makeSemaphore(concurrency);
+  const clients = new Map();
+  let isShutdown = false;
+  const shutdownLatch = Effect.unsafeMakeLatch(false);
+  yield* Scope.addFinalizer(scope, Effect.fiberIdWith(fiberId => {
+    isShutdown = true;
+    for (const client of clients.values()) {
+      client.ended = true;
+      if (client.fibers.size === 0) {
+        runFork(endClient(client));
+        continue;
+      }
+      for (const fiber of client.fibers.values()) {
+        fiber.unsafeInterruptAsFork(fiberId);
+      }
+    }
+    if (clients.size === 0) {
+      return Effect.void;
+    }
+    return shutdownLatch.await;
+  }));
+  const disconnect = clientId => Effect.fiberIdWith(fiberId => {
+    const client = clients.get(clientId);
+    if (!client) return Effect.void;
+    for (const fiber of client.fibers.values()) {
+      fiber.unsafeInterruptAsFork(fiberId);
+    }
+    clients.delete(clientId);
+    return Effect.void;
+  });
+  const write = (clientId, message) => Effect.runtime().pipe(
+    Effect.flatMap(runtime => Effect.catchAllDefect(Effect.suspend(() => {
+    if (isShutdown) return Effect.interrupt;
+    let client = clients.get(clientId);
+    if (!client) {
+      client = {
+        id: clientId,
+        latches: new Map(),
+        fibers: new Map(),
+        ended: false
+      };
+      clients.set(clientId, client);
+    } else if (client.ended) {
+      return Effect.interrupt;
+    }
+    switch (message._tag) {
+      case "Request":
+        {
+          return handleRequest(client, message, flow(Effect.interruptible, Runtime.runFork(runtime), _ => FiberSet.add(fiberSet, _).pipe(Effect.zipRight(Effect.succeed(_))), Effect.runSync));
+        }
+      case "Ack":
+        {
+          const latch = client.latches.get(message.requestId);
+          return latch ? latch.open : Effect.void;
+        }
+      case "Interrupt":
+        {
+          const fiber = client.fibers.get(message.requestId);
+          return fiber ? Fiber.interruptFork(fiber) : options.onFromServer({
+            _tag: "Exit",
+            clientId,
+            requestId: message.requestId,
+            exit: Exit.interrupt(FiberId.none)
+          });
+        }
+      case "Eof":
+        {
+          client.ended = true;
+          if (client.fibers.size > 0) return Effect.void;
+          return endClient(client);
+        }
+      default:
+        {
+          return sendDefect(client, `Unknown request tag: ${message._tag}`);
+        }
+    }
+  }), defect => sendDefect(clients.get(clientId), defect))));
+  const endClient = client => {
+    clients.delete(client.id);
+    const write = options.onFromServer({
+      _tag: "ClientEnd",
+      clientId: client.id
+    });
+    if (isShutdown && clients.size === 0) {
+      return Effect.zipRight(write, shutdownLatch.open);
+    }
+    return write;
+  };
+  const handleRequest = (client, request, runFork) => {
+    if (client.fibers.has(request.id)) {
+      return Effect.interrupt;
+    }
+    const rpc = group.requests.get(request.tag);
+    const entry = context.unsafeMap.get(rpc?.key);
+    if (!rpc || !entry) {
+      const write = Effect.catchAllDefect(options.onFromServer({
+        _tag: "Exit",
+        clientId: client.id,
+        requestId: request.id,
+        exit: Exit.die(`Unknown request tag: ${request.tag}`)
+      }), defect => sendDefect(client, defect));
+      if (!client.ended || client.fibers.size > 0) return write;
+      return Effect.zipRight(write, endClient(client));
+    }
+    const isStream = RpcSchema.isStreamSchema(rpc.successSchema);
+    const result = entry.handler(request.payload, request.headers);
+    // if the handler requested forking, then we skip the concurrency control
+    const isFork = Rpc.isFork(result);
+    // unwrap the fork data type
+    const streamOrEffect = isFork ? result.value : result;
+    let responded = false;
+    let effect = Effect.uninterruptible(Effect.matchCauseEffect(Effect.interruptible(applyMiddleware(rpc, context, request.payload, request.headers, isStream ? streamEffect(client, request, streamOrEffect) : streamOrEffect)), {
+      onSuccess: value => {
+        responded = true;
+        return options.onFromServer({
+          _tag: "Exit",
+          clientId: client.id,
+          requestId: request.id,
+          exit: Exit.succeed(value)
+        });
+      },
+      onFailure: cause => {
+        responded = true;
+        return options.onFromServer({
+          _tag: "Exit",
+          clientId: client.id,
+          requestId: request.id,
+          exit: Exit.failCause(cause)
+        });
+      }
+    }));
+    if (tracingEnabled) {
+      effect = Effect.withSpan(effect, `${spanPrefix}.${request.tag}`, {
+        captureStackTrace: false,
+        parent: {
+          _tag: "ExternalSpan",
+          traceId: request.traceId,
+          spanId: request.spanId,
+          sampled: request.sampled,
+          context: Context.empty()
+        }
+      });
+    }
+    //console.log("ctx2", context2)
+    let eff = effect
+    //effect = Effect.context().pipe(Effect.flatMap(context => Effect.provide(eff, Context.merge(context, entry.context))));
+    if (!isFork && concurrencySemaphore) {
+      effect = concurrencySemaphore.withPermits(1)(effect);
+    }
+    const fiber = runFork(effect);
+    client.fibers.set(request.id, fiber);
+    fiber.addObserver(exit => {
+      if (!responded && exit._tag === "Failure") {
+        runFork(options.onFromServer({
+          _tag: "Exit",
+          clientId: client.id,
+          requestId: request.id,
+          exit: Exit.interrupt(FiberId.none)
+        }));
+      }
+      client.fibers.delete(request.id);
+      client.latches.delete(request.id);
+      if (client.ended && client.fibers.size === 0) {
+        runFork(endClient(client));
+      }
+    });
+    return Effect.void;
+  };
+  const streamEffect = (client, request, stream) => {
+    let latch = client.latches.get(request.id);
+    if (supportsAck && !latch) {
+      latch = Effect.unsafeMakeLatch(false);
+      client.latches.set(request.id, latch);
+    }
+    if (Effect.isEffect(stream)) {
+      let done = false;
+      return stream.pipe(Effect.flatMap(mailbox => Effect.whileLoop({
+        while: () => !done,
+        body: constant(Effect.flatMap(mailbox.takeAll, ([chunk, done_]) => {
+          done = done_;
+          if (!Chunk.isNonEmpty(chunk)) return Effect.void;
+          const write = options.onFromServer({
+            _tag: "Chunk",
+            clientId: client.id,
+            requestId: request.id,
+            values: Chunk.toReadonlyArray(chunk)
+          });
+          if (!latch) return write;
+          latch.unsafeClose();
+          return Effect.zipRight(write, latch.await);
+        })),
+        step: constVoid
+      })), Effect.scoped);
+    }
+    return Stream.runForEachChunk(stream, chunk => {
+      if (!Chunk.isNonEmpty(chunk)) return Effect.void;
+      const write = options.onFromServer({
+        _tag: "Chunk",
+        clientId: client.id,
+        requestId: request.id,
+        values: Chunk.toReadonlyArray(chunk)
+      });
+      if (!latch) return write;
+      latch.unsafeClose();
+      return Effect.zipRight(write, latch.await);
+    });
+  };
+  const sendDefect = (client, defect) => Effect.suspend(() => {
+    const shouldEnd = client.ended && client.fibers.size === 0;
+    const write = options.onFromServer({
+      _tag: "Defect",
+      clientId: client.id,
+      defect
+    });
+    if (!shouldEnd) return write;
+    return Effect.zipRight(write, endClient(client));
+  });
+  return identity({
+    write,
+    disconnect
+  });
+});
+const applyMiddleware = (rpc, context, payload, headers, handler) => {
+  if (rpc.middlewares.size === 0) {
+    return handler;
+  }
+  const options = {
+    rpc,
+    payload,
+    headers
+  };
+  for (const tag of rpc.middlewares) {
+    const middleware = Context.unsafeGet(context, tag);
+    if (tag.optional) {
+      const previous = handler;
+      handler = Effect.matchEffect(middleware(options), {
+        onFailure: () => previous,
+        onSuccess: tag.provides !== undefined ? value => Effect.provideService(previous, tag.provides, value) : _ => previous
+      });
+    } else {
+      handler = tag.provides !== undefined ? Effect.provideServiceEffect(handler, tag.provides, middleware(options)) : Effect.zipRight(middleware(options), handler);
+    }
+  }
+  return handler;
+};
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export const make = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const {
+    disconnects,
+    end,
+    run,
+    send,
+    supportsAck,
+    supportsTransferables
+  } = yield* Protocol;
+  const context = yield* Effect.context();
+  const scope = yield* Scope.make();
+  const server = yield* makeNoSerialization(group, {
+    ...options,
+    disableClientAcks: !supportsAck,
+    onFromServer(response) {
+      const client = clients.get(response.clientId);
+      if (!client) return Effect.void;
+      switch (response._tag) {
+        case "Chunk":
+          {
+            const schemas = client.schemas.get(response.requestId);
+            if (!schemas) return Effect.void;
+            return handleEncode(client, response.requestId, schemas.collector, Effect.locally(schemas.encodeChunk(response.values), FiberRef.currentContext, schemas.context), values => ({
+              _tag: "Chunk",
+              requestId: response.requestId,
+              values
+            }));
+          }
+        case "Exit":
+          {
+            const schemas = client.schemas.get(response.requestId);
+            if (!schemas) return Effect.void;
+            client.schemas.delete(response.requestId);
+            return handleEncode(client, response.requestId, schemas.collector, Effect.locally(schemas.encodeExit(response.exit), FiberRef.currentContext, schemas.context), exit => ({
+              _tag: "Exit",
+              requestId: response.requestId,
+              exit
+            }));
+          }
+        case "Defect":
+          {
+            return sendDefect(client, response.defect);
+          }
+        case "ClientEnd":
+          {
+            clients.delete(response.clientId);
+            return end(response.clientId);
+          }
+      }
+    }
+  }).pipe(Scope.extend(scope));
+  // handle disconnects
+  yield* Effect.fork(Effect.interruptible(Effect.whileLoop({
+    while: constTrue,
+    body: constant(Effect.flatMap(disconnects.take, clientId => {
+      clients.delete(clientId);
+      return server.disconnect(clientId);
+    })),
+    step: constVoid
+  })));
+  const schemasCache = new WeakMap();
+  const getSchemas = rpc => {
+    let schemas = schemasCache.get(rpc);
+    if (!schemas) {
+      const entry = context.unsafeMap.get(rpc.key);
+      const streamSchemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast);
+      const failures = new Set([rpc.errorSchema]);
+      if (Option.isSome(streamSchemas)) {
+        failures.add(streamSchemas.value.failure);
+      }
+      for (const middleware of rpc.middlewares) {
+        failures.add(middleware.failure);
+      }
+      schemas = {
+        decode: Schema.decodeUnknown(rpc.payloadSchema),
+        encodeChunk: Schema.encodeUnknown(Schema.Array(Option.isSome(streamSchemas) ? streamSchemas.value.success : Schema.Any)),
+        encodeExit: Schema.encodeUnknown(Rpc.exitSchema(rpc)),
+        context: entry.context
+      };
+      schemasCache.set(rpc, schemas);
+    }
+    return schemas;
+  };
+  const clients = new Map();
+  const handleEncode = (client, requestId, collector, effect, onSuccess) => (collector ? Effect.provideService(effect, Transferable.Collector, collector) : effect).pipe(Effect.flatMap(a => send(client.id, onSuccess(a), collector && collector.unsafeClear())), Effect.catchAllCause(cause => {
+    client.schemas.delete(requestId);
+    const defect = Cause.squash(Cause.map(cause, ArrayFormatter.formatErrorSync));
+    return Effect.zipRight(server.write(client.id, {
+      _tag: "Interrupt",
+      requestId,
+      interruptors: []
+    }), sendRequestDefect(client, requestId, defect));
+  }));
+  const sendRequestDefect = (client, requestId, defect) => Effect.catchAllCause(send(client.id, {
+    _tag: "Exit",
+    requestId,
+    exit: {
+      _tag: "Failure",
+      cause: {
+        _tag: "Die",
+        defect
+      }
+    }
+  }), cause => sendDefect(client, Cause.squash(cause)));
+  const sendDefect = (client, defect) => Effect.catchAllCause(send(client.id, {
+    _tag: "Defect",
+    defect
+  }), cause => Effect.annotateLogs(Effect.logDebug(cause), {
+    module: "RpcServer",
+    method: "sendDefect"
+  }));
+  // main server loop
+  return yield* run((clientId, request) => {
+    let client = clients.get(clientId);
+    if (!client) {
+      client = {
+        id: clientId,
+        schemas: new Map()
+      };
+      clients.set(clientId, client);
+    }
+    switch (request._tag) {
+      case "Request":
+        {
+          const tag = Predicate.hasProperty(request, "tag") ? request.tag : "";
+          const rpc = group.requests.get(tag);
+          if (!rpc) {
+            return sendDefect(client, `Unknown request tag: ${tag}`);
+          }
+          let requestId;
+          switch (typeof request.id) {
+            case "bigint":
+            case "string":
+              {
+                requestId = RequestId(request.id);
+                break;
+              }
+            default:
+              {
+                return sendDefect(client, `Invalid request id: ${request.id}`);
+              }
+          }
+          const schemas = getSchemas(rpc);
+          return Effect.matchEffect(Effect.locally(schemas.decode(request.payload), FiberRef.currentContext, schemas.context), {
+            onFailure: error => sendRequestDefect(client, requestId, ArrayFormatter.formatErrorSync(error)),
+            onSuccess: payload => {
+              client.schemas.set(requestId, supportsTransferables ? {
+                ...schemas,
+                collector: Transferable.unsafeMakeCollector()
+              } : schemas);
+              return server.write(clientId, {
+                ...request,
+                id: requestId,
+                payload,
+                headers: Headers.fromInput(request.headers)
+              });
+            }
+          });
+        }
+      case "Ping":
+        {
+          return Effect.catchAllCause(send(client.id, constPong), cause => sendDefect(client, Cause.squash(cause)));
+        }
+      case "Ack":
+      case "Eof":
+      case "Interrupt":
+        {
+          if ("requestId" in request && typeof request.requestId === "string") {
+            ;
+            request.requestId = BigInt(request.requestId);
+          }
+          return server.write(clientId, request._tag === "Interrupt" ? {
+            ...request,
+            interruptors: []
+          } : request);
+        }
+      default:
+        {
+          return sendDefect(client, `Unknown request tag: ${request._tag}`);
+        }
+    }
+  }).pipe(Effect.interruptible, Effect.tapErrorCause(cause => Effect.logFatal("BUG: RpcServer protocol crashed", cause)), Effect.onExit(exit => Scope.close(scope, exit)));
+});
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export const layer = (group, options) => Layer.scopedDiscard(Effect.forkScoped(Effect.interruptible(make(group, options))));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export class Protocol extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcServer/Protocol")() {
+  /**
+   * @since 1.0.0
+   */
+  static make = /*#__PURE__*/withRun();
+}
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolSocketServer = /*#__PURE__*/Effect.gen(function* () {
+  const server = yield* SocketServer.SocketServer;
+  const {
+    onSocket,
+    protocol
+  } = yield* makeSocketProtocol;
+  yield* Effect.forkScoped(Effect.interruptible(server.run(Effect.fnUntraced(onSocket, Effect.scoped))));
+  return protocol;
+});
+/**
+ * A rpc protocol that uses `SocketServer` for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolSocketServer = /*#__PURE__*/Layer.scoped(Protocol, makeProtocolSocketServer);
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWithHttpAppWebsocket = /*#__PURE__*/Effect.gen(function* () {
+  const {
+    onSocket,
+    protocol
+  } = yield* makeSocketProtocol;
+  const httpApp = Effect.gen(function* () {
+    const request = yield* HttpServerRequest.HttpServerRequest;
+    const socket = yield* Effect.orDie(request.upgrade);
+    yield* onSocket(socket);
+    return HttpServerResponse.empty();
+  });
+  return {
+    protocol,
+    httpApp
+  };
+});
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWebsocket = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpAppWebsocket;
+  const router = yield* options.routerTag ?? HttpRouter.Default;
+  yield* router.get(options.path, httpApp);
+  return protocol;
+});
+/**
+ * A rpc protocol that uses websockets for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolWebsocket = options => {
+  const routerTag = options.routerTag ?? HttpRouter.Default;
+  return Layer.effect(Protocol, makeProtocolWebsocket(options)).pipe(Layer.provide(routerTag.Live));
+};
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWithHttpApp = /*#__PURE__*/Effect.gen(function* () {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const isJson = serialization.contentType === "application/json";
+  const disconnects = yield* Mailbox.make();
+  let writeRequest;
+  let clientId = 0;
+  const clients = new Map();
+  const httpApp = Effect.gen(function* () {
+    const request = yield* HttpServerRequest.HttpServerRequest;
+    const data = yield* Effect.orDie(request.arrayBuffer);
+    const id = clientId++;
+    const mailbox = yield* Mailbox.make();
+    const parser = serialization.unsafeMake();
+    const encoder = new TextEncoder();
+    const offer = data => typeof data === "string" ? mailbox.offer(encoder.encode(data)) : mailbox.offer(data);
+    clients.set(id, {
+      write: response => {
+        try {
+          if (!serialization.supportsBigInt) {
+            transformBigInt(response);
+          }
+          return isJson ? mailbox.offer(response) : offer(parser.encode(response));
+        } catch (cause) {
+          return isJson ? mailbox.offer(ResponseDefectEncoded(cause)) : offer(parser.encode(ResponseDefectEncoded(cause)));
+        }
+      },
+      end: mailbox.end
+    });
+    const requestIds = [];
+    try {
+      const decoded = parser.decode(new Uint8Array(data));
+      for (const message of decoded) {
+        if (message._tag === "Request") {
+          requestIds.push(RequestId(message.id));
+        }
+        yield* writeRequest(id, message);
+      }
+    } catch (cause) {
+      yield* offer(parser.encode(ResponseDefectEncoded(cause)));
+    }
+    yield* writeRequest(id, constEof);
+    if (isJson) {
+      let done = false;
+      yield* Effect.addFinalizer(() => {
+        clients.delete(id);
+        disconnects.unsafeOffer(id);
+        if (done) return Effect.void;
+        return Effect.forEach(requestIds, requestId => writeRequest(id, {
+          _tag: "Interrupt",
+          requestId
+        }), {
+          discard: true
+        });
+      });
+      const responses = Arr.empty();
+      while (true) {
+        const [items, done] = yield* mailbox.takeAll;
+        // eslint-disable-next-line no-restricted-syntax
+        responses.push(...items);
+        if (done) break;
+      }
+      done = true;
+      return HttpServerResponse.unsafeJson(responses);
+    }
+    return HttpServerResponse.stream(Stream.ensuringWith(Mailbox.toStream(mailbox), exit => {
+      clients.delete(id);
+      disconnects.unsafeOffer(id);
+      if (!Exit.isInterrupted(exit)) return Effect.void;
+      return Effect.forEach(requestIds, requestId => writeRequest(id, {
+        _tag: "Interrupt",
+        requestId
+      }), {
+        discard: true
+      });
+    }), {
+      contentType: serialization.contentType
+    });
+  }).pipe(Effect.interruptible);
+  const protocol = yield* Protocol.make(writeRequest_ => {
+    writeRequest = writeRequest_;
+    return Effect.succeed({
+      disconnects,
+      send: (clientId, response) => {
+        const client = clients.get(clientId);
+        if (!client) return Effect.void;
+        return client.write(response);
+      },
+      end(clientId) {
+        const client = clients.get(clientId);
+        if (!client) return Effect.void;
+        return client.end;
+      },
+      initialMessage: Effect.succeedNone,
+      supportsAck: false,
+      supportsTransferables: false
+    });
+  });
+  return {
+    protocol,
+    httpApp
+  };
+});
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolHttp = /*#__PURE__*/Effect.fnUntraced(function* (options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpApp;
+  const router = yield* options.routerTag ?? HttpRouter.Default;
+  yield* router.post(options.path, httpApp);
+  return protocol;
+});
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWorkerRunner = /*#__PURE__*/Protocol.make( /*#__PURE__*/Effect.fnUntraced(function* (writeRequest) {
+  const runner = yield* WorkerRunner.PlatformRunner;
+  const closeLatch = yield* WorkerRunner.CloseLatch;
+  const backing = yield* runner.start(closeLatch);
+  const initialMessage = yield* Deferred.make();
+  yield* backing.run((clientId, message) => {
+    if (message._tag === "InitialMessage") {
+      return Deferred.succeed(initialMessage, message.value);
+    }
+    return writeRequest(clientId, message);
+  });
+  return {
+    disconnects: backing.disconnects ?? (yield* Mailbox.make()),
+    send: backing.send,
+    end(_clientId) {
+      return Effect.void;
+    },
+    initialMessage: Effect.asSome(Deferred.await(initialMessage)),
+    supportsAck: true,
+    supportsTransferables: true
+  };
+}));
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolWorkerRunner = /*#__PURE__*/Layer.scoped(Protocol, makeProtocolWorkerRunner);
+/**
+ * A rpc protocol that uses streaming http for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolHttp = options => {
+  const routerTag = options.routerTag ?? HttpRouter.Default;
+  return Layer.effect(Protocol, makeProtocolHttp(options)).pipe(Layer.provide(routerTag.Live));
+};
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+export const toHttpApp = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpApp;
+  yield* make(group, options).pipe(Effect.provideService(Protocol, protocol), Effect.interruptible, Effect.forkScoped);
+  return httpApp;
+});
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+export const toHttpAppWebsocket = /*#__PURE__*/Effect.fnUntraced(function* (group, options) {
+  const {
+    httpApp,
+    protocol
+  } = yield* makeProtocolWithHttpAppWebsocket;
+  yield* make(group, options).pipe(Effect.provideService(Protocol, protocol), Effect.interruptible, Effect.forkScoped);
+  return httpApp;
+});
+/**
+ * Construct an http web handler from an `RpcGroup`.
+ *
+ * @since 1.0.0
+ * @category constructors
+ */
+export const toWebHandler = (group, options) => {
+  const runtime = ManagedRuntime.make(Layer.mergeAll(options.layer, Layer.scope), options?.memoMap);
+  let handlerCached;
+  const handlerPromise = Effect.gen(function* () {
+    const app = yield* toHttpApp(group, options);
+    const rt = yield* runtime.runtimeEffect;
+    const handler = HttpApp.toWebHandlerRuntime(rt)(options?.middleware ? options.middleware(app) : app);
+    handlerCached = handler;
+    return handler;
+  }).pipe(runtime.runPromise);
+  function handler(request, context) {
+    if (handlerCached !== undefined) {
+      return handlerCached(request, context);
+    }
+    return handlerPromise.then(handler => handler(request, context));
+  }
+  return {
+    handler,
+    dispose: runtime.dispose
+  };
+};
+// internal
+const makeSocketProtocol = /*#__PURE__*/Effect.gen(function* () {
+  const serialization = yield* RpcSerialization.RpcSerialization;
+  const disconnects = yield* Mailbox.make();
+  let clientId = 0;
+  const clients = new Map();
+  let writeRequest;
+  const onSocket = function* (socket) {
+    const scope = yield* Effect.scope;
+    const parser = serialization.unsafeMake();
+    const id = clientId++;
+    yield* Scope.addFinalizerExit(scope, () => {
+      clients.delete(id);
+      return disconnects.offer(id);
+    });
+    const writeRaw = yield* socket.writer;
+    const write = response => {
+      try {
+        if (!serialization.supportsBigInt) {
+          transformBigInt(response);
+        }
+        return Effect.orDie(writeRaw(parser.encode(response)));
+      } catch (cause) {
+        return Effect.orDie(writeRaw(parser.encode(ResponseDefectEncoded(cause))));
+      }
+    };
+    clients.set(id, {
+      write
+    });
+    yield* Effect.orDie(Effect.interruptible(socket.runRaw(data => {
+      try {
+        const decoded = parser.decode(data);
+        if (decoded.length === 0) return Effect.void;
+        let i = 0;
+        return Effect.whileLoop({
+          while: () => i < decoded.length,
+          body: () => writeRequest(id, decoded[i++]),
+          step: constVoid
+        });
+      } catch (cause) {
+        return writeRaw(parser.encode(ResponseDefectEncoded(cause)));
+      }
+    })));
+  };
+  const protocol = yield* Protocol.make(writeRequest_ => {
+    writeRequest = writeRequest_;
+    return Effect.succeed({
+      disconnects,
+      send: (clientId, response) => {
+        const client = clients.get(clientId);
+        if (!client) return Effect.void;
+        return Effect.orDie(client.write(response));
+      },
+      end(_clientId) {
+        return Effect.void;
+      },
+      initialMessage: Effect.succeedNone,
+      supportsAck: true,
+      supportsTransferables: false
+    });
+  });
+  return {
+    protocol,
+    onSocket
+  };
+});
+const transformBigInt = response => {
+  if ("requestId" in response) {
+    ;
+    response.requestId = response.requestId.toString();
+  }
+};
+//# sourceMappingURL=RpcServer.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcServer.js.map b/dist/esm/RpcServer.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..ecbf1fc7c083d7f373c015ab67c7f78a37c78aa8
--- /dev/null
+++ b/dist/esm/RpcServer.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcServer.js","names":["Headers","HttpApp","HttpRouter","HttpServerRequest","HttpServerResponse","SocketServer","Transferable","WorkerRunner","Arr","Cause","Chunk","Context","Deferred","Effect","Exit","Fiber","FiberId","FiberRef","FiberSet","constant","constTrue","constVoid","identity","Layer","Mailbox","ManagedRuntime","Option","ArrayFormatter","Predicate","Schema","Scope","Stream","withRun","Rpc","constEof","constPong","RequestId","ResponseDefectEncoded","RpcSchema","RpcSerialization","makeNoSerialization","fnUntraced","group","options","tracingEnabled","disableSpanPropagation","supportsAck","disableClientAcks","spanPrefix","concurrency","context","scope","get","fiberSet","make","runFork","runtime","pipe","interruptible","concurrencySemaphore","undefined","makeSemaphore","clients","Map","isShutdown","shutdownLatch","unsafeMakeLatch","addFinalizer","fiberIdWith","fiberId","client","values","ended","fibers","size","endClient","fiber","unsafeInterruptAsFork","void","await","disconnect","clientId","delete","write","message","catchAllDefect","suspend","interrupt","id","latches","set","_tag","handleRequest","latch","requestId","open","interruptFork","onFromServer","exit","none","sendDefect","defect","zipRight","request","has","rpc","requests","tag","entry","unsafeMap","key","die","isStream","isStreamSchema","successSchema","result","handler","payload","headers","isFork","streamOrEffect","value","responded","effect","uninterruptible","matchCauseEffect","applyMiddleware","streamEffect","onSuccess","succeed","onFailure","cause","failCause","withSpan","captureStackTrace","parent","traceId","spanId","sampled","empty","locally","currentContext","withPermits","addObserver","stream","isEffect","done","flatMap","mailbox","whileLoop","while","body","takeAll","chunk","done_","isNonEmpty","toReadonlyArray","unsafeClose","step","scoped","runForEachChunk","shouldEnd","middlewares","middleware","unsafeGet","optional","previous","matchEffect","provides","provideService","_","provideServiceEffect","disconnects","end","run","send","supportsTransferables","Protocol","server","response","schemas","handleEncode","collector","encodeChunk","encodeExit","extend","fork","take","schemasCache","WeakMap","getSchemas","streamSchemas","getStreamSchemas","ast","failures","Set","errorSchema","isSome","add","failure","decode","decodeUnknown","payloadSchema","encodeUnknown","Array","success","Any","exitSchema","Collector","a","unsafeClear","catchAllCause","squash","map","formatErrorSync","interruptors","sendRequestDefect","annotateLogs","logDebug","module","method","hasProperty","error","unsafeMakeCollector","fromInput","BigInt","tapErrorCause","logFatal","onExit","close","layer","scopedDiscard","forkScoped","Tag","makeProtocolSocketServer","gen","onSocket","protocol","makeSocketProtocol","layerProtocolSocketServer","makeProtocolWithHttpAppWebsocket","httpApp","socket","orDie","upgrade","makeProtocolWebsocket","router","routerTag","Default","path","layerProtocolWebsocket","provide","Live","makeProtocolWithHttpApp","serialization","isJson","contentType","writeRequest","data","arrayBuffer","parser","unsafeMake","encoder","TextEncoder","offer","encode","supportsBigInt","transformBigInt","requestIds","decoded","Uint8Array","push","unsafeOffer","forEach","discard","responses","items","unsafeJson","ensuringWith","toStream","isInterrupted","writeRequest_","initialMessage","succeedNone","makeProtocolHttp","post","makeProtocolWorkerRunner","runner","PlatformRunner","closeLatch","CloseLatch","backing","start","_clientId","asSome","layerProtocolWorkerRunner","layerProtocolHttp","toHttpApp","toHttpAppWebsocket","toWebHandler","mergeAll","memoMap","handlerCached","handlerPromise","app","rt","runtimeEffect","toWebHandlerRuntime","runPromise","then","dispose","addFinalizerExit","writeRaw","writer","runRaw","length","i","toString"],"sources":["../../src/RpcServer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcTest.js b/dist/esm/RpcTest.js
new file mode 100644
index 0000000000000000000000000000000000000000..fc33ca6c2f60b8f19c9c7b1e8588e9296c5bec16
--- /dev/null
+++ b/dist/esm/RpcTest.js
@@ -0,0 +1,29 @@
+/**
+ * @since 1.0.0
+ */
+import * as Effect from "effect/Effect";
+import * as RpcClient from "./RpcClient.js";
+import * as RpcServer from "./RpcServer.js";
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export const makeClient = /*#__PURE__*/Effect.fnUntraced(function* (group) {
+  // eslint-disable-next-line prefer-const
+  let client;
+  const server = yield* RpcServer.makeNoSerialization(group, {
+    onFromServer(response) {
+      return client.write(response);
+    }
+  });
+  client = yield* RpcClient.makeNoSerialization(group, {
+    supportsAck: true,
+    onFromClient({
+      message
+    }) {
+      return server.write(0, message);
+    }
+  });
+  return client.client;
+});
+//# sourceMappingURL=RpcTest.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcTest.js.map b/dist/esm/RpcTest.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..41c2958083c9902a2e59bd5f23e95f691010ee20
--- /dev/null
+++ b/dist/esm/RpcTest.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcTest.js","names":["Effect","RpcClient","RpcServer","makeClient","fnUntraced","group","client","server","makeNoSerialization","onFromServer","response","write","supportsAck","onFromClient","message"],"sources":["../../src/RpcTest.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,MAAM,MAAM,eAAe;AAGvC,OAAO,KAAKC,SAAS,MAAM,gBAAgB;AAE3C,OAAO,KAAKC,SAAS,MAAM,gBAAgB;AAE3C;;;;AAIA,OAAO,MAAMC,UAAU,gBAMnBH,MAAM,CAACI,UAAU,CAAC,WACpBC,KAA8B;EAE9B;EACA,IAAIC,MAA6F;EACjG,MAAMC,MAAM,GAAG,OAAOL,SAAS,CAACM,mBAAmB,CAACH,KAAK,EAAE;IACzDI,YAAYA,CAACC,QAAQ;MACnB,OAAOJ,MAAM,CAACK,KAAK,CAACD,QAAQ,CAAC;IAC/B;GACD,CAAC;EACFJ,MAAM,GAAG,OAAOL,SAAS,CAACO,mBAAmB,CAACH,KAAK,EAAE;IACnDO,WAAW,EAAE,IAAI;IACjBC,YAAYA,CAAC;MAAEC;IAAO,CAAE;MACtB,OAAOP,MAAM,CAACI,KAAK,CAAC,CAAC,EAAEG,OAAO,CAAC;IACjC;GACD,CAAC;EACF,OAAOR,MAAM,CAACA,MAAM;AACtB,CAAC,CAAC","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/RpcWorker.js b/dist/esm/RpcWorker.js
new file mode 100644
index 0000000000000000000000000000000000000000..7d1b8d743ac93b5a8d948f1998436b08fffb4cf1
--- /dev/null
+++ b/dist/esm/RpcWorker.js
@@ -0,0 +1,33 @@
+/**
+ * @since 1.0.0
+ */
+import * as Transferable from "@effect/platform/Transferable";
+import * as Context from "effect/Context";
+import * as Effect from "effect/Effect";
+import * as Layer from "effect/Layer";
+import * as Schema from "effect/Schema";
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export class InitialMessage extends /*#__PURE__*/Context.Tag("@effect/rpc/RpcWorker/InitialMessage")() {}
+const ProtocolTag = /*#__PURE__*/Context.GenericTag("@effect/rpc/RpcServer/Protocol");
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export const makeInitialMessage = (schema, effect) => Effect.flatMap(effect, value => {
+  const collector = Transferable.unsafeMakeCollector();
+  return Schema.encode(schema)(value).pipe(Effect.provideService(Transferable.Collector, collector), Effect.map(encoded => [encoded, collector.unsafeClear()]));
+});
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export const layerInitialMessage = (schema, build) => Layer.effect(InitialMessage, Effect.contextWith(context => Effect.provide(Effect.orDie(makeInitialMessage(schema, build)), context)));
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export const initialMessage = schema => ProtocolTag.pipe(Effect.flatMap(protocol => protocol.initialMessage), Effect.flatten, Effect.flatMap(Schema.decodeUnknown(schema)));
+//# sourceMappingURL=RpcWorker.js.map
\ No newline at end of file
diff --git a/dist/esm/RpcWorker.js.map b/dist/esm/RpcWorker.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..79707767a911283c5d67ea6e92b5c18b6bbb3c3b
--- /dev/null
+++ b/dist/esm/RpcWorker.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"RpcWorker.js","names":["Transferable","Context","Effect","Layer","Schema","InitialMessage","Tag","ProtocolTag","GenericTag","makeInitialMessage","schema","effect","flatMap","value","collector","unsafeMakeCollector","encode","pipe","provideService","Collector","map","encoded","unsafeClear","layerInitialMessage","build","contextWith","context","provide","orDie","initialMessage","protocol","flatten","decodeUnknown"],"sources":["../../src/RpcWorker.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,YAAY,MAAM,+BAA+B;AAE7D,OAAO,KAAKC,OAAO,MAAM,gBAAgB;AACzC,OAAO,KAAKC,MAAM,MAAM,eAAe;AACvC,OAAO,KAAKC,KAAK,MAAM,cAAc;AAErC,OAAO,KAAKC,MAAM,MAAM,eAAe;AAGvC;;;;AAIA,OAAM,MAAOC,cAAe,sBAAQJ,OAAO,CAACK,GAAG,CAAC,sCAAsC,CAAC,EAQpF;AAiBH,MAAMC,WAAW,gBAAoBN,OAAO,CAACO,UAAU,CAAC,gCAAgC,CAAQ;AAEhG;;;;AAIA,OAAO,MAAMC,kBAAkB,GAAGA,CAChCC,MAA8B,EAC9BC,MAA+B,KAM/BT,MAAM,CAACU,OAAO,CAACD,MAAM,EAAGE,KAAK,IAAI;EAC/B,MAAMC,SAAS,GAAGd,YAAY,CAACe,mBAAmB,EAAE;EACpD,OAAOX,MAAM,CAACY,MAAM,CAACN,MAAM,CAAC,CAACG,KAAK,CAAC,CAACI,IAAI,CACtCf,MAAM,CAACgB,cAAc,CAAClB,YAAY,CAACmB,SAAS,EAAEL,SAAS,CAAC,EACxDZ,MAAM,CAACkB,GAAG,CAAEC,OAAO,IAAK,CAACA,OAAO,EAAEP,SAAS,CAACQ,WAAW,EAAE,CAAU,CAAC,CACrE;AACH,CAAC,CAAC;AAEJ;;;;AAIA,OAAO,MAAMC,mBAAmB,GAAGA,CACjCb,MAA8B,EAC9Bc,KAAkC,KAElCrB,KAAK,CAACQ,MAAM,CACVN,cAAc,EACdH,MAAM,CAACuB,WAAW,CAAEC,OAAgC,IAClDxB,MAAM,CAACyB,OAAO,CAACzB,MAAM,CAAC0B,KAAK,CAACnB,kBAAkB,CAACC,MAAM,EAAEc,KAAK,CAAC,CAAC,EAAEE,OAAO,CAAC,CACzE,CACF;AAEH;;;;AAIA,OAAO,MAAMG,cAAc,GACzBnB,MAA8B,IAE9BH,WAAW,CAACU,IAAI,CACdf,MAAM,CAACU,OAAO,CAAEkB,QAAQ,IAAKA,QAAQ,CAACD,cAAc,CAAC,EACrD3B,MAAM,CAAC6B,OAAO,EACd7B,MAAM,CAACU,OAAO,CAACR,MAAM,CAAC4B,aAAa,CAACtB,MAAM,CAAC,CAAC,CAC7C","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/index.js b/dist/esm/index.js
index 460563cdf2a7e60badb88dd7f0fbd2c9bd8b860f..5c2ff392f8da296f8dc79dfd9adb8e091fd5fceb 100644
--- a/dist/esm/index.js
+++ b/dist/esm/index.js
@@ -5,13 +5,37 @@ export * as Rpc from "./Rpc.js";
 /**
  * @since 1.0.0
  */
-export * as RpcResolver from "./RpcResolver.js";
+export * as RpcClient from "./RpcClient.js";
 /**
  * @since 1.0.0
  */
-export * as RpcResolverNoStream from "./RpcResolverNoStream.js";
+export * as RpcGroup from "./RpcGroup.js";
 /**
  * @since 1.0.0
  */
-export * as RpcRouter from "./RpcRouter.js";
+export * as RpcMessage from "./RpcMessage.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcMiddleware from "./RpcMiddleware.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcSchema from "./RpcSchema.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcSerialization from "./RpcSerialization.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcServer from "./RpcServer.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcTest from "./RpcTest.js";
+/**
+ * @since 1.0.0
+ */
+export * as RpcWorker from "./RpcWorker.js";
 //# sourceMappingURL=index.js.map
\ No newline at end of file
diff --git a/dist/esm/index.js.map b/dist/esm/index.js.map
index 393465860be424b2a84a4211585c7c10056e5538..7a25ae3c5434e44d82ef35add4dc008bb9f87509 100644
--- a/dist/esm/index.js.map
+++ b/dist/esm/index.js.map
@@ -1 +1 @@
-{"version":3,"file":"index.js","names":["Rpc","RpcResolver","RpcResolverNoStream","RpcRouter"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,GAAG,MAAM,UAAU;AAE/B;;;AAGA,OAAO,KAAKC,WAAW,MAAM,kBAAkB;AAE/C;;;AAGA,OAAO,KAAKC,mBAAmB,MAAM,0BAA0B;AAE/D;;;AAGA,OAAO,KAAKC,SAAS,MAAM,gBAAgB","ignoreList":[]}
\ No newline at end of file
+{"version":3,"file":"index.js","names":["Rpc","RpcClient","RpcGroup","RpcMessage","RpcMiddleware","RpcSchema","RpcSerialization","RpcServer","RpcTest","RpcWorker"],"sources":["../../src/index.ts"],"sourcesContent":[null],"mappings":"AAAA;;;AAGA,OAAO,KAAKA,GAAG,MAAM,UAAU;AAE/B;;;AAGA,OAAO,KAAKC,SAAS,MAAM,gBAAgB;AAE3C;;;AAGA,OAAO,KAAKC,QAAQ,MAAM,eAAe;AAEzC;;;AAGA,OAAO,KAAKC,UAAU,MAAM,iBAAiB;AAE7C;;;AAGA,OAAO,KAAKC,aAAa,MAAM,oBAAoB;AAEnD;;;AAGA,OAAO,KAAKC,SAAS,MAAM,gBAAgB;AAE3C;;;AAGA,OAAO,KAAKC,gBAAgB,MAAM,uBAAuB;AAEzD;;;AAGA,OAAO,KAAKC,SAAS,MAAM,gBAAgB;AAE3C;;;AAGA,OAAO,KAAKC,OAAO,MAAM,cAAc;AAEvC;;;AAGA,OAAO,KAAKC,SAAS,MAAM,gBAAgB","ignoreList":[]}
\ No newline at end of file
diff --git a/dist/esm/internal/utils.js b/dist/esm/internal/utils.js
new file mode 100644
index 0000000000000000000000000000000000000000..323aac37cec80cc769bd46e74de0a1aae025fac6
--- /dev/null
+++ b/dist/esm/internal/utils.js
@@ -0,0 +1,25 @@
+import * as Effect from "effect/Effect";
+/** @internal */
+export const withRun = () => f => Effect.suspend(() => {
+  const semaphore = Effect.unsafeMakeSemaphore(1);
+  let buffer = [];
+  let write = (...args) => Effect.sync(() => buffer.push(args));
+  return Effect.map(f((...args) => write(...args)), a => ({
+    ...a,
+    run(f) {
+      return semaphore.withPermits(1)(Effect.gen(function* () {
+        const prev = write;
+        write = f;
+        for (const value of buffer) {
+          yield* write(...value);
+        }
+        buffer = [];
+        return yield* Effect.onExit(Effect.never, () => {
+          write = prev;
+          return Effect.void;
+        });
+      }));
+    }
+  }));
+});
+//# sourceMappingURL=utils.js.map
\ No newline at end of file
diff --git a/dist/esm/internal/utils.js.map b/dist/esm/internal/utils.js.map
new file mode 100644
index 0000000000000000000000000000000000000000..1fc1298f664dac9a46743dd8e3a6122142787af8
--- /dev/null
+++ b/dist/esm/internal/utils.js.map
@@ -0,0 +1 @@
+{"version":3,"file":"utils.js","names":["Effect","withRun","f","suspend","semaphore","unsafeMakeSemaphore","buffer","write","args","sync","push","map","a","run","withPermits","gen","prev","value","onExit","never","void"],"sources":["../../../src/internal/utils.ts"],"sourcesContent":[null],"mappings":"AAAA,OAAO,KAAKA,MAAM,MAAM,eAAe;AAEvC;AACA,OAAO,MAAMC,OAAO,GAAGA,CAAA,KAKdC,CAA4E,IACnFF,MAAM,CAACG,OAAO,CAAC,MAAK;EAClB,MAAMC,SAAS,GAAGJ,MAAM,CAACK,mBAAmB,CAAC,CAAC,CAAC;EAC/C,IAAIC,MAAM,GAAsB,EAAE;EAClC,IAAIC,KAAK,GAAGA,CAAC,GAAGC,IAAgB,KAA0BR,MAAM,CAACS,IAAI,CAAC,MAAMH,MAAM,CAACI,IAAI,CAACF,IAAI,CAAC,CAAC;EAC9F,OAAOR,MAAM,CAACW,GAAG,CAACT,CAAC,CAAC,CAAC,GAAGM,IAAI,KAAKD,KAAK,CAAC,GAAGC,IAAI,CAAC,CAAC,EAAGI,CAAC,KAAM;IACxD,GAAGA,CAAC;IACJC,GAAGA,CAACX,CAAC;MACH,OAAOE,SAAS,CAACU,WAAW,CAAC,CAAC,CAAC,CAACd,MAAM,CAACe,GAAG,CAAC,aAAS;QAClD,MAAMC,IAAI,GAAGT,KAAK;QAClBA,KAAK,GAAGL,CAAC;QAET,KAAK,MAAMe,KAAK,IAAIX,MAAM,EAAE;UAC1B,OAAOC,KAAK,CAAC,GAAGU,KAAK,CAAC;QACxB;QACAX,MAAM,GAAG,EAAE;QAEX,OAAO,OAAON,MAAM,CAACkB,MAAM,CAAClB,MAAM,CAACmB,KAAK,EAAE,MAAK;UAC7CZ,KAAK,GAAGS,IAAI;UACZ,OAAOhB,MAAM,CAACoB,IAAI;QACpB,CAAC,CAAC;MACJ,CAAC,CAAC,CAAC;IACL;GACK,EAAC;AACV,CAAC,CAAC","ignoreList":[]}
\ No newline at end of file
diff --git a/package.json b/package.json
index 73bbacc4caa0113a1506c5574faf9e8349ebbf70..b99733f848dd8190d92bcca5e64d3fb4d2dc2dea 100644
--- a/package.json
+++ b/package.json
@@ -31,20 +31,50 @@
       "import": "./dist/esm/Rpc.js",
       "default": "./dist/cjs/Rpc.js"
     },
-    "./RpcResolver": {
-      "types": "./dist/dts/RpcResolver.d.ts",
-      "import": "./dist/esm/RpcResolver.js",
-      "default": "./dist/cjs/RpcResolver.js"
+    "./RpcClient": {
+      "types": "./dist/dts/RpcClient.d.ts",
+      "import": "./dist/esm/RpcClient.js",
+      "default": "./dist/cjs/RpcClient.js"
     },
-    "./RpcResolverNoStream": {
-      "types": "./dist/dts/RpcResolverNoStream.d.ts",
-      "import": "./dist/esm/RpcResolverNoStream.js",
-      "default": "./dist/cjs/RpcResolverNoStream.js"
+    "./RpcGroup": {
+      "types": "./dist/dts/RpcGroup.d.ts",
+      "import": "./dist/esm/RpcGroup.js",
+      "default": "./dist/cjs/RpcGroup.js"
     },
-    "./RpcRouter": {
-      "types": "./dist/dts/RpcRouter.d.ts",
-      "import": "./dist/esm/RpcRouter.js",
-      "default": "./dist/cjs/RpcRouter.js"
+    "./RpcMessage": {
+      "types": "./dist/dts/RpcMessage.d.ts",
+      "import": "./dist/esm/RpcMessage.js",
+      "default": "./dist/cjs/RpcMessage.js"
+    },
+    "./RpcMiddleware": {
+      "types": "./dist/dts/RpcMiddleware.d.ts",
+      "import": "./dist/esm/RpcMiddleware.js",
+      "default": "./dist/cjs/RpcMiddleware.js"
+    },
+    "./RpcSchema": {
+      "types": "./dist/dts/RpcSchema.d.ts",
+      "import": "./dist/esm/RpcSchema.js",
+      "default": "./dist/cjs/RpcSchema.js"
+    },
+    "./RpcSerialization": {
+      "types": "./dist/dts/RpcSerialization.d.ts",
+      "import": "./dist/esm/RpcSerialization.js",
+      "default": "./dist/cjs/RpcSerialization.js"
+    },
+    "./RpcServer": {
+      "types": "./dist/dts/RpcServer.d.ts",
+      "import": "./dist/esm/RpcServer.js",
+      "default": "./dist/cjs/RpcServer.js"
+    },
+    "./RpcTest": {
+      "types": "./dist/dts/RpcTest.d.ts",
+      "import": "./dist/esm/RpcTest.js",
+      "default": "./dist/cjs/RpcTest.js"
+    },
+    "./RpcWorker": {
+      "types": "./dist/dts/RpcWorker.d.ts",
+      "import": "./dist/esm/RpcWorker.js",
+      "default": "./dist/cjs/RpcWorker.js"
     }
   },
   "typesVersions": {
@@ -52,14 +82,32 @@
       "Rpc": [
         "./dist/dts/Rpc.d.ts"
       ],
-      "RpcResolver": [
-        "./dist/dts/RpcResolver.d.ts"
+      "RpcClient": [
+        "./dist/dts/RpcClient.d.ts"
+      ],
+      "RpcGroup": [
+        "./dist/dts/RpcGroup.d.ts"
+      ],
+      "RpcMessage": [
+        "./dist/dts/RpcMessage.d.ts"
+      ],
+      "RpcMiddleware": [
+        "./dist/dts/RpcMiddleware.d.ts"
+      ],
+      "RpcSchema": [
+        "./dist/dts/RpcSchema.d.ts"
+      ],
+      "RpcSerialization": [
+        "./dist/dts/RpcSerialization.d.ts"
+      ],
+      "RpcServer": [
+        "./dist/dts/RpcServer.d.ts"
       ],
-      "RpcResolverNoStream": [
-        "./dist/dts/RpcResolverNoStream.d.ts"
+      "RpcTest": [
+        "./dist/dts/RpcTest.d.ts"
       ],
-      "RpcRouter": [
-        "./dist/dts/RpcRouter.d.ts"
+      "RpcWorker": [
+        "./dist/dts/RpcWorker.d.ts"
       ]
     }
   }
diff --git a/src/Rpc.ts b/src/Rpc.ts
index ab2bfa8194660328278890dc7a4e48a266cc2d89..dbc696dd43a92bfc2042735020a1fe3b9fe117b8 100644
--- a/src/Rpc.ts
+++ b/src/Rpc.ts
@@ -1,24 +1,19 @@
 /**
  * @since 1.0.0
  */
-import * as Headers from "@effect/platform/Headers"
-import type * as Context from "effect/Context"
-import * as Effect from "effect/Effect"
-import * as FiberRef from "effect/FiberRef"
-import { dual, pipe } from "effect/Function"
+import type { Headers } from "@effect/platform/Headers"
+import * as Context_ from "effect/Context"
+import type { Effect } from "effect/Effect"
+import type { Exit as Exit_ } from "effect/Exit"
 import { globalValue } from "effect/GlobalValue"
-import type * as ParseResult from "effect/ParseResult"
+import * as Option from "effect/Option"
 import { type Pipeable, pipeArguments } from "effect/Pipeable"
 import * as Predicate from "effect/Predicate"
-import type * as PrimaryKey from "effect/PrimaryKey"
-import type * as Record from "effect/Record"
-import type * as EffectRequest from "effect/Request"
-import type * as RequestResolver from "effect/RequestResolver"
 import * as Schema from "effect/Schema"
-import type { Scope } from "effect/Scope"
-import * as Stream from "effect/Stream"
-import type * as Types from "effect/Types"
-import * as Internal from "./internal/rpc.js"
+import type * as AST from "effect/SchemaAST"
+import type { Stream } from "effect/Stream"
+import type * as RpcMiddleware from "./RpcMiddleware.js"
+import * as RpcSchema from "./RpcSchema.js"
 
 /**
  * @since 1.0.0
@@ -34,410 +29,615 @@ export type TypeId = typeof TypeId
 
 /**
  * @since 1.0.0
- * @category refinements
+ * @category guards
  */
-export const isRpc = (u: unknown): u is Rpc<any, any> => Predicate.hasProperty(u, TypeId)
+export const isRpc = (u: unknown): u is Rpc<any, any, any> => Predicate.hasProperty(u, TypeId)
 
 /**
+ * Represents an API endpoint. An API endpoint is mapped to a single route on
+ * the underlying `HttpRouter`.
+ *
  * @since 1.0.0
  * @category models
  */
-export type Rpc<Req extends Schema.TaggedRequest.All, R> = RpcEffect<Req, R> | RpcStream<Req, R>
+export interface Rpc<
+  out Tag extends string,
+  out Payload extends AnyStructSchema = Schema.Struct<{}>,
+  out Success extends Schema.Schema.Any = typeof Schema.Void,
+  out Error extends Schema.Schema.All = typeof Schema.Never,
+  out Middleware extends RpcMiddleware.TagClassAny = never
+> extends Pipeable {
+  readonly [TypeId]: TypeId
+  readonly _tag: Tag
+  readonly key: string
+  readonly payloadSchema: Payload
+  readonly successSchema: Success
+  readonly errorSchema: Error
+  readonly annotations: Context_.Context<never>
+  readonly middlewares: ReadonlySet<Middleware>
+
+  /**
+   * Set the schema for the success response of the rpc.
+   */
+  setSuccess<S extends Schema.Schema.Any>(schema: S): Rpc<
+    Tag,
+    Payload,
+    S,
+    Error,
+    Middleware
+  >
+
+  /**
+   * Set the schema for the error response of the rpc.
+   */
+  setError<E extends Schema.Schema.Any>(schema: E): Rpc<
+    Tag,
+    Payload,
+    Success,
+    E,
+    Middleware
+  >
+
+  /**
+   * Set the schema for the payload of the rpc.
+   */
+  setPayload<P extends Schema.Struct<any> | Schema.Struct.Fields>(
+    schema: P
+  ): Rpc<
+    Tag,
+    P extends Schema.Struct<infer _> ? P : P extends Schema.Struct.Fields ? Schema.Struct<P> : never,
+    Success,
+    Error,
+    Middleware
+  >
+
+  /**
+   * Add an `RpcMiddleware` to this procedure.
+   */
+  middleware<M extends RpcMiddleware.TagClassAny>(middleware: M): Rpc<
+    Tag,
+    Payload,
+    Success,
+    Error,
+    Middleware | M
+  >
+
+  /**
+   * Add an annotation on the rpc.
+   */
+  annotate<I, S>(
+    tag: Context_.Tag<I, S>,
+    value: S
+  ): Rpc<Tag, Payload, Success, Error, Middleware>
+
+  /**
+   * Merge the annotations of the rpc with the provided context.
+   */
+  annotateContext<I>(
+    context: Context_.Context<I>
+  ): Rpc<Tag, Payload, Success, Error, Middleware>
+}
 
 /**
+ * Represents an implemented rpc.
+ *
  * @since 1.0.0
  * @category models
  */
-export interface RpcEffect<Req extends Schema.TaggedRequest.All, R> extends Rpc.Proto<Req> {
-  readonly _tag: "Effect"
-  readonly handler: (
-    request: Req
-  ) => Effect.Effect<
-    EffectRequest.Request.Success<Req>,
-    EffectRequest.Request.Error<Req>,
-    R
-  >
+export interface Handler<Tag extends string> {
+  readonly _: unique symbol
+  readonly tag: Tag
+  readonly handler: (request: any, headers: Headers) => Effect<any, any> | Stream<any, any>
+  readonly context: Context<never>
 }
 
 /**
  * @since 1.0.0
  * @category models
  */
-export interface RpcStream<Req extends Schema.TaggedRequest.All, R> extends Rpc.Proto<Req> {
-  readonly _tag: "Stream"
-  readonly handler: (
-    request: Req
-  ) => Stream.Stream<
-    Req extends Schema.WithResult<infer A, infer _I, infer _E, infer _EI, infer _R> ? A : never,
-    Req extends Schema.WithResult<infer _A, infer _I, infer E, infer _EI, infer _R> ? E : never,
-    R
-  >
+export interface Any extends Pipeable {
+  readonly [TypeId]: TypeId
+  readonly _tag: string
+  readonly key: string
 }
 
 /**
  * @since 1.0.0
  * @category models
  */
-export declare namespace Rpc {
-  /**
-   * @since 1.0.0
-   * @category models
-   */
-  export interface Proto<Req extends Schema.TaggedRequest.All> extends Pipeable {
-    readonly [TypeId]: TypeId
-    readonly _tag: string
-    readonly schema: Schema.Schema<Req, any, unknown>
-  }
+export interface AnyWithProps {
+  readonly [TypeId]: TypeId
+  readonly _tag: string
+  readonly key: string
+  readonly payloadSchema: AnyStructSchema
+  readonly successSchema: Schema.Schema.Any
+  readonly errorSchema: Schema.Schema.All
+  readonly annotations: Context_.Context<never>
+  readonly middlewares: ReadonlySet<RpcMiddleware.TagClassAnyWithProps>
+}
 
-  /**
-   * @since 1.0.0
-   * @category models
-   */
-  export type Context<A extends Rpc<any, any>> = A extends Rpc<infer Req, infer R>
-    ? R | Schema.SerializableWithResult.Context<Req>
-    : never
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Tag<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? _Tag
+  : never
 
-  /**
-   * @since 1.0.0
-   * @category models
-   */
-  export type Request<A extends Rpc<any, any>> = Schema.Schema.Type<A["schema"]>
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Success<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? _Success["Type"]
+  : never
 
-  /**
-   * @since 1.0.0
-   * @category models
-   */
-  export type Result<A extends Schema.TaggedRequest.All, R = never> = StreamRequestTypeId extends keyof A ?
-    EffectRequest.Request.Success<A> :
-    Effect.Effect<EffectRequest.Request.Success<A>, EffectRequest.Request.Error<A>, R>
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type SuccessEncoded<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? _Success["Encoded"]
+  : never
 
-  /**
-   * @since 1.0.0
-   * @category models
-   */
-  export type ResultUndecoded<A extends Schema.TaggedRequest.All, R = never> = A extends
-    Schema.WithResult<infer _A, infer I, infer E, infer _EI, infer _R>
-    ? StreamRequestTypeId extends keyof A ? Stream.Stream<I, E, R>
-    : Effect.Effect<I, E, R>
-    : never
-}
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type SuccessExit<R> = Success<R> extends infer T ? T extends Stream<infer _A, infer _E, infer _Env> ? void : T
+  : never
 
 /**
  * @since 1.0.0
- * @category constructors
+ * @category models
  */
-export const effect = <Req extends Schema.TaggedRequest.All, R>(
-  schema: Schema.Schema<Req, any, unknown>,
-  handler: (request: Req) => Effect.Effect<EffectRequest.Request.Success<Req>, EffectRequest.Request.Error<Req>, R>
-): Rpc<Req, R> => ({
-  [TypeId]: TypeId,
-  _tag: "Effect",
-  schema,
-  handler,
-  pipe() {
-    return pipeArguments(this, arguments)
-  }
-})
+export type SuccessExitEncoded<R> = SuccessEncoded<R> extends infer T ?
+  T extends Stream<infer _A, infer _E, infer _Env> ? void : T
+  : never
 
 /**
  * @since 1.0.0
- * @category type ids
+ * @category models
  */
-export const StreamRequestTypeId: unique symbol = Internal.StreamRequestTypeId
+export type SuccessChunk<R> = Success<R> extends Stream<infer _A, infer _E, infer _Env> ? _A : never
 
 /**
  * @since 1.0.0
- * @category type ids
+ * @category models
  */
-export type StreamRequestTypeId = typeof StreamRequestTypeId
+export type SuccessChunkEncoded<R> = SuccessEncoded<R> extends Stream<infer _A, infer _E, infer _Env> ? _A : never
 
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export interface StreamRequest<Tag extends string, SR, SI, S, RR, EI, E, AI, A>
-  extends EffectRequest.Request<Stream.Stream<A, E, never>>, Schema.SerializableWithResult<S, SI, SR, A, AI, E, EI, RR>
-{
-  readonly [StreamRequestTypeId]: StreamRequestTypeId
-  readonly _tag: Tag
-}
+export type ErrorSchema<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? _Error | _Middleware
+  : never
 
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export declare namespace StreamRequest {
-  /**
-   * @since 1.0.0
-   * @category schemas
-   */
-  export type Any =
-    | StreamRequest<string, any, any, any, any, any, any, any, any>
-    | StreamRequest<string, any, any, any, any, never, never, any, any>
-}
+export type Error<R> = Schema.Schema.Type<ErrorSchema<R>>
 
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export interface StreamRequestConstructor<Tag extends string, Self, R, IS, S, RR, IE, E, IA, A>
-  extends Schema.Schema<Self, Types.Simplify<IS & { readonly _tag: Tag }>, R>
-{
-  new(
-    props: Types.Equals<S, {}> extends true ? void : S,
-    disableValidation?: boolean
-  ): StreamRequest<Tag, R, IS & { readonly _tag: Tag }, Self, RR, IE, E, IA, A> & S
-}
+export type ErrorEncoded<R> = Schema.Schema.Encoded<ErrorSchema<R>>
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ErrorExit<R> = Success<R> extends Stream<infer _A, infer _E, infer _Env> ? _E | Error<R> : Error<R>
 
 /**
  * @since 1.0.0
- * @category schemas
+ * @category models
  */
-export const StreamRequest =
-  <Self>() =>
-  <Tag extends string, E, IE, RE, A, IA, RA, Payload extends Schema.Struct.Fields>(
-    tag: Tag,
-    options: {
-      readonly failure: Schema.Schema<E, IE, RE>
-      readonly success: Schema.Schema<A, IA, RA>
-      readonly payload: Payload
-    }
-  ): StreamRequestConstructor<
-    Tag,
-    Self,
-    Schema.Schema.Context<Payload[keyof Payload]>,
-    Types.Simplify<Schema.Struct.Encoded<Payload>>,
-    Types.Simplify<Schema.Struct.Type<Payload>>,
-    RE | RA,
-    IE,
-    E,
-    IA,
-    A
-  > => {
-    return class extends (Schema.TaggedRequest<{}>()(tag, options) as any) {
-      constructor(props: any, disableValidation?: boolean) {
-        super(props, disableValidation)
-        ;(this as any)[Internal.StreamRequestTypeId] = Internal.StreamRequestTypeId
-      }
-    } as any
-  }
+export type ErrorExitEncoded<R> = SuccessEncoded<R> extends Stream<infer _A, infer _E, infer _Env>
+  ? _E | ErrorEncoded<R>
+  : ErrorEncoded<R>
 
 /**
  * @since 1.0.0
- * @category constructors
+ * @category models
  */
-export const stream = <Req extends StreamRequest.Any, R>(
-  schema: Schema.Schema<Req, any, unknown>,
-  handler: (
-    request: Req
-  ) => Stream.Stream<
-    Req extends Schema.WithResult<infer A, infer _I, infer _E, infer _EI, infer _R> ? A : never,
-    Req extends Schema.WithResult<infer _A, infer _I, infer E, infer _EI, infer _R> ? E : never,
-    R
-  >
-): Rpc<Req, R> => ({
+export type Exit<R> = Exit_<SuccessExit<R>, ErrorExit<R>>
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExitEncoded<R, Defect = unknown> = Schema.ExitEncoded<SuccessExitEncoded<R>, ErrorExitEncoded<R>, Defect>
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type PayloadConstructor<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ?
+  Schema.Struct.Constructor<_Payload["fields"]> extends infer T ?
+    [keyof T] extends [never] ? void | {} : Schema.Simplify<T>
+  : never
+  : never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Payload<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? _Payload["Type"]
+  : never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Context<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? _Payload["Context"] | _Success["Context"] | _Error["Context"]
+  : never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type Middleware<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? Context_.Tag.Identifier<_Middleware>
+  : never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type MiddlewareClient<R> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ?
+  _Middleware extends { readonly requiredForClient: true }
+    ? RpcMiddleware.ForClient<Context_.Tag.Identifier<_Middleware>>
+  : never
+  : never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type AddError<R extends Any, Error extends Schema.Schema.All> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? Rpc<
+    _Tag,
+    _Payload,
+    _Success,
+    _Error | Error,
+    _Middleware
+  > :
+  never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type AddMiddleware<R extends Any, Middleware extends RpcMiddleware.TagClassAny> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? Rpc<
+    _Tag,
+    _Payload,
+    _Success,
+    _Error,
+    _Middleware | Middleware
+  > :
+  never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ToHandler<R extends Any> = R extends Rpc<
+  infer _Tag,
+  infer _Payload,
+  infer _Success,
+  infer _Error,
+  infer _Middleware
+> ? Handler<_Tag> :
+  never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExtractTag<R extends Any, Tag extends string> = R extends
+  Rpc<Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? R : never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExtractProvides<R extends Any, Tag extends string> = R extends
+  Rpc<Tag, infer _Payload, infer _Success, infer _Error, infer _Middleware> ? _Middleware extends {
+    readonly provides: Context_.Tag<infer _I, infer _S>
+  } ? _I :
+  never :
+  never
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export type ExcludeProvides<Env, R extends Any, Tag extends string> = Exclude<
+  Env,
+  ExtractProvides<R, Tag>
+>
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface From<S extends AnyTaggedRequestSchema> extends Rpc<S["_tag"], S, S["success"], S["failure"]> {}
+
+const Proto = {
   [TypeId]: TypeId,
-  _tag: "Stream",
-  schema: schema as any,
-  handler,
   pipe() {
     return pipeArguments(this, arguments)
+  },
+  setSuccess(
+    this: AnyWithProps,
+    successSchema: Schema.Schema.Any
+  ) {
+    return makeProto({
+      ...this,
+      successSchema
+    })
+  },
+  setError(this: AnyWithProps, errorSchema: Schema.Schema.All) {
+    return makeProto({
+      ...this,
+      errorSchema
+    })
+  },
+  setPayload(this: AnyWithProps, payloadSchema: Schema.Struct<any> | Schema.Struct.Fields) {
+    return makeProto({
+      ...this,
+      payloadSchema: Schema.isSchema(payloadSchema) ? payloadSchema as any : Schema.Struct(payloadSchema as any)
+    })
+  },
+  middleware(this: AnyWithProps, middleware: RpcMiddleware.TagClassAny) {
+    return makeProto({
+      ...this,
+      middlewares: new Set([...this.middlewares, middleware])
+    })
+  },
+  annotate(this: AnyWithProps, tag: Context_.Tag<any, any>, value: any) {
+    return makeProto({
+      ...this,
+      annotations: Context_.add(this.annotations, tag, value)
+    })
+  },
+  annotateContext(this: AnyWithProps, context: Context_.Context<any>) {
+    return makeProto({
+      ...this,
+      annotations: Context_.merge(this.annotations, context)
+    })
   }
-})
+}
+
+const makeProto = <
+  const Tag extends string,
+  Payload extends AnyStructSchema,
+  Success extends Schema.Schema.Any,
+  Error extends Schema.Schema.All,
+  Middleware extends RpcMiddleware.TagClassAny
+>(options: {
+  readonly _tag: Tag
+  readonly payloadSchema: Payload
+  readonly successSchema: Success
+  readonly errorSchema: Error
+  readonly annotations: Context_.Context<never>
+  readonly middlewares: ReadonlySet<Middleware>
+}): Rpc<Tag, Payload, Success, Error, Middleware> => {
+  const self = Object.assign(Object.create(Proto), options)
+  self.key = `@effect/rpc/Rpc/${options._tag}`
+  return self
+}
+
+const constEmptyStruct = Schema.Struct({})
 
 /**
  * @since 1.0.0
- * @category models
+ * @category constructors
  */
-export interface Request<A extends Schema.TaggedRequest.All> extends
-  EffectRequest.Request<
-    EffectRequest.Request.Success<A>,
-    EffectRequest.Request.Error<A>
-  >,
-  PrimaryKey.PrimaryKey,
-  Schema.WithResult<
-    Schema.WithResult.Context<A>,
-    Schema.Schema.Encoded<A[typeof Schema.symbolWithResult]["failure"]>,
-    Schema.Schema.Type<A[typeof Schema.symbolWithResult]["failure"]>,
-    Schema.Schema.Encoded<A[typeof Schema.symbolWithResult]["success"]>,
-    Schema.Schema.Type<A[typeof Schema.symbolWithResult]["success"]>
-  >
-{
-  readonly request: A
-  readonly traceId: string
-  readonly spanId: string
-  readonly sampled: boolean
-  readonly headers: Headers.Headers
+export const make = <
+  const Tag extends string,
+  Payload extends AnyStructSchema | Schema.Struct.Fields = Schema.Struct<{}>,
+  Success extends Schema.Schema.Any = typeof Schema.Void,
+  Error extends Schema.Schema.All = typeof Schema.Never,
+  const Stream extends boolean = false
+>(tag: Tag, options?: {
+  readonly payload?: Payload
+  readonly success?: Success
+  readonly error?: Error
+  readonly stream?: Stream
+}): Rpc<
+  Tag,
+  Payload extends Schema.Struct.Fields ? Schema.Struct<Payload> : Payload,
+  Stream extends true ? RpcSchema.Stream<Success, Error> : Success,
+  Stream extends true ? typeof Schema.Never : Error
+> => {
+  const successSchema = options?.success ?? Schema.Void
+  const errorSchema = options?.error ?? Schema.Never
+  return makeProto({
+    _tag: tag,
+    payloadSchema: Schema.isSchema(options?.payload)
+      ? options?.payload as any
+      : options?.payload
+      ? Schema.Struct(options?.payload as any)
+      : constEmptyStruct,
+    successSchema: options?.stream ?
+      RpcSchema.Stream({
+        success: successSchema,
+        failure: errorSchema
+      }) :
+      successSchema,
+    errorSchema: options?.stream ? Schema.Never : errorSchema,
+    annotations: Context_.empty(),
+    middlewares: new Set<never>()
+  }) as any
 }
 
 /**
  * @since 1.0.0
- * @category models
+ * @category constructors
+ */
+export interface AnyStructSchema extends Pipeable {
+  readonly [Schema.TypeId]: any
+  readonly make: any
+  readonly Type: any
+  readonly Encoded: any
+  readonly Context: any
+  readonly ast: AST.AST
+  readonly fields: Schema.Struct.Fields
+  readonly annotations: any
+}
+
+/**
+ * @since 1.0.0
+ * @category constructors
  */
-export interface RequestFrom<A> {
-  readonly request: A
-  readonly traceId: string
-  readonly spanId: string
-  readonly sampled: boolean
-  readonly headers: Record<string, string>
+export interface AnyTaggedRequestSchema extends AnyStructSchema {
+  readonly _tag: string
+  readonly success: Schema.Schema.Any
+  readonly failure: Schema.Schema.All
 }
 
 /**
  * @since 1.0.0
- * @category schemas
+ * @category constructors
  */
-export const RequestSchema = <A, I, R>(
-  schema: Schema.Schema<A, I, R>
-): Schema.Schema<RequestFrom<A>, RequestFrom<I>, R> =>
-  Schema.Struct({
-    request: schema,
-    traceId: Schema.String,
-    spanId: Schema.String,
-    sampled: Schema.Boolean,
-    headers: Schema.Record({ key: Schema.String, value: Schema.String })
+export const fromTaggedRequest = <S extends AnyTaggedRequestSchema>(
+  schema: S
+): From<S> =>
+  makeProto({
+    _tag: schema._tag,
+    payloadSchema: schema as any,
+    successSchema: schema.success as any,
+    errorSchema: schema.failure,
+    annotations: Context_.empty(),
+    middlewares: new Set()
   })
 
+const exitSchemaCache = globalValue("@effect/rpc/Rpc/exitSchemaCache", () => new WeakMap<Any, Schema.Schema.Any>())
+
 /**
  * @since 1.0.0
- * @category headers
+ * @category constructors
  */
-export const currentHeaders: FiberRef.FiberRef<Headers.Headers> = globalValue(
-  "@effect/rpc/Rpc/currentHeaders",
-  () => FiberRef.unsafeMake(Headers.empty)
-)
+export const exitSchema = <R extends Any>(
+  self: R
+): Schema.Schema<Exit<R>, ExitEncoded<R>, Context<R>> => {
+  if (exitSchemaCache.has(self)) {
+    return exitSchemaCache.get(self) as any
+  }
+  const rpc = self as any as AnyWithProps
+  const streamSchemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast)
+  const schema = Schema.Exit({
+    success: Option.isSome(streamSchemas) ? Schema.Void : rpc.successSchema,
+    failure: Option.isSome(streamSchemas) ?
+      Schema.Union(
+        streamSchemas.value.failure,
+        rpc.errorSchema
+      ) :
+      rpc.errorSchema,
+    defect: Schema.Defect
+  })
+  exitSchemaCache.set(self, schema)
+  return schema as any
+}
 
 /**
  * @since 1.0.0
- * @category headers
+ * @category Fork
  */
-export const annotateHeaders: {
-  /**
-   * @since 1.0.0
-   * @category headers
-   */
-  (headers: Headers.Input): <A, E, R>(self: Effect.Effect<A, E, R>) => Effect.Effect<A, E, R>
-  /**
-   * @since 1.0.0
-   * @category headers
-   */
-  <A, E, R>(self: Effect.Effect<A, E, R>, headers: Headers.Input): Effect.Effect<A, E, R>
-} = dual(2, (self, headers) => {
-  const resolved = Headers.fromInput(headers)
-  return Effect.locallyWith(self, currentHeaders, (prev) => ({ ...prev, ...resolved }))
-})
+export const ForkTypeId: unique symbol = Symbol.for("@effect/rpc/Rpc/Fork")
 
 /**
  * @since 1.0.0
- * @category headers
+ * @category Fork
  */
-export const schemaHeaders = <R, I extends Record.ReadonlyRecord<string, string | undefined>, A>(
-  schema: Schema.Schema<R, I, A>
-): Effect.Effect<R, ParseResult.ParseError, A> => {
-  const decode = Schema.decodeUnknown(schema)
-  return Effect.flatMap(FiberRef.get(currentHeaders), decode)
-}
+export type ForkTypeId = typeof ForkTypeId
 
 /**
  * @since 1.0.0
- * @category requests
+ * @category Fork
  */
-export const request = <A extends Schema.TaggedRequest.All>(
-  request: A,
-  options?: {
-    readonly spanPrefix?: string
-  }
-): Effect.Effect<Request<A>, never, Scope> =>
-  pipe(
-    Effect.makeSpanScoped(`${options?.spanPrefix ?? "Rpc.request "}${request._tag}`, {
-      kind: "client",
-      captureStackTrace: false
-    }),
-    Effect.zip(FiberRef.get(currentHeaders)),
-    Effect.map(([span, headers]) =>
-      Internal.makeRequest({
-        request,
-        traceId: span.traceId,
-        spanId: span.spanId,
-        sampled: span.sampled,
-        headers
-      })
-    )
-  )
-
-/**
- * @since 1.0.0
- * @category requests
- */
-export const call = <
-  A extends Schema.TaggedRequest.All,
-  R extends
-    | RequestResolver.RequestResolver<Request<A>>
-    | Effect.Effect<RequestResolver.RequestResolver<Request<A>>, never, any>
->(
-  req: A,
-  resolver: R,
-  options?: {
-    readonly spanPrefix?: string
-  }
-): R extends Effect.Effect<infer _A, infer _E, infer R> ? Rpc.Result<A, R> : Rpc.Result<A> => {
-  const isStream = Internal.StreamRequestTypeId in req
-  const res = pipe(
-    request(req, options),
-    Effect.flatMap((_) => Effect.request(_, resolver))
-  )
-  return isStream ? Stream.unwrapScoped(res as any) : Effect.scoped(res) as any
+export interface Fork<A> {
+  readonly [ForkTypeId]: ForkTypeId
+  readonly value: A
 }
 
 /**
+ * You can use `fork` to wrap a response Effect or Stream, to ensure that the
+ * response is executed concurrently regardless of the RpcServer concurrency
+ * setting.
+ *
  * @since 1.0.0
- * @category context
+ * @category Fork
  */
-export const provideServiceEffect: {
-  /**
-   * @since 1.0.0
-   * @category context
-   */
-  <I, S, E, R2>(tag: Context.Tag<I, S>, effect: Effect.Effect<S, E, R2>): <Req extends Schema.TaggedRequest.All, R>(self: Rpc<Req, R>) => Rpc<Req, Exclude<R, I> | R2>
-  /**
-   * @since 1.0.0
-   * @category context
-   */
-  <Req extends Schema.TaggedRequest.All, R, I, S, E, R2>(self: Rpc<Req, R>, tag: Context.Tag<I, S>, effect: Effect.Effect<S, E, R2>): Rpc<Req, Exclude<R, I> | R2>
-} = dual(3, <Req extends Schema.TaggedRequest.All, R, I, S, E, R2>(
-  self: Rpc<Req, R>,
-  tag: Context.Tag<I, S>,
-  make: Effect.Effect<S, E, R2>
-): Rpc<Req, Exclude<R, I> | R2> =>
-  self._tag === "Effect"
-    ? effect(self.schema, (req) => Effect.provideServiceEffect(self.handler(req), tag, Effect.orDie(make))) as any
-    : stream(
-      self.schema as any,
-      (req) => Stream.provideServiceEffect(self.handler(req as any), tag, Effect.orDie(make))
-    ))
+export const fork = <A>(value: A): Fork<A> => ({ [ForkTypeId]: ForkTypeId, value })
 
 /**
  * @since 1.0.0
- * @category context
+ * @category Fork
  */
-export const provideService: {
-  /**
-   * @since 1.0.0
-   * @category context
-   */
-  <I, S>(tag: Context.Tag<I, S>, service: S): <Req extends Schema.TaggedRequest.All, R>(self: Rpc<Req, R>) => Rpc<Req, Exclude<R, I>>
-  /**
-   * @since 1.0.0
-   * @category context
-   */
-  <Req extends Schema.TaggedRequest.All, R, I, S>(self: Rpc<Req, R>, tag: Context.Tag<I, S>, service: S): Rpc<Req, Exclude<R, I>>
-} = dual(3, <Req extends Schema.TaggedRequest.All, R, I, S>(
-  self: Rpc<Req, R>,
-  tag: Context.Tag<I, S>,
-  service: S
-): Rpc<Req, Exclude<R, I>> =>
-  self._tag === "Effect"
-    ? effect(self.schema, (req) => Effect.provideService(self.handler(req), tag, service)) as any
-    : stream(
-      self.schema as any,
-      (req) => Stream.provideService(self.handler(req as any), tag, service)
-    ))
+export const isFork = (u: object): u is Fork<any> => ForkTypeId in u
diff --git a/src/RpcClient.ts b/src/RpcClient.ts
new file mode 100644
index 0000000000000000000000000000000000000000..7c0e57d1088aa71f0b44d6847de54a7887dee2a1
--- /dev/null
+++ b/src/RpcClient.ts
@@ -0,0 +1,1009 @@
+/**
+ * @since 1.0.0
+ */
+import * as Headers from "@effect/platform/Headers"
+import * as HttpBody from "@effect/platform/HttpBody"
+import * as HttpClient from "@effect/platform/HttpClient"
+import * as HttpClientRequest from "@effect/platform/HttpClientRequest"
+import * as Socket from "@effect/platform/Socket"
+import * as Transferable from "@effect/platform/Transferable"
+import * as Worker from "@effect/platform/Worker"
+import type { WorkerError } from "@effect/platform/WorkerError"
+import type { NonEmptyReadonlyArray } from "effect/Array"
+import * as Cause from "effect/Cause"
+import * as Chunk from "effect/Chunk"
+import * as Context from "effect/Context"
+import type * as Duration from "effect/Duration"
+import * as Effect from "effect/Effect"
+import * as Exit from "effect/Exit"
+import * as Fiber from "effect/Fiber"
+import * as FiberId from "effect/FiberId"
+import * as FiberRef from "effect/FiberRef"
+import { constVoid, dual, identity } from "effect/Function"
+import { globalValue } from "effect/GlobalValue"
+import * as Layer from "effect/Layer"
+import * as Mailbox from "effect/Mailbox"
+import * as Option from "effect/Option"
+import type { ParseError } from "effect/ParseResult"
+import * as Pool from "effect/Pool"
+import * as Schedule from "effect/Schedule"
+import * as Schema from "effect/Schema"
+import * as Scope from "effect/Scope"
+import * as Stream from "effect/Stream"
+import type { Span } from "effect/Tracer"
+import type { Mutable } from "effect/Types"
+import { withRun } from "./internal/utils.js"
+import * as Rpc from "./Rpc.js"
+import type * as RpcGroup from "./RpcGroup.js"
+import type { FromClient, FromClientEncoded, FromServer, FromServerEncoded, Request, RequestId } from "./RpcMessage.js"
+import { constPing } from "./RpcMessage.js"
+import type * as RpcMiddleware from "./RpcMiddleware.js"
+import * as RpcSchema from "./RpcSchema.js"
+import * as RpcSerialization from "./RpcSerialization.js"
+import * as RpcWorker from "./RpcWorker.js"
+
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export type RpcClient<Rpcs extends Rpc.Any, E = never> = {
+  readonly [Current in Rpcs as Current["_tag"]]: <const AsMailbox extends boolean = false, const Discard = false>(
+    input: Rpc.PayloadConstructor<Current>,
+    options?: Rpc.Success<Current> extends Stream.Stream<infer _A, infer _E, infer _R> ? {
+        readonly asMailbox?: AsMailbox | undefined
+        readonly streamBufferSize?: number | undefined
+        readonly headers?: Headers.Input | undefined
+        readonly context?: Context.Context<never> | undefined
+      } :
+      {
+        readonly headers?: Headers.Input | undefined
+        readonly context?: Context.Context<never> | undefined
+        readonly discard?: Discard | undefined
+      }
+  ) => Rpc.Success<Current> extends Stream.Stream<infer _A, infer _E, infer _R>
+    ? AsMailbox extends true ? Effect.Effect<
+        Mailbox.ReadonlyMailbox<_A, _E | Rpc.Error<Current> | E>,
+        never,
+        Scope.Scope
+      >
+    : Stream.Stream<_A, _E | Rpc.Error<Current> | E>
+    : Effect.Effect<
+      Discard extends true ? void : Rpc.Success<Current>,
+      Discard extends true ? never : Rpc.Error<Current> | E
+    >
+}
+
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export type FromGroup<Group> = RpcClient<RpcGroup.Rpcs<Group>>
+
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export const makeNoSerialization: <Rpcs extends Rpc.Any, E>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options: {
+    readonly onFromClient: (
+      options: {
+        readonly message: FromClient<Rpcs>
+        readonly context: Context.Context<never>
+        readonly discard: boolean
+      }
+    ) => Effect.Effect<void, E>
+    readonly supportsAck?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+    readonly generateRequestId?: (() => RequestId) | undefined
+    readonly disableTracing?: boolean | undefined
+  }
+) => Effect.Effect<
+  {
+    readonly client: RpcClient<Rpcs, E>
+    readonly write: (message: FromServer<Rpcs>) => Effect.Effect<void>
+  },
+  never,
+  Scope.Scope | Rpc.MiddlewareClient<Rpcs>
+> = Effect.fnUntraced(function*<Rpcs extends Rpc.Any, E>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options: {
+    readonly onFromClient: (
+      options: {
+        readonly message: FromClient<Rpcs>
+        readonly context: Context.Context<never>
+        readonly discard: boolean
+      }
+    ) => Effect.Effect<void, E>
+    readonly supportsAck?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+    readonly generateRequestId?: (() => RequestId) | undefined
+    readonly disableTracing?: boolean | undefined
+  }
+) {
+  const spanPrefix = options?.spanPrefix ?? "RpcClient"
+  const supportsAck = options?.supportsAck ?? true
+  const disableTracing = options?.disableTracing ?? false
+  let requestId = BigInt(0)
+  const generateRequestId = options.generateRequestId ?? (() => requestId++ as RequestId)
+
+  const context = yield* Effect.context<Rpc.MiddlewareClient<Rpcs> | Scope.Scope>()
+  const scope = Context.get(context, Scope.Scope)
+
+  type ClientEntry = {
+    readonly _tag: "Effect"
+    readonly rpc: Rpc.AnyWithProps
+    readonly context: Context.Context<never>
+    resume: (_: Exit.Exit<any, any>) => void
+  } | {
+    readonly _tag: "Mailbox"
+    readonly rpc: Rpc.AnyWithProps
+    readonly mailbox: Mailbox.Mailbox<any, any>
+    readonly scope: Scope.Scope
+    readonly context: Context.Context<never>
+  }
+  const entries = new Map<RequestId, ClientEntry>()
+
+  let isShutdown = false
+  yield* Scope.addFinalizer(
+    scope,
+    Effect.fiberIdWith((fiberId) => {
+      isShutdown = true
+      return clearEntries(Exit.interrupt(fiberId))
+    })
+  )
+
+  const clearEntries = Effect.fnUntraced(function*(exit: Exit.Exit<never>) {
+    for (const [id, entry] of entries) {
+      entries.delete(id)
+      if (entry._tag === "Mailbox") {
+        yield* entry.mailbox.done(exit)
+      } else {
+        entry.resume(exit)
+      }
+    }
+  })
+
+  const onRequest = (rpc: Rpc.AnyWithProps) => {
+    const isStream = RpcSchema.isStreamSchema(rpc.successSchema)
+    const middleware = getRpcClientMiddleware(rpc)
+    return (payload: any, options?: {
+      readonly asMailbox?: boolean | undefined
+      readonly streamBufferSize?: number | undefined
+      readonly headers?: Headers.Input | undefined
+      readonly context?: Context.Context<never> | undefined
+      readonly discard?: boolean | undefined
+    }) => {
+      const headers = options?.headers ? Headers.fromInput(options.headers) : Headers.empty
+      if (!isStream) {
+        const effect = Effect.useSpan(
+          `${spanPrefix}.${rpc._tag}`,
+          { captureStackTrace: false },
+          (span) =>
+            onEffectRequest(
+              rpc,
+              middleware,
+              span,
+              payload ? rpc.payloadSchema.make(payload) : {},
+              headers,
+              options?.context ?? Context.empty(),
+              options?.discard ?? false
+            )
+        )
+        return disableTracing ? Effect.withTracerEnabled(effect, false) : effect
+      }
+      const mailbox = Effect.suspend(() =>
+        onStreamRequest(
+          rpc,
+          middleware,
+          payload ? rpc.payloadSchema.make(payload) : {},
+          headers,
+          options?.streamBufferSize ?? 16,
+          options?.context ?? Context.empty()
+        )
+      )
+      if (options?.asMailbox) return mailbox
+      return Stream.unwrapScoped(Effect.map(mailbox, Mailbox.toStream))
+    }
+  }
+
+  const onEffectRequest = (
+    rpc: Rpc.AnyWithProps,
+    middleware: (request: Request<Rpcs>) => Effect.Effect<Request<Rpcs>>,
+    span: Span,
+    payload: any,
+    headers: Headers.Headers,
+    context: Context.Context<never>,
+    discard: boolean
+  ) =>
+    Effect.withFiberRuntime<any, any, any>((parentFiber) => {
+      if (isShutdown) {
+        return Effect.interrupt
+      }
+      const id = generateRequestId()
+      const send = middleware({
+        _tag: "Request",
+        id,
+        tag: rpc._tag as Rpc.Tag<Rpcs>,
+        payload,
+        traceId: span.traceId,
+        spanId: span.spanId,
+        sampled: span.sampled,
+        headers: Headers.merge(parentFiber.getFiberRef(currentHeaders), headers)
+      })
+      if (discard) {
+        return Effect.flatMap(send, (message) =>
+          options.onFromClient({
+            message,
+            context,
+            discard
+          }))
+      }
+      let fiber: Fiber.RuntimeFiber<any, any>
+      return Effect.onInterrupt(
+        Effect.async<any, any>((resume) => {
+          const entry: ClientEntry = {
+            _tag: "Effect",
+            rpc,
+            context,
+            resume(exit) {
+              resume(exit)
+              if (!fiber.unsafePoll()) {
+                parentFiber.currentScheduler.scheduleTask(() => {
+                  fiber.unsafeInterruptAsFork(parentFiber.id())
+                }, 0)
+              }
+            }
+          }
+          entries.set(id, entry)
+          fiber = send.pipe(
+            Effect.flatMap((request) =>
+              options.onFromClient({
+                message: request,
+                context,
+                discard
+              })
+            ),
+            Effect.runFork
+          )
+          fiber.addObserver((exit) => {
+            if (exit._tag === "Failure") {
+              return resume(exit)
+            }
+          })
+        }),
+        (interruptors) => {
+          entries.delete(id)
+          const ids = Array.from(interruptors).flatMap((id) => Array.from(FiberId.toSet(id)))
+          return Effect.zipRight(
+            Fiber.interrupt(fiber),
+            sendInterrupt(id, ids, context)
+          )
+        }
+      )
+    })
+
+  const onStreamRequest = Effect.fnUntraced(function*(
+    rpc: Rpc.AnyWithProps,
+    middleware: (request: Request<Rpcs>) => Effect.Effect<Request<Rpcs>>,
+    payload: any,
+    headers: Headers.Headers,
+    streamBufferSize: number,
+    context: Context.Context<never>
+  ) {
+    if (isShutdown) {
+      return yield* Effect.interrupt
+    }
+
+    const span = yield* Effect.makeSpanScoped(`${spanPrefix}.${rpc._tag}`, { captureStackTrace: false }).pipe(
+      disableTracing ? Effect.withTracerEnabled(false) : identity
+    )
+    const fiber = Option.getOrThrow(Fiber.getCurrentFiber())
+    const id = generateRequestId()
+
+    const scope = Context.unsafeGet(fiber.currentContext, Scope.Scope)
+    yield* Scope.addFinalizerExit(
+      scope,
+      (exit) => {
+        if (!entries.has(id)) return Effect.void
+        entries.delete(id)
+        return sendInterrupt(
+          id,
+          Exit.isFailure(exit)
+            ? Array.from(Cause.interruptors(exit.cause)).flatMap((id) => Array.from(FiberId.toSet(id)))
+            : [],
+          context
+        )
+      }
+    )
+
+    const mailbox = yield* Mailbox.make<any, any>(streamBufferSize)
+    entries.set(id, {
+      _tag: "Mailbox",
+      rpc,
+      mailbox,
+      scope,
+      context
+    })
+
+    yield* middleware({
+      _tag: "Request",
+      id,
+      tag: rpc._tag as Rpc.Tag<Rpcs>,
+      traceId: span.traceId,
+      payload,
+      spanId: span.spanId,
+      sampled: span.sampled,
+      headers: Headers.merge(fiber.getFiberRef(currentHeaders), headers)
+    }).pipe(
+      Effect.flatMap(
+        (request) =>
+          options.onFromClient({
+            message: request,
+            context,
+            discard: false
+          })
+      ),
+      Effect.catchAllCause((error) => mailbox.failCause(error)),
+      Effect.interruptible,
+      Effect.forkIn(scope)
+    )
+
+    return mailbox
+  })
+
+  const getRpcClientMiddleware = (rpc: Rpc.AnyWithProps): (request: Request<Rpcs>) => Effect.Effect<Request<Rpcs>> => {
+    const middlewares: Array<RpcMiddleware.RpcMiddlewareClient> = []
+    for (const tag of rpc.middlewares.values()) {
+      const middleware = context.unsafeMap.get(`${tag.key}/Client`)
+      if (!middleware) continue
+      middlewares.push(middleware)
+    }
+    return middlewares.length === 0
+      ? Effect.succeed
+      : function(request) {
+        let i = 0
+        return Effect.map(
+          Effect.whileLoop({
+            while: () => i < middlewares.length,
+            body: () =>
+              middlewares[i]({
+                rpc,
+                request
+              }) as Effect.Effect<Request<Rpcs>>,
+            step(nextRequest) {
+              request = nextRequest
+              i++
+            }
+          }),
+          () => request
+        )
+      }
+  }
+
+  const sendInterrupt = (
+    requestId: RequestId,
+    interruptors: ReadonlyArray<FiberId.FiberId>,
+    context: Context.Context<never>
+  ): Effect.Effect<void> =>
+    Effect.async<void>((resume) => {
+      const fiber = options.onFromClient({
+        message: { _tag: "Interrupt", requestId, interruptors },
+        context,
+        discard: false
+      }).pipe(
+        Effect.timeout(1000),
+        Effect.runFork
+      )
+      fiber.addObserver(() => {
+        resume(Effect.void)
+      })
+    })
+
+  const write = (message: FromServer<Rpcs>): Effect.Effect<void> => {
+    switch (message._tag) {
+      case "Chunk": {
+        const requestId = parseRequestId(message.requestId)
+        const entry = entries.get(requestId)
+        if (!entry || entry._tag !== "Mailbox") return Effect.void
+        return entry.mailbox.offerAll(message.values).pipe(
+          supportsAck
+            ? Effect.zipRight(
+              options.onFromClient({
+                message: { _tag: "Ack", requestId: message.requestId },
+                context: entry.context,
+                discard: false
+              })
+            )
+            : identity,
+          Effect.onError((cause) => entry.mailbox.done(Exit.failCause(cause))),
+          Effect.forkIn(entry.scope)
+        )
+      }
+      case "Exit": {
+        const requestId = parseRequestId(message.requestId)
+        const entry = entries.get(requestId)
+        if (!entry) return Effect.void
+        entries.delete(requestId)
+        if (entry._tag === "Effect") {
+          entry.resume(message.exit)
+          return Effect.void
+        }
+        return entry.mailbox.done(Exit.asVoid(message.exit))
+      }
+      case "Defect": {
+        return clearEntries(Exit.die(message.defect))
+      }
+      case "ClientEnd": {
+        return Effect.void
+      }
+    }
+  }
+
+  const client = {} as Mutable<RpcClient<Rpcs>>
+  for (const rpc of group.requests.values()) {
+    ;(client as any)[rpc._tag] = onRequest(rpc as any)
+  }
+
+  return {
+    client: client as RpcClient<Rpcs>,
+    write
+  } as const
+})
+
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export const make: <Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly spanPrefix?: string | undefined
+    readonly generateRequestId?: (() => RequestId) | undefined
+    readonly disableTracing?: boolean | undefined
+  } | undefined
+) => Effect.Effect<
+  RpcClient<Rpcs>,
+  never,
+  Protocol | Rpc.Context<Rpcs> | Rpc.MiddlewareClient<Rpcs> | Scope.Scope
+> = Effect.fnUntraced(function*<Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly spanPrefix?: string | undefined
+    readonly generateRequestId?: (() => RequestId) | undefined
+    readonly disableTracing?: boolean | undefined
+  } | undefined
+) {
+  const context = yield* Effect.context<Rpc.Context<Rpcs>>()
+  const { run, send, supportsAck, supportsTransferables } = yield* Protocol
+
+  type ClientEntry = {
+    readonly rpc: Rpc.AnyWithProps
+    readonly decodeChunk:
+      | ((chunk: ReadonlyArray<unknown>) => Effect.Effect<NonEmptyReadonlyArray<any>, ParseError, unknown>)
+      | undefined
+  }
+  const entries = new Map<RequestId, ClientEntry>()
+
+  const { client, write } = yield* makeNoSerialization(group, {
+    ...options,
+    supportsAck,
+    onFromClient({ message }) {
+      switch (message._tag) {
+        case "Request": {
+          const rpc = group.requests.get(message.tag)! as any as Rpc.AnyWithProps
+          const schemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast)
+          const collector = supportsTransferables ? Transferable.unsafeMakeCollector() : undefined
+          const entry: ClientEntry = {
+            rpc,
+            decodeChunk: Option.isSome(schemas)
+              ? Schema.decodeUnknown(Schema.NonEmptyArray(schemas.value.success))
+              : undefined
+          }
+          entries.set(message.id, entry)
+          return Schema.encode(rpc.payloadSchema)(message.payload).pipe(
+            Effect.locally(
+              FiberRef.currentContext,
+              collector ? Context.add(context, Transferable.Collector, collector) : context
+            ),
+            Effect.orDie,
+            Effect.flatMap((payload) =>
+              send({
+                ...message,
+                payload,
+                headers: Object.entries(message.headers)
+              }, collector && collector.unsafeClear())
+            )
+          ) as Effect.Effect<void>
+        }
+        case "Ack": {
+          const entry = entries.get(message.requestId)
+          if (!entry) return Effect.void
+          return send(message) as Effect.Effect<void>
+        }
+        case "Interrupt": {
+          const entry = entries.get(message.requestId)
+          if (!entry) return Effect.void
+          entries.delete(message.requestId)
+          return send({
+            _tag: "Interrupt",
+            requestId: message.requestId
+          }) as Effect.Effect<void>
+        }
+        case "Eof": {
+          return Effect.void
+        }
+      }
+    }
+  })
+
+  yield* run((message) => {
+    switch (message._tag) {
+      case "Chunk": {
+        const requestId = parseRequestId(message.requestId)
+        const entry = entries.get(requestId)
+        if (!entry || !entry.decodeChunk) return Effect.void
+        return entry.decodeChunk(message.values).pipe(
+          Effect.locally(FiberRef.currentContext, context),
+          Effect.orDie,
+          Effect.flatMap((chunk) =>
+            write({ _tag: "Chunk", clientId: 0, requestId: parseRequestId(message.requestId), values: chunk })
+          ),
+          Effect.onError((cause) =>
+            write({
+              _tag: "Exit",
+              clientId: 0,
+              requestId: parseRequestId(message.requestId),
+              exit: Exit.failCause(cause)
+            })
+          )
+        ) as Effect.Effect<void>
+      }
+      case "Exit": {
+        const requestId = parseRequestId(message.requestId)
+        const entry = entries.get(requestId)
+        if (!entry) return Effect.void
+        entries.delete(requestId)
+        return Schema.decode(Rpc.exitSchema(entry.rpc as any))(message.exit).pipe(
+          Effect.locally(FiberRef.currentContext, context),
+          Effect.orDie,
+          Effect.matchCauseEffect({
+            onSuccess: (exit) => write({ _tag: "Exit", clientId: 0, requestId, exit }),
+            onFailure: (cause) => write({ _tag: "Exit", clientId: 0, requestId, exit: Exit.failCause(cause) })
+          })
+        ) as Effect.Effect<void>
+      }
+      case "Defect": {
+        return write({ _tag: "Defect", clientId: 0, defect: decodeDefect(message.defect) })
+      }
+      default: {
+        return Effect.void
+      }
+    }
+  }).pipe(
+    Effect.catchAllCause(Effect.logError),
+    Effect.interruptible,
+    Effect.forkScoped
+  )
+
+  return client
+})
+
+const parseRequestId = (input: string | bigint): RequestId => typeof input === "string" ? BigInt(input) : input as any
+
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export const currentHeaders: FiberRef.FiberRef<Headers.Headers> = globalValue(
+  "@effect/rpc/RpcClient/currentHeaders",
+  () => FiberRef.unsafeMake(Headers.empty)
+)
+
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export const withHeaders: {
+  /**
+   * @since 1.0.0
+   * @category headers
+   */
+  (headers: Headers.Input): <A, E, R>(effect: Effect.Effect<A, E, R>) => Effect.Effect<A, E, R>
+  /**
+   * @since 1.0.0
+   * @category headers
+   */
+  <A, E, R>(effect: Effect.Effect<A, E, R>, headers: Headers.Input): Effect.Effect<A, E, R>
+} = dual(
+  2,
+  <A, E, R>(effect: Effect.Effect<A, E, R>, headers: Headers.Input): Effect.Effect<A, E, R> =>
+    Effect.locallyWith(effect, currentHeaders, Headers.merge(Headers.fromInput(headers)))
+)
+
+/**
+ * @since 1.0.0
+ * @category headers
+ */
+export const withHeadersEffect: {
+  /**
+   * @since 1.0.0
+   * @category headers
+   */
+  <E2, R2>(
+    headers: Effect.Effect<Headers.Input, E2, R2>
+  ): <A, E, R>(effect: Effect.Effect<A, E, R>) => Effect.Effect<A, E | E2, R | R2>
+  /**
+   * @since 1.0.0
+   * @category headers
+   */
+  <A, E, R, E2, R2>(
+    effect: Effect.Effect<A, E, R>,
+    headers: Effect.Effect<Headers.Input, E2, R2>
+  ): Effect.Effect<A, E | E2, R | R2>
+} = dual(
+  2,
+  <A, E, R, E2, R2>(
+    effect: Effect.Effect<A, E, R>,
+    headers: Effect.Effect<Headers.Input, E2, R2>
+  ): Effect.Effect<A, E | E2, R | R2> => Effect.flatMap(headers, (headers) => withHeaders(effect, headers))
+)
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export class Protocol extends Context.Tag("@effect/rpc/RpcClient/Protocol")<Protocol, {
+  readonly run: (
+    f: (data: FromServerEncoded) => Effect.Effect<void>
+  ) => Effect.Effect<never>
+  readonly send: (
+    request: FromClientEncoded,
+    transferables?: ReadonlyArray<globalThis.Transferable>
+  ) => Effect.Effect<void>
+  readonly supportsAck: boolean
+  readonly supportsTransferables: boolean
+}>() {
+  /**
+   * @since 1.0.0
+   */
+  static make = withRun<Protocol["Type"]>()
+}
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolHttp = (client: HttpClient.HttpClient): Effect.Effect<
+  Protocol["Type"],
+  never,
+  RpcSerialization.RpcSerialization
+> =>
+  Protocol.make(Effect.fnUntraced(function*(writeResponse) {
+    const serialization = yield* RpcSerialization.RpcSerialization
+    const isJson = serialization.contentType === "application/json"
+
+    const send = (request: FromClientEncoded): Effect.Effect<void> => {
+      if (request._tag !== "Request") {
+        return Effect.void
+      }
+
+      const parser = serialization.unsafeMake()
+      if (!serialization.supportsBigInt) transformBigInt(request)
+
+      const encoded = parser.encode(request)
+      const body = typeof encoded === "string" ?
+        HttpBody.text(encoded, serialization.contentType) :
+        HttpBody.uint8Array(encoded, serialization.contentType)
+
+      if (isJson) {
+        return client.post("/", { body }).pipe(
+          Effect.flatMap((r) => r.json),
+          Effect.scoped,
+          Effect.flatMap((u) => {
+            if (!Array.isArray(u)) {
+              return Effect.dieMessage(`Expected an array of responses, but got: ${u}`)
+            }
+            let i = 0
+            return Effect.whileLoop({
+              while: () => i < u.length,
+              body: () => writeResponse(u[i++]),
+              step: constVoid
+            })
+          }),
+          Effect.orDie
+        )
+      }
+
+      return client.post("/", { body }).pipe(
+        Effect.flatMap((r) =>
+          Stream.runForEachChunk(r.stream, (chunk) => {
+            const responses = Chunk.toReadonlyArray(chunk).flatMap(parser.decode) as Array<FromServerEncoded>
+            if (responses.length === 0) return Effect.void
+            let i = 0
+            return Effect.whileLoop({
+              while: () => i < responses.length,
+              body: () => writeResponse(responses[i++]),
+              step: constVoid
+            })
+          })
+        ),
+        Effect.scoped,
+        Effect.orDie
+      )
+    }
+
+    return {
+      send,
+      supportsAck: false,
+      supportsTransferables: false
+    }
+  }))
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolHttp = (options: {
+  readonly url: string
+  readonly transformClient?: <E, R>(client: HttpClient.HttpClient.With<E, R>) => HttpClient.HttpClient.With<E, R>
+}): Layer.Layer<Protocol, never, RpcSerialization.RpcSerialization | HttpClient.HttpClient> =>
+  Layer.scoped(
+    Protocol,
+    Effect.flatMap(
+      HttpClient.HttpClient,
+      (client) => {
+        client = HttpClient.mapRequest(client, HttpClientRequest.prependUrl(options.url))
+        return makeProtocolHttp(options.transformClient ? options.transformClient(client) : client)
+      }
+    )
+  )
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolSocket: Effect.Effect<
+  Protocol["Type"],
+  never,
+  Scope.Scope | RpcSerialization.RpcSerialization | Socket.Socket
+> = Protocol.make(Effect.fnUntraced(function*(writeResponse) {
+  const socket = yield* Socket.Socket
+  const serialization = yield* RpcSerialization.RpcSerialization
+
+  const write = yield* socket.writer
+
+  let parser = serialization.unsafeMake()
+
+  yield* Effect.suspend(() => {
+    parser = serialization.unsafeMake()
+    return socket.runRaw((message) => {
+      try {
+        const responses = parser.decode(message) as Array<FromServerEncoded>
+        if (responses.length === 0) return
+        let i = 0
+        return Effect.whileLoop({
+          while: () => i < responses.length,
+          body: () => writeResponse(responses[i++]),
+          step: constVoid
+        })
+      } catch (defect) {
+        return writeResponse({ _tag: "Defect", defect })
+      }
+    })
+  }).pipe(
+    Effect.zipRight(Effect.fail(
+      new Socket.SocketCloseError({
+        reason: "Close",
+        code: 1000
+      })
+    )),
+    Effect.tapErrorCause((cause) => writeResponse({ _tag: "Defect", defect: Cause.squash(cause) })),
+    Effect.retry(Schedule.spaced(1000)),
+    Effect.annotateLogs({
+      module: "RpcClient",
+      method: "makeProtocolSocket"
+    }),
+    Effect.interruptible,
+    Effect.forkScoped
+  )
+
+  yield* Effect.suspend(() => write(parser.encode(constPing))).pipe(
+    Effect.delay("30 seconds"),
+    Effect.ignore,
+    Effect.forever,
+    Effect.interruptible,
+    Effect.forkScoped
+  )
+
+  return {
+    send(request) {
+      if (!serialization.supportsBigInt) transformBigInt(request)
+      return Effect.orDie(write(parser.encode(request)))
+    },
+    supportsAck: true,
+    supportsTransferables: false
+  }
+}))
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWorker = (
+  options: {
+    readonly size: number
+    readonly concurrency?: number | undefined
+    readonly targetUtilization?: number | undefined
+  } | {
+    readonly minSize: number
+    readonly maxSize: number
+    readonly concurrency?: number | undefined
+    readonly targetUtilization?: number | undefined
+    readonly timeToLive: Duration.DurationInput
+  }
+): Effect.Effect<
+  Protocol["Type"],
+  WorkerError,
+  Scope.Scope | Worker.PlatformWorker | Worker.Spawner
+> =>
+  Protocol.make(Effect.fnUntraced(function*(writeResponse) {
+    const worker = yield* Worker.PlatformWorker
+    const scope = yield* Effect.scope
+    let workerId = 0
+    const initialMessage = yield* Effect.serviceOption(RpcWorker.InitialMessage)
+
+    const entries = new Map<string | bigint, {
+      readonly worker: Worker.BackingWorker<FromClientEncoded | RpcWorker.InitialMessage.Encoded, FromServerEncoded>
+      readonly scope: Scope.CloseableScope
+    }>()
+
+    yield* Scope.addFinalizerExit(
+      scope,
+      (exit) =>
+        Effect.forEach(entries, ([_, entry]) => Scope.close(entry.scope, exit), {
+          discard: true,
+          concurrency: "unbounded"
+        })
+    )
+
+    const acquire = Effect.gen(function*() {
+      const id = workerId++
+      const backing = yield* worker.spawn<FromClientEncoded | RpcWorker.InitialMessage.Encoded, FromServerEncoded>(id)
+      const readyLatch = yield* Effect.makeLatch()
+
+      yield* backing.run((message) => {
+        if (message[0] === 0) {
+          return readyLatch.open
+        }
+        const response = message[1]
+        if (response._tag === "Exit") {
+          const entry = entries.get(response.requestId)
+          if (entry) {
+            entries.delete(response.requestId)
+            return Effect.ensuring(writeResponse(response), Scope.close(entry.scope, Exit.void))
+          }
+        } else if (response._tag === "Defect") {
+          return Effect.zipRight(
+            Effect.forEach(entries, ([requestId, entry]) => {
+              entries.delete(requestId)
+              return Scope.close(entry.scope, Exit.die(response.defect))
+            }, { discard: true }),
+            writeResponse(response)
+          )
+        }
+        return writeResponse(response)
+      }).pipe(
+        Effect.tapErrorCause((cause) => writeResponse({ _tag: "Defect", defect: Cause.squash(cause) })),
+        Effect.retry(Schedule.spaced(1000)),
+        Effect.annotateLogs({
+          module: "RpcClient",
+          method: "makeProtocolWorker"
+        }),
+        Effect.interruptible,
+        Effect.forkScoped
+      )
+
+      yield* readyLatch.await
+
+      if (Option.isSome(initialMessage)) {
+        const [value, transfers] = yield* initialMessage.value
+        yield* backing.send({ _tag: "InitialMessage", value }, transfers)
+      }
+
+      return backing
+    })
+
+    const pool = "minSize" in options ?
+      yield* Pool.makeWithTTL({
+        acquire,
+        min: options.minSize,
+        max: options.maxSize,
+        concurrency: options.concurrency,
+        targetUtilization: options.targetUtilization,
+        timeToLive: options.timeToLive
+      }) :
+      yield* Pool.make({
+        acquire,
+        size: options.size,
+        concurrency: options.concurrency,
+        targetUtilization: options.targetUtilization
+      })
+
+    const send = (request: FromClientEncoded, transferables?: ReadonlyArray<globalThis.Transferable>) => {
+      switch (request._tag) {
+        case "Request": {
+          return Scope.make().pipe(
+            Effect.flatMap((scope) =>
+              Effect.flatMap(Scope.extend(pool.get, scope), (worker) => {
+                entries.set(request.id, { worker, scope })
+                return Effect.orDie(worker.send(request, transferables))
+              })
+            ),
+            Effect.orDie
+          )
+        }
+        case "Interrupt": {
+          const entry = entries.get(request.requestId)
+          if (!entry) return Effect.void
+          entries.delete(request.requestId)
+          return Effect.ensuring(
+            Effect.orDie(entry.worker.send(request)),
+            Scope.close(entry.scope, Exit.void)
+          )
+        }
+        case "Ack": {
+          const entry = entries.get(request.requestId)
+          if (!entry) return Effect.void
+          return Effect.orDie(entry.worker.send(request))
+        }
+      }
+      return Effect.void
+    }
+
+    yield* Effect.scoped(pool.get)
+
+    return {
+      send,
+      supportsAck: true,
+      supportsTransferables: true
+    }
+  }))
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolWorker = (
+  options: {
+    readonly size: number
+    readonly concurrency?: number | undefined
+    readonly targetUtilization?: number | undefined
+  } | {
+    readonly minSize: number
+    readonly maxSize: number
+    readonly concurrency?: number | undefined
+    readonly targetUtilization?: number | undefined
+    readonly timeToLive: Duration.DurationInput
+  }
+): Layer.Layer<Protocol, WorkerError, Worker.PlatformWorker | Worker.Spawner> =>
+  Layer.scoped(Protocol, makeProtocolWorker(options))
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolSocket: Layer.Layer<Protocol, never, Socket.Socket | RpcSerialization.RpcSerialization> =
+  Layer.scoped(Protocol, makeProtocolSocket)
+
+// internal
+
+const decodeDefect = Schema.decodeSync(Schema.Defect)
+
+const transformBigInt = (request: FromClientEncoded) => {
+  if (request._tag === "Request") {
+    ;(request as any).id = request.id.toString()
+  } else if ("requestId" in request) {
+    ;(request as any).requestId = request.requestId.toString()
+  }
+}
diff --git a/src/RpcGroup.ts b/src/RpcGroup.ts
new file mode 100644
index 0000000000000000000000000000000000000000..d734ec479a557cf75efc6ab2df98eeb6da7e8406
--- /dev/null
+++ b/src/RpcGroup.ts
@@ -0,0 +1,249 @@
+/**
+ * @since 1.0.0
+ */
+import type { Headers } from "@effect/platform/Headers"
+import * as Context from "effect/Context"
+import * as Effect from "effect/Effect"
+import * as Layer from "effect/Layer"
+import type { ReadonlyMailbox } from "effect/Mailbox"
+import { type Pipeable } from "effect/Pipeable"
+import type * as Record from "effect/Record"
+import * as Schema from "effect/Schema"
+import type { Scope } from "effect/Scope"
+import type * as Stream from "effect/Stream"
+import * as Rpc from "./Rpc.js"
+import type * as RpcMiddleware from "./RpcMiddleware.js"
+
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export const TypeId: unique symbol = Symbol.for("@effect/rpc/RpcGroup")
+
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export type TypeId = typeof TypeId
+
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export interface RpcGroup<in out Rpcs extends Rpc.Any> extends Pipeable {
+  new(_: never): {}
+
+  readonly [TypeId]: TypeId
+  readonly requests: ReadonlyMap<string, Rpcs>
+  readonly annotations: Context.Context<never>
+
+  /**
+   * Add one or more procedures to the group.
+   */
+  add<const Rpcs2 extends ReadonlyArray<Rpc.Any>>(
+    ...rpcs: Rpcs2
+  ): RpcGroup<Rpcs | Rpcs2[number]>
+
+  /**
+   * Merge this group with another group.
+   */
+  merge<Rpcs2 extends Rpc.Any>(
+    that: RpcGroup<Rpcs2>
+  ): RpcGroup<Rpcs | Rpcs2>
+
+  /**
+   * Add middleware to all the procedures added to the group until this point.
+   */
+  middleware<M extends RpcMiddleware.TagClassAny>(middleware: M): RpcGroup<Rpc.AddMiddleware<Rpcs, M>>
+
+  /**
+   * Implement the handlers for the procedures in this group, returning a
+   * context object.
+   */
+  toHandlersContext<
+    Handlers extends HandlersFrom<Rpcs>,
+    EX = never,
+    RX = never
+  >(
+    build:
+      | Handlers
+      | Effect.Effect<Handlers, EX, RX>
+  ): Effect.Effect<
+    Context.Context<Rpc.ToHandler<Rpcs>>,
+    EX,
+    | RX
+    | HandlersContext<Rpcs, Handlers>
+  >
+
+  /**
+   * Implement the handlers for the procedures in this group.
+   */
+  toLayer<
+    Handlers extends HandlersFrom<Rpcs>,
+    EX = never,
+    RX = never
+  >(
+    build:
+      | Handlers
+      | Effect.Effect<Handlers, EX, RX>
+  ): Layer.Layer<
+    Rpc.ToHandler<Rpcs>,
+    EX,
+    | Exclude<RX, Scope>
+    | HandlersContext<Rpcs, Handlers>
+  >
+
+  /**
+   * Annotate the group with a value.
+   */
+  annotate<I, S>(tag: Context.Tag<I, S>, value: S): RpcGroup<Rpcs>
+
+  /**
+   * Annotate the group with a context object.
+   */
+  annotateContext<S>(context: Context.Context<S>): RpcGroup<Rpcs>
+}
+
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type HandlersFrom<Rpc extends Rpc.Any> = {
+  readonly [Current in Rpc as Current["_tag"]]: (
+    payload: Rpc.Payload<Current>,
+    headers: Headers
+  ) => ResultFrom<Current> | Rpc.Fork<ResultFrom<Current>>
+}
+
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type ResultFrom<Rpc extends Rpc.Any> = Rpc.Success<Rpc> extends Stream.Stream<infer _A, infer _E, infer _R> ?
+    | Stream.Stream<
+      _A,
+      _E | Rpc.Error<Rpc>,
+      any
+    >
+    | Effect.Effect<ReadonlyMailbox<_A, _E | Rpc.Error<Rpc>>, _E | Rpc.Error<Rpc>, any> :
+  Effect.Effect<
+    Rpc.Success<Rpc>,
+    Rpc.Error<Rpc>,
+    any
+  >
+
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type HandlersContext<Rpcs extends Rpc.Any, Handlers> = keyof Handlers extends infer K ?
+  K extends keyof Handlers & string ? Handlers[K] extends (...args: any) =>
+      | Stream.Stream<infer _A, infer _E, infer _R>
+      | Effect.Effect<
+        ReadonlyMailbox<infer _A, infer _E>,
+        infer _EX,
+        infer _R
+      > ? Exclude<Rpc.ExcludeProvides<_R, Rpcs, K>, Scope> :
+    Handlers[K] extends (...args: any) => Effect.Effect<infer _A, infer _E, infer _R> ? _R
+    : never
+  : never
+  : never
+
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export type Rpcs<Group> = Group extends RpcGroup<infer R> ? R : never
+
+const RpcGroupProto = {
+  add(this: RpcGroup<any>, ...rpcs: Array<any>) {
+    return makeProto({
+      requests: resolveInput(
+        ...this.requests.values(),
+        ...rpcs
+      ),
+      annotations: this.annotations
+    })
+  },
+  merge(this: RpcGroup<any>, that: RpcGroup<any>) {
+    const requests = new Map(this.requests)
+    for (const rpc of that.requests.values()) {
+      requests.set(rpc._tag, rpc)
+    }
+    return makeProto({
+      requests,
+      annotations: Context.merge(this.annotations, that.annotations)
+    })
+  },
+  middleware(this: RpcGroup<any>, middleware: RpcMiddleware.TagClassAny) {
+    const requests = new Map<string, any>()
+    for (const [tag, rpc] of this.requests) {
+      requests.set(tag, rpc.middleware(middleware))
+    }
+    return makeProto({
+      requests,
+      annotations: this.annotations
+    })
+  },
+  toHandlersContext(this: RpcGroup<any>, build: Effect.Effect<Record<string, (request: any) => any>>) {
+    return Effect.gen(this, function*() {
+      const context = yield* Effect.context<never>()
+      const handlers = Effect.isEffect(build) ? yield* build : build
+      const contextMap = new Map<string, unknown>()
+      for (const [tag, handler] of Object.entries(handlers)) {
+        const rpc = this.requests.get(tag)!
+        contextMap.set(rpc.key, {
+          handler,
+          context
+        })
+      }
+      return Context.unsafeMake(contextMap)
+    })
+  },
+  toLayer(this: RpcGroup<any>, build: Effect.Effect<Record<string, (request: any) => any>>) {
+    return Layer.scopedContext(this.toHandlersContext(build))
+  },
+  annotate(this: RpcGroup<any>, tag: Context.Tag<any, any>, value: any) {
+    return makeProto({
+      requests: this.requests,
+      annotations: Context.add(this.annotations, tag, value)
+    })
+  },
+  annotateContext(this: RpcGroup<any>, context: Context.Context<any>) {
+    return makeProto({
+      requests: this.requests,
+      annotations: Context.merge(this.annotations, context)
+    })
+  }
+}
+
+const makeProto = <Rpcs extends Rpc.Any>(options: {
+  readonly requests: ReadonlyMap<string, Rpcs>
+  readonly annotations: Context.Context<never>
+}): RpcGroup<Rpcs> =>
+  Object.assign(function() {}, RpcGroupProto, {
+    requests: options.requests,
+    annotations: options.annotations
+  }) as any
+
+const resolveInput = <Rpcs extends ReadonlyArray<Rpc.Any>>(
+  ...rpcs: Rpcs
+): ReadonlyMap<string, Rpcs[number]> => {
+  const requests = new Map<string, Rpcs[number]>()
+  for (const rpc of rpcs) {
+    requests.set(rpc._tag, Schema.isSchema(rpc) ? Rpc.fromTaggedRequest(rpc as any) : rpc as any)
+  }
+  return requests
+}
+
+/**
+ * @since 1.0.0
+ * @category groups
+ */
+export const make = <const Rpcs extends ReadonlyArray<Rpc.Any>>(
+  ...rpcs: Rpcs
+): RpcGroup<Rpcs[number]> =>
+  makeProto({
+    requests: resolveInput(...rpcs),
+    annotations: Context.empty()
+  })
diff --git a/src/RpcMessage.ts b/src/RpcMessage.ts
new file mode 100644
index 0000000000000000000000000000000000000000..52ecdec307240f431a6cf1a73862166620423b16
--- /dev/null
+++ b/src/RpcMessage.ts
@@ -0,0 +1,261 @@
+/**
+ * @since 1.0.0
+ */
+import type { Headers } from "@effect/platform/Headers"
+import type { NonEmptyReadonlyArray } from "effect/Array"
+import type { Branded } from "effect/Brand"
+import type * as FiberId from "effect/FiberId"
+import * as Schema from "effect/Schema"
+import type * as Rpc from "./Rpc.js"
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type FromClient<A extends Rpc.Any> = Request<A> | Ack | Interrupt | Eof
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type FromClientEncoded = RequestEncoded | Ack | InterruptEncoded | Ping | Eof
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const RequestIdTypeId: unique symbol = Symbol.for("@effect/rpc/RpcServer/RequestId")
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type RequestIdTypeId = typeof RequestIdTypeId
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export type RequestId = Branded<bigint, RequestIdTypeId>
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const RequestId = (id: bigint | string): RequestId =>
+  typeof id === "bigint" ? id as RequestId : BigInt(id) as RequestId
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface RequestEncoded {
+  readonly _tag: "Request"
+  readonly id: bigint | string
+  readonly tag: string
+  readonly payload: unknown
+  readonly traceId: string
+  readonly spanId: string
+  readonly sampled: boolean
+  readonly headers: ReadonlyArray<[string, string]>
+}
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Request<A extends Rpc.Any> {
+  readonly _tag: "Request"
+  readonly id: RequestId
+  readonly tag: Rpc.Tag<A>
+  readonly payload: Rpc.Payload<A>
+  readonly traceId: string
+  readonly spanId: string
+  readonly sampled: boolean
+  readonly headers: Headers
+}
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Ack {
+  readonly _tag: "Ack"
+  readonly requestId: RequestId
+}
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Interrupt {
+  readonly _tag: "Interrupt"
+  readonly requestId: RequestId
+  readonly interruptors: ReadonlyArray<FiberId.FiberId>
+}
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface InterruptEncoded {
+  readonly _tag: "Interrupt"
+  readonly requestId: RequestId
+}
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Eof {
+  readonly _tag: "Eof"
+}
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export interface Ping {
+  readonly _tag: "Ping"
+}
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const constEof: Eof = { _tag: "Eof" }
+
+/**
+ * @since 1.0.0
+ * @category request
+ */
+export const constPing: Ping = { _tag: "Ping" }
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type FromServer<A extends Rpc.Any> =
+  | ResponseChunk<A>
+  | ResponseExit<A>
+  | ResponseDefect
+  | ClientEnd
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type FromServerEncoded = ResponseChunkEncoded | ResponseExitEncoded | ResponseDefectEncoded | Pong
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export const ResponseIdTypeId: unique symbol = Symbol.for("@effect/rpc/RpcServer/ResponseId")
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type ResponseIdTypeId = typeof ResponseIdTypeId
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export type ResponseId = Branded<number, ResponseIdTypeId>
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseChunkEncoded {
+  readonly _tag: "Chunk"
+  readonly requestId: bigint | string
+  readonly values: NonEmptyReadonlyArray<unknown>
+}
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseChunk<A extends Rpc.Any> {
+  readonly _tag: "Chunk"
+  readonly clientId: number
+  readonly requestId: RequestId
+  readonly values: NonEmptyReadonlyArray<Rpc.SuccessChunk<A>>
+}
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseExitEncoded {
+  readonly _tag: "Exit"
+  readonly requestId: bigint | string
+  readonly exit: Schema.ExitEncoded<unknown, unknown, unknown>
+}
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseExit<A extends Rpc.Any> {
+  readonly _tag: "Exit"
+  readonly clientId: number
+  readonly requestId: RequestId
+  readonly exit: Rpc.Exit<A>
+}
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseDefectEncoded {
+  readonly _tag: "Defect"
+  readonly defect: unknown
+}
+
+const encodeDefect = Schema.encodeSync(Schema.Defect)
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export const ResponseDefectEncoded = (input: unknown): ResponseDefectEncoded => ({
+  _tag: "Defect",
+  defect: encodeDefect(input)
+})
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ResponseDefect {
+  readonly _tag: "Defect"
+  readonly clientId: number
+  readonly defect: unknown
+}
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface ClientEnd {
+  readonly _tag: "ClientEnd"
+  readonly clientId: number
+}
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export interface Pong {
+  readonly _tag: "Pong"
+}
+
+/**
+ * @since 1.0.0
+ * @category response
+ */
+export const constPong: Pong = { _tag: "Pong" }
diff --git a/src/RpcMiddleware.ts b/src/RpcMiddleware.ts
new file mode 100644
index 0000000000000000000000000000000000000000..4168d1802472a68e1a10a2c1d91e91e3bfac41a2
--- /dev/null
+++ b/src/RpcMiddleware.ts
@@ -0,0 +1,265 @@
+/**
+ * @since 1.0.0
+ */
+import type { Headers } from "@effect/platform/Headers"
+import * as Context from "effect/Context"
+import * as Effect from "effect/Effect"
+import * as Layer from "effect/Layer"
+import * as Schema from "effect/Schema"
+import { Scope } from "effect/Scope"
+import type { Mutable } from "effect/Types"
+import type * as Rpc from "./Rpc.js"
+import type { Request } from "./RpcMessage.js"
+
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export const TypeId: unique symbol = Symbol.for("@effect/rpc/RpcMiddleware")
+
+/**
+ * @since 1.0.0
+ * @category type ids
+ */
+export type TypeId = typeof TypeId
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface RpcMiddleware<Provides, E> {
+  (options: {
+    readonly rpc: Rpc.AnyWithProps
+    readonly payload: unknown
+    readonly headers: Headers
+  }): Effect.Effect<Provides, E>
+}
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface RpcMiddlewareClient<R = never> {
+  (options: {
+    readonly rpc: Rpc.AnyWithProps
+    readonly request: Request<Rpc.Any>
+  }): Effect.Effect<Request<Rpc.Any>, never, R>
+}
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface ForClient<Id> {
+  readonly _: unique symbol
+  readonly id: Id
+}
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface Any {
+  (options: {
+    readonly rpc: Rpc.AnyWithProps
+    readonly payload: unknown
+    readonly headers: Headers
+  }): Effect.Effect<any, any>
+}
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface TagClass<
+  Self,
+  Name extends string,
+  Options
+> extends
+  TagClass.Base<
+    Self,
+    Name,
+    Options,
+    RpcMiddleware<
+      TagClass.Service<Options>,
+      TagClass.FailureService<Options>
+    >
+  >
+{}
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export declare namespace TagClass {
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type Provides<Options> = Options extends {
+    readonly provides: Context.Tag<any, any>
+    readonly optional?: false
+  } ? Context.Tag.Identifier<Options["provides"]>
+    : never
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type Service<Options> = Options extends { readonly provides: Context.Tag<any, any> }
+    ? Context.Tag.Service<Options["provides"]>
+    : void
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type FailureSchema<Options> = Options extends
+    { readonly failure: Schema.Schema.All; readonly optional?: false } ? Options["failure"]
+    : typeof Schema.Never
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type Failure<Options> = Options extends
+    { readonly failure: Schema.Schema<infer _A, infer _I, infer _R>; readonly optional?: false } ? _A
+    : never
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type FailureContext<Options> = Schema.Schema.Context<FailureSchema<Options>>
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type FailureService<Options> = Optional<Options> extends true ? unknown : Failure<Options>
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type Optional<Options> = Options extends { readonly optional: true } ? true : false
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export type RequiredForClient<Options> = Options extends { readonly requiredForClient: true } ? true : false
+
+  /**
+   * @since 1.0.0
+   * @category models
+   */
+  export interface Base<Self, Name extends string, Options, Service> extends Context.Tag<Self, Service> {
+    new(_: never): Context.TagClassShape<Name, Service>
+    readonly [TypeId]: TypeId
+    readonly optional: Optional<Options>
+    readonly failure: FailureSchema<Options>
+    readonly provides: Options extends { readonly provides: Context.Tag<any, any> } ? Options["provides"]
+      : undefined
+    readonly requiredForClient: RequiredForClient<Options>
+  }
+}
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface TagClassAny extends Context.Tag<any, any> {
+  readonly [TypeId]: TypeId
+  readonly optional: boolean
+  readonly provides?: Context.Tag<any, any> | undefined
+  readonly failure: Schema.Schema.All
+  readonly requiredForClient: boolean
+}
+
+/**
+ * @since 1.0.0
+ * @category models
+ */
+export interface TagClassAnyWithProps extends Context.Tag<any, RpcMiddleware<any, any>> {
+  readonly [TypeId]: TypeId
+  readonly optional: boolean
+  readonly provides?: Context.Tag<any, any>
+  readonly failure: Schema.Schema.All
+  readonly requiredForClient: boolean
+}
+
+/**
+ * @since 1.0.0
+ * @category tags
+ */
+export const Tag = <Self>(): <
+  const Name extends string,
+  const Options extends {
+    readonly optional?: boolean
+    readonly failure?: Schema.Schema.All
+    readonly provides?: Context.Tag<any, any>
+    readonly requiredForClient?: boolean
+  }
+>(
+  id: Name,
+  options?: Options | undefined
+) => TagClass<Self, Name, Options> =>
+(
+  id: string,
+  options?: {
+    readonly optional?: boolean
+    readonly failure?: Schema.Schema.All
+    readonly provides?: Context.Tag<any, any>
+    readonly requiredForClient?: boolean
+  }
+) => {
+  const Err = globalThis.Error as any
+  const limit = Err.stackTraceLimit
+  Err.stackTraceLimit = 2
+  const creationError = new Err()
+  Err.stackTraceLimit = limit
+
+  function TagClass() {}
+  const TagClass_ = TagClass as any as Mutable<TagClassAny>
+  Object.setPrototypeOf(TagClass, Object.getPrototypeOf(Context.GenericTag<Self, any>(id)))
+  TagClass.key = id
+  Object.defineProperty(TagClass, "stack", {
+    get() {
+      return creationError.stack
+    }
+  })
+  TagClass_[TypeId] = TypeId
+  TagClass_.failure = options?.optional === true || options?.failure === undefined ? Schema.Never : options.failure
+  if (options?.provides) {
+    TagClass_.provides = options.provides
+  }
+  TagClass_.optional = options?.optional ?? false
+  TagClass_.requiredForClient = options?.requiredForClient ?? false
+  return TagClass as any
+}
+
+/**
+ * @since 1.0.0
+ * @category client
+ */
+export const layerClient = <Id, S, R, EX = never, RX = never>(
+  tag: Context.Tag<Id, S>,
+  service: RpcMiddlewareClient<R> | Effect.Effect<RpcMiddlewareClient<R>, EX, RX>
+): Layer.Layer<ForClient<Id>, EX, R | Exclude<RX, Scope>> =>
+  Layer.scopedContext(Effect.gen(function*() {
+    const context = (yield* Effect.context<R | Scope>()).pipe(
+      Context.omit(Scope)
+    ) as Context.Context<R>
+    const middleware = Effect.isEffect(service) ? yield* service : service
+    return Context.unsafeMake(
+      new Map([[
+        `${tag.key}/Client`,
+        (options: any) =>
+          Effect.mapInputContext(
+            middleware(options),
+            (requestContext) => Context.merge(context, requestContext)
+          )
+      ]])
+    )
+  }))
diff --git a/src/RpcResolverNoStream.ts b/src/RpcResolverNoStream.ts
index 908f480c922afd79351936586606c7ab0d9a9ee8..3259e81473b424aa2f5dd5a0f81634aa4ad98e16 100644
--- a/src/RpcResolverNoStream.ts
+++ b/src/RpcResolverNoStream.ts
@@ -37,9 +37,13 @@ export const make = <HR, E>(
           (request) => ({ ..._, request })
         )),
       Effect.flatMap(handler),
-      Effect.filterOrDieMessage(
+      Effect.filterOrElse(
         (_): _ is Array<unknown> => Array.isArray(_) && _.length === requests.length,
-        "@effect/rpc: handler must return an array of responses with the same length as the requests."
+        (_) =>
+          Effect.dieMessage(
+            "@effect/rpc: handler must return an array of responses with the same length as the requests. Got: " +
+              JSON.stringify(_)
+          )
       ),
       Effect.flatMap(Effect.forEach((response, index) => {
         const request = requests[index]
diff --git a/src/RpcRouter.ts b/src/RpcRouter.ts
index d624a392c4b991608ab6d651a570a43387353081..f094c0a700634d14314fcabd958d8fdc69887197 100644
--- a/src/RpcRouter.ts
+++ b/src/RpcRouter.ts
@@ -140,7 +140,10 @@ export const provideServiceEffect: {
    * @since 1.0.0
    * @category context
    */
-  <I, S, E, R2>(tag: Context.Tag<I, S>, effect: Effect.Effect<S, E, R2>): <Reqs extends Schema.TaggedRequest.All, R>(self: RpcRouter<Reqs, R>) => RpcRouter<Reqs, Exclude<R, I> | R2>
+  <I, S, E, R2>(
+    tag: Context.Tag<I, S>,
+    effect: Effect.Effect<S, E, R2>
+  ): <Reqs extends Schema.TaggedRequest.All, R>(self: RpcRouter<Reqs, R>) => RpcRouter<Reqs, Exclude<R, I> | R2>
   /**
    * @since 1.0.0
    * @category context
@@ -165,12 +168,19 @@ export const provideService: {
    * @since 1.0.0
    * @category context
    */
-  <I, S>(tag: Context.Tag<I, S>, service: S): <Reqs extends Schema.TaggedRequest.All, R>(self: RpcRouter<Reqs, R>) => RpcRouter<Reqs, Exclude<R, I>>
+  <I, S>(
+    tag: Context.Tag<I, S>,
+    service: S
+  ): <Reqs extends Schema.TaggedRequest.All, R>(self: RpcRouter<Reqs, R>) => RpcRouter<Reqs, Exclude<R, I>>
   /**
    * @since 1.0.0
    * @category context
    */
-  <Reqs extends Schema.TaggedRequest.All, R, I, S>(self: RpcRouter<Reqs, R>, tag: Context.Tag<I, S>, service: S): RpcRouter<Reqs, Exclude<R, I>>
+  <Reqs extends Schema.TaggedRequest.All, R, I, S>(
+    self: RpcRouter<Reqs, R>,
+    tag: Context.Tag<I, S>,
+    service: S
+  ): RpcRouter<Reqs, Exclude<R, I>>
 } = dual(3, <Reqs extends Schema.TaggedRequest.All, R, I, S>(
   self: RpcRouter<Reqs, R>,
   tag: Context.Tag<I, S>,
@@ -230,11 +240,13 @@ export const toHandler: {
     return (u: unknown): Stream.Stream<RpcRouter.Response, ParseError, RpcRouter.Context<R>> =>
       pipe(
         decode(u),
-        Effect.zip(Mailbox.make</**
-         * @since 1.0.0
-         * @category combinators
-         */
-        RpcRouter.Response>(4)),
+        Effect.zip(Mailbox.make<
+          /**
+           * @since 1.0.0
+           * @category combinators
+           */
+          RpcRouter.Response
+        >(4)),
         Effect.tap(([requests, mailbox]) =>
           pipe(
             Effect.forEach(requests, (req, index) => {
@@ -306,7 +318,7 @@ export const toHandler: {
         ),
         Effect.map(([_, mailbox]) => Mailbox.toStream(mailbox)),
         Stream.unwrapScoped
-      );
+      )
   }
 )
 
diff --git a/src/RpcSchema.ts b/src/RpcSchema.ts
new file mode 100644
index 0000000000000000000000000000000000000000..36014df95b96ac4540d1115f082606c18a20dcb4
--- /dev/null
+++ b/src/RpcSchema.ts
@@ -0,0 +1,121 @@
+/**
+ * @since 1.0.0
+ */
+import type * as Chunk from "effect/Chunk"
+import * as Effect from "effect/Effect"
+import * as Option from "effect/Option"
+import * as ParseResult from "effect/ParseResult"
+import { hasProperty } from "effect/Predicate"
+import * as Schema from "effect/Schema"
+import * as AST from "effect/SchemaAST"
+import * as Stream_ from "effect/Stream"
+
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const StreamSchemaId: unique symbol = Symbol.for("@effect/rpc/RpcSchema/Stream")
+
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const isStreamSchema = (schema: Schema.Schema.All): schema is Stream<any, any> =>
+  schema.ast.annotations[AST.SchemaIdAnnotationId] === StreamSchemaId
+
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const isStreamSerializable = (schema: Schema.WithResult.Any): boolean =>
+  isStreamSchema(Schema.successSchema(schema))
+
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const getStreamSchemas = (
+  ast: AST.AST
+): Option.Option<{
+  readonly success: Schema.Schema.Any
+  readonly failure: Schema.Schema.All
+}> => ast.annotations[StreamSchemaId] ? Option.some(ast.annotations[StreamSchemaId] as any) : Option.none()
+
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export interface Stream<A extends Schema.Schema.Any, E extends Schema.Schema.All> extends
+  Schema.Schema<
+    Stream_.Stream<A["Type"], E["Type"]>,
+    Stream_.Stream<A["Encoded"], E["Encoded"]>,
+    A["Context"] | E["Context"]
+  >
+{
+  readonly success: A
+  readonly failure: E
+}
+
+/**
+ * @since 1.0.0
+ * @category Stream
+ */
+export const Stream = <A extends Schema.Schema.Any, E extends Schema.Schema.All>(
+  { failure, success }: {
+    readonly failure: E
+    readonly success: A
+  }
+): Stream<A, E> =>
+  Object.assign(
+    Schema.declare(
+      [success, failure],
+      {
+        decode: (success, failure) =>
+          parseStream(
+            ParseResult.decodeUnknown(Schema.ChunkFromSelf(success)),
+            ParseResult.decodeUnknown(failure)
+          ),
+        encode: (success, failure) =>
+          parseStream(
+            ParseResult.encodeUnknown(Schema.ChunkFromSelf(success)),
+            ParseResult.encodeUnknown(failure)
+          )
+      },
+      {
+        schemaId: StreamSchemaId,
+        [StreamSchemaId]: { success, failure }
+      }
+    ),
+    {
+      success,
+      failure
+    }
+  )
+
+const isStream = (u: unknown): u is Stream_.Stream<unknown, unknown> => hasProperty(u, Stream_.StreamTypeId)
+
+const parseStream = <A, E, RA, RE>(
+  decodeSuccess: (
+    u: Chunk.Chunk<unknown>,
+    overrideOptions?: AST.ParseOptions
+  ) => Effect.Effect<Chunk.Chunk<A>, ParseResult.ParseIssue, RA>,
+  decodeFailure: (u: unknown, overrideOptions?: AST.ParseOptions) => Effect.Effect<E, ParseResult.ParseIssue, RE>
+) =>
+(u: unknown, options: AST.ParseOptions, ast: AST.AST) =>
+  Effect.flatMap(
+    Effect.context<RA | RE>(),
+    (context) => {
+      if (!isStream(u)) return Effect.fail(new ParseResult.Type(ast, u))
+      return Effect.succeed(u.pipe(
+        Stream_.mapChunksEffect((value) => decodeSuccess(value, options)),
+        Stream_.catchAll((error) => {
+          if (ParseResult.isParseError(error)) return Stream_.die(error)
+          return Effect.matchEffect(decodeFailure(error, options), {
+            onFailure: Effect.die,
+            onSuccess: Effect.fail
+          })
+        }),
+        Stream_.provideContext(context)
+      ))
+    }
+  )
diff --git a/src/RpcSerialization.ts b/src/RpcSerialization.ts
new file mode 100644
index 0000000000000000000000000000000000000000..358f884ccc88039a8293c08a357874ccdf76c76a
--- /dev/null
+++ b/src/RpcSerialization.ts
@@ -0,0 +1,125 @@
+/**
+ * @since 1.0.0
+ */
+import { Msgpackr } from "@effect/platform/MsgPack"
+import * as Context from "effect/Context"
+import * as Effect from "effect/Effect"
+import * as Layer from "effect/Layer"
+
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export class RpcSerialization extends Context.Tag("@effect/rpc/RpcSerialization")<RpcSerialization, {
+  unsafeMake(): Parser
+  readonly contentType: string
+  readonly supportsBigInt: boolean
+}>() {}
+
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export interface Parser {
+  readonly decode: (data: Uint8Array | string) => ReadonlyArray<unknown>
+  readonly encode: (response: unknown) => Uint8Array | string
+}
+
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export const json: Effect.Effect<RpcSerialization["Type"]> = Effect.sync(() => {
+  const decoder = new TextDecoder()
+  return RpcSerialization.of({
+    contentType: "application/json",
+    supportsBigInt: false,
+    unsafeMake: () => ({
+      decode: (bytes) => [JSON.parse(typeof bytes === "string" ? bytes : decoder.decode(bytes))],
+      encode: (response) => JSON.stringify(response)
+    })
+  })
+})
+
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export const ndjson: Effect.Effect<RpcSerialization["Type"]> = Effect.sync(() => {
+  const decoder = new TextDecoder()
+  return RpcSerialization.of({
+    contentType: "application/ndjson",
+    supportsBigInt: false,
+    unsafeMake: () => {
+      let buffer = ""
+      return ({
+        decode: (bytes) => {
+          buffer += typeof bytes === "string" ? bytes : decoder.decode(bytes)
+          let position = 0
+          let nlIndex = buffer.indexOf("\n", position)
+          const items: Array<unknown> = []
+          while (nlIndex !== -1) {
+            const item = JSON.parse(buffer.slice(position, nlIndex))
+            items.push(item)
+            position = nlIndex + 1
+            nlIndex = buffer.indexOf("\n", position)
+          }
+          buffer = buffer.slice(position)
+          return items
+        },
+        encode: (response) => JSON.stringify(response) + "\n"
+      })
+    }
+  })
+})
+
+/**
+ * @since 1.0.0
+ * @category serialization
+ */
+export const msgPack: RpcSerialization["Type"] = RpcSerialization.of({
+  contentType: "application/msgpack",
+  supportsBigInt: true,
+  unsafeMake: () => {
+    const unpackr = new Msgpackr.Unpackr()
+    const packr = new Msgpackr.Packr()
+    const encoder = new TextEncoder()
+    return ({
+      decode: (bytes) => unpackr.unpackMultiple(typeof bytes === "string" ? encoder.encode(bytes) : bytes),
+      encode: (response) => packr.pack(response)
+    })
+  }
+})
+
+/**
+ * A rpc serialization layer that uses JSON for serialization.
+ *
+ * Use this if your protocol supports framing for messages, otherwise use
+ * `layerSerializationNdjson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export const layerJson: Layer.Layer<RpcSerialization> = Layer.effect(RpcSerialization, json)
+
+/**
+ * A rpc serialization layer that uses NDJSON for serialization.
+ *
+ * Use this if your protocol does not support framing for messages, otherwise
+ * use `layerSerializationJson`.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export const layerNdjson: Layer.Layer<RpcSerialization> = Layer.effect(RpcSerialization, ndjson)
+
+/**
+ * A rpc serialization layer that uses MessagePack for serialization.
+ *
+ * MessagePack has a more compact binary format compared to JSON and NDJSON. It
+ * also has better support for binary data.
+ *
+ * @since 1.0.0
+ * @category serialization
+ */
+export const layerMsgPack: Layer.Layer<RpcSerialization> = Layer.succeed(RpcSerialization, msgPack)
diff --git a/src/RpcServer.ts b/src/RpcServer.ts
new file mode 100644
index 0000000000000000000000000000000000000000..fbb513ca217111d0bd9558049284d61096d7e4d4
--- /dev/null
+++ b/src/RpcServer.ts
@@ -0,0 +1,1190 @@
+/**
+ * @since 1.0.0
+ */
+import * as Headers from "@effect/platform/Headers"
+import * as HttpApp from "@effect/platform/HttpApp"
+import * as HttpRouter from "@effect/platform/HttpRouter"
+import * as HttpServerRequest from "@effect/platform/HttpServerRequest"
+import * as HttpServerResponse from "@effect/platform/HttpServerResponse"
+import type * as Socket from "@effect/platform/Socket"
+import * as SocketServer from "@effect/platform/SocketServer"
+import * as Transferable from "@effect/platform/Transferable"
+import type { WorkerError } from "@effect/platform/WorkerError"
+import * as WorkerRunner from "@effect/platform/WorkerRunner"
+import type { NonEmptyReadonlyArray } from "effect/Array"
+import * as Arr from "effect/Array"
+import * as Cause from "effect/Cause"
+import * as Chunk from "effect/Chunk"
+import * as Context from "effect/Context"
+import * as Deferred from "effect/Deferred"
+import * as Effect from "effect/Effect"
+import * as Exit from "effect/Exit"
+import * as Fiber from "effect/Fiber"
+import * as FiberId from "effect/FiberId"
+import * as FiberRef from "effect/FiberRef"
+import * as FiberSet from "effect/FiberSet"
+import { constant, constTrue, constVoid, identity } from "effect/Function"
+import * as Layer from "effect/Layer"
+import * as Mailbox from "effect/Mailbox"
+import * as ManagedRuntime from "effect/ManagedRuntime"
+import * as Option from "effect/Option"
+import { ArrayFormatter, type ParseError } from "effect/ParseResult"
+import * as Predicate from "effect/Predicate"
+import * as Schema from "effect/Schema"
+import * as Scope from "effect/Scope"
+import * as Stream from "effect/Stream"
+import { withRun } from "./internal/utils.js"
+import * as Rpc from "./Rpc.js"
+import type * as RpcGroup from "./RpcGroup.js"
+import {
+  constEof,
+  constPong,
+  type FromClient,
+  type FromClientEncoded,
+  type FromServer,
+  type FromServerEncoded,
+  type Request,
+  RequestId,
+  ResponseDefectEncoded
+} from "./RpcMessage.js"
+import * as RpcSchema from "./RpcSchema.js"
+import * as RpcSerialization from "./RpcSerialization.js"
+import type { InitialMessage } from "./RpcWorker.js"
+
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export interface RpcServer<A extends Rpc.Any> {
+  readonly write: (clientId: number, message: FromClient<A>) => Effect.Effect<void>
+  readonly disconnect: (clientId: number) => Effect.Effect<void>
+}
+
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export const makeNoSerialization: <Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options: {
+    readonly onFromServer: (response: FromServer<Rpcs>) => Effect.Effect<void>
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+    readonly disableClientAcks?: boolean | undefined
+    readonly concurrency?: number | "unbounded" | undefined
+  }
+) => Effect.Effect<
+  RpcServer<Rpcs>,
+  never,
+  Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs> | Scope.Scope
+> = Effect.fnUntraced(function*<Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options: {
+    readonly onFromServer: (response: FromServer<Rpcs>) => Effect.Effect<void>
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+    readonly disableClientAcks?: boolean | undefined
+    readonly concurrency?: number | "unbounded" | undefined
+  }
+) {
+  const tracingEnabled = options.disableSpanPropagation !== true
+  const supportsAck = options.disableClientAcks !== true
+  const spanPrefix = options.spanPrefix ?? "RpcServer"
+  const concurrency = options.concurrency ?? "unbounded"
+  const context = yield* Effect.context<Rpc.ToHandler<Rpcs> | Scope.Scope>()
+  const scope = Context.get(context, Scope.Scope)
+  const fiberSet = yield* FiberSet.make()
+  const runFork = yield* FiberSet.runtime(fiberSet)().pipe(
+    Effect.interruptible
+  )
+  const concurrencySemaphore = concurrency === "unbounded"
+    ? undefined
+    : yield* Effect.makeSemaphore(concurrency)
+
+  type Client = {
+    readonly id: number
+    readonly latches: Map<RequestId, Effect.Latch>
+    readonly fibers: Map<RequestId, Fiber.RuntimeFiber<unknown, any>>
+    ended: boolean
+  }
+
+  const clients = new Map<number, Client>()
+  let isShutdown = false
+  const shutdownLatch = Effect.unsafeMakeLatch(false)
+  yield* Scope.addFinalizer(
+    scope,
+    Effect.fiberIdWith((fiberId) => {
+      isShutdown = true
+      for (const client of clients.values()) {
+        client.ended = true
+        if (client.fibers.size === 0) {
+          runFork(endClient(client))
+          continue
+        }
+        for (const fiber of client.fibers.values()) {
+          fiber.unsafeInterruptAsFork(fiberId)
+        }
+      }
+      if (clients.size === 0) {
+        return Effect.void
+      }
+      return shutdownLatch.await
+    })
+  )
+
+  const disconnect = (clientId: number) =>
+    Effect.fiberIdWith((fiberId) => {
+      const client = clients.get(clientId)
+      if (!client) return Effect.void
+      for (const fiber of client.fibers.values()) {
+        fiber.unsafeInterruptAsFork(fiberId)
+      }
+      clients.delete(clientId)
+      return Effect.void
+    })
+
+  const write = (clientId: number, message: FromClient<Rpcs>): Effect.Effect<void> =>
+    Effect.catchAllDefect(
+      Effect.suspend(() => {
+        if (isShutdown) return Effect.interrupt
+        let client = clients.get(clientId)
+        if (!client) {
+          client = {
+            id: clientId,
+            latches: new Map(),
+            fibers: new Map(),
+            ended: false
+          }
+          clients.set(clientId, client)
+        } else if (client.ended) {
+          return Effect.interrupt
+        }
+
+        switch (message._tag) {
+          case "Request": {
+            return handleRequest(client, message)
+          }
+          case "Ack": {
+            const latch = client.latches.get(message.requestId)
+            return latch ? latch.open : Effect.void
+          }
+          case "Interrupt": {
+            const fiber = client.fibers.get(message.requestId)
+            return fiber ? Fiber.interruptFork(fiber) : options.onFromServer({
+              _tag: "Exit",
+              clientId,
+              requestId: message.requestId,
+              exit: Exit.interrupt(FiberId.none)
+            })
+          }
+          case "Eof": {
+            client.ended = true
+            if (client.fibers.size > 0) return Effect.void
+            return endClient(client)
+          }
+          default: {
+            return sendDefect(client, `Unknown request tag: ${(message as any)._tag}`)
+          }
+        }
+      }),
+      (defect) => sendDefect(clients.get(clientId)!, defect)
+    )
+
+  const endClient = (client: Client) => {
+    clients.delete(client.id)
+    const write = options.onFromServer({
+      _tag: "ClientEnd",
+      clientId: client.id
+    })
+    if (isShutdown && clients.size === 0) {
+      return Effect.zipRight(write, shutdownLatch.open)
+    }
+    return write
+  }
+
+  const handleRequest = (client: Client, request: Request<Rpcs>): Effect.Effect<void> => {
+    if (client.fibers.has(request.id)) {
+      return Effect.interrupt
+    }
+    const rpc = group.requests.get(request.tag) as any as Rpc.AnyWithProps
+    const entry = context.unsafeMap.get(rpc?.key) as Rpc.Handler<Rpcs["_tag"]>
+    if (!rpc || !entry) {
+      const write = Effect.catchAllDefect(
+        options.onFromServer({
+          _tag: "Exit",
+          clientId: client.id,
+          requestId: request.id,
+          exit: Exit.die(`Unknown request tag: ${request.tag}`)
+        }),
+        (defect) => sendDefect(client, defect)
+      )
+      if (!client.ended || client.fibers.size > 0) return write
+      return Effect.zipRight(write, endClient(client))
+    }
+    const isStream = RpcSchema.isStreamSchema(rpc.successSchema)
+    const result = entry.handler(request.payload, request.headers)
+
+    // if the handler requested forking, then we skip the concurrency control
+    const isFork = Rpc.isFork(result)
+    // unwrap the fork data type
+    const streamOrEffect = isFork ? result.value : result
+
+    let responded = false
+    let effect = Effect.uninterruptible(Effect.matchCauseEffect(
+      Effect.interruptible(applyMiddleware(
+        rpc,
+        context,
+        request.payload,
+        request.headers,
+        isStream
+          ? streamEffect(client, request, streamOrEffect)
+          : streamOrEffect as Effect.Effect<any>
+      )),
+      {
+        onSuccess: (value) => {
+          responded = true
+          return options.onFromServer({
+            _tag: "Exit",
+            clientId: client.id,
+            requestId: request.id,
+            exit: Exit.succeed(value as any)
+          })
+        },
+        onFailure: (cause) => {
+          responded = true
+          return options.onFromServer({
+            _tag: "Exit",
+            clientId: client.id,
+            requestId: request.id,
+            exit: Exit.failCause(cause)
+          })
+        }
+      }
+    ))
+    if (tracingEnabled) {
+      effect = Effect.withSpan(effect, `${spanPrefix}.${request.tag}`, {
+        captureStackTrace: false,
+        parent: {
+          _tag: "ExternalSpan",
+          traceId: request.traceId,
+          spanId: request.spanId,
+          sampled: request.sampled,
+          context: Context.empty()
+        }
+      })
+    }
+    effect = Effect.locally(effect, FiberRef.currentContext, entry.context)
+    if (!isFork && concurrencySemaphore) {
+      effect = concurrencySemaphore.withPermits(1)(effect)
+    }
+    const fiber = runFork(effect)
+    client.fibers.set(request.id, fiber)
+    fiber.addObserver((exit) => {
+      if (!responded && exit._tag === "Failure") {
+        runFork(
+          options.onFromServer({
+            _tag: "Exit",
+            clientId: client.id,
+            requestId: request.id,
+            exit: Exit.interrupt(FiberId.none)
+          })
+        )
+      }
+      client.fibers.delete(request.id)
+      client.latches.delete(request.id)
+      if (client.ended && client.fibers.size === 0) {
+        runFork(endClient(client))
+      }
+    })
+    return Effect.void
+  }
+
+  const streamEffect = (
+    client: Client,
+    request: Request<Rpcs>,
+    stream: Stream.Stream<any, any> | Effect.Effect<Mailbox.ReadonlyMailbox<any, any>, any, Scope.Scope>
+  ) => {
+    let latch = client.latches.get(request.id)
+    if (supportsAck && !latch) {
+      latch = Effect.unsafeMakeLatch(false)
+      client.latches.set(request.id, latch)
+    }
+    if (Effect.isEffect(stream)) {
+      let done = false
+      return stream.pipe(
+        Effect.flatMap((mailbox) =>
+          Effect.whileLoop({
+            while: () => !done,
+            body: constant(Effect.flatMap(mailbox.takeAll, ([chunk, done_]) => {
+              done = done_
+              if (!Chunk.isNonEmpty(chunk)) return Effect.void
+              const write = options.onFromServer({
+                _tag: "Chunk",
+                clientId: client.id,
+                requestId: request.id,
+                values: Chunk.toReadonlyArray(chunk)
+              })
+              if (!latch) return write
+              latch.unsafeClose()
+              return Effect.zipRight(write, latch.await)
+            })),
+            step: constVoid
+          })
+        ),
+        Effect.scoped
+      )
+    }
+    return Stream.runForEachChunk(stream, (chunk) => {
+      if (!Chunk.isNonEmpty(chunk)) return Effect.void
+      const write = options.onFromServer({
+        _tag: "Chunk",
+        clientId: client.id,
+        requestId: request.id,
+        values: Chunk.toReadonlyArray(chunk)
+      })
+      if (!latch) return write
+      latch.unsafeClose()
+      return Effect.zipRight(write, latch.await)
+    })
+  }
+
+  const sendDefect = (client: Client, defect: unknown) =>
+    Effect.suspend(() => {
+      const shouldEnd = client.ended && client.fibers.size === 0
+      const write = options.onFromServer({
+        _tag: "Defect",
+        clientId: client.id,
+        defect
+      })
+      if (!shouldEnd) return write
+      return Effect.zipRight(write, endClient(client))
+    })
+
+  return identity<RpcServer<Rpcs>>({
+    write,
+    disconnect
+  })
+})
+
+const applyMiddleware = <A, E, R>(
+  rpc: Rpc.AnyWithProps,
+  context: Context.Context<never>,
+  payload: A,
+  headers: Headers.Headers,
+  handler: Effect.Effect<A, E, R>
+) => {
+  if (rpc.middlewares.size === 0) {
+    return handler
+  }
+
+  const options = {
+    rpc,
+    payload,
+    headers
+  }
+
+  for (const tag of rpc.middlewares) {
+    const middleware = Context.unsafeGet(context, tag)
+    if (tag.optional) {
+      const previous = handler
+      handler = Effect.matchEffect(middleware(options), {
+        onFailure: () => previous,
+        onSuccess: tag.provides !== undefined
+          ? (value) => Effect.provideService(previous, tag.provides as any, value)
+          : (_) => previous
+      })
+    } else {
+      handler = tag.provides !== undefined
+        ? Effect.provideServiceEffect(handler, tag.provides as any, middleware(options))
+        : Effect.zipRight(middleware(options), handler)
+    }
+  }
+
+  return handler
+}
+
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export const make: <Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?:
+    | {
+      readonly disableSpanPropagation?: boolean | undefined
+      readonly spanPrefix?: string | undefined
+      readonly concurrency?: number | "unbounded" | undefined
+    }
+    | undefined
+) => Effect.Effect<
+  never,
+  never,
+  Protocol | Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs>
+> = Effect.fnUntraced(function*<Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+    readonly concurrency?: number | "unbounded" | undefined
+  }
+) {
+  const { disconnects, end, run, send, supportsAck, supportsTransferables } = yield* Protocol
+  const context = yield* Effect.context<Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs>>()
+  const scope = yield* Scope.make()
+
+  const server = yield* makeNoSerialization(group, {
+    ...options,
+    disableClientAcks: !supportsAck,
+    onFromServer(response): Effect.Effect<void> {
+      const client = clients.get(response.clientId)
+      if (!client) return Effect.void
+      switch (response._tag) {
+        case "Chunk": {
+          const schemas = client.schemas.get(response.requestId)
+          if (!schemas) return Effect.void
+          return handleEncode(
+            client,
+            response.requestId,
+            schemas.collector,
+            Effect.locally(schemas.encodeChunk(response.values), FiberRef.currentContext, schemas.context),
+            (values) => ({ _tag: "Chunk", requestId: response.requestId, values })
+          )
+        }
+        case "Exit": {
+          const schemas = client.schemas.get(response.requestId)
+          if (!schemas) return Effect.void
+          client.schemas.delete(response.requestId)
+          return handleEncode(
+            client,
+            response.requestId,
+            schemas.collector,
+            Effect.locally(schemas.encodeExit(response.exit), FiberRef.currentContext, schemas.context),
+            (exit) => ({ _tag: "Exit", requestId: response.requestId, exit })
+          )
+        }
+        case "Defect": {
+          return sendDefect(client, response.defect)
+        }
+        case "ClientEnd": {
+          clients.delete(response.clientId)
+          return end(response.clientId)
+        }
+      }
+    }
+  }).pipe(Scope.extend(scope))
+
+  // handle disconnects
+  yield* Effect.fork(Effect.interruptible(Effect.whileLoop({
+    while: constTrue,
+    body: constant(Effect.flatMap(disconnects.take, (clientId) => {
+      clients.delete(clientId)
+      return server.disconnect(clientId)
+    })),
+    step: constVoid
+  })))
+
+  type Schemas = {
+    readonly decode: (u: unknown) => Effect.Effect<Rpc.Payload<Rpcs>, ParseError>
+    readonly encodeChunk: (u: ReadonlyArray<unknown>) => Effect.Effect<NonEmptyReadonlyArray<unknown>, ParseError>
+    readonly encodeExit: (u: unknown) => Effect.Effect<Schema.ExitEncoded<unknown, unknown, unknown>, ParseError>
+    readonly context: Context.Context<never>
+    readonly collector?: Transferable.CollectorService | undefined
+  }
+
+  const schemasCache = new WeakMap<any, Schemas>()
+  const getSchemas = (rpc: Rpc.AnyWithProps) => {
+    let schemas = schemasCache.get(rpc)
+    if (!schemas) {
+      const entry = context.unsafeMap.get(rpc.key) as Rpc.Handler<Rpcs["_tag"]>
+      const streamSchemas = RpcSchema.getStreamSchemas(rpc.successSchema.ast)
+      const failures = new Set([rpc.errorSchema])
+      if (Option.isSome(streamSchemas)) {
+        failures.add(streamSchemas.value.failure)
+      }
+      for (const middleware of rpc.middlewares) {
+        failures.add(middleware.failure)
+      }
+      schemas = {
+        decode: Schema.decodeUnknown(rpc.payloadSchema as any),
+        encodeChunk: Schema.encodeUnknown(
+          Schema.Array(Option.isSome(streamSchemas) ? streamSchemas.value.success : Schema.Any)
+        ) as any,
+        encodeExit: Schema.encodeUnknown(Rpc.exitSchema(rpc as any)) as any,
+        context: entry.context
+      }
+      schemasCache.set(rpc, schemas)
+    }
+    return schemas
+  }
+
+  type Client = {
+    readonly id: number
+    readonly schemas: Map<RequestId, Schemas>
+  }
+  const clients = new Map<number, Client>()
+
+  const handleEncode = <A, R>(
+    client: Client,
+    requestId: RequestId,
+    collector: Transferable.CollectorService | undefined,
+    effect: Effect.Effect<A, ParseError, R>,
+    onSuccess: (a: A) => FromServerEncoded
+  ) =>
+    (collector ? Effect.provideService(effect, Transferable.Collector, collector) : effect).pipe(
+      Effect.flatMap((a) => send(client.id, onSuccess(a), collector && collector.unsafeClear())),
+      Effect.catchAllCause((cause) => {
+        client.schemas.delete(requestId)
+        const defect = Cause.squash(Cause.map(cause, ArrayFormatter.formatErrorSync))
+        return Effect.zipRight(
+          server.write(client.id, { _tag: "Interrupt", requestId, interruptors: [] }),
+          sendRequestDefect(client, requestId, defect)
+        )
+      })
+    )
+
+  const sendRequestDefect = (client: Client, requestId: RequestId, defect: unknown) =>
+    Effect.catchAllCause(
+      send(client.id, {
+        _tag: "Exit",
+        requestId,
+        exit: {
+          _tag: "Failure",
+          cause: {
+            _tag: "Die",
+            defect
+          }
+        }
+      }),
+      (cause) => sendDefect(client, Cause.squash(cause))
+    )
+
+  const sendDefect = (client: Client, defect: unknown) =>
+    Effect.catchAllCause(
+      send(client.id, { _tag: "Defect", defect }),
+      (cause) =>
+        Effect.annotateLogs(Effect.logDebug(cause), {
+          module: "RpcServer",
+          method: "sendDefect"
+        })
+    )
+
+  // main server loop
+  return yield* run((clientId, request) => {
+    let client = clients.get(clientId)
+    if (!client) {
+      client = {
+        id: clientId,
+        schemas: new Map()
+      }
+      clients.set(clientId, client)
+    }
+
+    switch (request._tag) {
+      case "Request": {
+        const tag = Predicate.hasProperty(request, "tag") ? request.tag as string : ""
+        const rpc = group.requests.get(tag)
+        if (!rpc) {
+          return sendDefect(client, `Unknown request tag: ${tag}`)
+        }
+        let requestId: RequestId
+        switch (typeof request.id) {
+          case "bigint":
+          case "string": {
+            requestId = RequestId(request.id)
+            break
+          }
+          default: {
+            return sendDefect(client, `Invalid request id: ${request.id}`)
+          }
+        }
+        const schemas = getSchemas(rpc as any)
+        return Effect.matchEffect(
+          Effect.locally(schemas.decode(request.payload), FiberRef.currentContext, schemas.context),
+          {
+            onFailure: (error) => sendRequestDefect(client, requestId, ArrayFormatter.formatErrorSync(error)),
+            onSuccess: (payload) => {
+              client.schemas.set(
+                requestId,
+                supportsTransferables ?
+                  {
+                    ...schemas,
+                    collector: Transferable.unsafeMakeCollector()
+                  } :
+                  schemas
+              )
+              return server.write(clientId, {
+                ...request,
+                id: requestId,
+                payload,
+                headers: Headers.fromInput(request.headers)
+              } as any)
+            }
+          }
+        )
+      }
+      case "Ping": {
+        return Effect.catchAllCause(
+          send(client.id, constPong),
+          (cause) => sendDefect(client, Cause.squash(cause))
+        )
+      }
+      case "Ack":
+      case "Eof":
+      case "Interrupt": {
+        if ("requestId" in request && typeof request.requestId === "string") {
+          ;(request as any).requestId = BigInt(request.requestId)
+        }
+        return server.write(
+          clientId,
+          request._tag === "Interrupt" ?
+            {
+              ...request,
+              interruptors: []
+            } :
+            request
+        )
+      }
+      default: {
+        return sendDefect(client, `Unknown request tag: ${(request as any)._tag}`)
+      }
+    }
+  }).pipe(
+    Effect.interruptible,
+    Effect.tapErrorCause((cause) => Effect.logFatal("BUG: RpcServer protocol crashed", cause)),
+    Effect.onExit((exit) => Scope.close(scope, exit))
+  )
+})
+
+/**
+ * @since 1.0.0
+ * @category server
+ */
+export const layer = <Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+    readonly concurrency?: number | "unbounded" | undefined
+  }
+): Layer.Layer<
+  never,
+  never,
+  | Protocol
+  | Rpc.ToHandler<Rpcs>
+  | Rpc.Middleware<Rpcs>
+> => Layer.scopedDiscard(Effect.forkScoped(Effect.interruptible(make(group, options))))
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export class Protocol extends Context.Tag("@effect/rpc/RpcServer/Protocol")<Protocol, {
+  readonly run: (
+    f: (clientId: number, data: FromClientEncoded) => Effect.Effect<void>
+  ) => Effect.Effect<never>
+  readonly disconnects: Mailbox.ReadonlyMailbox<number>
+  readonly send: (
+    clientId: number,
+    response: FromServerEncoded,
+    transferables?: ReadonlyArray<globalThis.Transferable>
+  ) => Effect.Effect<void>
+  readonly end: (clientId: number) => Effect.Effect<void>
+  readonly initialMessage: Effect.Effect<Option.Option<unknown>>
+  readonly supportsAck: boolean
+  readonly supportsTransferables: boolean
+}>() {
+  /**
+   * @since 1.0.0
+   */
+  static make = withRun<Protocol["Type"]>()
+}
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolSocketServer = Effect.gen(function*() {
+  const server = yield* SocketServer.SocketServer
+  const { onSocket, protocol } = yield* makeSocketProtocol
+  yield* Effect.forkScoped(Effect.interruptible(
+    server.run(Effect.fnUntraced(onSocket, Effect.scoped))
+  ))
+  return protocol
+})
+
+/**
+ * A rpc protocol that uses `SocketServer` for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolSocketServer: Layer.Layer<
+  Protocol,
+  never,
+  RpcSerialization.RpcSerialization | SocketServer.SocketServer
+> = Layer.scoped(Protocol, makeProtocolSocketServer)
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWithHttpAppWebsocket: Effect.Effect<
+  {
+    readonly protocol: Protocol["Type"]
+    readonly httpApp: HttpApp.Default<never, Scope.Scope>
+  },
+  never,
+  RpcSerialization.RpcSerialization
+> = Effect.gen(function*() {
+  const { onSocket, protocol } = yield* makeSocketProtocol
+
+  const httpApp: HttpApp.Default<never, Scope.Scope> = Effect.gen(function*() {
+    const request = yield* HttpServerRequest.HttpServerRequest
+    const socket = yield* Effect.orDie(request.upgrade)
+    yield* onSocket(socket)
+    return HttpServerResponse.empty()
+  })
+
+  return { protocol, httpApp } as const
+})
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWebsocket: <I = HttpRouter.Default>(
+  options: {
+    readonly path: HttpRouter.PathInput
+    readonly routerTag?: Context.Tag<I, HttpRouter.HttpRouter.Service<any, any>>
+  }
+) => Effect.Effect<
+  Protocol["Type"],
+  never,
+  RpcSerialization.RpcSerialization | I
+> = Effect.fnUntraced(function*<I = HttpRouter.Default>(options: {
+  readonly path: HttpRouter.PathInput
+  readonly routerTag?: Context.Tag<I, HttpRouter.HttpRouter.Service<any, any>>
+}) {
+  const { httpApp, protocol } = yield* makeProtocolWithHttpAppWebsocket
+  const router =
+    yield* (options.routerTag ?? HttpRouter.Default as any as Context.Tag<I, HttpRouter.HttpRouter.Service<any, any>>)
+  yield* router.get(options.path, httpApp)
+  return protocol
+})
+
+/**
+ * A rpc protocol that uses websockets for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolWebsocket = <I = HttpRouter.Default>(options: {
+  readonly path: HttpRouter.PathInput
+  readonly routerTag?: HttpRouter.HttpRouter.TagClass<I, string, any, any>
+}): Layer.Layer<Protocol, never, RpcSerialization.RpcSerialization> => {
+  const routerTag = options.routerTag ??
+    HttpRouter.Default as any as HttpRouter.HttpRouter.TagClass<I, string, any, any>
+  return Layer.effect(Protocol, makeProtocolWebsocket(options)).pipe(
+    Layer.provide(routerTag.Live)
+  )
+}
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWithHttpApp: Effect.Effect<
+  {
+    readonly protocol: Protocol["Type"]
+    readonly httpApp: HttpApp.Default<never, Scope.Scope>
+  },
+  never,
+  RpcSerialization.RpcSerialization
+> = Effect.gen(function*() {
+  const serialization = yield* RpcSerialization.RpcSerialization
+  const isJson = serialization.contentType === "application/json"
+
+  const disconnects = yield* Mailbox.make<number>()
+  let writeRequest!: (clientId: number, message: FromClientEncoded) => Effect.Effect<void>
+
+  let clientId = 0
+
+  const clients = new Map<number, {
+    readonly write: (bytes: FromServerEncoded) => Effect.Effect<void>
+    readonly end: Effect.Effect<void>
+  }>()
+
+  const httpApp: HttpApp.Default<never, Scope.Scope> = Effect.gen(function*() {
+    const request = yield* HttpServerRequest.HttpServerRequest
+    const data = yield* Effect.orDie(request.arrayBuffer)
+    const id = clientId++
+    const mailbox = yield* Mailbox.make<Uint8Array | FromServerEncoded>()
+    const parser = serialization.unsafeMake()
+    const encoder = new TextEncoder()
+
+    const offer = (data: Uint8Array | string) =>
+      typeof data === "string" ? mailbox.offer(encoder.encode(data)) : mailbox.offer(data)
+
+    clients.set(id, {
+      write: (response) => {
+        try {
+          if (!serialization.supportsBigInt) {
+            transformBigInt(response)
+          }
+          return isJson ? mailbox.offer(response) : offer(parser.encode(response))
+        } catch (cause) {
+          return isJson
+            ? mailbox.offer(ResponseDefectEncoded(cause))
+            : offer(parser.encode(ResponseDefectEncoded(cause)))
+        }
+      },
+      end: mailbox.end
+    })
+
+    const requestIds: Array<RequestId> = []
+
+    try {
+      const decoded = parser.decode(new Uint8Array(data)) as ReadonlyArray<FromClientEncoded>
+      for (const message of decoded) {
+        if (message._tag === "Request") {
+          requestIds.push(RequestId(message.id))
+        }
+        yield* writeRequest(id, message)
+      }
+    } catch (cause) {
+      yield* offer(parser.encode(ResponseDefectEncoded(cause)))
+    }
+
+    yield* writeRequest(id, constEof)
+
+    if (isJson) {
+      let done = false
+      yield* Effect.addFinalizer(() => {
+        clients.delete(id)
+        disconnects.unsafeOffer(id)
+        if (done) return Effect.void
+        return Effect.forEach(
+          requestIds,
+          (requestId) => writeRequest(id, { _tag: "Interrupt", requestId }),
+          { discard: true }
+        )
+      })
+      const responses = Arr.empty<FromServerEncoded>()
+      while (true) {
+        const [items, done] = yield* mailbox.takeAll
+        // eslint-disable-next-line no-restricted-syntax
+        responses.push(...items as any)
+        if (done) break
+      }
+      done = true
+      return HttpServerResponse.unsafeJson(responses)
+    }
+
+    return HttpServerResponse.stream(
+      Stream.ensuringWith(Mailbox.toStream(mailbox as Mailbox.ReadonlyMailbox<Uint8Array>), (exit) => {
+        clients.delete(id)
+        disconnects.unsafeOffer(id)
+        if (!Exit.isInterrupted(exit)) return Effect.void
+        return Effect.forEach(
+          requestIds,
+          (requestId) => writeRequest(id, { _tag: "Interrupt", requestId }),
+          { discard: true }
+        )
+      }),
+      { contentType: serialization.contentType }
+    )
+  }).pipe(Effect.interruptible)
+
+  const protocol = yield* Protocol.make((writeRequest_) => {
+    writeRequest = writeRequest_
+    return Effect.succeed({
+      disconnects,
+      send: (clientId, response) => {
+        const client = clients.get(clientId)
+        if (!client) return Effect.void
+        return client.write(response)
+      },
+      end(clientId) {
+        const client = clients.get(clientId)
+        if (!client) return Effect.void
+        return client.end
+      },
+      initialMessage: Effect.succeedNone,
+      supportsAck: false,
+      supportsTransferables: false
+    })
+  })
+
+  return { protocol, httpApp } as const
+})
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolHttp = Effect.fnUntraced(function*<I = HttpRouter.Default>(options: {
+  readonly path: HttpRouter.PathInput
+  readonly routerTag?: HttpRouter.HttpRouter.TagClass<I, string, any, any>
+}) {
+  const { httpApp, protocol } = yield* makeProtocolWithHttpApp
+  const router =
+    yield* (options.routerTag ?? HttpRouter.Default as any as HttpRouter.HttpRouter.TagClass<I, string, any, any>)
+  yield* router.post(options.path, httpApp)
+  return protocol
+})
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const makeProtocolWorkerRunner: Effect.Effect<
+  Protocol["Type"],
+  WorkerError,
+  WorkerRunner.PlatformRunner | Scope.Scope
+> = Protocol.make(Effect.fnUntraced(function*(writeRequest) {
+  const runner = yield* WorkerRunner.PlatformRunner
+  const closeLatch = yield* WorkerRunner.CloseLatch
+  const backing = yield* runner.start<FromClientEncoded | InitialMessage.Encoded, FromServerEncoded>(closeLatch)
+  const initialMessage = yield* Deferred.make<unknown>()
+
+  yield* backing.run((clientId, message) => {
+    if (message._tag === "InitialMessage") {
+      return Deferred.succeed(initialMessage, message.value)
+    }
+    return writeRequest(clientId, message)
+  })
+
+  return {
+    disconnects: backing.disconnects ?? (yield* Mailbox.make<number>()),
+    send: backing.send,
+    end(_clientId) {
+      return Effect.void
+    },
+    initialMessage: Effect.asSome(Deferred.await(initialMessage)),
+    supportsAck: true,
+    supportsTransferables: true
+  }
+}))
+
+/**
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolWorkerRunner: Layer.Layer<
+  Protocol,
+  WorkerError,
+  WorkerRunner.PlatformRunner
+> = Layer.scoped(Protocol, makeProtocolWorkerRunner)
+
+/**
+ * A rpc protocol that uses streaming http for communication.
+ *
+ * @since 1.0.0
+ * @category protocol
+ */
+export const layerProtocolHttp = <I = HttpRouter.Default>(options: {
+  readonly path: HttpRouter.PathInput
+  readonly routerTag?: HttpRouter.HttpRouter.TagClass<I, string, any, any>
+}): Layer.Layer<Protocol, never, RpcSerialization.RpcSerialization> => {
+  const routerTag = options.routerTag ??
+    HttpRouter.Default as any as HttpRouter.HttpRouter.TagClass<I, string, any, any>
+  return Layer.effect(Protocol, makeProtocolHttp(options)).pipe(
+    Layer.provide(routerTag.Live)
+  )
+}
+
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+export const toHttpApp: <Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+  } | undefined
+) => Effect.Effect<
+  HttpApp.Default<never, Scope.Scope>,
+  never,
+  | Scope.Scope
+  | RpcSerialization.RpcSerialization
+  | Rpc.ToHandler<Rpcs>
+  | Rpc.Middleware<Rpcs>
+> = Effect.fnUntraced(function*<Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+  }
+) {
+  const { httpApp, protocol } = yield* makeProtocolWithHttpApp
+  yield* make(group, options).pipe(
+    Effect.provideService(Protocol, protocol),
+    Effect.interruptible,
+    Effect.forkScoped
+  )
+  return httpApp
+})
+
+/**
+ * @since 1.0.0
+ * @category http app
+ */
+export const toHttpAppWebsocket: <Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+  } | undefined
+) => Effect.Effect<
+  HttpApp.Default<never, Scope.Scope>,
+  never,
+  | Scope.Scope
+  | RpcSerialization.RpcSerialization
+  | Rpc.ToHandler<Rpcs>
+  | Rpc.Middleware<Rpcs>
+> = Effect.fnUntraced(function*<Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options?: {
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+  }
+) {
+  const { httpApp, protocol } = yield* makeProtocolWithHttpAppWebsocket
+  yield* make(group, options).pipe(
+    Effect.provideService(Protocol, protocol),
+    Effect.interruptible,
+    Effect.forkScoped
+  )
+  return httpApp
+})
+
+/**
+ * Construct an http web handler from an `RpcGroup`.
+ *
+ * @since 1.0.0
+ * @category constructors
+ */
+export const toWebHandler = <Rpcs extends Rpc.Any, LE>(
+  group: RpcGroup.RpcGroup<Rpcs>,
+  options: {
+    readonly layer: Layer.Layer<
+      | Rpc.ToHandler<Rpcs>
+      | Rpc.Middleware<Rpcs>
+      | RpcSerialization.RpcSerialization
+      | HttpRouter.HttpRouter.DefaultServices,
+      LE
+    >
+    readonly disableSpanPropagation?: boolean | undefined
+    readonly spanPrefix?: string | undefined
+    readonly middleware?: (
+      httpApp: HttpApp.Default
+    ) => HttpApp.Default<
+      never,
+      HttpRouter.HttpRouter.DefaultServices
+    >
+    readonly memoMap?: Layer.MemoMap
+  }
+): {
+  readonly handler: (request: globalThis.Request, context?: Context.Context<never> | undefined) => Promise<Response>
+  readonly dispose: () => Promise<void>
+} => {
+  const runtime = ManagedRuntime.make(Layer.mergeAll(options.layer, Layer.scope), options?.memoMap)
+  let handlerCached:
+    | ((request: globalThis.Request, context?: Context.Context<never> | undefined) => Promise<Response>)
+    | undefined
+  const handlerPromise = Effect.gen(function*() {
+    const app = yield* toHttpApp(group, options)
+    const rt = yield* runtime.runtimeEffect
+    const handler = HttpApp.toWebHandlerRuntime(rt)(options?.middleware ? options.middleware(app as any) as any : app)
+    handlerCached = handler
+    return handler
+  }).pipe(runtime.runPromise)
+  function handler(request: globalThis.Request, context?: Context.Context<never> | undefined): Promise<Response> {
+    if (handlerCached !== undefined) {
+      return handlerCached(request, context)
+    }
+    return handlerPromise.then((handler) => handler(request, context))
+  }
+  return { handler, dispose: runtime.dispose } as const
+}
+
+// internal
+
+const makeSocketProtocol = Effect.gen(function*() {
+  const serialization = yield* RpcSerialization.RpcSerialization
+  const disconnects = yield* Mailbox.make<number>()
+
+  let clientId = 0
+  const clients = new Map<number, {
+    readonly write: (bytes: FromServerEncoded) => Effect.Effect<void>
+  }>()
+
+  let writeRequest!: (clientId: number, message: FromClientEncoded) => Effect.Effect<void>
+
+  const onSocket = function*(socket: Socket.Socket) {
+    const scope = yield* Effect.scope
+    const parser = serialization.unsafeMake()
+    const id = clientId++
+    yield* Scope.addFinalizerExit(scope, () => {
+      clients.delete(id)
+      return disconnects.offer(id)
+    })
+
+    const writeRaw = yield* socket.writer
+    const write = (response: FromServerEncoded) => {
+      try {
+        if (!serialization.supportsBigInt) {
+          transformBigInt(response)
+        }
+        return Effect.orDie(writeRaw(parser.encode(response)))
+      } catch (cause) {
+        return Effect.orDie(
+          writeRaw(parser.encode(ResponseDefectEncoded(cause)))
+        )
+      }
+    }
+    clients.set(id, { write })
+
+    yield* Effect.orDie(Effect.interruptible(socket.runRaw((data) => {
+      try {
+        const decoded = parser.decode(data) as ReadonlyArray<FromClientEncoded>
+        if (decoded.length === 0) return Effect.void
+        let i = 0
+        return Effect.whileLoop({
+          while: () => i < decoded.length,
+          body: () => writeRequest(id, decoded[i++]),
+          step: constVoid
+        })
+      } catch (cause) {
+        return writeRaw(parser.encode(ResponseDefectEncoded(cause)))
+      }
+    })))
+  }
+
+  const protocol = yield* Protocol.make((writeRequest_) => {
+    writeRequest = writeRequest_
+    return Effect.succeed({
+      disconnects,
+      send: (clientId, response) => {
+        const client = clients.get(clientId)
+        if (!client) return Effect.void
+        return Effect.orDie(client.write(response))
+      },
+      end(_clientId) {
+        return Effect.void
+      },
+      initialMessage: Effect.succeedNone,
+      supportsAck: true,
+      supportsTransferables: false
+    })
+  })
+
+  return { protocol, onSocket } as const
+})
+
+const transformBigInt = (response: FromServerEncoded) => {
+  if ("requestId" in response) {
+    ;(response as any).requestId = response.requestId.toString()
+  }
+}
diff --git a/src/RpcTest.ts b/src/RpcTest.ts
new file mode 100644
index 0000000000000000000000000000000000000000..a4e6bca0a87be91706156562ff18b6a4c678b487
--- /dev/null
+++ b/src/RpcTest.ts
@@ -0,0 +1,38 @@
+/**
+ * @since 1.0.0
+ */
+import * as Effect from "effect/Effect"
+import type * as Scope from "effect/Scope"
+import type * as Rpc from "./Rpc.js"
+import * as RpcClient from "./RpcClient.js"
+import type * as RpcGroup from "./RpcGroup.js"
+import * as RpcServer from "./RpcServer.js"
+
+/**
+ * @since 1.0.0
+ * @category constructors
+ */
+export const makeClient: <Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>
+) => Effect.Effect<
+  RpcClient.RpcClient<Rpcs>,
+  never,
+  Scope.Scope | Rpc.ToHandler<Rpcs> | Rpc.Middleware<Rpcs> | Rpc.MiddlewareClient<Rpcs>
+> = Effect.fnUntraced(function*<Rpcs extends Rpc.Any>(
+  group: RpcGroup.RpcGroup<Rpcs>
+) {
+  // eslint-disable-next-line prefer-const
+  let client!: Effect.Effect.Success<ReturnType<typeof RpcClient.makeNoSerialization<Rpcs, never>>>
+  const server = yield* RpcServer.makeNoSerialization(group, {
+    onFromServer(response) {
+      return client.write(response)
+    }
+  })
+  client = yield* RpcClient.makeNoSerialization(group, {
+    supportsAck: true,
+    onFromClient({ message }) {
+      return server.write(0, message)
+    }
+  })
+  return client.client
+})
diff --git a/src/RpcWorker.ts b/src/RpcWorker.ts
new file mode 100644
index 0000000000000000000000000000000000000000..ec08fa8bedff995112dbf3cef3237e136701eb6d
--- /dev/null
+++ b/src/RpcWorker.ts
@@ -0,0 +1,90 @@
+/**
+ * @since 1.0.0
+ */
+import * as Transferable from "@effect/platform/Transferable"
+import type { NoSuchElementException } from "effect/Cause"
+import * as Context from "effect/Context"
+import * as Effect from "effect/Effect"
+import * as Layer from "effect/Layer"
+import type { ParseError } from "effect/ParseResult"
+import * as Schema from "effect/Schema"
+import type { Protocol } from "./RpcServer.js"
+
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export class InitialMessage extends Context.Tag("@effect/rpc/RpcWorker/InitialMessage")<
+  InitialMessage,
+  Effect.Effect<
+    readonly [
+      data: unknown,
+      transfers: ReadonlyArray<Transferable>
+    ]
+  >
+>() {}
+
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export declare namespace InitialMessage {
+  /**
+   * @since 1.0.0
+   * @category initial message
+   */
+  export interface Encoded {
+    readonly _tag: "InitialMessage"
+    readonly value: unknown
+  }
+}
+
+const ProtocolTag: typeof Protocol = Context.GenericTag("@effect/rpc/RpcServer/Protocol") as any
+
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export const makeInitialMessage = <A, I, R, E, R2>(
+  schema: Schema.Schema<A, I, R>,
+  effect: Effect.Effect<A, E, R2>
+): Effect.Effect<
+  readonly [data: unknown, transferables: ReadonlyArray<globalThis.Transferable>],
+  E | ParseError,
+  R | R2
+> =>
+  Effect.flatMap(effect, (value) => {
+    const collector = Transferable.unsafeMakeCollector()
+    return Schema.encode(schema)(value).pipe(
+      Effect.provideService(Transferable.Collector, collector),
+      Effect.map((encoded) => [encoded, collector.unsafeClear()] as const)
+    )
+  })
+
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export const layerInitialMessage = <A, I, R, R2>(
+  schema: Schema.Schema<A, I, R>,
+  build: Effect.Effect<A, never, R2>
+): Layer.Layer<InitialMessage, never, R | R2> =>
+  Layer.effect(
+    InitialMessage,
+    Effect.contextWith((context: Context.Context<R | R2>) =>
+      Effect.provide(Effect.orDie(makeInitialMessage(schema, build)), context)
+    )
+  )
+
+/**
+ * @since 1.0.0
+ * @category initial message
+ */
+export const initialMessage = <A, I, R>(
+  schema: Schema.Schema<A, I, R>
+): Effect.Effect<A, NoSuchElementException | ParseError, Protocol | R> =>
+  ProtocolTag.pipe(
+    Effect.flatMap((protocol) => protocol.initialMessage),
+    Effect.flatten,
+    Effect.flatMap(Schema.decodeUnknown(schema))
+  )
diff --git a/src/index.ts b/src/index.ts
index 56a86163a9db7f267c019959b7d1e5b186d7294a..3b352e71a7b94b8308b04a76113cc09575f412a9 100644
--- a/src/index.ts
+++ b/src/index.ts
@@ -6,14 +6,44 @@ export * as Rpc from "./Rpc.js"
 /**
  * @since 1.0.0
  */
-export * as RpcResolver from "./RpcResolver.js"
+export * as RpcClient from "./RpcClient.js"
 
 /**
  * @since 1.0.0
  */
-export * as RpcResolverNoStream from "./RpcResolverNoStream.js"
+export * as RpcGroup from "./RpcGroup.js"
 
 /**
  * @since 1.0.0
  */
-export * as RpcRouter from "./RpcRouter.js"
+export * as RpcMessage from "./RpcMessage.js"
+
+/**
+ * @since 1.0.0
+ */
+export * as RpcMiddleware from "./RpcMiddleware.js"
+
+/**
+ * @since 1.0.0
+ */
+export * as RpcSchema from "./RpcSchema.js"
+
+/**
+ * @since 1.0.0
+ */
+export * as RpcSerialization from "./RpcSerialization.js"
+
+/**
+ * @since 1.0.0
+ */
+export * as RpcServer from "./RpcServer.js"
+
+/**
+ * @since 1.0.0
+ */
+export * as RpcTest from "./RpcTest.js"
+
+/**
+ * @since 1.0.0
+ */
+export * as RpcWorker from "./RpcWorker.js"
diff --git a/src/internal/utils.ts b/src/internal/utils.ts
new file mode 100644
index 0000000000000000000000000000000000000000..5b4e81297ff8c070d72f063c35f8856e6f8d3bfe
--- /dev/null
+++ b/src/internal/utils.ts
@@ -0,0 +1,33 @@
+import * as Effect from "effect/Effect"
+
+/** @internal */
+export const withRun = <
+  A extends {
+    readonly run: (f: (...args: Array<any>) => Effect.Effect<void>) => Effect.Effect<never>
+  }
+>() =>
+<EX, RX>(f: (write: Parameters<A["run"]>[0]) => Effect.Effect<Omit<A, "run">, EX, RX>): Effect.Effect<A, EX, RX> =>
+  Effect.suspend(() => {
+    const semaphore = Effect.unsafeMakeSemaphore(1)
+    let buffer: Array<Array<any>> = []
+    let write = (...args: Array<any>): Effect.Effect<void> => Effect.sync(() => buffer.push(args))
+    return Effect.map(f((...args) => write(...args)), (a) => ({
+      ...a,
+      run(f) {
+        return semaphore.withPermits(1)(Effect.gen(function*() {
+          const prev = write
+          write = f
+
+          for (const value of buffer) {
+            yield* write(...value)
+          }
+          buffer = []
+
+          return yield* Effect.onExit(Effect.never, () => {
+            write = prev
+            return Effect.void
+          })
+        }))
+      }
+    } as A))
+  })
